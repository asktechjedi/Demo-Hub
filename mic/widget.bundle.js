(()=>{"use strict";var e={"./node_modules/css-loader/dist/cjs.js!./src/js/components/chat/style.css":(e,t,s)=>{s.r(t),s.d(t,{default:()=>o});var i=s("./node_modules/css-loader/dist/runtime/noSourceMaps.js"),n=s.n(i),r=s("./node_modules/css-loader/dist/runtime/api.js"),a=s.n(r)()(n());a.push([e.id,".toggle-chat-btn {\n  border: none;\n  padding: 0.5rem 0.7rem;\n  cursor: pointer;\n  font-size: 14px;\n  transition: background 0.2s;\n  align-self: center;\n  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);\n  background-color: #2d2d2d80; /* Dark gray */\n  border-radius: 12px;\n  color: #fff;\n  user-select: none; /* Prevents text selection */\n  outline: none;\n  min-height: 60px;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n}\n\n.toggle-chat-btn:hover {\n  background-color: #1a1a1a90; /* Even darker gray on hover */\n}\n\n.toggle-chat-btn:focus {\n  outline: none; /* Ensures no outline on keyboard focus */\n  box-shadow: none; /* Optional: remove any focus ring shadow */\n}\n\n/* Responsive text sizing for chat button */\n@media (max-width: 768px) {\n  .toggle-chat-btn {\n    padding: 0.4rem 0.6rem;\n    min-height: 55px;\n  }\n\n  .toggle-chat-btn div div {\n    font-size: 7px !important;\n  }\n}\n\n@media (max-width: 480px) {\n  .toggle-chat-btn {\n    padding: 0.3rem 0.5rem;\n    min-height: 50px;\n  }\n\n  .toggle-chat-btn div div {\n    font-size: 6px !important;\n  }\n}\n",""]);const o=a},"./node_modules/css-loader/dist/cjs.js!./src/js/components/html/style.css":(e,t,s)=>{s.r(t),s.d(t,{default:()=>o});var i=s("./node_modules/css-loader/dist/runtime/noSourceMaps.js"),n=s.n(i),r=s("./node_modules/css-loader/dist/runtime/api.js"),a=s.n(r)()(n());a.push([e.id,".video-html-layout {\n  display: flex;\n  width: 100%;\n  max-width: 650px;\n  min-width: 320px;\n  overflow: hidden;\n}\n\n.video-section {\n  flex: 2 2 0;\n  min-width: 0;\n  background: #000;\n  /* border-radius: 8px; */\n  display: flex;\n  flex-direction: column;\n}\n\n.html-section {\n  /* flex: 1 1 0; */\n  min-width: 0;\n  background: #f8fafc;\n  /* padding: 8px; */\n  border-radius: 8px;\n  overflow-y: auto;\n  display: flex;\n  flex-direction: column;\n  transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1),\n    min-width 0.4s cubic-bezier(0.4, 0, 0.2, 1), padding 0.3s, opacity 0.3s;\n  opacity: 1;\n}\n\n.html-section.collapsed {\n  width: 0 !important;\n  min-width: 0 !important;\n  padding: 0 !important;\n  opacity: 0;\n  pointer-events: none;\n}\n\n.html-section {\n  padding: 16px;\n  /* border: 1px solid #ccc; */\n}\n\n.layout-wrapper.HTML_LAYOUT_01 {\n  background-color: #f9f9f9;\n}\n\n/* Fallback content styling */\n.fallback-content {\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  min-height: 200px;\n  padding: 40px 20px;\n  text-align: center;\n  background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);\n  border-radius: 8px;\n  margin: 20px 0;\n}\n\n.fallback-content p {\n  color: #666;\n  font-size: 16px;\n  font-family: Arial, sans-serif;\n  margin: 0;\n  opacity: 0.8;\n}\n\n.layout-wrapper.fallback-layout {\n  background-color: #f8fafc;\n  border: 2px dashed #e2e8f0;\n  border-radius: 8px;\n  min-height: 150px;\n}\n\n.layout-wrapper.FALLBACK_LAYOUT {\n  background-color: #f8fafc;\n  border: 2px dashed #e2e8f0;\n  border-radius: 8px;\n  min-height: 150px;\n}\n\n\n/* Picture-in-Picture Video Container Styles */\n.html-wrapper {\n  position: relative;\n  width: 100%;\n  height: 100%;\n}\n\n.html-container {\n  position: relative;\n  width: 100%;\n  height: 100%;\n  overflow: auto;\n}\n\n.video-pip-container {\n  /* Position will be set by JavaScript to fixed */\n  width: 320px;\n  height: 180px;\n  background: #000;\n  border-radius: 8px;\n  overflow: hidden;\n  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);\n  z-index: 1000;\n  transition: all 0.3s ease;\n  cursor: pointer;\n}\n\n.video-pip-container.minimized {\n  width: 160px;\n  height: 90px;\n}\n\n.video-pip-container:hover {\n  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);\n  transform: translateY(-2px);\n}\n\n.video-toggle-btn {\n  position: absolute;\n  top: 8px;\n  right: 8px;\n  width: 24px;\n  height: 24px;\n  background: rgba(0, 0, 0, 0.7);\n  color: white;\n  border: none;\n  border-radius: 50%;\n  cursor: pointer;\n  font-size: 16px;\n  line-height: 1;\n  z-index: 1001;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  transition: background-color 0.2s ease;\n}\n\n.video-toggle-btn:hover {\n  background: rgba(0, 0, 0, 0.9);\n}\n\n.video-toggle-btn:active {\n  transform: scale(0.95);\n}\n\n/* Mobile PiP adjustments - use smaller video sizes on mobile */\n.mobile-pip {\n  /* Mobile-optimized PiP video container - smaller than desktop */\n  position: fixed;\n  z-index: 10000;\n  /* Don't use !important for width/height so JavaScript can override */\n}\n\n/* Mobile responsive adjustments - only apply to mobile HTML wrapper */\n@media only screen and (max-width: 900px) {\n  /* Ensure HTML content has proper padding to avoid PiP overlap on mobile */\n  .mobile-html-wrapper .html-section {\n    padding-bottom: 130px; /* Extra padding for mobile PiP */\n  }\n  \n  /* Constrain HTML wrapper to normal widget body size on mobile only */\n  .mobile-html-wrapper {\n    max-height: 50vh; /* Same as desktop body height */\n    overflow: hidden;\n  }\n  \n  .mobile-html-wrapper .html-container {\n    max-height: 50vh;\n  }\n}\n\n/* Additional responsive breakpoint for very small screens - mobile only */\n@media only screen and (max-width: 480px) {\n  .mobile-html-wrapper .html-section {\n    padding-bottom: 110px; /* Adjust for smaller PiP */\n  }\n}\n",""]);const o=a},"./node_modules/css-loader/dist/cjs.js!./src/js/components/mic/style.css":(e,t,s)=>{s.r(t),s.d(t,{default:()=>o});var i=s("./node_modules/css-loader/dist/runtime/noSourceMaps.js"),n=s.n(i),r=s("./node_modules/css-loader/dist/runtime/api.js"),a=s.n(r)()(n());a.push([e.id,".toggle-mic-btn {\n  border: none;\n  padding: 0.5rem 0.7rem;\n  cursor: pointer;\n  font-size: 14px;\n  transition: background 0.2s;\n  align-self: center;\n  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);\n  background-color: #2d2d2d80; /* Dark gray */\n  border-radius: 12px;\n  color: #fff;\n  user-select: none; /* Prevents text selection */\n  outline: none;\n  min-height: 60px;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n}\n\n.toggle-mic-btn:hover {\n  background-color: #1a1a1a90; /* Even darker gray on hover */\n}\n\n.toggle-mic-btn:focus {\n  outline: none; /* Ensures no outline on keyboard focus */\n  box-shadow: none; /* Optional: remove any focus ring shadow */\n}\n\n/* Responsive text sizing for mic button */\n@media (max-width: 768px) {\n  .toggle-mic-btn {\n    padding: 0.4rem 0.6rem;\n    min-height: 55px;\n  }\n\n  .toggle-mic-btn div div {\n    font-size: 7px !important;\n  }\n}\n\n@media (max-width: 480px) {\n  .toggle-mic-btn {\n    padding: 0.3rem 0.5rem;\n    min-height: 50px;\n  }\n\n  .toggle-mic-btn div div {\n    font-size: 6px !important;\n  }\n}\n\n#mic-wave-container {\n  width: 16vh;\n  height: 40px;\n  padding: 2px;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  background-color: #2d2d2d80;\n  border-radius: 8px;\n  overflow: hidden;\n}\n\n.mic-wave {\n  width: 100%;\n  height: 100%;\n  display: block;\n}\n#mic-wave-container {\n  opacity: 0;\n  transform: scaleY(0.8);\n  transition: opacity 0.3s ease, transform 0.3s ease;\n}\n\n#mic-wave-container.visible {\n  opacity: 1;\n  transform: scaleY(1);\n}\n\n/* Video playing message styles */\n.video-playing-message {\n  animation: pulse 2s infinite;\n}\n\n@keyframes pulse {\n  0% {\n    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);\n  }\n  50% {\n    box-shadow: 0 2px 12px rgba(102, 126, 234, 0.5);\n  }\n  100% {\n    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);\n  }\n}\n\n/* Permission error message styles */\n.mic-permission-error {\n  animation: shake 0.5s ease-in-out;\n}\n\n@keyframes shake {\n  0%,\n  100% {\n    transform: translateX(0);\n  }\n  25% {\n    transform: translateX(-2px);\n  }\n  75% {\n    transform: translateX(2px);\n  }\n}\n\n/* Hide mic button on Android devices */\n.toggle-mic-btn.hidden {\n  display: none !important;\n}\n",""]);const o=a},"./node_modules/css-loader/dist/cjs.js!./src/js/components/suggestions/style.css":(e,t,s)=>{s.r(t),s.d(t,{default:()=>o});var i=s("./node_modules/css-loader/dist/runtime/noSourceMaps.js"),n=s.n(i),r=s("./node_modules/css-loader/dist/runtime/api.js"),a=s.n(r)()(n());a.push([e.id,"/* Suggestions Overlay Styles */\n.suggestions-overlay {\n  position: absolute;\n  bottom: 0;\n  left: 0;\n  right: 0;\n  background: linear-gradient(to top, rgba(0, 0, 0, 0.8) 0%, rgba(0, 0, 0, 0.6) 50%, transparent 100%);\n  padding: 20px 16px 16px;\n  z-index: 1002;\n  display: none;\n  flex-direction: column;\n  align-items: center;\n  justify-content: flex-end;\n  opacity: 0;\n  transition: opacity 0.3s ease-in-out;\n  pointer-events: auto;\n}\n\n.suggestions-container {\n  width: 100%;\n  max-width: 100%;\n  display: flex;\n  flex-direction: column;\n  align-items: center;\n  gap: 12px;\n}\n\n.suggestions-header {\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n  width: 100%;\n  margin-bottom: 4px;\n}\n\n.suggestions-title {\n  color: white;\n  font-size: 14px;\n  font-weight: 600;\n  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);\n  flex: 1;\n  text-align: center;\n}\n\n.suggestions-close-btn {\n  background: rgba(255, 255, 255, 0.2);\n  color: white;\n  border: none;\n  border-radius: 50%;\n  width: 24px;\n  height: 24px;\n  cursor: pointer;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  transition: all 0.2s ease;\n  flex-shrink: 0;\n}\n\n.suggestions-close-btn:hover {\n  background: rgba(255, 255, 255, 0.3);\n  transform: scale(1.1);\n}\n\n.suggestions-close-btn:active {\n  transform: scale(0.95);\n}\n\n.suggestions-close-btn svg {\n  width: 14px;\n  height: 14px;\n}\n\n.suggestions-list {\n  display: flex;\n  flex-wrap: wrap;\n  gap: 8px;\n  justify-content: center;\n  align-items: center;\n  width: 100%;\n  max-width: 100%;\n}\n\n.suggestion-item {\n  background: rgba(255, 255, 255, 0.9);\n  color: #333;\n  border: none;\n  border-radius: 20px;\n  padding: 10px 16px;\n  font-size: 13px;\n  font-weight: 500;\n  cursor: pointer;\n  transition: all 0.2s ease;\n  white-space: normal;\n  word-wrap: break-word;\n  max-width: 280px;\n  min-width: fit-content;\n  width: fit-content;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  gap: 6px;\n  position: relative;\n  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);\n  line-height: 1.3;\n  text-align: center;\n  height: auto;\n}\n\n.suggestion-item:hover {\n  background: rgba(255, 255, 255, 1);\n  transform: translateY(-1px);\n  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);\n}\n\n.suggestion-item:active {\n  transform: translateY(0);\n  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);\n}\n\n.suggestion-item.loading {\n  background: rgba(255, 255, 255, 0.7);\n  cursor: not-allowed;\n  pointer-events: none;\n}\n\n.suggestion-item.error {\n  background: rgba(255, 99, 99, 0.9);\n  color: white;\n  animation: shake 0.5s ease-in-out;\n}\n\n.suggestion-item.more-button,\n.suggestion-item.less-button {\n  background: rgba(255, 255, 255, 0.8);\n  color: #666;\n  border: 1px dashed rgba(255, 255, 255, 0.5);\n  font-size: 12px;\n  font-weight: 400;\n  display: flex;\n  align-items: center;\n  gap: 4px;\n}\n\n.suggestion-item.more-button:hover,\n.suggestion-item.less-button:hover {\n  background: rgba(255, 255, 255, 0.9);\n  color: #333;\n  border-color: rgba(255, 255, 255, 0.8);\n}\n\n.suggestion-item.more-button svg,\n.suggestion-item.less-button svg {\n  width: 12px;\n  height: 12px;\n  flex-shrink: 0;\n}\n\n.loading-spinner {\n  width: 12px;\n  height: 12px;\n  border: 2px solid #ccc;\n  border-top: 2px solid #333;\n  border-radius: 50%;\n  animation: spin 1s linear infinite;\n  flex-shrink: 0;\n}\n\n@keyframes spin {\n  0% { transform: rotate(0deg); }\n  100% { transform: rotate(360deg); }\n}\n\n@keyframes shake {\n  0%, 100% { transform: translateX(0); }\n  25% { transform: translateX(-4px); }\n  75% { transform: translateX(4px); }\n}\n\n/* Responsive adjustments */\n@media only screen and (max-width: 480px) {\n  .suggestions-overlay {\n    padding: 16px 12px 12px;\n  }\n  \n  .suggestions-title {\n    font-size: 13px;\n  }\n  \n  .suggestion-item {\n    font-size: 12px;\n    padding: 6px 12px;\n    max-width: 150px;\n  }\n  \n  .suggestions-list {\n    gap: 6px;\n  }\n}\n\n/* Ensure suggestions don't interfere with video controls */\n.video-pip-container .suggestions-overlay {\n  bottom: 0;\n}\n\n.video-pip-container.minimized .suggestions-overlay {\n  padding: 12px 8px 8px;\n}\n\n.video-pip-container.minimized .suggestions-title {\n  font-size: 11px;\n}\n\n.video-pip-container.minimized .suggestion-item {\n  font-size: 10px;\n  padding: 4px 8px;\n  max-width: 100px;\n}\n\n.video-pip-container.minimized .suggestions-list {\n  gap: 4px;\n}\n\n/* Input Bar Suggestions Styles */\n#input-suggestions-container .suggestions-overlay {\n  position: absolute;\n  bottom: 100%;\n  left: 0;\n  right: 0;\n  background: linear-gradient(to bottom, transparent 0%, rgba(0, 0, 0, 0.6) 50%, rgba(0, 0, 0, 0.8) 100%);\n  padding: 16px 16px 20px;\n  margin-bottom: 0;\n  border-radius: 8px 8px 0 0;\n  box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1);\n}\n\n#input-suggestions-container .suggestions-title {\n  color: white;\n  font-size: 12px;\n  font-weight: 600;\n  text-align: center;\n  margin-bottom: 8px;\n  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);\n}\n\n#input-suggestions-container .suggestion-item {\n  background: rgba(255, 255, 255, 0.95);\n  color: #333;\n  font-size: 12px;\n  padding: 8px 14px;\n  border-radius: 16px;\n  max-width: 300px;\n  min-width: fit-content;\n  width: fit-content;\n  white-space: normal;\n  word-wrap: break-word;\n  line-height: 1.3;\n  text-align: center;\n  height: auto;\n}\n\n#input-suggestions-container .suggestion-item:hover {\n  background: rgba(255, 255, 255, 1);\n  transform: translateY(-1px);\n}\n\n/* Responsive adjustments for input bar suggestions */\n@media only screen and (max-width: 480px) {\n  #input-suggestions-container .suggestions-overlay {\n    padding: 12px 12px 16px;\n    margin-bottom: 0;\n  }\n  \n  #input-suggestions-container .suggestions-title {\n    font-size: 11px;\n    margin-bottom: 6px;\n  }\n  \n  #input-suggestions-container .suggestion-item {\n    font-size: 11px;\n    padding: 5px 10px;\n    max-width: fit-content;\n  }\n  \n  #input-suggestions-container .suggestions-list {\n    gap: 6px;\n  }\n}\n",""]);const o=a},"./node_modules/css-loader/dist/cjs.js!./src/js/components/video/style.css":(e,t,s)=>{s.r(t),s.d(t,{default:()=>o});var i=s("./node_modules/css-loader/dist/runtime/noSourceMaps.js"),n=s.n(i),r=s("./node_modules/css-loader/dist/runtime/api.js"),a=s.n(r)()(n());a.push([e.id,"#controls-container {\n  /* width: 2rem; */\n  /* height: 2rem; */\n  position: relative;\n  z-index: 3;\n  top: 82%;\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  gap: 1rem;\n  transition: all 0.3s ease;\n  overflow: hidden;\n}\n\n#controls-container.expanded {\n  padding-bottom: 1rem; /* adjust as needed */\n}\n",""]);const o=a},"./node_modules/css-loader/dist/cjs.js!./src/styles/animations.css":(e,t,s)=>{s.r(t),s.d(t,{default:()=>o});var i=s("./node_modules/css-loader/dist/runtime/noSourceMaps.js"),n=s.n(i),r=s("./node_modules/css-loader/dist/runtime/api.js"),a=s.n(r)()(n());a.push([e.id,".fade-slide {\n    animation: fadeSlideIn 0.35s ease;\n  }\n  \n  @keyframes fadeSlideIn {\n    from {\n      opacity: 0;\n      transform: translateY(12px);\n    }\n    to {\n      opacity: 1;\n      transform: translateY(0);\n    }\n  }\n  \n  .fade-in {\n    animation: fadeIn 0.35s ease;\n  }\n  \n  @keyframes fadeIn {\n    from {\n      opacity: 0;\n    }\n    to {\n      opacity: 1;\n    }\n  }  ",""]);const o=a},"./node_modules/css-loader/dist/cjs.js!./src/styles/components/chat.css":(e,t,s)=>{s.r(t),s.d(t,{default:()=>o});var i=s("./node_modules/css-loader/dist/runtime/noSourceMaps.js"),n=s.n(i),r=s("./node_modules/css-loader/dist/runtime/api.js"),a=s.n(r)()(n());a.push([e.id,'#widget-chat-history {\n  height: 100%;\n  min-height: 0;\n  flex-grow: 1;\n  overflow-y: auto;\n  display: flex;\n  flex-direction: column;\n  gap: 10px;\n  padding: 12px;\n  background: #f9f9f9;\n  border-radius: 8px;\n  box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05);\n  font-family: "Inter", sans-serif;\n}\n\n/* Message wrapper */\n.chat-message {\n  display: flex;\n  flex-direction: column;\n  max-width: 80%;\n  font-size: 14px;\n}\n\n/* Align left/right */\n.chat-message.bot {\n  align-self: flex-start;\n}\n.chat-message.user {\n  align-self: flex-end;\n}\n\n/* Chat bubble */\n.chat-bubble {\n  padding: 10px 14px;\n  border-radius: 18px;\n  line-height: 1.4;\n  word-wrap: break-word;\n  display: inline-block;\n}\n\n.chat-message.bot .chat-bubble {\n  background: #e5e7eb;\n  color: #1f2937;\n  border-bottom-left-radius: 0;\n}\n\n.chat-message.user .chat-bubble {\n  background: #3b82f6;\n  color: white;\n  border-bottom-right-radius: 0;\n}\n\n/* Timestamp */\n.chat-time {\n  font-size: 11px;\n  margin-top: 4px;\n  color: #999;\n  align-self: flex-end;\n}\n\n.typing-bubble {\n  display: inline-flex;\n  gap: 4px;\n  align-items: center;\n  justify-content: center;\n  padding: 8px 12px;\n  border-radius: 18px;\n  background: #e5e7eb;\n  width: 48px;\n  height: 20px;\n}\n\n.typing-bubble .dot {\n  width: 6px;\n  height: 6px;\n  background-color: #888;\n  border-radius: 50%;\n  animation: typing 1s infinite ease-in-out;\n}\n\n.typing-bubble .dot:nth-child(2) {\n  animation-delay: 0.2s;\n}\n.typing-bubble .dot:nth-child(3) {\n  animation-delay: 0.4s;\n}\n\n@keyframes typing {\n  0%,\n  80%,\n  100% {\n    transform: scale(0.8);\n    opacity: 0.3;\n  }\n  40% {\n    transform: scale(1);\n    opacity: 1;\n  }\n}\n',""]);const o=a},"./node_modules/css-loader/dist/cjs.js!./src/styles/components/contact.css":(e,t,s)=>{s.r(t),s.d(t,{default:()=>o});var i=s("./node_modules/css-loader/dist/runtime/noSourceMaps.js"),n=s.n(i),r=s("./node_modules/css-loader/dist/runtime/api.js"),a=s.n(r)()(n());a.push([e.id,"#widget-contact-form {\n  display: flex;\n  flex-direction: column;\n  gap: 12px;\n  padding: 12px;\n}\n\n.form-group {\n  display: flex;\n  flex-direction: column;\n}\n\nlabel {\n  font-size: 14px;\n  font-weight: 600;\n  margin-bottom: 4px;\n}\n\ninput,\ntextarea {\n  padding: 10px;\n  border: 1px solid #ccc;\n  border-radius: 6px;\n  font-size: 14px;\n  outline: none;\n  transition: border-color 0.2s ease;\n}\n\ninput:focus,\ntextarea:focus {\n  border-color: #1e40af;\n}\n\n.error-message {\n  font-size: 12px;\n  color: #dc2626; /* red-600 */\n  margin-top: 4px;\n}\n\n#submit-btn {\n  padding: 10px 16px;\n  background-color: #1e40af;\n  color: white;\n  border: none;\n  border-radius: 6px;\n  font-size: 14px;\n  cursor: pointer;\n  transition: background 0.3s ease;\n}\n\n#submit-btn:hover {\n  background-color: #1d4ed8;\n}\n\n.form-group {\n  display: flex;\n  flex-direction: column;\n  margin-bottom: 12px;\n}\n\n.error-message {\n  color: #dc2626;\n  font-size: 12px;\n  margin-top: 4px;\n  min-height: 16px;\n}\n\n#form-footer {\n  display: flex;\n  align-items: center;\n  gap: 12px;\n}\n\n\n\n.hidden {\n  display: none;\n}\n\n#success-banner {\n  background-color: #d1fae5;\n  color: #065f46;\n  border: 1px solid #10b981;\n  padding: 10px;\n  margin-top: 12px;\n  font-size: 14px;\n  border-radius: 6px;\n  text-align: center;\n}\n\n.error-message {\n  color: #e53935;\n  font-size: 12px;\n  margin-top: 4px;\n  display: block;\n}\n\n#success-banner,\n#error-banner {\n  margin-top: 1rem;\n  font-size: 14px;\n  padding: 8px;\n  border-radius: 6px;\n  text-align: center;\n}\n\n#success-banner {\n  background-color: #d4edda;\n  color: #155724;\n}\n\n#error-banner {\n  background-color: #fdecea;\n  color: #a94442;\n}\n\n.hidden {\n  display: none;\n}\n\n@keyframes shake {\n  0% {\n    transform: translateX(0);\n  }\n  25% {\n    transform: translateX(-4px);\n  }\n  50% {\n    transform: translateX(4px);\n  }\n  75% {\n    transform: translateX(-4px);\n  }\n  100% {\n    transform: translateX(0);\n  }\n}\n\n.shake {\n  animation: shake 0.3s ease-in-out;\n}\n\n.form-footer {\n  display: flex;\n  justify-content: space-around;\n  align-items: center;\n  margin-top: 20px;\n  flex-wrap: wrap;\n}\n\n#skip-btn {\n  background-color: #f1f3f5;\n  border: 1px solid #ccc;\n  color: #333;\n  font-size: 14px;\n  padding: 8px 16px;\n  border-radius: 6px;\n  display: inline-flex;\n  align-items: center;\n  gap: 8px;\n  transition: background-color 0.3s ease, box-shadow 0.3s ease;\n}\n\n#skip-btn:hover {\n  background-color: #e2e6ea;\n  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);\n  cursor: pointer;\n}\n\n#skip-btn:focus {\n  outline: 2px solid #007bff;\n  outline-offset: 2px;\n}\n\n#skip-btn:disabled {\n  opacity: 0.6;\n  cursor: not-allowed;\n  background-color: #f8f9fa;\n}\n\n.form-actions {\n  display: flex;\n  align-items: center;\n  gap: 8px;\n}\n\n#submit-btn {\n  background-color: #007bff;\n  border: none;\n  color: white;\n  font-size: 14px;\n  padding: 8px 16px;\n  border-radius: 6px;\n  cursor: pointer;\n  transition: background-color 0.3s ease;\n}\n\n#submit-btn:hover {\n  background-color: #0056b3;\n}\n\n#form-loader {\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  gap: 8px;\n  padding: 12px;\n  margin: 16px 0;\n  background-color: #f8fafc;\n  border: 1px solid #e2e8f0;\n  border-radius: 8px;\n  font-size: 14px;\n  color: #475569;\n  font-weight: 500;\n}\n\n.loader-spinner {\n  width: 16px;\n  height: 16px;\n  border: 2px solid #e2e8f0;\n  border-top: 2px solid #3b82f6;\n  border-radius: 50%;\n  animation: spin 1s linear infinite;\n}\n\n@keyframes spin {\n  0% {\n    transform: rotate(0deg);\n  }\n  100% {\n    transform: rotate(360deg);\n  }\n}\n\n#form-loader.hidden {\n  display: none;\n}\n",""]);const o=a},"./node_modules/css-loader/dist/cjs.js!./src/styles/components/header.css":(e,t,s)=>{s.r(t),s.d(t,{default:()=>o});var i=s("./node_modules/css-loader/dist/runtime/noSourceMaps.js"),n=s.n(i),r=s("./node_modules/css-loader/dist/runtime/api.js"),a=s.n(r)()(n());a.push([e.id,'.my-widget-header {\n    background: #1e293b; /* dark blue-gray */\n    color: #fff;\n    padding: 12px 16px;\n    border-top-left-radius: 8px;\n    border-top-right-radius: 8px;\n    font-family: "Inter", sans-serif;\n    box-shadow: 0 2px 4px rgba(0,0,0,0.1);\n  }\n  \n  .header-container {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    gap: 12px;\n  }\n  \n  .widget-title {\n    font-size: 16px;\n    margin: 0;\n  }\n  \n  .close-btn {\n    background: transparent;\n    color: white;\n    font-size: 20px;\n    border: none;\n    cursor: pointer;\n  }\n',""]);const o=a},"./node_modules/css-loader/dist/cjs.js!./src/styles/components/inputBar.css":(e,t,s)=>{s.r(t),s.d(t,{default:()=>o});var i=s("./node_modules/css-loader/dist/runtime/noSourceMaps.js"),n=s.n(i),r=s("./node_modules/css-loader/dist/runtime/api.js"),a=s.n(r)()(n());a.push([e.id,"#my-widget-input-bar {\n    display: flex;\n    align-items: center;\n    padding: 8px;\n    border-top: 1px solid #eee;\n    background: #f9f9f9;\n    border-bottom-left-radius: 8px;\n    border-bottom-right-radius: 8px;\n  }\n  \n  #widget-chat-input {\n    flex: 1;\n    padding: 8px 12px;\n    border: 1px solid #ccc;\n    border-radius: 20px;\n    font-size: 14px;\n    outline: none;\n    transition: border 0.2s ease;\n  }\n  \n  #widget-chat-input:focus {\n    border-color: #3b82f6;\n  }\n  \n  #widget-send-btn {\n    margin-left: 8px;\n    background-color: #3b82f6;\n    border: none;\n    color: white;\n    font-size: 14px;\n    padding: 6px 8px 6px 13px;\n    border-radius: 50%;\n    cursor: pointer;\n    transition: background-color 0.2s ease;\n  }\n\n  #widget-send-btn img{\n    color: white;\n  }\n  \n  #widget-send-btn:hover:enabled {\n    background-color: #2563eb;\n  }\n  \n  #widget-send-btn:disabled {\n    background-color: #ccc;\n    cursor: not-allowed;\n    opacity: 0.6;\n  }\n  \n\n  .fb-loader {\n  width: 16px;\n  height: 16px;\n  border: 2px solid #fff;\n  border-top: 2px solid #999;\n  border-radius: 50%;\n  animation: fb-spin 0.6s linear infinite;\n}\n\n@keyframes fb-spin {\n  0% { transform: rotate(0deg); }\n  100% { transform: rotate(360deg); }\n}\n",""]);const o=a},"./node_modules/css-loader/dist/cjs.js!./src/styles/launcher.css":(e,t,s)=>{s.r(t),s.d(t,{default:()=>o});var i=s("./node_modules/css-loader/dist/runtime/noSourceMaps.js"),n=s.n(i),r=s("./node_modules/css-loader/dist/runtime/api.js"),a=s.n(r)()(n());a.push([e.id,'.widget-launcher {\n  position: fixed;\n  bottom: 24px;\n  right: 24px;\n  width: 80px;\n  height: 80px;\n  background-color: transparent;\n  /* box-shadow: 0 0 8px rgba(0, 0, 0, 0.2); */\n  cursor: pointer;\n  z-index: 9998;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  border-radius: 8px;\n  transition: opacity 0.3s ease;\n}\n\n/* Launcher text label styles */\n.launcher-text {\n  position: absolute;\n  bottom: 100%;\n  /* left: 50%; */\n  transform: translateX(-50%);\n  margin-bottom: 8px;\n  font-size: 12px;\n  font-weight: 600;\n  color: #333;\n  background: rgba(255, 255, 255, 0.95);\n  padding: 4px 8px;\n  border-radius: 6px;\n  white-space: nowrap;\n  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);\n  z-index: 9999;\n  backdrop-filter: blur(4px);\n  border: 1px solid rgba(0, 0, 0, 0.1);\n  animation: launcherJump 1.5s ease-in-out infinite;\n  font-family: "Inter", sans-serif;\n  transition: opacity 0.5s ease;\n}\n\n.widget-launcher .video-container {\n  transition: transform 0.3s ease; /* Smooth scaling animation */\n  height: 100%;\n  width: 100%;\n  /* Enable hardware acceleration */\n  transform: translateZ(0);\n  will-change: transform;\n}\n\n.widget-launcher .video-container:hover {\n  transform: scale(1.05) translateZ(0); /* Scale up on hover */\n}\n\n/* Enhanced Smooth Jumping Animation */\n@keyframes launcherJump {\n  0% {\n    transform: translate3d(0, 0, 0);\n  }\n  50% {\n    transform: translate3d(0, -18px, 0);\n  }\n  100% {\n    transform: translate3d(0, 0, 0);\n  }\n}\n\n/* Bounce effect for landing */\n@keyframes launcherBounce {\n  0% {\n    transform: translate3d(0, 0, 0);\n  }\n  50% {\n    transform: translate3d(0, 0, 0);\n  }\n  100% {\n    transform: translate3d(0, 0, 0);\n  }\n}\n\n.launcher-jumping {\n  animation: launcherJump 1.5s ease-in-out infinite;\n  /* Hardware acceleration */\n  transform: translateZ(0);\n  will-change: transform;\n}\n\n/* .launcher-jumping:hover {\n  animation-play-state: paused;\n  transform: scale(1.05) translateZ(0);\n} */\n\n/* ðŸ”½ Mobile Styles */\n@media (max-width: 768px) {\n  .widget-launcher {\n    width: 80px;\n    height: 80px;\n  }\n\n  .widget-launcher .video-container:hover {\n    transform: none; /* disable hover scale on mobile */\n  }\n\n  .launcher-text {\n    font-size: 11px;\n    padding: 3px 6px;\n    margin-bottom: 6px;\n    animation: launcherJump 1.5s ease-in-out infinite;\n  }\n\n  .launcher-jumping {\n    animation: launcherJump 1.5s ease-in-out infinite;\n  }\n}\n',""]);const o=a},"./node_modules/css-loader/dist/cjs.js!./src/styles/layout.css":(e,t,s)=>{s.r(t),s.d(t,{default:()=>o});var i=s("./node_modules/css-loader/dist/runtime/noSourceMaps.js"),n=s.n(i),r=s("./node_modules/css-loader/dist/runtime/api.js"),a=s.n(r)()(n());a.push([e.id,".my-widget-footer a{\n    color: #1e293b;\n    text-decoration: none;\n\n}",""]);const o=a},"./node_modules/css-loader/dist/cjs.js!./src/styles/style.css":(e,t,s)=>{s.r(t),s.d(t,{default:()=>p});var i=s("./node_modules/css-loader/dist/runtime/noSourceMaps.js"),n=s.n(i),r=s("./node_modules/css-loader/dist/runtime/api.js"),a=s.n(r),o=s("./node_modules/css-loader/dist/cjs.js!./src/styles/components/header.css"),l=s("./node_modules/css-loader/dist/cjs.js!./src/styles/components/inputBar.css"),d=s("./node_modules/css-loader/dist/cjs.js!./src/styles/components/chat.css"),c=s("./node_modules/css-loader/dist/cjs.js!./src/styles/components/contact.css"),h=s("./node_modules/css-loader/dist/cjs.js!./src/styles/animations.css"),u=s("./node_modules/css-loader/dist/cjs.js!./src/styles/launcher.css"),f=s("./node_modules/css-loader/dist/cjs.js!./src/styles/videoWithChat.css"),g=s("./node_modules/css-loader/dist/cjs.js!./src/styles/layout.css"),m=a()(n());m.push([e.id,"@import url(https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap);"]),m.i(o.default),m.i(l.default),m.i(d.default),m.i(c.default),m.i(h.default),m.i(u.default),m.i(f.default),m.i(g.default),m.push([e.id,'/* Inter font from Google */\n\n/* Root wrapper */\n.my-widget-wrapper {\n  all: initial;\n  font-family: sans-serif;\n  width: 370px;\n  transition: width 0.3s ease;\n  background: #fff;\n  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);\n  border-radius: 12px;\n  position: fixed;\n  bottom: 24px;\n  right: 24px;\n  z-index: 9999;\n}\n\n.my-widget-wrapper * {\n  font-family: "Inter", sans-serif !important;\n}\n\n.my-widget-wrapper.chat-visible {\n  width: 640px;\n}\n\n/* Body section */\n#my-widget-body {\n  background: #f9f9f9;\n  /* border-radius: 0 0 8px 8px; */\n  /* padding: 2px 0; */\n  font-size: 14px;\n  color: #333;\n  height: 50vh;\n  overflow-y: auto;\n  transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1),\n    height 0.4s cubic-bezier(0.4, 0, 0.2, 1);\n}\n\n/* Footer section */\n.my-widget-footer {\n  font-size: 12px;\n  text-align: center;\n  color: #888;\n}\n\n/* Widget fade-in animation */\n@keyframes fadeInUp {\n  from {\n    opacity: 0;\n    transform: translateY(10px);\n  }\n\n  to {\n    opacity: 1;\n    transform: translateY(0);\n  }\n}\n\n.fade-in {\n  animation: fadeInUp 0.3s ease-out;\n}\n\n/* Tablets */\n@media (max-width: 992px) {\n  .my-widget-wrapper {\n    width: 40%;\n  }\n}\n\n/* Hide desktop-only elements on mobile/tablet */\n@media only screen and (max-width: 768px) {\n  .my-widget-wrapper {\n    width: 100vw !important;\n    min-width: 0 !important;\n    max-width: 100vw !important;\n    /* height: 90vh !important; */\n    left: 0 !important;\n    right: 0 !important;\n    bottom: 0 !important;\n    border-radius: 0 !important;\n    position: fixed !important;\n  }\n\n  .desktop-only {\n    display: none !important;\n  }\n\n  /* Body section */\n  #my-widget-body {\n    height: inherit;\n    transition: height 0.4s cubic-bezier(0.4, 0, 0.2, 1);\n  }\n}\n',""]);const p=m},"./node_modules/css-loader/dist/cjs.js!./src/styles/videoWithChat.css":(e,t,s)=>{s.r(t),s.d(t,{default:()=>o});var i=s("./node_modules/css-loader/dist/runtime/noSourceMaps.js"),n=s.n(i),r=s("./node_modules/css-loader/dist/runtime/api.js"),a=s.n(r)()(n());a.push([e.id,".video-chat-layout {\n  display: flex;\n  width: 100%;\n  max-width: 650px;\n  min-width: 320px;\n  /* gap: 8px; */\n  overflow: hidden;\n}\n\n.video-section {\n  flex: 2 2 0;\n  min-width: 0;\n  background: #000;\n  /* border-radius: 8px; */\n  display: flex;\n  flex-direction: column;\n}\n\n.chat-section {\n  /* flex: 1 1 0; */\n  min-width: 0;\n  background: #f8fafc;\n  /* padding: 8px; */\n  border-radius: 8px;\n  overflow-y: auto;\n  display: flex;\n  flex-direction: column;\n  transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1),\n    min-width 0.4s cubic-bezier(0.4, 0, 0.2, 1), padding 0.3s, opacity 0.3s;\n  opacity: 1;\n}\n\n.chat-section.collapsed {\n  width: 0 !important;\n  min-width: 0 !important;\n  padding: 0 !important;\n  opacity: 0;\n  pointer-events: none;\n}\n\n.widget-title {\n  flex: 1;\n  margin: 0;\n  font-size: 16px;\n  font-weight: 500;\n}\n\n/* \n\nmobile-chat-section-only container for video with chat */\n.video-chat-mobile-container {\n  display: none;\n}\n\n@media only screen and (max-width: 900px) {\n  .video-chat-layout {\n    flex-direction: column;\n    max-width: 100vw;\n    min-width: 0;\n    width: 100vw;\n    height: 100vh;\n    gap: 0;\n  }\n\n  .video-section,\n  .chat-section {\n    width: 100%;\n    min-width: 0;\n    border-radius: 0;\n  }\n\n  .video-section {\n    height: 40vh;\n    min-height: 180px;\n    max-height: 50vh;\n  }\n\n  .chat-section {\n    flex: 1 1 0;\n    height: 60vh;\n    /* min-height: 200px; */\n    max-height: 60vh;\n    padding: 4px;\n    transition: height 0.4s cubic-bezier(0.4, 0, 0.2, 1), padding 0.3s,\n      opacity 0.3s;\n  }\n\n  .chat-section.collapsed {\n    height: 0 !important;\n    min-height: 0 !important;\n    max-height: 0 !important;\n    padding: 0 !important;\n    opacity: 0;\n    pointer-events: none;\n  }\n\n  .video-chat-mobile-container {\n    display: flex;\n    flex-direction: column;\n    width: 100vw;\n    /* height will be animated */\n    max-width: 100vw;\n    min-width: 0;\n    background: #fff;\n    overflow: hidden;\n    z-index: 9999;\n    /* position: relative; */\n    height: 50vh;\n    transition: height 0.4s cubic-bezier(0.4, 0, 0.2, 1);\n  }\n\n  .video-chat-mobile-container .video-section {\n    height: 40vh;\n    min-height: 180px;\n    max-height: 50vh;\n    width: 100%;\n    background: #000;\n    display: flex;\n    flex-direction: column;\n  }\n\n  .video-chat-mobile-container .chat-section {\n    flex: 1 1 0;\n    height: 60vh;\n    /* min-height: 200px; */\n    max-height: 60vh;\n    width: 100%;\n    background: #f8fafc;\n    padding: 4px;\n    border-radius: 0;\n    overflow-y: auto;\n    display: flex;\n    flex-direction: column;\n    transition: height 0.4s cubic-bezier(0.4, 0, 0.2, 1), padding 0.3s,\n      opacity 0.3s;\n    opacity: 1;\n  }\n}\n\n/* Hide desktop-only elements on mobile/tablet */\n@media only screen and (max-width: 768px) {\n  #mobile-chat-section {\n    overflow-y: auto !important;\n  }\n}\n\n/* Floating chat icon/button for mobile */\n.mobile-chat-icon {\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  position: fixed;\n  bottom: 70px;\n  right: 20px;\n  width: 56px;\n  height: 56px;\n  background: #007bff;\n  color: #fff;\n  border: none;\n  border-radius: 50%;\n  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);\n  font-size: 2rem;\n  z-index: 10001;\n  cursor: pointer;\n  transition: background 0.2s;\n}\n\n.mobile-chat-icon:active {\n  background: #0056b3;\n}\n\n/* Chat modal/drawer for mobile */\n.mobile-chat-modal {\n  position: fixed;\n  left: 0;\n  right: 0;\n  bottom: 55px;\n  /* leave space for input bar/footer */\n  width: 100vw;\n  height: 25vh;\n  max-height: 200px;\n  min-height: 150px;\n  background: #fff;\n  z-index: 10002;\n  display: flex;\n  flex-direction: column;\n  transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s;\n  transform: translateY(100%);\n  opacity: 0;\n  pointer-events: none;\n  border-top-left-radius: 8px;\n  border-top-right-radius: 8px;\n  box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);\n}\n\n.mobile-chat-modal:not(.hidden) {\n  transform: translateY(0);\n  opacity: 1;\n  pointer-events: auto;\n}\n\n.mobile-chat-modal.hidden {\n  transform: translateY(100%);\n  opacity: 0;\n  pointer-events: none;\n}\n\n@media only screen and (min-width: 901px) {\n  .mobile-chat-icon,\n  .mobile-chat-modal {\n    display: none !important;\n  }\n}\n\n/* Ensure header is always visible on mobile */\n@media only screen and (max-width: 900px) {\n  .my-widget-header {\n    position: relative;\n    z-index: 10003;\n    background: #1e293b;\n  }\n\n  /* Ensure footer and input bar stay above chat modal */\n  .my-widget-footer,\n  #my-widget-input-bar {\n    position: relative;\n    z-index: 10004;\n    background: #f9f9f9;\n  }\n\n  /* Adjust body height when chat is open to prevent header hiding */\n  #my-widget-body.chat-open {\n    max-height: calc(100vh - 60px) !important;\n    overflow: hidden;\n  }\n\n  /* Adjust control container position when mobile chat is open */\n  .video-chat-mobile-container #controls-container {\n    top: 80%;\n  }\n\n  /* Adjust control container position when mobile chat is open */\n  .video-chat-mobile-container.chat-open #controls-container {\n    top: 80%;\n  }\n\n  /* Fix mobile chat modal positioning when HTML data is null */\n  .mobile-chat-modal {\n    /* Ensure consistent positioning regardless of parent container */\n    position: fixed !important;\n    bottom: 55px !important;\n    left: 0 !important;\n    right: 0 !important;\n    width: 100vw !important;\n    z-index: 10002 !important;\n  }\n\n  /* Ensure mobile chat modal works with different layout states */\n  #my-widget-body.html-layout .mobile-chat-modal,\n  #my-widget-body.video-layout .mobile-chat-modal,\n  #my-widget-body.fallback-layout .mobile-chat-modal {\n    position: fixed !important;\n    bottom: 55px !important;\n    transform: translateY(100%);\n  }\n\n  /* When chat modal is visible */\n  #my-widget-body.html-layout .mobile-chat-modal:not(.hidden),\n  #my-widget-body.video-layout .mobile-chat-modal:not(.hidden),\n  #my-widget-body.fallback-layout .mobile-chat-modal:not(.hidden) {\n    transform: translateY(0) !important;\n    opacity: 1 !important;\n    pointer-events: auto !important;\n  }\n\n  /* Ensure chat section inside modal has proper styling */\n  .mobile-chat-modal .chat-section {\n    height: 100% !important;\n    max-height: none !important;\n    min-height: 0 !important;\n    /* padding: 8px !important; */\n    background: #f8fafc !important;\n    border-radius: 0 !important;\n    overflow-y: auto !important;\n  }\n\n  /* Fix for when body container height changes affect modal */\n  .my-widget-wrapper {\n    position: relative;\n  }\n\n  /* Ensure modal positioning is not affected by body height changes */\n  .my-widget-wrapper .mobile-chat-modal {\n    position: fixed !important;\n    bottom: 55px !important;\n  }\n}\n",""]);const o=a},"./node_modules/css-loader/dist/runtime/api.js":e=>{e.exports=function(e){var t=[];return t.toString=function(){return this.map(function(t){var s="",i=void 0!==t[5];return t[4]&&(s+="@supports (".concat(t[4],") {")),t[2]&&(s+="@media ".concat(t[2]," {")),i&&(s+="@layer".concat(t[5].length>0?" ".concat(t[5]):""," {")),s+=e(t),i&&(s+="}"),t[2]&&(s+="}"),t[4]&&(s+="}"),s}).join("")},t.i=function(e,s,i,n,r){"string"==typeof e&&(e=[[null,e,void 0]]);var a={};if(i)for(var o=0;o<this.length;o++){var l=this[o][0];null!=l&&(a[l]=!0)}for(var d=0;d<e.length;d++){var c=[].concat(e[d]);i&&a[c[0]]||(void 0!==r&&(void 0===c[5]||(c[1]="@layer".concat(c[5].length>0?" ".concat(c[5]):""," {").concat(c[1],"}")),c[5]=r),s&&(c[2]?(c[1]="@media ".concat(c[2]," {").concat(c[1],"}"),c[2]=s):c[2]=s),n&&(c[4]?(c[1]="@supports (".concat(c[4],") {").concat(c[1],"}"),c[4]=n):c[4]="".concat(n)),t.push(c))}},t}},"./node_modules/css-loader/dist/runtime/noSourceMaps.js":e=>{e.exports=function(e){return e[1]}},"./node_modules/hls.js/dist/hls.mjs":(e,t,s)=>{s.r(t),s.d(t,{AbrController:()=>st,AttrList:()=>Kt,AudioStreamController:()=>Dn,AudioTrackController:()=>On,BasePlaylistController:()=>_n,BaseSegment:()=>K,BaseStreamController:()=>ei,BufferController:()=>$n,CMCDController:()=>mr,CapLevelController:()=>Hn,ChunkMetadata:()=>Ot,ContentSteeringController:()=>pr,Cues:()=>Ga,DateRange:()=>Wt,EMEController:()=>Sr,ErrorActionFlags:()=>gt,ErrorController:()=>mt,ErrorDetails:()=>o,ErrorTypes:()=>a,Events:()=>l,FPSController:()=>Ar,FetchLoader:()=>Va,Fragment:()=>Y,Hls:()=>po,HlsSkip:()=>je,HlsUrlParameters:()=>Ve,KeySystemFormats:()=>ss,KeySystems:()=>ts,Level:()=>Ke,LevelDetails:()=>zt,LevelKey:()=>ds,LoadStats:()=>G,M3U8Parser:()=>ms,MetadataSchema:()=>ki,NetworkErrorAction:()=>ft,Part:()=>W,PlaylistLevelType:()=>f,SubtitleStreamController:()=>Vr,SubtitleTrackController:()=>kr,TimelineController:()=>Fa,XhrLoader:()=>Wa,default:()=>po,fetchSupported:()=>ja,getMediaSource:()=>I,isMSESupported:()=>lo,isSupported:()=>co,requestMediaKeySystemAccess:()=>as});const i=Number.isFinite||function(e){return"number"==typeof e&&isFinite(e)},n=Number.isSafeInteger||function(e){return"number"==typeof e&&Math.abs(e)<=r},r=Number.MAX_SAFE_INTEGER||9007199254740991;let a=function(e){return e.NETWORK_ERROR="networkError",e.MEDIA_ERROR="mediaError",e.KEY_SYSTEM_ERROR="keySystemError",e.MUX_ERROR="muxError",e.OTHER_ERROR="otherError",e}({}),o=function(e){return e.KEY_SYSTEM_NO_KEYS="keySystemNoKeys",e.KEY_SYSTEM_NO_ACCESS="keySystemNoAccess",e.KEY_SYSTEM_NO_SESSION="keySystemNoSession",e.KEY_SYSTEM_NO_CONFIGURED_LICENSE="keySystemNoConfiguredLicense",e.KEY_SYSTEM_LICENSE_REQUEST_FAILED="keySystemLicenseRequestFailed",e.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED="keySystemServerCertificateRequestFailed",e.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED="keySystemServerCertificateUpdateFailed",e.KEY_SYSTEM_SESSION_UPDATE_FAILED="keySystemSessionUpdateFailed",e.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED="keySystemStatusOutputRestricted",e.KEY_SYSTEM_STATUS_INTERNAL_ERROR="keySystemStatusInternalError",e.KEY_SYSTEM_DESTROY_MEDIA_KEYS_ERROR="keySystemDestroyMediaKeysError",e.KEY_SYSTEM_DESTROY_CLOSE_SESSION_ERROR="keySystemDestroyCloseSessionError",e.KEY_SYSTEM_DESTROY_REMOVE_SESSION_ERROR="keySystemDestroyRemoveSessionError",e.MANIFEST_LOAD_ERROR="manifestLoadError",e.MANIFEST_LOAD_TIMEOUT="manifestLoadTimeOut",e.MANIFEST_PARSING_ERROR="manifestParsingError",e.MANIFEST_INCOMPATIBLE_CODECS_ERROR="manifestIncompatibleCodecsError",e.LEVEL_EMPTY_ERROR="levelEmptyError",e.LEVEL_LOAD_ERROR="levelLoadError",e.LEVEL_LOAD_TIMEOUT="levelLoadTimeOut",e.LEVEL_PARSING_ERROR="levelParsingError",e.LEVEL_SWITCH_ERROR="levelSwitchError",e.AUDIO_TRACK_LOAD_ERROR="audioTrackLoadError",e.AUDIO_TRACK_LOAD_TIMEOUT="audioTrackLoadTimeOut",e.SUBTITLE_LOAD_ERROR="subtitleTrackLoadError",e.SUBTITLE_TRACK_LOAD_TIMEOUT="subtitleTrackLoadTimeOut",e.FRAG_LOAD_ERROR="fragLoadError",e.FRAG_LOAD_TIMEOUT="fragLoadTimeOut",e.FRAG_DECRYPT_ERROR="fragDecryptError",e.FRAG_PARSING_ERROR="fragParsingError",e.FRAG_GAP="fragGap",e.REMUX_ALLOC_ERROR="remuxAllocError",e.KEY_LOAD_ERROR="keyLoadError",e.KEY_LOAD_TIMEOUT="keyLoadTimeOut",e.BUFFER_ADD_CODEC_ERROR="bufferAddCodecError",e.BUFFER_INCOMPATIBLE_CODECS_ERROR="bufferIncompatibleCodecsError",e.BUFFER_APPEND_ERROR="bufferAppendError",e.BUFFER_APPENDING_ERROR="bufferAppendingError",e.BUFFER_STALLED_ERROR="bufferStalledError",e.BUFFER_FULL_ERROR="bufferFullError",e.BUFFER_SEEK_OVER_HOLE="bufferSeekOverHole",e.BUFFER_NUDGE_ON_STALL="bufferNudgeOnStall",e.ASSET_LIST_LOAD_ERROR="assetListLoadError",e.ASSET_LIST_LOAD_TIMEOUT="assetListLoadTimeout",e.ASSET_LIST_PARSING_ERROR="assetListParsingError",e.INTERSTITIAL_ASSET_ITEM_ERROR="interstitialAssetItemError",e.INTERNAL_EXCEPTION="internalException",e.INTERNAL_ABORTED="aborted",e.ATTACH_MEDIA_ERROR="attachMediaError",e.UNKNOWN="unknown",e}({}),l=function(e){return e.MEDIA_ATTACHING="hlsMediaAttaching",e.MEDIA_ATTACHED="hlsMediaAttached",e.MEDIA_DETACHING="hlsMediaDetaching",e.MEDIA_DETACHED="hlsMediaDetached",e.MEDIA_ENDED="hlsMediaEnded",e.STALL_RESOLVED="hlsStallResolved",e.BUFFER_RESET="hlsBufferReset",e.BUFFER_CODECS="hlsBufferCodecs",e.BUFFER_CREATED="hlsBufferCreated",e.BUFFER_APPENDING="hlsBufferAppending",e.BUFFER_APPENDED="hlsBufferAppended",e.BUFFER_EOS="hlsBufferEos",e.BUFFERED_TO_END="hlsBufferedToEnd",e.BUFFER_FLUSHING="hlsBufferFlushing",e.BUFFER_FLUSHED="hlsBufferFlushed",e.MANIFEST_LOADING="hlsManifestLoading",e.MANIFEST_LOADED="hlsManifestLoaded",e.MANIFEST_PARSED="hlsManifestParsed",e.LEVEL_SWITCHING="hlsLevelSwitching",e.LEVEL_SWITCHED="hlsLevelSwitched",e.LEVEL_LOADING="hlsLevelLoading",e.LEVEL_LOADED="hlsLevelLoaded",e.LEVEL_UPDATED="hlsLevelUpdated",e.LEVEL_PTS_UPDATED="hlsLevelPtsUpdated",e.LEVELS_UPDATED="hlsLevelsUpdated",e.AUDIO_TRACKS_UPDATED="hlsAudioTracksUpdated",e.AUDIO_TRACK_SWITCHING="hlsAudioTrackSwitching",e.AUDIO_TRACK_SWITCHED="hlsAudioTrackSwitched",e.AUDIO_TRACK_LOADING="hlsAudioTrackLoading",e.AUDIO_TRACK_LOADED="hlsAudioTrackLoaded",e.AUDIO_TRACK_UPDATED="hlsAudioTrackUpdated",e.SUBTITLE_TRACKS_UPDATED="hlsSubtitleTracksUpdated",e.SUBTITLE_TRACKS_CLEARED="hlsSubtitleTracksCleared",e.SUBTITLE_TRACK_SWITCH="hlsSubtitleTrackSwitch",e.SUBTITLE_TRACK_LOADING="hlsSubtitleTrackLoading",e.SUBTITLE_TRACK_LOADED="hlsSubtitleTrackLoaded",e.SUBTITLE_TRACK_UPDATED="hlsSubtitleTrackUpdated",e.SUBTITLE_FRAG_PROCESSED="hlsSubtitleFragProcessed",e.CUES_PARSED="hlsCuesParsed",e.NON_NATIVE_TEXT_TRACKS_FOUND="hlsNonNativeTextTracksFound",e.INIT_PTS_FOUND="hlsInitPtsFound",e.FRAG_LOADING="hlsFragLoading",e.FRAG_LOAD_EMERGENCY_ABORTED="hlsFragLoadEmergencyAborted",e.FRAG_LOADED="hlsFragLoaded",e.FRAG_DECRYPTED="hlsFragDecrypted",e.FRAG_PARSING_INIT_SEGMENT="hlsFragParsingInitSegment",e.FRAG_PARSING_USERDATA="hlsFragParsingUserdata",e.FRAG_PARSING_METADATA="hlsFragParsingMetadata",e.FRAG_PARSED="hlsFragParsed",e.FRAG_BUFFERED="hlsFragBuffered",e.FRAG_CHANGED="hlsFragChanged",e.FPS_DROP="hlsFpsDrop",e.FPS_DROP_LEVEL_CAPPING="hlsFpsDropLevelCapping",e.MAX_AUTO_LEVEL_UPDATED="hlsMaxAutoLevelUpdated",e.ERROR="hlsError",e.DESTROYING="hlsDestroying",e.KEY_LOADING="hlsKeyLoading",e.KEY_LOADED="hlsKeyLoaded",e.LIVE_BACK_BUFFER_REACHED="hlsLiveBackBufferReached",e.BACK_BUFFER_REACHED="hlsBackBufferReached",e.STEERING_MANIFEST_LOADED="hlsSteeringManifestLoaded",e.ASSET_LIST_LOADING="hlsAssetListLoading",e.ASSET_LIST_LOADED="hlsAssetListLoaded",e.INTERSTITIALS_UPDATED="hlsInterstitialsUpdated",e.INTERSTITIALS_BUFFERED_TO_BOUNDARY="hlsInterstitialsBufferedToBoundary",e.INTERSTITIAL_ASSET_PLAYER_CREATED="hlsInterstitialAssetPlayerCreated",e.INTERSTITIAL_STARTED="hlsInterstitialStarted",e.INTERSTITIAL_ASSET_STARTED="hlsInterstitialAssetStarted",e.INTERSTITIAL_ASSET_ENDED="hlsInterstitialAssetEnded",e.INTERSTITIAL_ASSET_ERROR="hlsInterstitialAssetError",e.INTERSTITIAL_ENDED="hlsInterstitialEnded",e.INTERSTITIALS_PRIMARY_RESUMED="hlsInterstitialsPrimaryResumed",e.PLAYOUT_LIMIT_REACHED="hlsPlayoutLimitReached",e.EVENT_CUE_ENTER="hlsEventCueEnter",e}({});var d="manifest",c="level",h="audioTrack",u="subtitleTrack",f={MAIN:"main",AUDIO:"audio",SUBTITLE:"subtitle"};class g{constructor(e,t=0,s=0){this.halfLife=void 0,this.alpha_=void 0,this.estimate_=void 0,this.totalWeight_=void 0,this.halfLife=e,this.alpha_=e?Math.exp(Math.log(.5)/e):0,this.estimate_=t,this.totalWeight_=s}sample(e,t){const s=Math.pow(this.alpha_,e);this.estimate_=t*(1-s)+s*this.estimate_,this.totalWeight_+=e}getTotalWeight(){return this.totalWeight_}getEstimate(){if(this.alpha_){const e=1-Math.pow(this.alpha_,this.totalWeight_);if(e)return this.estimate_/e}return this.estimate_}}class m{constructor(e,t,s,i=100){this.defaultEstimate_=void 0,this.minWeight_=void 0,this.minDelayMs_=void 0,this.slow_=void 0,this.fast_=void 0,this.defaultTTFB_=void 0,this.ttfb_=void 0,this.defaultEstimate_=s,this.minWeight_=.001,this.minDelayMs_=50,this.slow_=new g(e),this.fast_=new g(t),this.defaultTTFB_=i,this.ttfb_=new g(e)}update(e,t){const{slow_:s,fast_:i,ttfb_:n}=this;s.halfLife!==e&&(this.slow_=new g(e,s.getEstimate(),s.getTotalWeight())),i.halfLife!==t&&(this.fast_=new g(t,i.getEstimate(),i.getTotalWeight())),n.halfLife!==e&&(this.ttfb_=new g(e,n.getEstimate(),n.getTotalWeight()))}sample(e,t){const s=(e=Math.max(e,this.minDelayMs_))/1e3,i=8*t/s;this.fast_.sample(s,i),this.slow_.sample(s,i)}sampleTTFB(e){const t=e/1e3,s=Math.sqrt(2)*Math.exp(-Math.pow(t,2)/2);this.ttfb_.sample(s,Math.max(e,5))}canEstimate(){return this.fast_.getTotalWeight()>=this.minWeight_}getEstimate(){return this.canEstimate()?Math.min(this.fast_.getEstimate(),this.slow_.getEstimate()):this.defaultEstimate_}getEstimateTTFB(){return this.ttfb_.getTotalWeight()>=this.minWeight_?this.ttfb_.getEstimate():this.defaultTTFB_}get defaultEstimate(){return this.defaultEstimate_}destroy(){}}function p(e,t,s){return(t=function(e){var t=function(e){if("object"!=typeof e||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var s=t.call(e,"string");if("object"!=typeof s)return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==typeof t?t:t+""}(t))in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}function y(){return y=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var i in s)({}).hasOwnProperty.call(s,i)&&(e[i]=s[i])}return e},y.apply(null,arguments)}function v(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),s.push.apply(s,i)}return s}function E(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?v(Object(s),!0).forEach(function(t){p(e,t,s[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):v(Object(s)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))})}return e}class T{constructor(e,t){this.trace=void 0,this.debug=void 0,this.log=void 0,this.warn=void 0,this.info=void 0,this.error=void 0;const s=`[${e}]:`;this.trace=S,this.debug=t.debug.bind(null,s),this.log=t.log.bind(null,s),this.warn=t.warn.bind(null,s),this.info=t.info.bind(null,s),this.error=t.error.bind(null,s)}}const S=function(){},b={trace:S,debug:S,log:S,warn:S,info:S,error:S};function A(){return y({},b)}function L(e,t,s){return t[e]?t[e].bind(t):function(e,t){const s=self.console[e];return s?s.bind(self.console,`${t?"["+t+"] ":""}[${e}] >`):S}(e,s)}const w=A(),R=w;function I(e=!0){if("undefined"!=typeof self)return(e||!self.MediaSource)&&self.ManagedMediaSource||self.MediaSource||self.WebKitMediaSource}function x(e,t){const s=Object.keys(e),i=Object.keys(t),n=s.length,r=i.length;return!n||!r||n===r&&!s.some(e=>-1===i.indexOf(e))}function k(e,t=!1){if("undefined"!=typeof TextDecoder){const s=new TextDecoder("utf-8").decode(e);if(t){const e=s.indexOf("\0");return-1!==e?s.substring(0,e):s}return s.replace(/\0/g,"")}const s=e.length;let i,n,r,a="",o=0;for(;o<s;){if(i=e[o++],0===i&&t)return a;if(0!==i&&3!==i)switch(i>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:a+=String.fromCharCode(i);break;case 12:case 13:n=e[o++],a+=String.fromCharCode((31&i)<<6|63&n);break;case 14:n=e[o++],r=e[o++],a+=String.fromCharCode((15&i)<<12|(63&n)<<6|63&r)}}return a}const D=function(e){let t="";for(let s=0;s<e.length;s++){let i=e[s].toString(16);i.length<2&&(i="0"+i),t+=i}return t};function _(e){return Uint8Array.from(e.replace(/^0x/,"").replace(/([\da-fA-F]{2}) ?/g,"0x$1 ").replace(/ +$/,"").split(" ")).buffer}function C(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var P,M,O,F,N,B,U={exports:{}},$=(P||(P=1,M=/^(?=((?:[a-zA-Z0-9+\-.]+:)?))\1(?=((?:\/\/[^\/?#]*)?))\2(?=((?:(?:[^?#\/]*\/)*[^;?#\/]*)?))\3((?:;[^?#]*)?)(\?[^#]*)?(#[^]*)?$/,O=/^(?=([^\/?#]*))\1([^]*)$/,F=/(?:\/|^)\.(?=\/)/g,N=/(?:\/|^)\.\.\/(?!\.\.\/)[^\/]*(?=\/)/g,U.exports=B={buildAbsoluteURL:function(e,t,s){if(s=s||{},e=e.trim(),!(t=t.trim())){if(!s.alwaysNormalize)return e;var i=B.parseURL(e);if(!i)throw new Error("Error trying to parse base URL.");return i.path=B.normalizePath(i.path),B.buildURLFromParts(i)}var n=B.parseURL(t);if(!n)throw new Error("Error trying to parse relative URL.");if(n.scheme)return s.alwaysNormalize?(n.path=B.normalizePath(n.path),B.buildURLFromParts(n)):t;var r=B.parseURL(e);if(!r)throw new Error("Error trying to parse base URL.");if(!r.netLoc&&r.path&&"/"!==r.path[0]){var a=O.exec(r.path);r.netLoc=a[1],r.path=a[2]}r.netLoc&&!r.path&&(r.path="/");var o={scheme:r.scheme,netLoc:n.netLoc,path:null,params:n.params,query:n.query,fragment:n.fragment};if(!n.netLoc&&(o.netLoc=r.netLoc,"/"!==n.path[0]))if(n.path){var l=r.path,d=l.substring(0,l.lastIndexOf("/")+1)+n.path;o.path=B.normalizePath(d)}else o.path=r.path,n.params||(o.params=r.params,n.query||(o.query=r.query));return null===o.path&&(o.path=s.alwaysNormalize?B.normalizePath(n.path):n.path),B.buildURLFromParts(o)},parseURL:function(e){var t=M.exec(e);return t?{scheme:t[1]||"",netLoc:t[2]||"",path:t[3]||"",params:t[4]||"",query:t[5]||"",fragment:t[6]||""}:null},normalizePath:function(e){for(e=e.split("").reverse().join("").replace(F,"");e.length!==(e=e.replace(N,"")).length;);return e.split("").reverse().join("")},buildURLFromParts:function(e){return e.scheme+e.netLoc+e.path+e.params+e.query+e.fragment}}),U.exports);class G{constructor(){this.aborted=!1,this.loaded=0,this.retry=0,this.total=0,this.chunkCount=0,this.bwEstimate=0,this.loading={start:0,first:0,end:0},this.parsing={start:0,end:0},this.buffering={start:0,first:0,end:0}}}var j="audio",H="video",V="audiovideo";class K{constructor(e){this._byteRange=null,this._url=null,this._stats=null,this._streams=null,this.base=void 0,this.relurl=void 0,"string"==typeof e&&(e={url:e}),this.base=e,function(e,t){const s=z(e,t);s&&(s.enumerable=!0,Object.defineProperty(e,t,s))}(this,"stats")}setByteRange(e,t){const s=e.split("@",2);let i;i=1===s.length?(null==t?void 0:t.byteRangeEndOffset)||0:parseInt(s[1]),this._byteRange=[i,parseInt(s[0])+i]}get baseurl(){return this.base.url}get byteRange(){return null===this._byteRange?[]:this._byteRange}get byteRangeStartOffset(){return this.byteRange[0]}get byteRangeEndOffset(){return this.byteRange[1]}get elementaryStreams(){return null===this._streams&&(this._streams={[j]:null,[H]:null,[V]:null}),this._streams}set elementaryStreams(e){this._streams=e}get hasStats(){return null!==this._stats}get hasStreams(){return null!==this._streams}get stats(){return null===this._stats&&(this._stats=new G),this._stats}set stats(e){this._stats=e}get url(){return!this._url&&this.baseurl&&this.relurl&&(this._url=$.buildAbsoluteURL(this.baseurl,this.relurl,{alwaysNormalize:!0})),this._url||""}set url(e){this._url=e}clearElementaryStreamInfo(){const{elementaryStreams:e}=this;e[j]=null,e[H]=null,e[V]=null}}function q(e){return"initSegment"!==e.sn}class Y extends K{constructor(e,t){super(t),this._decryptdata=null,this._programDateTime=null,this._ref=null,this._bitrate=void 0,this.rawProgramDateTime=null,this.tagList=[],this.duration=0,this.sn=0,this.levelkeys=void 0,this.type=void 0,this.loader=null,this.keyLoader=null,this.level=-1,this.cc=0,this.startPTS=void 0,this.endPTS=void 0,this.startDTS=void 0,this.endDTS=void 0,this.start=0,this.playlistOffset=0,this.deltaPTS=void 0,this.maxStartPTS=void 0,this.minEndPTS=void 0,this.data=void 0,this.bitrateTest=!1,this.title=null,this.initSegment=null,this.endList=void 0,this.gap=void 0,this.urlId=0,this.type=e}get byteLength(){if(this.hasStats){const e=this.stats.total;if(e)return e}if(this.byteRange){const e=this.byteRange[0],t=this.byteRange[1];if(i(e)&&i(t))return t-e}return null}get bitrate(){return this.byteLength?8*this.byteLength/this.duration:this._bitrate?this._bitrate:null}set bitrate(e){this._bitrate=e}get decryptdata(){const{levelkeys:e}=this;if(!e&&!this._decryptdata)return null;if(!this._decryptdata&&this.levelkeys&&!this.levelkeys.NONE){const e=this.levelkeys.identity;if(e)this._decryptdata=e.getDecryptData(this.sn);else{const e=Object.keys(this.levelkeys);if(1===e.length)return this._decryptdata=this.levelkeys[e[0]].getDecryptData(this.sn)}}return this._decryptdata}get end(){return this.start+this.duration}get endProgramDateTime(){if(null===this.programDateTime)return null;const e=i(this.duration)?this.duration:0;return this.programDateTime+1e3*e}get encrypted(){var e;if(null!=(e=this._decryptdata)&&e.encrypted)return!0;if(this.levelkeys){const e=Object.keys(this.levelkeys),t=e.length;if(t>1||1===t&&this.levelkeys[e[0]].encrypted)return!0}return!1}get programDateTime(){return null===this._programDateTime&&this.rawProgramDateTime&&(this.programDateTime=Date.parse(this.rawProgramDateTime)),this._programDateTime}set programDateTime(e){i(e)?this._programDateTime=e:this._programDateTime=this.rawProgramDateTime=null}get ref(){return q(this)?(this._ref||(this._ref={base:this.base,start:this.start,duration:this.duration,sn:this.sn,programDateTime:this.programDateTime}),this._ref):null}addStart(e){this.setStart(this.start+e)}setStart(e){this.start=e,this._ref&&(this._ref.start=e)}setDuration(e){this.duration=e,this._ref&&(this._ref.duration=e)}setKeyFormat(e){if(this.levelkeys){const t=this.levelkeys[e];t&&!this._decryptdata&&(this._decryptdata=t.getDecryptData(this.sn))}}abortRequests(){var e,t;null==(e=this.loader)||e.abort(),null==(t=this.keyLoader)||t.abort()}setElementaryStreamInfo(e,t,s,i,n,r=!1){const{elementaryStreams:a}=this,o=a[e];o?(o.startPTS=Math.min(o.startPTS,t),o.endPTS=Math.max(o.endPTS,s),o.startDTS=Math.min(o.startDTS,i),o.endDTS=Math.max(o.endDTS,n)):a[e]={startPTS:t,endPTS:s,startDTS:i,endDTS:n,partial:r}}}class W extends K{constructor(e,t,s,i,n){super(s),this.fragOffset=0,this.duration=0,this.gap=!1,this.independent=!1,this.relurl=void 0,this.fragment=void 0,this.index=void 0,this.duration=e.decimalFloatingPoint("DURATION"),this.gap=e.bool("GAP"),this.independent=e.bool("INDEPENDENT"),this.relurl=e.enumeratedString("URI"),this.fragment=t,this.index=i;const r=e.enumeratedString("BYTERANGE");r&&this.setByteRange(r,n),n&&(this.fragOffset=n.fragOffset+n.duration)}get start(){return this.fragment.start+this.fragOffset}get end(){return this.start+this.duration}get loaded(){const{elementaryStreams:e}=this;return!!(e.audio||e.video||e.audiovideo)}}function z(e,t){const s=Object.getPrototypeOf(e);if(s)return Object.getOwnPropertyDescriptor(s,t)||z(s,t)}const X=Math.pow(2,32)-1,Z=[].push,Q={video:1,audio:2,id3:3,text:4};function J(e){return String.fromCharCode.apply(null,e)}function ee(e,t){const s=e[t]<<8|e[t+1];return s<0?65536+s:s}function te(e,t){const s=ie(e,t);return s<0?4294967296+s:s}function se(e,t){let s=te(e,t);return s*=Math.pow(2,32),s+=te(e,t+4),s}function ie(e,t){return e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3]}function ne(e,t){const s=[];if(!t.length)return s;const i=e.byteLength;for(let n=0;n<i;){const r=te(e,n),a=r>1?n+r:i;if(J(e.subarray(n+4,n+8))===t[0])if(1===t.length)s.push(e.subarray(n+8,a));else{const i=ne(e.subarray(n+8,a),t.slice(1));i.length&&Z.apply(s,i)}n=a}return s}function re(e){const t=[],s=e[0];let i=8;const n=te(e,i);i+=4;let r=0,a=0;0===s?(r=te(e,i),a=te(e,i+4),i+=8):(r=se(e,i),a=se(e,i+8),i+=16),i+=2;let o=e.length+a;const l=ee(e,i);i+=2;for(let s=0;s<l;s++){let s=i;const r=te(e,s);s+=4;const a=2147483647&r;if(1==(2147483648&r)>>>31)return R.warn("SIDX has hierarchical references (not supported)"),null;const l=te(e,s);s+=4,t.push({referenceSize:a,subsegmentDuration:l,info:{duration:l/n,start:o,end:o+a-1}}),o+=a,s+=4,i=s}return{earliestPresentationTime:r,timescale:n,version:s,referencesCount:l,references:t}}function ae(e){const t=[],s=ne(e,["moov","trak"]);for(let e=0;e<s.length;e++){const i=s[e],n=ne(i,["tkhd"])[0];if(n){let e=n[0];const s=te(n,0===e?12:20),r=ne(i,["mdia","mdhd"])[0];if(r){e=r[0];const n=te(r,0===e?12:20),a=ne(i,["mdia","hdlr"])[0];if(a){const e=J(a.subarray(8,12)),r={soun:j,vide:H}[e],o=oe(ne(i,["mdia","minf","stbl","stsd"])[0]);r?(t[s]={timescale:n,type:r,stsd:o},t[r]=E({timescale:n,id:s},o)):t[s]={timescale:n,type:e,stsd:o}}}}}return ne(e,["moov","mvex","trex"]).forEach(e=>{const s=te(e,4),i=t[s];i&&(i.default={duration:te(e,12),flags:te(e,20)})}),t}function oe(e){const t=e.subarray(8),s=t.subarray(86),i=J(t.subarray(4,8));let n,r=i;const a="enca"===i||"encv"===i;if(a){const e=ne(t,[i])[0];ne(e.subarray("enca"===i?28:78),["sinf"]).forEach(e=>{const t=ne(e,["schm"])[0];if(t){const s=J(t.subarray(4,8));if("cbcs"===s||"cenc"===s){const t=ne(e,["frma"])[0];t&&(r=J(t))}}})}const o=r;switch(r){case"avc1":case"avc2":case"avc3":case"avc4":{const e=ne(s,["avcC"])[0];e&&e.length>3&&(r+="."+ce(e[1])+ce(e[2])+ce(e[3]),n=le("avc1"===o?"dva1":"dvav",s));break}case"mp4a":{const e=ne(t,[i])[0],s=ne(e.subarray(28),["esds"])[0];if(s&&s.length>7){let e=4;if(3!==s[e++])break;e=de(s,e),e+=2;const t=s[e++];if(128&t&&(e+=2),64&t&&(e+=s[e++]),4!==s[e++])break;e=de(s,e);const i=s[e++];if(64!==i)break;if(r+="."+ce(i),e+=12,5!==s[e++])break;e=de(s,e);const n=s[e++];let a=(248&n)>>3;31===a&&(a+=1+((7&n)<<3)+((224&s[e])>>5)),r+="."+a}break}case"hvc1":case"hev1":{const e=ne(s,["hvcC"])[0];if(e&&e.length>12){const t=e[1],s=["","A","B","C"][t>>6],i=31&t,n=te(e,2),a=(32&t)>>5?"H":"L",o=e[12],l=e.subarray(6,12);r+="."+s+i,r+="."+function(e){let t=0;for(let s=0;s<32;s++)t|=(e>>s&1)<<31-s;return t>>>0}(n).toString(16).toUpperCase(),r+="."+a+o;let d="";for(let e=l.length;e--;){const t=l[e];(t||d)&&(d="."+t.toString(16).toUpperCase()+d)}r+=d}n=le("hev1"==o?"dvhe":"dvh1",s);break}case"dvh1":case"dvhe":case"dvav":case"dva1":case"dav1":r=le(r,s)||r;break;case"vp09":{const e=ne(s,["vpcC"])[0];if(e&&e.length>6){const t=e[4],s=e[5],i=e[6]>>4&15;r+="."+he(t)+"."+he(s)+"."+he(i)}break}case"av01":{const e=ne(s,["av1C"])[0];if(e&&e.length>2){const t=e[1]>>>5,i=31&e[1],a=e[2]>>>7?"H":"M",o=(64&e[2])>>6,l=(32&e[2])>>5,d=2===t&&o?l?12:10:o?10:8,c=(16&e[2])>>4,h=(8&e[2])>>3,u=(4&e[2])>>2,f=3&e[2],g=1,m=1,p=1,y=0;r+="."+t+"."+he(i)+a+"."+he(d)+"."+c+"."+h+u+f+"."+he(g)+"."+he(m)+"."+he(p)+"."+y,n=le("dav1",s)}break}}return{codec:r,encrypted:a,supplemental:n}}function le(e,t){const s=ne(t,["dvvC"]),i=s.length?s[0]:ne(t,["dvcC"])[0];if(i){const t=i[2]>>1&127,s=i[2]<<5&32|i[3]>>3&31;return e+"."+he(t)+"."+he(s)}}function de(e,t){const s=t+5;for(;128&e[t++]&&t<s;);return t}function ce(e){return("0"+e.toString(16).toUpperCase()).slice(-2)}function he(e){return(e<10?"0":"")+e}function ue(e,t){const s=new Uint8Array(e.length+t.length);return s.set(e),s.set(t,e.length),s}function fe(e,t){const s=[],i=t.samples,n=t.timescale,r=t.id;let a=!1;return ne(i,["moof"]).map(o=>{const l=o.byteOffset-8;ne(o,["traf"]).map(o=>{const d=ne(o,["tfdt"]).map(e=>{const t=e[0];let s=te(e,4);return 1===t&&(s*=Math.pow(2,32),s+=te(e,8)),s/n})[0];return void 0!==d&&(e=d),ne(o,["tfhd"]).map(d=>{const c=te(d,4),h=16777215&te(d,0);let u=0;const f=!!(16&h);let g=0;const m=!!(32&h);let p=8;c===r&&(!!(1&h)&&(p+=8),!!(2&h)&&(p+=4),!!(8&h)&&(u=te(d,p),p+=4),f&&(g=te(d,p),p+=4),m&&(p+=4),"video"===t.type&&(a=ge(t.codec)),ne(o,["trun"]).map(r=>{const o=r[0],d=16777215&te(r,0),c=!!(1&d);let h=0;const f=!!(4&d),m=!!(256&d);let p=0;const y=!!(512&d);let v=0;const E=!!(1024&d),T=!!(2048&d);let S=0;const b=te(r,4);let A=8;c&&(h=te(r,A),A+=4),f&&(A+=4);let L=h+l;for(let l=0;l<b;l++){if(m?(p=te(r,A),A+=4):p=u,y?(v=te(r,A),A+=4):v=g,E&&(A+=4),T&&(S=0===o?te(r,A):ie(r,A),A+=4),t.type===H){let t=0;for(;t<v;){const r=te(i,L);L+=4,me(a,i[L])&&pe(i.subarray(L,L+r),a?2:1,e+S/n,s),L+=r,t+=r+4}}e+=p/n}}))})})}),s}function ge(e){if(!e)return!1;const t=e.substring(0,4);return"hvc1"===t||"hev1"===t||"dvh1"===t||"dvhe"===t}function me(e,t){if(e){const e=t>>1&63;return 39===e||40===e}return 6==(31&t)}function pe(e,t,s,i){const n=ye(e);let r=0;r+=t;let a=0,o=0,l=0;for(;r<n.length;){a=0;do{if(r>=n.length)break;l=n[r++],a+=l}while(255===l);o=0;do{if(r>=n.length)break;l=n[r++],o+=l}while(255===l);const e=n.length-r;let t=r;if(o<e)r+=o;else if(o>e){R.error(`Malformed SEI payload. ${o} is too small, only ${e} bytes left to parse.`);break}if(4===a){if(181===n[t++]){const e=ee(n,t);if(t+=2,49===e){const e=te(n,t);if(t+=4,1195456820===e){const e=n[t++];if(3===e){const r=n[t++],o=64&r,l=o?2+3*(31&r):0,d=new Uint8Array(l);if(o){d[0]=r;for(let e=1;e<l;e++)d[e]=n[t++]}i.push({type:e,payloadType:a,pts:s,bytes:d})}}}}}else if(5===a&&o>16){const e=[];for(let s=0;s<16;s++){const i=n[t++].toString(16);e.push(1==i.length?"0"+i:i),3!==s&&5!==s&&7!==s&&9!==s||e.push("-")}const r=o-16,l=new Uint8Array(r);for(let e=0;e<r;e++)l[e]=n[t++];i.push({payloadType:a,pts:s,uuid:e.join(""),userData:k(l),userDataBytes:l})}}}function ye(e){const t=e.byteLength,s=[];let i=1;for(;i<t-2;)0===e[i]&&0===e[i+1]&&3===e[i+2]?(s.push(i+2),i+=2):i++;if(0===s.length)return e;const n=t-s.length,r=new Uint8Array(n);let a=0;for(i=0;i<n;a++,i++)a===s[0]&&(a++,s.shift()),r[i]=e[a];return r}const ve=()=>/\(Windows.+Firefox\//i.test(navigator.userAgent),Ee={audio:{a3ds:1,"ac-3":.95,"ac-4":1,alac:.9,alaw:1,dra1:1,"dts+":1,"dts-":1,dtsc:1,dtse:1,dtsh:1,"ec-3":.9,enca:1,fLaC:.9,flac:.9,FLAC:.9,g719:1,g726:1,m4ae:1,mha1:1,mha2:1,mhm1:1,mhm2:1,mlpa:1,mp4a:1,"raw ":1,Opus:1,opus:1,samr:1,sawb:1,sawp:1,sevc:1,sqcp:1,ssmv:1,twos:1,ulaw:1},video:{avc1:1,avc2:1,avc3:1,avc4:1,avcp:1,av01:.8,dav1:.8,drac:1,dva1:1,dvav:1,dvh1:.7,dvhe:.7,encv:1,hev1:.75,hvc1:.75,mjp2:1,mp4v:1,mvc1:1,mvc2:1,mvc3:1,mvc4:1,resv:1,rv60:1,s263:1,svc1:1,svc2:1,"vc-1":1,vp08:1,vp09:.9},text:{stpp:1,wvtt:1}};function Te(e,t){const s=Ee[t];return!!s&&!!s[e.slice(0,4)]}function Se(e,t,s=!0){return!e.split(",").some(e=>!be(e,t,s))}function be(e,t,s=!0){var i;const n=I(s);return null!=(i=null==n?void 0:n.isTypeSupported(Ae(e,t)))&&i}function Ae(e,t){return`${t}/mp4;codecs=${e}`}function Le(e){if(e){const t=e.substring(0,4);return Ee.video[t]}return 2}function we(e){const t=ve();return e.split(",").reduce((e,s)=>{const i=t&&ge(s)?9:Ee.video[s];return i?(2*i+e)/(e?3:2):(Ee.audio[s]+e)/(e?2:1)},0)}const Re={},Ie=/flac|opus|mp4a\.40\.34/i;function xe(e,t=!0){return e.replace(Ie,e=>function(e,t=!0){if(Re[e])return Re[e];const s={flac:["flac","fLaC","FLAC"],opus:["opus","Opus"],"mp4a.40.34":["mp3"]}[e];for(let n=0;n<s.length;n++){var i;if(be(s[n],"audio",t))return Re[e]=s[n],s[n];if("mp3"===s[n]&&null!=(i=I(t))&&i.isTypeSupported("audio/mpeg"))return""}return e}(e.toLowerCase(),t))}function ke(e,t){if(e&&(e.length>4||-1!==["ac-3","ec-3","alac","fLaC","Opus"].indexOf(e))&&(De(e,"audio")||De(e,"video")))return e;if(t){const s=t.split(",");if(s.length>1){if(e)for(let t=s.length;t--;)if(s[t].substring(0,4)===e.substring(0,4))return s[t];return s[0]}}return t||e}function De(e,t){return Te(e,t)&&be(e,t)}function _e(e){if(e.startsWith("av01.")){const t=e.split("."),s=["0","111","01","01","01","0"];for(let e=t.length;e>4&&e<10;e++)t[e]=s[e-4];return t.join(".")}return e}function Ce(e){const t=I(e)||{isTypeSupported:()=>!1};return{mpeg:t.isTypeSupported("audio/mpeg"),mp3:t.isTypeSupported('audio/mp4; codecs="mp3"'),ac3:t.isTypeSupported('audio/mp4; codecs="ac-3"')}}function Pe(e){return e.replace(/^.+codecs=["']?([^"']+).*$/,"$1")}const Me={supported:!0,configurations:[],decodingInfoResults:[{supported:!0,powerEfficient:!0,smooth:!0}]};function Oe(e,t){return{supported:!1,configurations:t,decodingInfoResults:[{supported:!1,smooth:!1,powerEfficient:!1}],error:e}}function Fe(e,t,s,n,r,a){const o=e.videoCodec,l=e.audioCodec?e.audioGroups:null,d=null==a?void 0:a.audioCodec,c=null==a?void 0:a.channels,h=c?parseInt(c):d?1/0:2;let u=null;if(null!=l&&l.length)try{u=1===l.length&&l[0]?t.groups[l[0]].channels:l.reduce((e,s)=>{if(s){const i=t.groups[s];if(!i)throw new Error(`Audio track group ${s} not found`);Object.keys(i.channels).forEach(t=>{e[t]=(e[t]||0)+i.channels[t]})}return e},{2:0})}catch(e){return!0}return void 0!==o&&(o.split(",").some(e=>ge(e))||e.width>1920&&e.height>1088||e.height>1920&&e.width>1088||e.frameRate>Math.max(n,30)||"SDR"!==e.videoRange&&e.videoRange!==s||e.bitrate>Math.max(r,8e6))||!!u&&i(h)&&Object.keys(u).some(e=>parseInt(e)>h)}function Ne(e,t,s,i={}){const n=e.videoCodec;if(!n&&!e.audioCodec||!s)return Promise.resolve(Me);const r=[],a=function(e){var t;const s=null==(t=e.videoCodec)?void 0:t.split(","),i=Ue(e),n=e.width||640,r=e.height||480,a=e.frameRate||30,o=e.videoRange.toLowerCase();return s?s.map(e=>{const t={contentType:Ae(_e(e),"video"),width:n,height:r,bitrate:i,framerate:a};return"sdr"!==o&&(t.transferFunction=o),t}):[]}(e),o=a.length,l=function(e,t,s){var i;const n=null==(i=e.audioCodec)?void 0:i.split(","),r=Ue(e);return n&&e.audioGroups?e.audioGroups.reduce((e,i)=>{var a;const o=i?null==(a=t.groups[i])?void 0:a.tracks:null;return o?o.reduce((e,t)=>{if(t.groupId===i){const i=parseFloat(t.channels||"");n.forEach(t=>{const n={contentType:Ae(t,"audio"),bitrate:s?Be(t,r):r};i&&(n.channels=""+i),e.push(n)})}return e},e):e},[]):[]}(e,t,o>0),d=l.length;for(let e=o||1*d||1;e--;){const t={type:"media-source"};if(o&&(t.video=a[e%o]),d){t.audio=l[e%d];const s=t.audio.bitrate;t.video&&s&&(t.video.bitrate-=s)}r.push(t)}if(n){const e=navigator.userAgent;if(n.split(",").some(e=>ge(e))&&ve())return Promise.resolve(Oe(new Error(`Overriding Windows Firefox HEVC MediaCapabilities result based on user-agent string: (${e})`),r))}return Promise.all(r.map(e=>{const t=function(e){let t="";const{audio:s,video:i}=e;return i&&(t+=`${Pe(i.contentType)}_r${i.height}x${i.width}f${Math.ceil(i.framerate)}${i.transferFunction||"sd"}_${Math.ceil(i.bitrate/1e5)}`),s&&(t+=`${i?"_":""}${Pe(s.contentType)}_c${s.channels}`),t}(e);return i[t]||(i[t]=s.decodingInfo(e))})).then(e=>({supported:!e.some(e=>!e.supported),configurations:r,decodingInfoResults:e})).catch(e=>({supported:!1,configurations:r,decodingInfoResults:[],error:e}))}function Be(e,t){if(t<=1)return 1;let s=128e3;return"ec-3"===e?s=768e3:"ac-3"===e&&(s=64e4),Math.min(t/2,s)}function Ue(e){return 1e3*Math.ceil(Math.max(.9*e.bitrate,e.averageBitrate)/1e3)||1}const $e=["NONE","TYPE-0","TYPE-1",null],Ge=["SDR","PQ","HLG"];var je={No:"",Yes:"YES",v2:"v2"};function He(e){const{canSkipUntil:t,canSkipDateRanges:s,age:i}=e;return t&&i<t/2?s?je.v2:je.Yes:je.No}class Ve{constructor(e,t,s){this.msn=void 0,this.part=void 0,this.skip=void 0,this.msn=e,this.part=t,this.skip=s}addDirectives(e){const t=new self.URL(e);return void 0!==this.msn&&t.searchParams.set("_HLS_msn",this.msn.toString()),void 0!==this.part&&t.searchParams.set("_HLS_part",this.part.toString()),this.skip&&t.searchParams.set("_HLS_skip",this.skip),t.href}}class Ke{constructor(e){if(this._attrs=void 0,this.audioCodec=void 0,this.bitrate=void 0,this.codecSet=void 0,this.url=void 0,this.frameRate=void 0,this.height=void 0,this.id=void 0,this.name=void 0,this.supplemental=void 0,this.videoCodec=void 0,this.width=void 0,this.details=void 0,this.fragmentError=0,this.loadError=0,this.loaded=void 0,this.realBitrate=0,this.supportedPromise=void 0,this.supportedResult=void 0,this._avgBitrate=0,this._audioGroups=void 0,this._subtitleGroups=void 0,this._urlId=0,this.url=[e.url],this._attrs=[e.attrs],this.bitrate=e.bitrate,e.details&&(this.details=e.details),this.id=e.id||0,this.name=e.name,this.width=e.width||0,this.height=e.height||0,this.frameRate=e.attrs.optionalFloat("FRAME-RATE",0),this._avgBitrate=e.attrs.decimalInteger("AVERAGE-BANDWIDTH"),this.audioCodec=e.audioCodec,this.videoCodec=e.videoCodec,this.codecSet=[e.videoCodec,e.audioCodec].filter(e=>!!e).map(e=>e.substring(0,4)).join(","),"supplemental"in e){var t;this.supplemental=e.supplemental;const s=null==(t=e.supplemental)?void 0:t.videoCodec;s&&s!==e.videoCodec&&(this.codecSet+=`,${s.substring(0,4)}`)}this.addGroupId("audio",e.attrs.AUDIO),this.addGroupId("text",e.attrs.SUBTITLES)}get maxBitrate(){return Math.max(this.realBitrate,this.bitrate)}get averageBitrate(){return this._avgBitrate||this.realBitrate||this.bitrate}get attrs(){return this._attrs[0]}get codecs(){return this.attrs.CODECS||""}get pathwayId(){return this.attrs["PATHWAY-ID"]||"."}get videoRange(){return this.attrs["VIDEO-RANGE"]||"SDR"}get score(){return this.attrs.optionalFloat("SCORE",0)}get uri(){return this.url[0]||""}hasAudioGroup(e){return qe(this._audioGroups,e)}hasSubtitleGroup(e){return qe(this._subtitleGroups,e)}get audioGroups(){return this._audioGroups}get subtitleGroups(){return this._subtitleGroups}addGroupId(e,t){if(t)if("audio"===e){let e=this._audioGroups;e||(e=this._audioGroups=[]),-1===e.indexOf(t)&&e.push(t)}else if("text"===e){let e=this._subtitleGroups;e||(e=this._subtitleGroups=[]),-1===e.indexOf(t)&&e.push(t)}}get urlId(){return 0}set urlId(e){}get audioGroupIds(){return this.audioGroups?[this.audioGroupId]:void 0}get textGroupIds(){return this.subtitleGroups?[this.textGroupId]:void 0}get audioGroupId(){var e;return null==(e=this.audioGroups)?void 0:e[0]}get textGroupId(){var e;return null==(e=this.subtitleGroups)?void 0:e[0]}addFallback(){}}function qe(e,t){return!(!t||!e)&&-1!==e.indexOf(t)}const Ye=(e,t)=>JSON.stringify(e,(e=>{const t=new WeakSet;return(s,i)=>{if(e&&(i=e(s,i)),"object"==typeof i&&null!==i){if(t.has(i))return;t.add(i)}return i}})(t));function We(e,t){R.log(`[abr] start candidates with "${e}" ignored because ${t}`)}function ze(e){return e.reduce((e,t)=>{let s=e.groups[t.groupId];s||(s=e.groups[t.groupId]={tracks:[],channels:{2:0},hasDefault:!1,hasAutoSelect:!1}),s.tracks.push(t);const i=t.channels||"2";return s.channels[i]=(s.channels[i]||0)+1,s.hasDefault=s.hasDefault||t.default,s.hasAutoSelect=s.hasAutoSelect||t.autoselect,s.hasDefault&&(e.hasDefaultAudio=!0),s.hasAutoSelect&&(e.hasAutoSelectAudio=!0),e},{hasDefaultAudio:!1,hasAutoSelectAudio:!1,groups:{}})}function Xe(e){if(!e)return e;const{lang:t,assocLang:s,characteristics:i,channels:n,audioCodec:r}=e;return{lang:t,assocLang:s,characteristics:i,channels:n,audioCodec:r}}function Ze(e,t,s){if("attrs"in e){const s=t.indexOf(e);if(-1!==s)return s}for(let i=0;i<t.length;i++)if(Qe(e,t[i],s))return i;return-1}function Qe(e,t,s){const{groupId:i,name:n,lang:r,assocLang:a,default:o}=e,l=e.forced;return(void 0===i||t.groupId===i)&&(void 0===n||t.name===n)&&(void 0===r||function(e,t="--"){return e.length===t.length?e===t:e.startsWith(t)||t.startsWith(e)}(r,t.lang))&&(void 0===r||t.assocLang===a)&&(void 0===o||t.default===o)&&(void 0===l||t.forced===l)&&(!("characteristics"in e)||function(e,t=""){const s=e.split(","),i=t.split(",");return s.length===i.length&&!s.some(e=>-1===i.indexOf(e))}(e.characteristics||"",t.characteristics))&&(void 0===s||s(e,t))}function Je(e,t){const{audioCodec:s,channels:i}=e;return!(void 0!==s&&(t.audioCodec||"").substring(0,4)!==s.substring(0,4)||void 0!==i&&i!==(t.channels||"2"))}function et(e,t,s){for(let i=t;i>-1;i--)if(s(e[i]))return i;for(let i=t+1;i<e.length;i++)if(s(e[i]))return i;return-1}function tt(e,t){var s;return!!e&&e!==(null==(s=t.loadLevelObj)?void 0:s.uri)}class st extends T{constructor(e){super("abr",e.logger),this.hls=void 0,this.lastLevelLoadSec=0,this.lastLoadedFragLevel=-1,this.firstSelection=-1,this._nextAutoLevel=-1,this.nextAutoLevelKey="",this.audioTracksByGroup=null,this.codecTiers=null,this.timer=-1,this.fragCurrent=null,this.partCurrent=null,this.bitrateTestDelay=0,this.rebufferNotice=-1,this.supportedCache={},this.bwEstimator=void 0,this._abandonRulesCheck=e=>{var t;const{fragCurrent:s,partCurrent:n,hls:r}=this,{autoLevelEnabled:a,media:o}=r;if(!s||!o)return;const d=performance.now(),c=n?n.stats:s.stats,h=n?n.duration:s.duration,u=d-c.loading.start,f=r.minAutoLevel,g=s.level,m=this._nextAutoLevel;if(c.aborted||c.loaded&&c.loaded===c.total||g<=f)return this.clearTimer(),void(this._nextAutoLevel=-1);if(!a)return;const p=m>-1&&m!==g,y=!!e||p;if(!y&&(o.paused||!o.playbackRate||!o.readyState))return;const v=r.mainForwardBufferInfo;if(!y&&null===v)return;const E=this.bwEstimator.getEstimateTTFB(),T=Math.abs(o.playbackRate);if(u<=Math.max(E,h/(2*T)*1e3))return;const S=v?v.len/T:0,b=c.loading.first?c.loading.first-c.loading.start:-1,A=c.loaded&&b>-1,L=this.getBwEstimate(),w=r.levels,R=w[g],I=Math.max(c.loaded,Math.round(h*(s.bitrate||R.averageBitrate)/8));let x=A?u-b:u;x<1&&A&&(x=Math.min(u,8*c.loaded/L));const k=A?1e3*c.loaded/x:0,D=E/1e3,_=k?(I-c.loaded)/k:8*I/L+D;if(_<=S)return;const C=k?8*k:L,P=!0===(null==(t=(null==e?void 0:e.details)||this.hls.latestLevelDetails)?void 0:t.live),M=this.hls.config.abrBandWidthUpFactor;let O,F=Number.POSITIVE_INFINITY;for(O=g-1;O>f;O--){const e=w[O].maxBitrate,t=!w[O].details||P;if(F=this.getTimeToLoadFrag(D,C,h*e,t),F<Math.min(S,h+D))break}if(F>=_)return;if(F>10*h)return;A?this.bwEstimator.sample(u-Math.min(E,b),c.loaded):this.bwEstimator.sampleTTFB(u);const N=w[O].maxBitrate;this.getBwEstimate()*M>N&&this.resetEstimator(N);const B=this.findBestLevel(N,f,O,0,S,1,1);B>-1&&(O=B),this.warn(`Fragment ${s.sn}${n?" part "+n.index:""} of level ${g} is loading too slowly;\n      Fragment duration: ${s.duration.toFixed(3)}\n      Time to underbuffer: ${S.toFixed(3)} s\n      Estimated load time for current fragment: ${_.toFixed(3)} s\n      Estimated load time for down switch fragment: ${F.toFixed(3)} s\n      TTFB estimate: ${0|b} ms\n      Current BW estimate: ${i(L)?0|L:"Unknown"} bps\n      New BW estimate: ${0|this.getBwEstimate()} bps\n      Switching to level ${O} @ ${0|N} bps`),r.nextLoadLevel=r.nextAutoLevel=O,this.clearTimer();const U=()=>{if(this.clearTimer(),this.fragCurrent===s&&this.hls.loadLevel===O&&O>0){const e=this.getStarvationDelay();if(this.warn(`Aborting inflight request ${O>0?"and switching down":""}\n      Fragment duration: ${s.duration.toFixed(3)} s\n      Time to underbuffer: ${e.toFixed(3)} s`),s.abortRequests(),this.fragCurrent=this.partCurrent=null,O>f){let t=this.findBestLevel(this.hls.levels[f].bitrate,f,O,0,e,1,1);-1===t&&(t=f),this.hls.nextLoadLevel=this.hls.nextAutoLevel=t,this.resetEstimator(this.hls.levels[t].bitrate)}}};p||_>2*F?U():this.timer=self.setInterval(U,1e3*F),r.trigger(l.FRAG_LOAD_EMERGENCY_ABORTED,{frag:s,part:n,stats:c})},this.hls=e,this.bwEstimator=this.initEstimator(),this.registerListeners()}resetEstimator(e){e&&(this.log(`setting initial bwe to ${e}`),this.hls.config.abrEwmaDefaultEstimate=e),this.firstSelection=-1,this.bwEstimator=this.initEstimator()}initEstimator(){const e=this.hls.config;return new m(e.abrEwmaSlowVoD,e.abrEwmaFastVoD,e.abrEwmaDefaultEstimate)}registerListeners(){const{hls:e}=this;e.on(l.MANIFEST_LOADING,this.onManifestLoading,this),e.on(l.FRAG_LOADING,this.onFragLoading,this),e.on(l.FRAG_LOADED,this.onFragLoaded,this),e.on(l.FRAG_BUFFERED,this.onFragBuffered,this),e.on(l.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(l.LEVEL_LOADED,this.onLevelLoaded,this),e.on(l.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(l.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),e.on(l.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e&&(e.off(l.MANIFEST_LOADING,this.onManifestLoading,this),e.off(l.FRAG_LOADING,this.onFragLoading,this),e.off(l.FRAG_LOADED,this.onFragLoaded,this),e.off(l.FRAG_BUFFERED,this.onFragBuffered,this),e.off(l.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(l.LEVEL_LOADED,this.onLevelLoaded,this),e.off(l.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(l.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),e.off(l.ERROR,this.onError,this))}destroy(){this.unregisterListeners(),this.clearTimer(),this.hls=this._abandonRulesCheck=this.supportedCache=null,this.fragCurrent=this.partCurrent=null}onManifestLoading(e,t){this.lastLoadedFragLevel=-1,this.firstSelection=-1,this.lastLevelLoadSec=0,this.supportedCache={},this.fragCurrent=this.partCurrent=null,this.onLevelsUpdated(),this.clearTimer()}onLevelsUpdated(){this.lastLoadedFragLevel>-1&&this.fragCurrent&&(this.lastLoadedFragLevel=this.fragCurrent.level),this._nextAutoLevel=-1,this.onMaxAutoLevelUpdated(),this.codecTiers=null,this.audioTracksByGroup=null}onMaxAutoLevelUpdated(){this.firstSelection=-1,this.nextAutoLevelKey=""}onFragLoading(e,t){const s=t.frag;var i;this.ignoreFragment(s)||(s.bitrateTest||(this.fragCurrent=s,this.partCurrent=null!=(i=t.part)?i:null),this.clearTimer(),this.timer=self.setInterval(this._abandonRulesCheck,100))}onLevelSwitching(e,t){this.clearTimer()}onError(e,t){if(!t.fatal)switch(t.details){case o.BUFFER_ADD_CODEC_ERROR:case o.BUFFER_APPEND_ERROR:this.lastLoadedFragLevel=-1,this.firstSelection=-1;break;case o.FRAG_LOAD_TIMEOUT:{const e=t.frag,{fragCurrent:s,partCurrent:i}=this;if(e&&s&&e.sn===s.sn&&e.level===s.level){const t=performance.now(),s=i?i.stats:e.stats,n=t-s.loading.start,r=s.loading.first?s.loading.first-s.loading.start:-1;if(s.loaded&&r>-1){const e=this.bwEstimator.getEstimateTTFB();this.bwEstimator.sample(n-Math.min(e,r),s.loaded)}else this.bwEstimator.sampleTTFB(n)}break}}}getTimeToLoadFrag(e,t,s,i){return e+s/t+(i?e+this.lastLevelLoadSec:0)}onLevelLoaded(e,t){const s=this.hls.config,{loading:n}=t.stats,r=n.end-n.first;i(r)&&(this.lastLevelLoadSec=r/1e3),t.details.live?this.bwEstimator.update(s.abrEwmaSlowLive,s.abrEwmaFastLive):this.bwEstimator.update(s.abrEwmaSlowVoD,s.abrEwmaFastVoD),this.timer>-1&&this._abandonRulesCheck(t.levelInfo)}onFragLoaded(e,{frag:t,part:s}){const i=s?s.stats:t.stats;if(t.type===f.MAIN&&this.bwEstimator.sampleTTFB(i.loading.first-i.loading.start),!this.ignoreFragment(t)){if(this.clearTimer(),t.level===this._nextAutoLevel&&(this._nextAutoLevel=-1),this.firstSelection=-1,this.hls.config.abrMaxWithRealBitrate){const e=s?s.duration:t.duration,n=this.hls.levels[t.level],r=(n.loaded?n.loaded.bytes:0)+i.loaded,a=(n.loaded?n.loaded.duration:0)+e;n.loaded={bytes:r,duration:a},n.realBitrate=Math.round(8*r/a)}if(t.bitrateTest){const e={stats:i,frag:t,part:s,id:t.type};this.onFragBuffered(l.FRAG_BUFFERED,e),t.bitrateTest=!1}else this.lastLoadedFragLevel=t.level}}onFragBuffered(e,t){const{frag:s,part:i}=t,n=null!=i&&i.stats.loaded?i.stats:s.stats;if(n.aborted)return;if(this.ignoreFragment(s))return;const r=n.parsing.end-n.loading.start-Math.min(n.loading.first-n.loading.start,this.bwEstimator.getEstimateTTFB());this.bwEstimator.sample(r,n.loaded),n.bwEstimate=this.getBwEstimate(),s.bitrateTest?this.bitrateTestDelay=r/1e3:this.bitrateTestDelay=0}ignoreFragment(e){return e.type!==f.MAIN||"initSegment"===e.sn}clearTimer(){this.timer>-1&&(self.clearInterval(this.timer),this.timer=-1)}get firstAutoLevel(){const{maxAutoLevel:e,minAutoLevel:t}=this.hls,s=this.getBwEstimate(),i=this.hls.config.maxStarvationDelay,n=this.findBestLevel(s,t,e,0,i,1,1);if(n>-1)return n;const r=this.hls.firstLevel,a=Math.min(Math.max(r,t),e);return this.warn(`Could not find best starting auto level. Defaulting to first in playlist ${r} clamped to ${a}`),a}get forcedAutoLevel(){return this.nextAutoLevelKey?-1:this._nextAutoLevel}get nextAutoLevel(){const e=this.forcedAutoLevel,t=this.bwEstimator.canEstimate(),s=this.lastLoadedFragLevel>-1;if(!(-1===e||t&&s&&this.nextAutoLevelKey!==this.getAutoLevelKey()))return e;const i=t&&s?this.getNextABRAutoLevel():this.firstAutoLevel;if(-1!==e){const t=this.hls.levels;if(t.length>Math.max(e,i)&&t[e].loadError<=t[i].loadError)return e}return this._nextAutoLevel=i,this.nextAutoLevelKey=this.getAutoLevelKey(),i}getAutoLevelKey(){return`${this.getBwEstimate()}_${this.getStarvationDelay().toFixed(2)}`}getNextABRAutoLevel(){const{fragCurrent:e,partCurrent:t,hls:s}=this;if(s.levels.length<=1)return s.loadLevel;const{maxAutoLevel:i,config:n,minAutoLevel:r}=s,a=t?t.duration:e?e.duration:0,o=this.getBwEstimate(),l=this.getStarvationDelay();let d=n.abrBandWidthFactor,c=n.abrBandWidthUpFactor;if(l){const e=this.findBestLevel(o,r,i,l,0,d,c);if(e>=0)return this.rebufferNotice=-1,e}let h=a?Math.min(a,n.maxStarvationDelay):n.maxStarvationDelay;if(!l){const e=this.bitrateTestDelay;e&&(h=(a?Math.min(a,n.maxLoadingDelay):n.maxLoadingDelay)-e,this.info(`bitrate test took ${Math.round(1e3*e)}ms, set first fragment max fetchDuration to ${Math.round(1e3*h)} ms`),d=c=1)}const u=this.findBestLevel(o,r,i,l,h,d,c);if(this.rebufferNotice!==u&&(this.rebufferNotice=u,this.info(`${l?"rebuffering expected":"buffer is empty"}, optimal quality level ${u}`)),u>-1)return u;const f=s.levels[r],g=s.loadLevelObj;return g&&(null==f?void 0:f.bitrate)<g.bitrate?r:s.loadLevel}getStarvationDelay(){const e=this.hls,t=e.media;if(!t)return 1/0;const s=t&&0!==t.playbackRate?Math.abs(t.playbackRate):1,i=e.mainForwardBufferInfo;return(i?i.len:0)/s}getBwEstimate(){return this.bwEstimator.canEstimate()?this.bwEstimator.getEstimate():this.hls.config.abrEwmaDefaultEstimate}findBestLevel(e,t,s,n,r,a,o){var l;const d=n+r,c=this.lastLoadedFragLevel,h=-1===c?this.hls.firstLevel:c,{fragCurrent:u,partCurrent:f}=this,{levels:g,allAudioTracks:m,loadLevel:p,config:y}=this.hls;if(1===g.length)return 0;const v=g[h],E=!(null==(l=this.hls.latestLevelDetails)||!l.live),T=-1===p||-1===c;let S,b="SDR",A=(null==v?void 0:v.frameRate)||0;const{audioPreference:L,videoPreference:w}=y,R=this.audioTracksByGroup||(this.audioTracksByGroup=ze(m));let I=-1;if(T){if(-1!==this.firstSelection)return this.firstSelection;const n=this.codecTiers||(this.codecTiers=function(e,t,s,i){return e.slice(s,i+1).reduce((e,s,i)=>{if(!s.codecSet)return e;const n=s.audioGroups;let r=e[s.codecSet];r||(e[s.codecSet]=r={minBitrate:1/0,minHeight:1/0,minFramerate:1/0,minIndex:i,maxScore:0,videoRanges:{SDR:0},channels:{2:0},hasDefaultAudio:!n,fragmentError:0}),r.minBitrate=Math.min(r.minBitrate,s.bitrate);const a=Math.min(s.height,s.width);return r.minHeight=Math.min(r.minHeight,a),r.minFramerate=Math.min(r.minFramerate,s.frameRate),r.minIndex=Math.min(r.minIndex,i),r.maxScore=Math.max(r.maxScore,s.score),r.fragmentError+=s.fragmentError,r.videoRanges[s.videoRange]=(r.videoRanges[s.videoRange]||0)+1,n&&n.forEach(e=>{if(!e)return;const s=t.groups[e];s&&(r.hasDefaultAudio=r.hasDefaultAudio||t.hasDefaultAudio?s.hasDefault:s.hasAutoSelect||!t.hasDefaultAudio&&!t.hasAutoSelectAudio,Object.keys(s.channels).forEach(e=>{r.channels[e]=(r.channels[e]||0)+s.channels[e]}))}),e},{})}(g,R,t,s)),r=function(e,t,s,n,r){const a=Object.keys(e),o=null==n?void 0:n.channels,l=null==n?void 0:n.audioCodec,d=null==r?void 0:r.videoCodec,c=o&&2===parseInt(o);let h=!1,u=!1,f=1/0,g=1/0,m=1/0,p=1/0,y=0,v=[];const{preferHDR:E,allowedVideoRanges:T}=function(e,t){let s=!1,i=[];if(e&&(s="SDR"!==e,i=[e]),t){i=t.allowedVideoRanges||Ge.slice(0);const e="SDR"!==i.join("")&&!t.videoCodec;s=void 0!==t.preferHDR?t.preferHDR:e&&function(){if("function"==typeof matchMedia){const e=matchMedia("(dynamic-range: high)"),t=matchMedia("bad query");if(e.media!==t.media)return!0===e.matches}return!1}(),s||(i=["SDR"])}return{preferHDR:s,allowedVideoRanges:i}}(t,r);for(let t=a.length;t--;){const s=e[a[t]];h||(h=s.channels[2]>0),f=Math.min(f,s.minHeight),g=Math.min(g,s.minFramerate),m=Math.min(m,s.minBitrate),T.filter(e=>s.videoRanges[e]>0).length>0&&(u=!0)}f=i(f)?f:0,g=i(g)?g:0;const S=Math.max(1080,f),b=Math.max(30,g);m=i(m)?m:s,s=Math.max(m,s),u||(t=void 0);const A=a.length>1;return{codecSet:a.reduce((t,i)=>{const n=e[i];if(i===t)return t;if(v=u?T.filter(e=>n.videoRanges[e]>0):[],A){if(n.minBitrate>s)return We(i,`min bitrate of ${n.minBitrate} > current estimate of ${s}`),t;if(!n.hasDefaultAudio)return We(i,"no renditions with default or auto-select sound found"),t;if(l&&i.indexOf(l.substring(0,4))%5!=0)return We(i,`audio codec preference "${l}" not found`),t;if(o&&!c){if(!n.channels[o])return We(i,`no renditions with ${o} channel sound found (channels options: ${Object.keys(n.channels)})`),t}else if((!l||c)&&h&&0===n.channels[2])return We(i,"no renditions with stereo sound found"),t;if(n.minHeight>S)return We(i,`min resolution of ${n.minHeight} > maximum of ${S}`),t;if(n.minFramerate>b)return We(i,`min framerate of ${n.minFramerate} > maximum of ${b}`),t;if(!v.some(e=>n.videoRanges[e]>0))return We(i,`no variants with VIDEO-RANGE of ${Ye(v)} found`),t;if(d&&i.indexOf(d.substring(0,4))%5!=0)return We(i,`video codec preference "${d}" not found`),t;if(n.maxScore<y)return We(i,`max score of ${n.maxScore} < selected max of ${y}`),t}return t&&(we(i)>=we(t)||n.fragmentError>e[t].fragmentError)?t:(p=n.minIndex,y=n.maxScore,i)},void 0),videoRanges:v,preferHDR:E,minFramerate:g,minBitrate:m,minIndex:p}}(n,b,e,L,w),{codecSet:a,videoRanges:o,minFramerate:l,minBitrate:d,minIndex:c,preferHDR:h}=r;I=c,S=a,b=h?o[o.length-1]:o[0],A=l,e=Math.max(e,d),this.log(`picked start tier ${Ye(r)}`)}else S=null==v?void 0:v.codecSet,b=null==v?void 0:v.videoRange;const x=f?f.duration:u?u.duration:0,k=this.bwEstimator.getEstimateTTFB()/1e3,D=[];for(let l=s;l>=t;l--){var _,C;const t=g[l],u=l>h;if(!t)continue;if(y.useMediaCapabilities&&!t.supportedResult&&!t.supportedPromise){const s=navigator.mediaCapabilities;"function"==typeof(null==s?void 0:s.decodingInfo)&&Fe(t,R,b,A,e,L)?(t.supportedPromise=Ne(t,R,s,this.supportedCache),t.supportedPromise.then(e=>{if(!this.hls)return;t.supportedResult=e;const s=this.hls.levels,i=s.indexOf(t);e.error?this.warn(`MediaCapabilities decodingInfo error: "${e.error}" for level ${i} ${Ye(e)}`):e.supported?e.decodingInfoResults.some(e=>!1===e.smooth||!1===e.powerEfficient)&&this.log(`MediaCapabilities decodingInfo for level ${i} not smooth or powerEfficient: ${Ye(e)}`):(this.warn(`Unsupported MediaCapabilities decodingInfo result for level ${i} ${Ye(e)}`),i>-1&&s.length>1&&(this.log(`Removing unsupported level ${i}`),this.hls.removeLevel(i),-1===this.hls.loadLevel&&(this.hls.nextLoadLevel=0)))})):t.supportedResult=Me}if((S&&t.codecSet!==S||b&&t.videoRange!==b||u&&A>t.frameRate||!u&&A>0&&A<t.frameRate||null!=(_=t.supportedResult)&&null!=(C=_.decodingInfoResults)&&C.some(e=>!1===e.smooth))&&(!T||l!==I)){D.push(l);continue}const m=t.details,v=(f?null==m?void 0:m.partTarget:null==m?void 0:m.averagetargetduration)||x;let w;w=u?o*e:a*e;const P=x&&n>=2*x&&0===r?t.averageBitrate:t.maxBitrate,M=this.getTimeToLoadFrag(k,w,P*v,void 0===m);if(w>=P&&(l===c||0===t.loadError&&0===t.fragmentError)&&(M<=k||!i(M)||E&&!this.bitrateTestDelay||M<d)){const e=this.forcedAutoLevel;return l===p||-1!==e&&e===p||(D.length&&this.trace(`Skipped level(s) ${D.join(",")} of ${s} max with CODECS and VIDEO-RANGE:"${g[D[0]].codecs}" ${g[D[0]].videoRange}; not compatible with "${S}" ${b}`),this.info(`switch candidate:${h}->${l} adjustedbw(${Math.round(w)})-bitrate=${Math.round(w-P)} ttfb:${k.toFixed(1)} avgDuration:${v.toFixed(1)} maxFetchDuration:${d.toFixed(1)} fetchDuration:${M.toFixed(1)} firstSelection:${T} codecSet:${t.codecSet} videoRange:${t.videoRange} hls.loadLevel:${p}`)),T&&(this.firstSelection=l),l}}return-1}set nextAutoLevel(e){const t=this.deriveNextAutoLevel(e);this._nextAutoLevel!==t&&(this.nextAutoLevelKey="",this._nextAutoLevel=t)}deriveNextAutoLevel(e){const{maxAutoLevel:t,minAutoLevel:s}=this.hls;return Math.min(Math.max(e,s),t)}}const it=function(e,t){let s=0,i=e.length-1,n=null,r=null;for(;s<=i;){n=(s+i)/2|0,r=e[n];const a=t(r);if(a>0)s=n+1;else{if(!(a<0))return r;i=n-1}}return null};function nt(e,t,s=0,i=0,n=.005){let r=null;if(e){r=t[1+e.sn-t[0].sn]||null;const i=e.endDTS-s;i>0&&i<15e-7&&(s+=15e-7),r&&e.level!==r.level&&r.end<=e.end&&(r=t[2+e.sn-t[0].sn]||null)}else 0===s&&0===t[0].start&&(r=t[0]);if(r&&((!e||e.level===r.level)&&0===rt(s,i,r)||function(e,t,s){if(t&&0===t.start&&t.level<e.level&&(t.endPTS||0)>0){const i=t.tagList.reduce((e,t)=>("INF"===t[0]&&(e+=parseFloat(t[1])),e),s);return e.start<=i}return!1}(r,e,Math.min(n,i))))return r;const a=it(t,rt.bind(null,s,i));return!a||a===e&&r?r:a}function rt(e=0,t=0,s){if(s.start<=e&&s.start+s.duration>e)return 0;const i=Math.min(t,s.duration+(s.deltaPTS?s.deltaPTS:0));return s.start+s.duration-i<=e?1:s.start-i>e&&s.start?-1:0}function at(e,t,s){const i=1e3*Math.min(t,s.duration+(s.deltaPTS?s.deltaPTS:0));return(s.endProgramDateTime||0)-i>e}function ot(e,t,s){if(e&&e.startCC<=t&&e.endCC>=t){let i=e.fragments;const{fragmentHint:n}=e;let r;return n&&(i=i.concat(n)),it(i,e=>e.cc<t?1:e.cc>t?-1:(r=e,e.end<=s?1:e.start>s?-1:0)),r||null}return null}function lt(e){switch(e.details){case o.FRAG_LOAD_TIMEOUT:case o.KEY_LOAD_TIMEOUT:case o.LEVEL_LOAD_TIMEOUT:case o.MANIFEST_LOAD_TIMEOUT:return!0}return!1}function dt(e,t){const s=lt(t);return e.default[(s?"timeout":"error")+"Retry"]}function ct(e,t){const s="linear"===e.backoff?1:Math.pow(2,t);return Math.min(s*e.retryDelayMs,e.maxRetryDelayMs)}function ht(e){return E(E({},e),{errorRetry:null,timeoutRetry:null})}function ut(e,t,s,i){if(!e)return!1;const n=null==i?void 0:i.code,r=t<e.maxNumRetry&&(function(e){return 0===e&&!1===navigator.onLine||!!e&&(e<400||e>499)}(n)||!!s);return e.shouldRetry?e.shouldRetry(e,t,s,i,r):r}var ft={DoNothing:0,SendEndCallback:1,SendAlternateToPenaltyBox:2,RemoveAlternatePermanently:3,InsertDiscontinuity:4,RetryRequest:5},gt={None:0,MoveAllAlternatesMatchingHost:1,MoveAllAlternatesMatchingHDCP:2,SwitchToSDR:4};class mt extends T{constructor(e){super("error-controller",e.logger),this.hls=void 0,this.playlistError=0,this.penalizedRenditions={},this.hls=e,this.registerListeners()}registerListeners(){const e=this.hls;e.on(l.ERROR,this.onError,this),e.on(l.MANIFEST_LOADING,this.onManifestLoading,this),e.on(l.LEVEL_UPDATED,this.onLevelUpdated,this)}unregisterListeners(){const e=this.hls;e&&(e.off(l.ERROR,this.onError,this),e.off(l.ERROR,this.onErrorOut,this),e.off(l.MANIFEST_LOADING,this.onManifestLoading,this),e.off(l.LEVEL_UPDATED,this.onLevelUpdated,this))}destroy(){this.unregisterListeners(),this.hls=null,this.penalizedRenditions={}}startLoad(e){}stopLoad(){this.playlistError=0}getVariantLevelIndex(e){return(null==e?void 0:e.type)===f.MAIN?e.level:this.hls.loadLevel}onManifestLoading(){this.playlistError=0,this.penalizedRenditions={}}onLevelUpdated(){this.playlistError=0}onError(e,t){var s;if(t.fatal)return;const i=this.hls,n=t.context;switch(t.details){case o.FRAG_LOAD_ERROR:case o.FRAG_LOAD_TIMEOUT:case o.KEY_LOAD_ERROR:case o.KEY_LOAD_TIMEOUT:return void(t.errorAction=this.getFragRetryOrSwitchAction(t));case o.FRAG_PARSING_ERROR:if(null!=(s=t.frag)&&s.gap)return void(t.errorAction=pt());case o.FRAG_GAP:case o.FRAG_DECRYPT_ERROR:return t.errorAction=this.getFragRetryOrSwitchAction(t),void(t.errorAction.action=ft.SendAlternateToPenaltyBox);case o.LEVEL_EMPTY_ERROR:case o.LEVEL_PARSING_ERROR:{var r,l;const e=t.parent===f.MAIN?t.level:i.loadLevel;t.details===o.LEVEL_EMPTY_ERROR&&null!=(r=t.context)&&null!=(l=r.levelDetails)&&l.live?t.errorAction=this.getPlaylistRetryOrSwitchAction(t,e):(t.levelRetry=!1,t.errorAction=this.getLevelSwitchAction(t,e))}return;case o.LEVEL_LOAD_ERROR:case o.LEVEL_LOAD_TIMEOUT:return void("number"==typeof(null==n?void 0:n.level)&&(t.errorAction=this.getPlaylistRetryOrSwitchAction(t,n.level)));case o.AUDIO_TRACK_LOAD_ERROR:case o.AUDIO_TRACK_LOAD_TIMEOUT:case o.SUBTITLE_LOAD_ERROR:case o.SUBTITLE_TRACK_LOAD_TIMEOUT:if(n){const e=i.loadLevelObj;if(e&&(n.type===h&&e.hasAudioGroup(n.groupId)||n.type===u&&e.hasSubtitleGroup(n.groupId)))return t.errorAction=this.getPlaylistRetryOrSwitchAction(t,i.loadLevel),t.errorAction.action=ft.SendAlternateToPenaltyBox,void(t.errorAction.flags=gt.MoveAllAlternatesMatchingHost)}return;case o.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED:{const e=i.loadLevelObj,s=null==e?void 0:e.attrs["HDCP-LEVEL"];s?t.errorAction={action:ft.SendAlternateToPenaltyBox,flags:gt.MoveAllAlternatesMatchingHDCP,hdcpLevel:s}:this.keySystemError(t)}return;case o.BUFFER_ADD_CODEC_ERROR:case o.REMUX_ALLOC_ERROR:case o.BUFFER_APPEND_ERROR:var d;return void(t.errorAction||(t.errorAction=this.getLevelSwitchAction(t,null!=(d=t.level)?d:i.loadLevel)));case o.INTERNAL_EXCEPTION:case o.BUFFER_APPENDING_ERROR:case o.BUFFER_FULL_ERROR:case o.LEVEL_SWITCH_ERROR:case o.BUFFER_STALLED_ERROR:case o.BUFFER_SEEK_OVER_HOLE:case o.BUFFER_NUDGE_ON_STALL:return void(t.errorAction=pt())}t.type===a.KEY_SYSTEM_ERROR&&this.keySystemError(t)}keySystemError(e){const t=this.getVariantLevelIndex(e.frag);e.levelRetry=!1,e.errorAction=this.getLevelSwitchAction(e,t)}getPlaylistRetryOrSwitchAction(e,t){const s=dt(this.hls.config.playlistLoadPolicy,e),i=this.playlistError++;if(ut(s,i,lt(e),e.response))return{action:ft.RetryRequest,flags:gt.None,retryConfig:s,retryCount:i};const n=this.getLevelSwitchAction(e,t);return s&&(n.retryConfig=s,n.retryCount=i),n}getFragRetryOrSwitchAction(e){const t=this.hls,s=this.getVariantLevelIndex(e.frag),i=t.levels[s],{fragLoadPolicy:n,keyLoadPolicy:r}=t.config,a=dt(e.details.startsWith("key")?r:n,e),l=t.levels.reduce((e,t)=>e+t.fragmentError,0);if(i&&(e.details!==o.FRAG_GAP&&i.fragmentError++,ut(a,l,lt(e),e.response)))return{action:ft.RetryRequest,flags:gt.None,retryConfig:a,retryCount:l};const d=this.getLevelSwitchAction(e,s);return a&&(d.retryConfig=a,d.retryCount=l),d}getLevelSwitchAction(e,t){const s=this.hls;null==t&&(t=s.loadLevel);const i=this.hls.levels[t];if(i){var n,r;const t=e.details;i.loadError++,t===o.BUFFER_APPEND_ERROR&&i.fragmentError++;let d=-1;const{levels:c,loadLevel:g,minAutoLevel:m,maxAutoLevel:p}=s;s.autoLevelEnabled||s.config.preserveManualLevelOnError||(s.loadLevel=-1);const y=null==(n=e.frag)?void 0:n.type,v=(y===f.AUDIO&&t===o.FRAG_PARSING_ERROR||"audio"===e.sourceBufferName&&(t===o.BUFFER_ADD_CODEC_ERROR||t===o.BUFFER_APPEND_ERROR))&&c.some(({audioCodec:e})=>i.audioCodec!==e),E="video"===e.sourceBufferName&&(t===o.BUFFER_ADD_CODEC_ERROR||t===o.BUFFER_APPEND_ERROR)&&c.some(({codecSet:e,audioCodec:t})=>i.codecSet!==e&&i.audioCodec===t),{type:T,groupId:S}=null!=(r=e.context)?r:{};for(let s=c.length;s--;){const n=(s+g)%c.length;if(n!==g&&n>=m&&n<=p&&0===c[n].loadError){var a,l;const s=c[n];if(t===o.FRAG_GAP&&y===f.MAIN&&e.frag){const t=c[n].details;if(t){const s=nt(e.frag,t.fragments,e.frag.start);if(null!=s&&s.gap)continue}}else{if(T===h&&s.hasAudioGroup(S)||T===u&&s.hasSubtitleGroup(S))continue;if(y===f.AUDIO&&null!=(a=i.audioGroups)&&a.some(e=>s.hasAudioGroup(e))||y===f.SUBTITLE&&null!=(l=i.subtitleGroups)&&l.some(e=>s.hasSubtitleGroup(e))||v&&i.audioCodec===s.audioCodec||!v&&i.audioCodec!==s.audioCodec||E&&i.codecSet===s.codecSet)continue}d=n;break}}if(d>-1&&s.loadLevel!==d)return e.levelRetry=!0,this.playlistError=0,{action:ft.SendAlternateToPenaltyBox,flags:gt.None,nextAutoLevel:d}}return{action:ft.SendAlternateToPenaltyBox,flags:gt.MoveAllAlternatesMatchingHost}}onErrorOut(e,t){var s;switch(null==(s=t.errorAction)?void 0:s.action){case ft.DoNothing:break;case ft.SendAlternateToPenaltyBox:this.sendAlternateToPenaltyBox(t),t.errorAction.resolved||t.details===o.FRAG_GAP?/MediaSource readyState: ended/.test(t.error.message)&&(this.warn(`MediaSource ended after "${t.sourceBufferName}" sourceBuffer append error. Attempting to recover from media error.`),this.hls.recoverMediaError()):t.fatal=!0;case ft.RetryRequest:}t.fatal&&this.hls.stopLoad()}sendAlternateToPenaltyBox(e){const t=this.hls,s=e.errorAction;if(!s)return;const{flags:i,hdcpLevel:n,nextAutoLevel:r}=s;switch(i){case gt.None:this.switchLevel(e,r);break;case gt.MoveAllAlternatesMatchingHDCP:n&&(t.maxHdcpLevel=$e[$e.indexOf(n)-1],s.resolved=!0),this.warn(`Restricting playback to HDCP-LEVEL of "${t.maxHdcpLevel}" or lower`)}s.resolved||this.switchLevel(e,r)}switchLevel(e,t){if(void 0!==t&&e.errorAction&&(this.warn(`switching to level ${t} after ${e.details}`),this.hls.nextAutoLevel=t,e.errorAction.resolved=!0,this.hls.nextLoadLevel=this.hls.nextAutoLevel,e.details===o.BUFFER_ADD_CODEC_ERROR&&e.mimeType&&"audiovideo"!==e.sourceBufferName)){const t=Pe(e.mimeType),s=this.hls.levels;for(let i=s.length;i--;)s[i][`${e.sourceBufferName}Codec`]===t&&this.hls.removeLevel(i)}}}function pt(e){const t={action:ft.DoNothing,flags:gt.None};return e&&(t.resolved=!0),t}var yt="NOT_LOADED",vt="APPENDING",Et="PARTIAL",Tt="OK";class St{constructor(e){this.activePartLists=Object.create(null),this.endListFragments=Object.create(null),this.fragments=Object.create(null),this.timeRanges=Object.create(null),this.bufferPadding=.2,this.hls=void 0,this.hasGaps=!1,this.hls=e,this._registerListeners()}_registerListeners(){const{hls:e}=this;e.on(l.MANIFEST_LOADING,this.onManifestLoading,this),e.on(l.BUFFER_APPENDED,this.onBufferAppended,this),e.on(l.FRAG_BUFFERED,this.onFragBuffered,this),e.on(l.FRAG_LOADED,this.onFragLoaded,this)}_unregisterListeners(){const{hls:e}=this;e.off(l.MANIFEST_LOADING,this.onManifestLoading,this),e.off(l.BUFFER_APPENDED,this.onBufferAppended,this),e.off(l.FRAG_BUFFERED,this.onFragBuffered,this),e.off(l.FRAG_LOADED,this.onFragLoaded,this)}destroy(){this._unregisterListeners(),this.fragments=this.activePartLists=this.endListFragments=this.timeRanges=null}getAppendedFrag(e,t){const s=this.activePartLists[t];if(s)for(let t=s.length;t--;){const i=s[t];if(!i)break;const n=i.end;if(i.start<=e&&null!==n&&e<=n)return i}return this.getBufferedFrag(e,t)}getBufferedFrag(e,t){return this.getFragAtPos(e,t,!0)}getFragAtPos(e,t,s){const{fragments:i}=this,n=Object.keys(i);for(let r=n.length;r--;){const a=i[n[r]];if((null==a?void 0:a.body.type)===t&&(!s||a.buffered)){const t=a.body;if(t.start<=e&&e<=t.end)return t}}return null}detectEvictedFragments(e,t,s,i,n){this.timeRanges&&(this.timeRanges[e]=t);const r=(null==i?void 0:i.fragment.sn)||-1;Object.keys(this.fragments).forEach(i=>{const a=this.fragments[i];if(!a)return;if(r>=a.body.sn)return;if(!a.buffered&&(!a.loaded||n))return void(a.body.type===s&&this.removeFragment(a.body));const o=a.range[e];o&&(0!==o.time.length?o.time.some(e=>{const s=!this.isTimeBuffered(e.startPTS,e.endPTS,t);return s&&this.removeFragment(a.body),s}):this.removeFragment(a.body))})}detectPartialFragments(e){const t=this.timeRanges;if(!t||"initSegment"===e.frag.sn)return;const s=e.frag,i=At(s),n=this.fragments[i];if(!n||n.buffered&&s.gap)return;const r=!s.relurl;Object.keys(t).forEach(i=>{const a=s.elementaryStreams[i];if(!a)return;const o=t[i],l=r||!0===a.partial;n.range[i]=this.getBufferedTimes(s,e.part,l,o)}),n.loaded=null,Object.keys(n.range).length?(n.buffered=!0,(n.body.endList=s.endList||n.body.endList)&&(this.endListFragments[n.body.type]=n),bt(n)||this.removeParts(s.sn-1,s.type)):this.removeFragment(n.body)}removeParts(e,t){const s=this.activePartLists[t];s&&(this.activePartLists[t]=Lt(s,t=>t.fragment.sn>=e))}fragBuffered(e,t){const s=At(e);let i=this.fragments[s];!i&&t&&(i=this.fragments[s]={body:e,appendedPTS:null,loaded:null,buffered:!1,range:Object.create(null)},e.gap&&(this.hasGaps=!0)),i&&(i.loaded=null,i.buffered=!0)}getBufferedTimes(e,t,s,i){const n={time:[],partial:s},r=e.start,a=e.end,o=e.minEndPTS||a,l=e.maxStartPTS||r;for(let e=0;e<i.length;e++){const t=i.start(e)-this.bufferPadding,s=i.end(e)+this.bufferPadding;if(l>=t&&o<=s){n.time.push({startPTS:Math.max(r,i.start(e)),endPTS:Math.min(a,i.end(e))});break}if(r<s&&a>t){const t=Math.max(r,i.start(e)),s=Math.min(a,i.end(e));s>t&&(n.partial=!0,n.time.push({startPTS:t,endPTS:s}))}else if(a<=t)break}return n}getPartialFragment(e){let t,s,i,n=null,r=0;const{bufferPadding:a,fragments:o}=this;return Object.keys(o).forEach(l=>{const d=o[l];d&&bt(d)&&(s=d.body.start-a,i=d.body.end+a,e>=s&&e<=i&&(t=Math.min(e-s,i-e),r<=t&&(n=d.body,r=t)))}),n}isEndListAppended(e){const t=this.endListFragments[e];return void 0!==t&&(t.buffered||bt(t))}getState(e){const t=At(e),s=this.fragments[t];return s?s.buffered?bt(s)?Et:Tt:vt:yt}isTimeBuffered(e,t,s){let i,n;for(let r=0;r<s.length;r++){if(i=s.start(r)-this.bufferPadding,n=s.end(r)+this.bufferPadding,e>=i&&t<=n)return!0;if(t<=i)return!1}return!1}onManifestLoading(){this.removeAllFragments()}onFragLoaded(e,t){if("initSegment"===t.frag.sn||t.frag.bitrateTest)return;const s=t.frag,i=t.part?null:t,n=At(s);this.fragments[n]={body:s,appendedPTS:null,loaded:i,buffered:!1,range:Object.create(null)}}onBufferAppended(e,t){const{frag:s,part:i,timeRanges:n,type:r}=t;if("initSegment"===s.sn)return;const a=s.type;if(i){let e=this.activePartLists[a];e||(this.activePartLists[a]=e=[]),e.push(i)}this.timeRanges=n;const o=n[r];this.detectEvictedFragments(r,o,a,i)}onFragBuffered(e,t){this.detectPartialFragments(t)}hasFragment(e){const t=At(e);return!!this.fragments[t]}hasFragments(e){const{fragments:t}=this,s=Object.keys(t);if(!e)return s.length>0;for(let i=s.length;i--;){const n=t[s[i]];if((null==n?void 0:n.body.type)===e)return!0}return!1}hasParts(e){var t;return!(null==(t=this.activePartLists[e])||!t.length)}removeFragmentsInRange(e,t,s,i,n){i&&!this.hasGaps||Object.keys(this.fragments).forEach(r=>{const a=this.fragments[r];if(!a)return;const o=a.body;o.type!==s||i&&!o.gap||o.start<t&&o.end>e&&(a.buffered||n)&&this.removeFragment(o)})}removeFragment(e){const t=At(e);e.clearElementaryStreamInfo();const s=this.activePartLists[e.type];if(s){const t=e.sn;this.activePartLists[e.type]=Lt(s,e=>e.fragment.sn!==t)}delete this.fragments[t],e.endList&&delete this.endListFragments[e.type]}removeAllFragments(){var e,t;this.fragments=Object.create(null),this.endListFragments=Object.create(null),this.activePartLists=Object.create(null),this.hasGaps=!1;const s=null==(e=this.hls)||null==(t=e.latestLevelDetails)?void 0:t.partList;s&&s.forEach(e=>e.clearElementaryStreamInfo())}}function bt(e){var t,s,i;return e.buffered&&(e.body.gap||(null==(t=e.range.video)?void 0:t.partial)||(null==(s=e.range.audio)?void 0:s.partial)||(null==(i=e.range.audiovideo)?void 0:i.partial))}function At(e){return`${e.type}_${e.level}_${e.sn}`}function Lt(e,t){return e.filter(e=>{const s=t(e);return s||e.clearElementaryStreamInfo(),s})}class wt{constructor(e,t,s){this.subtle=void 0,this.aesIV=void 0,this.aesMode=void 0,this.subtle=e,this.aesIV=t,this.aesMode=s}decrypt(e,t){switch(this.aesMode){case 0:return this.subtle.decrypt({name:"AES-CBC",iv:this.aesIV},t,e);case 1:return this.subtle.decrypt({name:"AES-CTR",counter:this.aesIV,length:64},t,e);default:throw new Error(`[AESCrypto] invalid aes mode ${this.aesMode}`)}}}class Rt{constructor(){this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.ksRows=0,this.keySize=0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.initTable()}uint8ArrayToUint32Array_(e){const t=new DataView(e),s=new Uint32Array(4);for(let e=0;e<4;e++)s[e]=t.getUint32(4*e);return s}initTable(){const e=this.sBox,t=this.invSBox,s=this.subMix,i=s[0],n=s[1],r=s[2],a=s[3],o=this.invSubMix,l=o[0],d=o[1],c=o[2],h=o[3],u=new Uint32Array(256);let f=0,g=0,m=0;for(m=0;m<256;m++)u[m]=m<128?m<<1:m<<1^283;for(m=0;m<256;m++){let s=g^g<<1^g<<2^g<<3^g<<4;s=s>>>8^255&s^99,e[f]=s,t[s]=f;const o=u[f],m=u[o],p=u[m];let y=257*u[s]^16843008*s;i[f]=y<<24|y>>>8,n[f]=y<<16|y>>>16,r[f]=y<<8|y>>>24,a[f]=y,y=16843009*p^65537*m^257*o^16843008*f,l[s]=y<<24|y>>>8,d[s]=y<<16|y>>>16,c[s]=y<<8|y>>>24,h[s]=y,f?(f=o^u[u[u[p^o]]],g^=u[u[g]]):f=g=1}}expandKey(e){const t=this.uint8ArrayToUint32Array_(e);let s=!0,i=0;for(;i<t.length&&s;)s=t[i]===this.key[i],i++;if(s)return;this.key=t;const n=this.keySize=t.length;if(4!==n&&6!==n&&8!==n)throw new Error("Invalid aes key size="+n);const r=this.ksRows=4*(n+6+1);let a,o;const l=this.keySchedule=new Uint32Array(r),d=this.invKeySchedule=new Uint32Array(r),c=this.sBox,h=this.rcon,u=this.invSubMix,f=u[0],g=u[1],m=u[2],p=u[3];let y,v;for(a=0;a<r;a++)a<n?y=l[a]=t[a]:(v=y,a%n===0?(v=v<<8|v>>>24,v=c[v>>>24]<<24|c[v>>>16&255]<<16|c[v>>>8&255]<<8|c[255&v],v^=h[a/n|0]<<24):n>6&&a%n===4&&(v=c[v>>>24]<<24|c[v>>>16&255]<<16|c[v>>>8&255]<<8|c[255&v]),l[a]=y=(l[a-n]^v)>>>0);for(o=0;o<r;o++)a=r-o,v=3&o?l[a]:l[a-4],d[o]=o<4||a<=4?v:f[c[v>>>24]]^g[c[v>>>16&255]]^m[c[v>>>8&255]]^p[c[255&v]],d[o]=d[o]>>>0}networkToHostOrderSwap(e){return e<<24|(65280&e)<<8|(16711680&e)>>8|e>>>24}decrypt(e,t,s){const i=this.keySize+6,n=this.invKeySchedule,r=this.invSBox,a=this.invSubMix,o=a[0],l=a[1],d=a[2],c=a[3],h=this.uint8ArrayToUint32Array_(s);let u=h[0],f=h[1],g=h[2],m=h[3];const p=new Int32Array(e),y=new Int32Array(p.length);let v,E,T,S,b,A,L,w,R,I,x,k,D,_;const C=this.networkToHostOrderSwap;for(;t<p.length;){for(R=C(p[t]),I=C(p[t+1]),x=C(p[t+2]),k=C(p[t+3]),b=R^n[0],A=k^n[1],L=x^n[2],w=I^n[3],D=4,_=1;_<i;_++)v=o[b>>>24]^l[A>>16&255]^d[L>>8&255]^c[255&w]^n[D],E=o[A>>>24]^l[L>>16&255]^d[w>>8&255]^c[255&b]^n[D+1],T=o[L>>>24]^l[w>>16&255]^d[b>>8&255]^c[255&A]^n[D+2],S=o[w>>>24]^l[b>>16&255]^d[A>>8&255]^c[255&L]^n[D+3],b=v,A=E,L=T,w=S,D+=4;v=r[b>>>24]<<24^r[A>>16&255]<<16^r[L>>8&255]<<8^r[255&w]^n[D],E=r[A>>>24]<<24^r[L>>16&255]<<16^r[w>>8&255]<<8^r[255&b]^n[D+1],T=r[L>>>24]<<24^r[w>>16&255]<<16^r[b>>8&255]<<8^r[255&A]^n[D+2],S=r[w>>>24]<<24^r[b>>16&255]<<16^r[A>>8&255]<<8^r[255&L]^n[D+3],y[t]=C(v^u),y[t+1]=C(S^f),y[t+2]=C(T^g),y[t+3]=C(E^m),u=R,f=I,g=x,m=k,t+=4}return y.buffer}}class It{constructor(e,t,s){this.subtle=void 0,this.key=void 0,this.aesMode=void 0,this.subtle=e,this.key=t,this.aesMode=s}expandKey(){const e=function(e){switch(e){case 0:return"AES-CBC";case 1:return"AES-CTR";default:throw new Error(`[FastAESKey] invalid aes mode ${e}`)}}(this.aesMode);return this.subtle.importKey("raw",this.key,{name:e},!1,["encrypt","decrypt"])}}class xt{constructor(e,{removePKCS7Padding:t=!0}={}){if(this.logEnabled=!0,this.removePKCS7Padding=void 0,this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null,this.useSoftware=void 0,this.enableSoftwareAES=void 0,this.enableSoftwareAES=e.enableSoftwareAES,this.removePKCS7Padding=t,t)try{const e=self.crypto;e&&(this.subtle=e.subtle||e.webkitSubtle)}catch(e){}this.useSoftware=!this.subtle}destroy(){this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null}isSync(){return this.useSoftware}flush(){const{currentResult:e,remainderData:t}=this;if(!e||t)return this.reset(),null;const s=new Uint8Array(e);return this.reset(),this.removePKCS7Padding?function(e){const t=e.byteLength,s=t&&new DataView(e.buffer).getUint8(t-1);return s?e.slice(0,t-s):e}(s):s}reset(){this.currentResult=null,this.currentIV=null,this.remainderData=null,this.softwareDecrypter&&(this.softwareDecrypter=null)}decrypt(e,t,s,i){return this.useSoftware?new Promise((n,r)=>{const a=ArrayBuffer.isView(e)?e:new Uint8Array(e);this.softwareDecrypt(a,t,s,i);const o=this.flush();o?n(o.buffer):r(new Error("[softwareDecrypt] Failed to decrypt data"))}):this.webCryptoDecrypt(new Uint8Array(e),t,s,i)}softwareDecrypt(e,t,s,i){const{currentIV:n,currentResult:r,remainderData:a}=this;if(0!==i||16!==t.byteLength)return R.warn("SoftwareDecrypt: can only handle AES-128-CBC"),null;this.logOnce("JS AES decrypt"),a&&(e=ue(a,e),this.remainderData=null);const o=this.getValidChunk(e);if(!o.length)return null;n&&(s=n);let l=this.softwareDecrypter;l||(l=this.softwareDecrypter=new Rt),l.expandKey(t);const d=r;return this.currentResult=l.decrypt(o.buffer,0,s),this.currentIV=o.slice(-16).buffer,d||null}webCryptoDecrypt(e,t,s,i){if(this.key!==t||!this.fastAesKey){if(!this.subtle)return Promise.resolve(this.onWebCryptoError(e,t,s,i));this.key=t,this.fastAesKey=new It(this.subtle,t,i)}return this.fastAesKey.expandKey().then(t=>this.subtle?(this.logOnce("WebCrypto AES decrypt"),new wt(this.subtle,new Uint8Array(s),i).decrypt(e.buffer,t)):Promise.reject(new Error("web crypto not initialized"))).catch(n=>(R.warn(`[decrypter]: WebCrypto Error, disable WebCrypto API, ${n.name}: ${n.message}`),this.onWebCryptoError(e,t,s,i)))}onWebCryptoError(e,t,s,i){const n=this.enableSoftwareAES;if(n){this.useSoftware=!0,this.logEnabled=!0,this.softwareDecrypt(e,t,s,i);const n=this.flush();if(n)return n.buffer}throw new Error("WebCrypto"+(n?" and softwareDecrypt":"")+": failed to decrypt data")}getValidChunk(e){let t=e;const s=e.length-e.length%16;return s!==e.length&&(t=e.slice(0,s),this.remainderData=e.slice(s)),t}logOnce(e){this.logEnabled&&(R.log(`[decrypter]: ${e}`),this.logEnabled=!1)}}const kt=Math.pow(2,17);class Dt{constructor(e){this.config=void 0,this.loader=null,this.partLoadTimeout=-1,this.config=e}destroy(){this.loader&&(this.loader.destroy(),this.loader=null)}abort(){this.loader&&this.loader.abort()}load(e,t){const s=e.url;if(!s)return Promise.reject(new Pt({type:a.NETWORK_ERROR,details:o.FRAG_LOAD_ERROR,fatal:!1,frag:e,error:new Error("Fragment does not have a "+(s?"part list":"url")),networkDetails:null}));this.abort();const i=this.config,n=i.fLoader,r=i.loader;return new Promise((l,d)=>{if(this.loader&&this.loader.destroy(),e.gap){if(e.tagList.some(e=>"GAP"===e[0]))return void d(Ct(e));e.gap=!1}const c=this.loader=n?new n(i):new r(i),h=_t(e);e.loader=c;const u=ht(i.fragLoadPolicy.default),f={loadPolicy:u,timeout:u.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:"initSegment"===e.sn?1/0:kt};e.stats=c.stats;const g={onSuccess:(t,s,i,n)=>{this.resetLoader(e,c);let r=t.data;i.resetIV&&e.decryptdata&&(e.decryptdata.iv=new Uint8Array(r.slice(0,16)),r=r.slice(16)),l({frag:e,part:null,payload:r,networkDetails:n})},onError:(t,i,n,r)=>{this.resetLoader(e,c),d(new Pt({type:a.NETWORK_ERROR,details:o.FRAG_LOAD_ERROR,fatal:!1,frag:e,response:E({url:s,data:void 0},t),error:new Error(`HTTP Error ${t.code} ${t.text}`),networkDetails:n,stats:r}))},onAbort:(t,s,i)=>{this.resetLoader(e,c),d(new Pt({type:a.NETWORK_ERROR,details:o.INTERNAL_ABORTED,fatal:!1,frag:e,error:new Error("Aborted"),networkDetails:i,stats:t}))},onTimeout:(t,s,i)=>{this.resetLoader(e,c),d(new Pt({type:a.NETWORK_ERROR,details:o.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,error:new Error(`Timeout after ${f.timeout}ms`),networkDetails:i,stats:t}))}};t&&(g.onProgress=(s,i,n,r)=>t({frag:e,part:null,payload:n,networkDetails:r})),c.load(h,f,g)})}loadPart(e,t,s){this.abort();const i=this.config,n=i.fLoader,r=i.loader;return new Promise((l,d)=>{if(this.loader&&this.loader.destroy(),e.gap||t.gap)return void d(Ct(e,t));const c=this.loader=n?new n(i):new r(i),h=_t(e,t);e.loader=c;const u=ht(i.fragLoadPolicy.default),f={loadPolicy:u,timeout:u.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:kt};t.stats=c.stats,c.load(h,f,{onSuccess:(i,n,r,a)=>{this.resetLoader(e,c),this.updateStatsFromPart(e,t);const o={frag:e,part:t,payload:i.data,networkDetails:a};s(o),l(o)},onError:(s,i,n,r)=>{this.resetLoader(e,c),d(new Pt({type:a.NETWORK_ERROR,details:o.FRAG_LOAD_ERROR,fatal:!1,frag:e,part:t,response:E({url:h.url,data:void 0},s),error:new Error(`HTTP Error ${s.code} ${s.text}`),networkDetails:n,stats:r}))},onAbort:(s,i,n)=>{e.stats.aborted=t.stats.aborted,this.resetLoader(e,c),d(new Pt({type:a.NETWORK_ERROR,details:o.INTERNAL_ABORTED,fatal:!1,frag:e,part:t,error:new Error("Aborted"),networkDetails:n,stats:s}))},onTimeout:(s,i,n)=>{this.resetLoader(e,c),d(new Pt({type:a.NETWORK_ERROR,details:o.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,part:t,error:new Error(`Timeout after ${f.timeout}ms`),networkDetails:n,stats:s}))}})})}updateStatsFromPart(e,t){const s=e.stats,i=t.stats,n=i.total;if(s.loaded+=i.loaded,n){const i=Math.round(e.duration/t.duration),r=Math.min(Math.round(s.loaded/n),i),a=(i-r)*Math.round(s.loaded/r);s.total=s.loaded+a}else s.total=Math.max(s.loaded,s.total);const r=s.loading,a=i.loading;r.start?r.first+=a.first-a.start:(r.start=a.start,r.first=a.first),r.end=a.end}resetLoader(e,t){e.loader=null,this.loader===t&&(self.clearTimeout(this.partLoadTimeout),this.loader=null),t.destroy()}}function _t(e,t=null){const s=t||e,n={frag:e,part:t,responseType:"arraybuffer",url:s.url,headers:{},rangeStart:0,rangeEnd:0},r=s.byteRangeStartOffset,a=s.byteRangeEndOffset;if(i(r)&&i(a)){var o;let t=r,s=a;if("initSegment"===e.sn&&("AES-128"===(l=null==(o=e.decryptdata)?void 0:o.method)||"AES-256"===l)){const e=a-r;e%16&&(s=a+(16-e%16)),0!==r&&(n.resetIV=!0,t=r-16)}n.rangeStart=t,n.rangeEnd=s}var l;return n}function Ct(e,t){const s=new Error(`GAP ${e.gap?"tag":"attribute"} found`),i={type:a.MEDIA_ERROR,details:o.FRAG_GAP,fatal:!1,frag:e,error:s,networkDetails:null};return t&&(i.part=t),(t||e).stats.aborted=!0,new Pt(i)}class Pt extends Error{constructor(e){super(e.error.message),this.data=void 0,this.data=e}}class Mt extends T{constructor(e,t){super(e,t),this._boundTick=void 0,this._tickTimer=null,this._tickInterval=null,this._tickCallCount=0,this._boundTick=this.tick.bind(this)}destroy(){this.onHandlerDestroying(),this.onHandlerDestroyed()}onHandlerDestroying(){this.clearNextTick(),this.clearInterval()}onHandlerDestroyed(){}hasInterval(){return!!this._tickInterval}hasNextTick(){return!!this._tickTimer}setInterval(e){return!this._tickInterval&&(this._tickCallCount=0,this._tickInterval=self.setInterval(this._boundTick,e),!0)}clearInterval(){return!!this._tickInterval&&(self.clearInterval(this._tickInterval),this._tickInterval=null,!0)}clearNextTick(){return!!this._tickTimer&&(self.clearTimeout(this._tickTimer),this._tickTimer=null,!0)}tick(){this._tickCallCount++,1===this._tickCallCount&&(this.doTick(),this._tickCallCount>1&&this.tickImmediate(),this._tickCallCount=0)}tickImmediate(){this.clearNextTick(),this._tickTimer=self.setTimeout(this._boundTick,0)}doTick(){}}class Ot{constructor(e,t,s,i=0,n=-1,r=!1){this.level=void 0,this.sn=void 0,this.part=void 0,this.id=void 0,this.size=void 0,this.partial=void 0,this.transmuxing={start:0,executeStart:0,executeEnd:0,end:0},this.buffering={audio:{start:0,executeStart:0,executeEnd:0,end:0},video:{start:0,executeStart:0,executeEnd:0,end:0},audiovideo:{start:0,executeStart:0,executeEnd:0,end:0}},this.level=e,this.sn=t,this.id=s,this.size=i,this.part=n,this.partial=r}}const Ft={length:0,start:()=>0,end:()=>0};class Nt{static isBuffered(e,t){if(e){const s=Nt.getBuffered(e);for(let e=s.length;e--;)if(t>=s.start(e)&&t<=s.end(e))return!0}return!1}static bufferedRanges(e){if(e){const t=Nt.getBuffered(e);return Nt.timeRangesToArray(t)}return[]}static timeRangesToArray(e){const t=[];for(let s=0;s<e.length;s++)t.push({start:e.start(s),end:e.end(s)});return t}static bufferInfo(e,t,s){if(e){const i=Nt.bufferedRanges(e);if(i.length)return Nt.bufferedInfo(i,t,s)}return{len:0,start:t,end:t,bufferedIndex:-1}}static bufferedInfo(e,t,s){t=Math.max(0,t),e.length>1&&e.sort((e,t)=>e.start-t.start||t.end-e.end);let i=-1,n=[];if(s)for(let r=0;r<e.length;r++){t>=e[r].start&&t<=e[r].end&&(i=r);const a=n.length;if(a){const t=n[a-1].end;e[r].start-t<s?e[r].end>t&&(n[a-1].end=e[r].end):n.push(e[r])}else n.push(e[r])}else n=e;let r,a=0,o=t,l=t;for(let e=0;e<n.length;e++){const d=n[e].start,c=n[e].end;if(-1===i&&t>=d&&t<=c&&(i=e),t+s>=d&&t<c)o=d,l=c,a=l-t;else if(t+s<d){r=d;break}}return{len:a,start:o||0,end:l||0,nextStart:r,buffered:e,bufferedIndex:i}}static getBuffered(e){try{return e.buffered||Ft}catch(e){return R.log("failed to get media.buffered",e),Ft}}}const Bt=/\{\$([a-zA-Z0-9-_]+)\}/g;function Ut(e){return Bt.test(e)}function $t(e,t){if(null!==e.variableList||e.hasVariableRefs){const s=e.variableList;return t.replace(Bt,t=>{const i=t.substring(2,t.length-1),n=null==s?void 0:s[i];return void 0===n?(e.playlistParsingError||(e.playlistParsingError=new Error(`Missing preceding EXT-X-DEFINE tag for Variable Reference: "${i}"`)),t):n})}return t}function Gt(e,t,s){let i,n,r=e.variableList;if(r||(e.variableList=r={}),"QUERYPARAM"in t){i=t.QUERYPARAM;try{const e=new self.URL(s).searchParams;if(!e.has(i))throw new Error(`"${i}" does not match any query parameter in URI: "${s}"`);n=e.get(i)}catch(t){e.playlistParsingError||(e.playlistParsingError=new Error(`EXT-X-DEFINE QUERYPARAM: ${t.message}`))}}else i=t.NAME,n=t.VALUE;i in r?e.playlistParsingError||(e.playlistParsingError=new Error(`EXT-X-DEFINE duplicate Variable Name declarations: "${i}"`)):r[i]=n||""}function jt(e,t,s){const i=t.IMPORT;if(s&&i in s){let t=e.variableList;t||(e.variableList=t={}),t[i]=s[i]}else e.playlistParsingError||(e.playlistParsingError=new Error(`EXT-X-DEFINE IMPORT attribute not found in Multivariant Playlist: "${i}"`))}const Ht=/^(\d+)x(\d+)$/,Vt=/(.+?)=(".*?"|.*?)(?:,|$)/g;class Kt{constructor(e,t){"string"==typeof e&&(e=Kt.parseAttrList(e,t)),y(this,e)}get clientAttrs(){return Object.keys(this).filter(e=>"X-"===e.substring(0,2))}decimalInteger(e){const t=parseInt(this[e],10);return t>Number.MAX_SAFE_INTEGER?1/0:t}hexadecimalInteger(e){if(this[e]){let t=(this[e]||"0x").slice(2);t=(1&t.length?"0":"")+t;const s=new Uint8Array(t.length/2);for(let e=0;e<t.length/2;e++)s[e]=parseInt(t.slice(2*e,2*e+2),16);return s}return null}hexadecimalIntegerAsNumber(e){const t=parseInt(this[e],16);return t>Number.MAX_SAFE_INTEGER?1/0:t}decimalFloatingPoint(e){return parseFloat(this[e])}optionalFloat(e,t){const s=this[e];return s?parseFloat(s):t}enumeratedString(e){return this[e]}enumeratedStringList(e,t){const s=this[e];return(s?s.split(/[ ,]+/):[]).reduce((e,t)=>(e[t.toLowerCase()]=!0,e),t)}bool(e){return"YES"===this[e]}decimalResolution(e){const t=Ht.exec(this[e]);if(null!==t)return{width:parseInt(t[1],10),height:parseInt(t[2],10)}}static parseAttrList(e,t){let s;const i={};for(Vt.lastIndex=0;null!==(s=Vt.exec(e));){const n=s[1].trim();let r=s[2];const a=0===r.indexOf('"')&&r.lastIndexOf('"')===r.length-1;let o=!1;if(a)r=r.slice(1,-1);else switch(n){case"IV":case"SCTE35-CMD":case"SCTE35-IN":case"SCTE35-OUT":o=!0}if(t&&(a||o))r=$t(t,r);else if(!o&&!a)switch(n){case"CLOSED-CAPTIONS":if("NONE"===r)break;case"ALLOWED-CPC":case"CLASS":case"ASSOC-LANGUAGE":case"AUDIO":case"BYTERANGE":case"CHANNELS":case"CHARACTERISTICS":case"CODECS":case"DATA-ID":case"END-DATE":case"GROUP-ID":case"ID":case"IMPORT":case"INSTREAM-ID":case"KEYFORMAT":case"KEYFORMATVERSIONS":case"LANGUAGE":case"NAME":case"PATHWAY-ID":case"QUERYPARAM":case"RECENTLY-REMOVED-DATERANGES":case"SERVER-URI":case"STABLE-RENDITION-ID":case"STABLE-VARIANT-ID":case"START-DATE":case"SUBTITLES":case"SUPPLEMENTAL-CODECS":case"URI":case"VALUE":case"VIDEO":case"X-ASSET-LIST":case"X-ASSET-URI":R.warn(`${e}: attribute ${n} is missing quotes`)}i[n]=r}return i}}function qt(e){return"ID"!==e&&"CLASS"!==e&&"CUE"!==e&&"START-DATE"!==e&&"DURATION"!==e&&"END-DATE"!==e&&"END-ON-NEXT"!==e}function Yt(e){return"SCTE35-OUT"===e||"SCTE35-IN"===e||"SCTE35-CMD"===e}class Wt{constructor(e,t,s=0){var n;if(this.attr=void 0,this.tagAnchor=void 0,this.tagOrder=void 0,this._startDate=void 0,this._endDate=void 0,this._dateAtEnd=void 0,this._cue=void 0,this._badValueForSameId=void 0,this.tagAnchor=(null==t?void 0:t.tagAnchor)||null,this.tagOrder=null!=(n=null==t?void 0:t.tagOrder)?n:s,t){const s=t.attr;for(const t in s)if(Object.prototype.hasOwnProperty.call(e,t)&&e[t]!==s[t]){R.warn(`DATERANGE tag attribute: "${t}" does not match for tags with ID: "${e.ID}"`),this._badValueForSameId=t;break}e=y(new Kt({}),s,e)}if(this.attr=e,t?(this._startDate=t._startDate,this._cue=t._cue,this._endDate=t._endDate,this._dateAtEnd=t._dateAtEnd):this._startDate=new Date(e["START-DATE"]),"END-DATE"in this.attr){const e=(null==t?void 0:t.endDate)||new Date(this.attr["END-DATE"]);i(e.getTime())&&(this._endDate=e)}}get id(){return this.attr.ID}get class(){return this.attr.CLASS}get cue(){const e=this._cue;return void 0===e?this._cue=this.attr.enumeratedStringList(this.attr.CUE?"CUE":"X-CUE",{pre:!1,post:!1,once:!1}):e}get startTime(){const{tagAnchor:e}=this;return null===e||null===e.programDateTime?(R.warn(`Expected tagAnchor Fragment with PDT set for DateRange "${this.id}": ${e}`),NaN):e.start+(this.startDate.getTime()-e.programDateTime)/1e3}get startDate(){return this._startDate}get endDate(){const e=this._endDate||this._dateAtEnd;if(e)return e;const t=this.duration;return null!==t?this._dateAtEnd=new Date(this._startDate.getTime()+1e3*t):null}get duration(){if("DURATION"in this.attr){const e=this.attr.decimalFloatingPoint("DURATION");if(i(e))return e}else if(this._endDate)return(this._endDate.getTime()-this._startDate.getTime())/1e3;return null}get plannedDuration(){return"PLANNED-DURATION"in this.attr?this.attr.decimalFloatingPoint("PLANNED-DURATION"):null}get endOnNext(){return this.attr.bool("END-ON-NEXT")}get isInterstitial(){return"com.apple.hls.interstitial"===this.class}get isValid(){return!!this.id&&!this._badValueForSameId&&i(this.startDate.getTime())&&(null===this.duration||this.duration>=0)&&(!this.endOnNext||!!this.class)&&(!this.attr.CUE||!this.cue.pre&&!this.cue.post||this.cue.pre!==this.cue.post)&&(!this.isInterstitial||"X-ASSET-URI"in this.attr||"X-ASSET-LIST"in this.attr)}}class zt{constructor(e){this.PTSKnown=!1,this.alignedSliding=!1,this.averagetargetduration=void 0,this.endCC=0,this.endSN=0,this.fragments=void 0,this.fragmentHint=void 0,this.partList=null,this.dateRanges=void 0,this.dateRangeTagCount=0,this.live=!0,this.requestScheduled=-1,this.ageHeader=0,this.advancedDateTime=void 0,this.updated=!0,this.advanced=!0,this.misses=0,this.startCC=0,this.startSN=0,this.startTimeOffset=null,this.targetduration=0,this.totalduration=0,this.type=null,this.url=void 0,this.m3u8="",this.version=null,this.canBlockReload=!1,this.canSkipUntil=0,this.canSkipDateRanges=!1,this.skippedSegments=0,this.recentlyRemovedDateranges=void 0,this.partHoldBack=0,this.holdBack=0,this.partTarget=0,this.preloadHint=void 0,this.renditionReports=void 0,this.tuneInGoal=0,this.deltaUpdateFailed=void 0,this.driftStartTime=0,this.driftEndTime=0,this.driftStart=0,this.driftEnd=0,this.encryptedFragments=void 0,this.playlistParsingError=null,this.variableList=null,this.hasVariableRefs=!1,this.appliedTimelineOffset=void 0,this.fragments=[],this.encryptedFragments=[],this.dateRanges={},this.url=e}reloaded(e){if(!e)return this.advanced=!0,void(this.updated=!0);const t=this.lastPartSn-e.lastPartSn,s=this.lastPartIndex-e.lastPartIndex;this.updated=this.endSN!==e.endSN||!!s||!!t||!this.live,this.advanced=this.endSN>e.endSN||t>0||0===t&&s>0,this.updated||this.advanced?this.misses=Math.floor(.6*e.misses):this.misses=e.misses+1}get hasProgramDateTime(){return!!this.fragments.length&&i(this.fragments[this.fragments.length-1].programDateTime)}get levelTargetDuration(){return this.averagetargetduration||this.targetduration||10}get drift(){const e=this.driftEndTime-this.driftStartTime;return e>0?1e3*(this.driftEnd-this.driftStart)/e:1}get edge(){return this.partEnd||this.fragmentEnd}get partEnd(){var e;return null!=(e=this.partList)&&e.length?this.partList[this.partList.length-1].end:this.fragmentEnd}get fragmentEnd(){var e;return null!=(e=this.fragments)&&e.length?this.fragments[this.fragments.length-1].end:0}get fragmentStart(){var e;return null!=(e=this.fragments)&&e.length?this.fragments[0].start:0}get age(){return this.advancedDateTime?Math.max(Date.now()-this.advancedDateTime,0)/1e3:0}get lastPartIndex(){var e;return null!=(e=this.partList)&&e.length?this.partList[this.partList.length-1].index:-1}get maxPartIndex(){const e=this.partList;if(e){const t=this.lastPartIndex;if(-1!==t){for(let s=e.length;s--;)if(e[s].index>t)return e[s].index;return t}}return 0}get lastPartSn(){var e;return null!=(e=this.partList)&&e.length?this.partList[this.partList.length-1].fragment.sn:this.endSN}get expired(){if(this.live&&this.age&&this.misses<3){const e=this.partEnd-this.fragmentStart;return this.age>Math.max(e,this.totalduration)+this.levelTargetDuration}return!1}}function Xt(e){return"AES-128"===e||"AES-256"===e||"AES-256-CTR"===e}function Zt(e){switch(e){case"AES-128":case"AES-256":return 0;case"AES-256-CTR":return 1;default:throw new Error(`invalid full segment method ${e}`)}}function Qt(e){return Uint8Array.from(atob(e),e=>e.charCodeAt(0))}function Jt(e){return Uint8Array.from(unescape(encodeURIComponent(e)),e=>e.charCodeAt(0))}const es="undefined"!=typeof self?self:void 0;var ts={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.fps",PLAYREADY:"com.microsoft.playready",WIDEVINE:"com.widevine.alpha"},ss={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.streamingkeydelivery",PLAYREADY:"com.microsoft.playready",WIDEVINE:"urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed"};function is(e){switch(e){case ss.FAIRPLAY:return ts.FAIRPLAY;case ss.PLAYREADY:return ts.PLAYREADY;case ss.WIDEVINE:return ts.WIDEVINE;case ss.CLEARKEY:return ts.CLEARKEY}}function ns(e){switch(e){case ts.FAIRPLAY:return ss.FAIRPLAY;case ts.PLAYREADY:return ss.PLAYREADY;case ts.WIDEVINE:return ss.WIDEVINE;case ts.CLEARKEY:return ss.CLEARKEY}}function rs(e){const{drmSystems:t,widevineLicenseUrl:s}=e,i=t?[ts.FAIRPLAY,ts.WIDEVINE,ts.PLAYREADY,ts.CLEARKEY].filter(e=>!!t[e]):[];return!i[ts.WIDEVINE]&&s&&i.push(ts.WIDEVINE),i}const as=null!=es&&null!=(os=es.navigator)&&os.requestMediaKeySystemAccess?self.navigator.requestMediaKeySystemAccess.bind(self.navigator):null;var os;let ls={};class ds{static clearKeyUriToKeyIdMap(){ls={}}constructor(e,t,s,i=[1],n=null,r){this.uri=void 0,this.method=void 0,this.keyFormat=void 0,this.keyFormatVersions=void 0,this.encrypted=void 0,this.isCommonEncryption=void 0,this.iv=null,this.key=null,this.keyId=null,this.pssh=null,this.method=e,this.uri=t,this.keyFormat=s,this.keyFormatVersions=i,this.iv=n,this.encrypted=!!e&&"NONE"!==e,this.isCommonEncryption=this.encrypted&&!Xt(e),null!=r&&r.startsWith("0x")&&(this.keyId=new Uint8Array(_(r)))}matches(e){var t,s;return e.uri===this.uri&&e.method===this.method&&e.encrypted===this.encrypted&&e.keyFormat===this.keyFormat&&e.keyFormatVersions.join(",")===this.keyFormatVersions.join(",")&&(null==(t=e.iv)?void 0:t.join(","))===(null==(s=this.iv)?void 0:s.join(","))}isSupported(){if(this.method){if(Xt(this.method)||"NONE"===this.method)return!0;if("identity"===this.keyFormat)return"SAMPLE-AES"===this.method;switch(this.keyFormat){case ss.FAIRPLAY:case ss.WIDEVINE:case ss.PLAYREADY:case ss.CLEARKEY:return-1!==["ISO-23001-7","SAMPLE-AES","SAMPLE-AES-CENC","SAMPLE-AES-CTR"].indexOf(this.method)}}return!1}getDecryptData(e){if(!this.encrypted||!this.uri)return null;if(Xt(this.method)&&this.uri&&!this.iv){"number"!=typeof e&&(R.warn(`missing IV for initialization segment with method="${this.method}" - compliance issue`),e=0);const t=function(e){const t=new Uint8Array(16);for(let s=12;s<16;s++)t[s]=e>>8*(15-s)&255;return t}(e);return new ds(this.method,this.uri,"identity",this.keyFormatVersions,t)}if(this.pssh&&this.keyId)return this;const t=function(e){const t=e.split(":");let s=null;if("data"===t[0]&&2===t.length){const e=t[1].split(";"),i=e[e.length-1].split(",");if(2===i.length){const t="base64"===i[0],n=i[1];t?(e.splice(-1,1),s=Qt(n)):s=function(e){const t=Jt(e).subarray(0,16),s=new Uint8Array(16);return s.set(t,16-t.length),s}(n)}}return s}(this.uri);if(t)switch(this.keyFormat){case ss.WIDEVINE:if(this.pssh=t,!this.keyId&&t.length>=22){const e=t.length-22;this.keyId=t.subarray(e,e+16)}break;case ss.PLAYREADY:{const e=new Uint8Array([154,4,240,121,152,64,66,134,171,146,230,91,224,136,95,149]);this.pssh=function(e,t,s){if(16!==e.byteLength)throw new RangeError("Invalid system id");let i,n,r;i=0,n=new Uint8Array,r=new Uint8Array;const a=new Uint8Array(4);return s&&s.byteLength>0&&new DataView(a.buffer).setUint32(0,s.byteLength,!1),function(e,...t){const s=t.length;let i=8,n=s;for(;n--;)i+=t[n].byteLength;const r=new Uint8Array(i);for(r[0]=i>>24&255,r[1]=i>>16&255,r[2]=i>>8&255,r[3]=255&i,r.set(e,4),n=0,i=8;n<s;n++)r.set(t[n],i),i+=t[n].byteLength;return r}([112,115,115,104],new Uint8Array([0,0,0,0]),e,r,n,a,s||new Uint8Array)}(e,0,t),this.keyId=function(e){const t=new Uint16Array(e.buffer,e.byteOffset,e.byteLength/2),s=String.fromCharCode.apply(null,Array.from(t)),i=s.substring(s.indexOf("<"),s.length),n=(new DOMParser).parseFromString(i,"text/xml").getElementsByTagName("KID")[0];if(n){const e=n.childNodes[0]?n.childNodes[0].nodeValue:n.getAttribute("VALUE");if(e){const t=Qt(e).subarray(0,16);return function(e){const t=function(e,t,s){const i=e[t];e[t]=e[s],e[s]=i};t(e,0,3),t(e,1,2),t(e,4,5),t(e,6,7)}(t),t}}return null}(t);break}default:{let e=t.subarray(0,16);if(16!==e.length){const t=new Uint8Array(16);t.set(e,16-e.length),e=t}this.keyId=e;break}}if(!this.keyId||16!==this.keyId.byteLength){let e=ls[this.uri];if(!e){const t=Object.keys(ls).length%Number.MAX_SAFE_INTEGER;e=new Uint8Array(16),new DataView(e.buffer,12,4).setUint32(0,t),ls[this.uri]=e}this.keyId=e}return this}}const cs=/#EXT-X-STREAM-INF:([^\r\n]*)(?:[\r\n](?:#[^\r\n]*)?)*([^\r\n]+)|#EXT-X-(SESSION-DATA|SESSION-KEY|DEFINE|CONTENT-STEERING|START):([^\r\n]*)[\r\n]+/g,hs=/#EXT-X-MEDIA:(.*)/g,us=/^#EXT(?:INF|-X-TARGETDURATION):/m,fs=new RegExp([/#EXTINF:\s*(\d*(?:\.\d+)?)(?:,(.*)\s+)?/.source,/(?!#) *(\S[^\r\n]*)/.source,/#.*/.source].join("|"),"g"),gs=new RegExp([/#EXT-X-(PROGRAM-DATE-TIME|BYTERANGE|DATERANGE|DEFINE|KEY|MAP|PART|PART-INF|PLAYLIST-TYPE|PRELOAD-HINT|RENDITION-REPORT|SERVER-CONTROL|SKIP|START):(.+)/.source,/#EXT-X-(BITRATE|DISCONTINUITY-SEQUENCE|MEDIA-SEQUENCE|TARGETDURATION|VERSION): *(\d+)/.source,/#EXT-X-(DISCONTINUITY|ENDLIST|GAP|INDEPENDENT-SEGMENTS)/.source,/(#)([^:]*):(.*)/.source,/(#)(.*)(?:.*)\r?\n?/.source].join("|"));class ms{static findGroup(e,t){for(let s=0;s<e.length;s++){const i=e[s];if(i.id===t)return i}}static resolve(e,t){return $.buildAbsoluteURL(t,e,{alwaysNormalize:!0})}static isMediaPlaylist(e){return us.test(e)}static parseMasterPlaylist(e,t){const s={contentSteering:null,levels:[],playlistParsingError:null,sessionData:null,sessionKeys:null,startTimeOffset:null,variableList:null,hasVariableRefs:Ut(e)},i=[];let n;for(cs.lastIndex=0;null!=(n=cs.exec(e));)if(n[1]){var r;const e=new Kt(n[1],s),a=$t(s,n[2]),o={attrs:e,bitrate:e.decimalInteger("BANDWIDTH")||e.decimalInteger("AVERAGE-BANDWIDTH"),name:e.NAME,url:ms.resolve(a,t)},l=e.decimalResolution("RESOLUTION");l&&(o.width=l.width,o.height=l.height),Ts(e.CODECS,o);const d=e["SUPPLEMENTAL-CODECS"];d&&(o.supplemental={},Ts(d,o.supplemental)),null!=(r=o.unknownCodecs)&&r.length||i.push(o),s.levels.push(o)}else if(n[3]){const e=n[3],i=n[4];switch(e){case"SESSION-DATA":{const e=new Kt(i,s),t=e["DATA-ID"];t&&(null===s.sessionData&&(s.sessionData={}),s.sessionData[t]=e);break}case"SESSION-KEY":{const e=vs(i,t,s);e.encrypted&&e.isSupported()?(null===s.sessionKeys&&(s.sessionKeys=[]),s.sessionKeys.push(e)):R.warn(`[Keys] Ignoring invalid EXT-X-SESSION-KEY tag: "${i}"`);break}case"DEFINE":Gt(s,new Kt(i,s),t);break;case"CONTENT-STEERING":{const e=new Kt(i,s);s.contentSteering={uri:ms.resolve(e["SERVER-URI"],t),pathwayId:e["PATHWAY-ID"]||"."};break}case"START":s.startTimeOffset=Es(i)}}const a=i.length>0&&i.length<s.levels.length;return s.levels=a?i:s.levels,0===s.levels.length&&(s.playlistParsingError=new Error("no levels found in manifest")),s}static parseMasterPlaylistMedia(e,t,s){let i;const n={},r=s.levels,a={AUDIO:r.map(e=>({id:e.attrs.AUDIO,audioCodec:e.audioCodec})),SUBTITLES:r.map(e=>({id:e.attrs.SUBTITLES,textCodec:e.textCodec})),"CLOSED-CAPTIONS":[]};let o=0;for(hs.lastIndex=0;null!==(i=hs.exec(e));){const e=new Kt(i[1],s),r=e.TYPE;if(r){const s=a[r],i=n[r]||[];n[r]=i;const l=e.LANGUAGE,d=e["ASSOC-LANGUAGE"],c=e.CHANNELS,h=e.CHARACTERISTICS,u=e["INSTREAM-ID"],f={attrs:e,bitrate:0,id:o++,groupId:e["GROUP-ID"]||"",name:e.NAME||l||"",type:r,default:e.bool("DEFAULT"),autoselect:e.bool("AUTOSELECT"),forced:e.bool("FORCED"),lang:l,url:e.URI?ms.resolve(e.URI,t):""};if(d&&(f.assocLang=d),c&&(f.channels=c),h&&(f.characteristics=h),u&&(f.instreamId=u),null!=s&&s.length){const e=ms.findGroup(s,f.groupId)||s[0];Ss(f,e,"audioCodec"),Ss(f,e,"textCodec")}i.push(f)}}return n}static parseLevelPlaylist(e,t,s,n,r,a){var o;const l={url:t},d=new zt(t),c=d.fragments,h=[];let u,f,g,m,p=null,v=0,E=0,T=0,S=0,b=0,A=null,L=new Y(n,l),w=-1,I=!1,x=null;if(fs.lastIndex=0,d.m3u8=e,d.hasVariableRefs=Ut(e),"#EXTM3U"!==(null==(o=fs.exec(e))?void 0:o[0]))return d.playlistParsingError=new Error("Missing format identifier #EXTM3U"),d;for(;null!==(u=fs.exec(e));){I&&(I=!1,L=new Y(n,l),L.playlistOffset=T,L.start=T,L.sn=v,L.cc=S,b&&(L.bitrate=b),L.level=s,p&&(L.initSegment=p,p.rawProgramDateTime&&(L.rawProgramDateTime=p.rawProgramDateTime,p.rawProgramDateTime=null),x&&(L.setByteRange(x),x=null)));const e=u[1];if(e){L.duration=parseFloat(e);const t=(" "+u[2]).slice(1);L.title=t||null,L.tagList.push(t?["INF",e,t]:["INF",e])}else if(u[3]){if(i(L.duration)){L.playlistOffset=T,L.start=T,g&&Ls(L,g,d),L.sn=v,L.level=s,L.cc=S,c.push(L);const e=(" "+u[3]).slice(1);L.relurl=$t(d,e),bs(L,A,h),A=L,T+=L.duration,v++,E=0,I=!0}}else{if(u=u[0].match(gs),!u){R.warn("No matches on slow regex match for level playlist!");continue}for(f=1;f<u.length&&void 0===u[f];f++);const e=(" "+u[f]).slice(1),r=(" "+u[f+1]).slice(1),o=u[f+2]?(" "+u[f+2]).slice(1):null;switch(e){case"BYTERANGE":A?L.setByteRange(r,A):L.setByteRange(r);break;case"PROGRAM-DATE-TIME":L.rawProgramDateTime=r,L.tagList.push(["PROGRAM-DATE-TIME",r]),-1===w&&(w=c.length);break;case"PLAYLIST-TYPE":d.type&&ws(d,e,u),d.type=r.toUpperCase();break;case"MEDIA-SEQUENCE":0!==d.startSN?ws(d,e,u):c.length>0&&Rs(d,e,u),v=d.startSN=parseInt(r);break;case"SKIP":{d.skippedSegments&&ws(d,e,u);const t=new Kt(r,d),s=t.decimalInteger("SKIPPED-SEGMENTS");if(i(s)){d.skippedSegments+=s;for(let e=s;e--;)c.push(null);v+=s}const n=t.enumeratedString("RECENTLY-REMOVED-DATERANGES");n&&(d.recentlyRemovedDateranges=(d.recentlyRemovedDateranges||[]).concat(n.split("\t")));break}case"TARGETDURATION":0!==d.targetduration&&ws(d,e,u),d.targetduration=Math.max(parseInt(r),1);break;case"VERSION":null!==d.version&&ws(d,e,u),d.version=parseInt(r);break;case"INDEPENDENT-SEGMENTS":break;case"ENDLIST":d.live||ws(d,e,u),d.live=!1;break;case"#":(r||o)&&L.tagList.push(o?[r,o]:[r]);break;case"DISCONTINUITY":S++,L.tagList.push(["DIS"]);break;case"GAP":L.gap=!0,L.tagList.push([e]);break;case"BITRATE":L.tagList.push([e,r]),b=1e3*parseInt(r),i(b)?L.bitrate=b:b=0;break;case"DATERANGE":{const e=new Kt(r,d),t=new Wt(e,d.dateRanges[e.ID],d.dateRangeTagCount);d.dateRangeTagCount++,t.isValid||d.skippedSegments?d.dateRanges[t.id]=t:R.warn(`Ignoring invalid DATERANGE tag: "${r}"`),L.tagList.push(["EXT-X-DATERANGE",r]);break}case"DEFINE":{const e=new Kt(r,d);"IMPORT"in e?jt(d,e,a):Gt(d,e,t)}break;case"DISCONTINUITY-SEQUENCE":0!==d.startCC?ws(d,e,u):c.length>0&&Rs(d,e,u),d.startCC=S=parseInt(r);break;case"KEY":{const e=vs(r,t,d);if(e.isSupported()){if("NONE"===e.method){g=void 0;break}g||(g={});const t=g[e.keyFormat];null!=t&&t.matches(e)||(t&&(g=y({},g)),g[e.keyFormat]=e)}else R.warn(`[Keys] Ignoring invalid EXT-X-KEY tag: "${r}"`);break}case"START":d.startTimeOffset=Es(r);break;case"MAP":{const e=new Kt(r,d);if(L.duration){const t=new Y(n,l);As(t,e,s,g),p=t,L.initSegment=p,p.rawProgramDateTime&&!L.rawProgramDateTime&&(L.rawProgramDateTime=p.rawProgramDateTime)}else{const t=L.byteRangeEndOffset;if(t){const e=L.byteRangeStartOffset;x=`${t-e}@${e}`}else x=null;As(L,e,s,g),p=L,I=!0}p.cc=S;break}case"SERVER-CONTROL":m&&ws(d,e,u),m=new Kt(r),d.canBlockReload=m.bool("CAN-BLOCK-RELOAD"),d.canSkipUntil=m.optionalFloat("CAN-SKIP-UNTIL",0),d.canSkipDateRanges=d.canSkipUntil>0&&m.bool("CAN-SKIP-DATERANGES"),d.partHoldBack=m.optionalFloat("PART-HOLD-BACK",0),d.holdBack=m.optionalFloat("HOLD-BACK",0);break;case"PART-INF":{d.partTarget&&ws(d,e,u);const t=new Kt(r);d.partTarget=t.decimalFloatingPoint("PART-TARGET");break}case"PART":{let e=d.partList;e||(e=d.partList=[]);const t=E>0?e[e.length-1]:void 0,s=E++,i=new Kt(r,d),n=new W(i,L,l,s,t);e.push(n),L.duration+=n.duration;break}case"PRELOAD-HINT":{const e=new Kt(r,d);d.preloadHint=e;break}case"RENDITION-REPORT":{const e=new Kt(r,d);d.renditionReports=d.renditionReports||[],d.renditionReports.push(e);break}default:R.warn(`line parsed but not handled: ${u}`)}}}A&&!A.relurl?(c.pop(),T-=A.duration,d.partList&&(d.fragmentHint=A)):d.partList&&(bs(L,A,h),L.cc=S,d.fragmentHint=L,g&&Ls(L,g,d)),d.targetduration||(d.playlistParsingError=new Error("#EXT-X-TARGETDURATION is required"));const k=c.length,D=c[0],_=c[k-1];if(T+=d.skippedSegments*d.targetduration,T>0&&k&&_){d.averagetargetduration=T/k;const e=_.sn;d.endSN="initSegment"!==e?e:0,d.live||(_.endList=!0),D&&void 0===d.startCC&&(d.startCC=D.cc),w>0&&(function(e,t){let s=e[t];for(let i=t;i--;){const t=e[i];if(!t)return;t.programDateTime=s.programDateTime-1e3*t.duration,s=t}}(c,w),D&&h.unshift(D))}else d.endSN=0,d.startCC=0;return d.fragmentHint&&(T+=d.fragmentHint.duration),d.totalduration=T,h.length&&d.dateRangeTagCount&&D&&ps(h,d),d.endCC=S,d}}function ps(e,t){const s=e.length;if(!s)return;const i=e[s-1],n=t.live?1/0:t.totalduration,r=Object.keys(t.dateRanges);for(let a=r.length;a--;){const o=t.dateRanges[r[a]],l=o.startDate.getTime();o.tagAnchor=i.ref;for(let i=s;i--;){const s=ys(t,l,e,i,n);if(-1!==s){o.tagAnchor=t.fragments[s].ref;break}}}}function ys(e,t,s,i,n){const r=s[i];if(r){const o=r.programDateTime;var a;if((t>=o||0===i)&&t<=o+1e3*(((null==(a=s[i+1])?void 0:a.start)||n)-r.start)){const n=s[i].sn-e.startSN,r=e.fragments;if(r.length>s.length)for(let a=(s[i+1]||r[r.length-1]).sn-e.startSN;a>n;a--){const e=r[a].programDateTime;if(t>=e&&t<e+1e3*r[a].duration)return a}return n}}return-1}function vs(e,t,s){var i,n;const r=new Kt(e,s),a=null!=(i=r.METHOD)?i:"",o=r.URI,l=r.hexadecimalInteger("IV"),d=r.KEYFORMATVERSIONS,c=null!=(n=r.KEYFORMAT)?n:"identity";o&&r.IV&&!l&&R.error(`Invalid IV: ${r.IV}`);const h=o?ms.resolve(o,t):"",u=(d||"1").split("/").map(Number).filter(Number.isFinite);return new ds(a,h,c,u,l,r.KEYID)}function Es(e){const t=new Kt(e).decimalFloatingPoint("TIME-OFFSET");return i(t)?t:null}function Ts(e,t){let s=(e||"").split(/[ ,]+/).filter(e=>e);["video","audio","text"].forEach(e=>{const i=s.filter(t=>Te(t,e));i.length&&(t[`${e}Codec`]=i.map(e=>e.split("/")[0]).join(","),s=s.filter(e=>-1===i.indexOf(e)))}),t.unknownCodecs=s}function Ss(e,t,s){const i=t[s];i&&(e[s]=i)}function bs(e,t,s){e.rawProgramDateTime?s.push(e):null!=t&&t.programDateTime&&(e.programDateTime=t.endProgramDateTime)}function As(e,t,s,i){e.relurl=t.URI,t.BYTERANGE&&e.setByteRange(t.BYTERANGE),e.level=s,e.sn="initSegment",i&&(e.levelkeys=i),e.initSegment=null}function Ls(e,t,s){e.levelkeys=t;const{encryptedFragments:i}=s;i.length&&i[i.length-1].levelkeys===t||!Object.keys(t).some(e=>t[e].isCommonEncryption)||i.push(e)}function ws(e,t,s){e.playlistParsingError=new Error(`#EXT-X-${t} must not appear more than once (${s[0]})`)}function Rs(e,t,s){e.playlistParsingError=new Error(`#EXT-X-${t} must appear before the first Media Segment (${s[0]})`)}function Is(e,t){const s=t.startPTS;if(i(s)){let i,n=0;t.sn>e.sn?(n=s-e.start,i=e):(n=e.start-s,i=t),i.duration!==n&&i.setDuration(n)}else t.sn>e.sn?e.cc===t.cc&&e.minEndPTS?t.setStart(e.start+(e.minEndPTS-e.start)):t.setStart(e.start+e.duration):t.setStart(Math.max(e.start-t.duration,0))}function xs(e,t,s,n,r,a){n-s<=0&&(R.warn("Fragment should have a positive duration",t),n=s+t.duration,a=r+t.duration);let o=s,l=n;const d=t.startPTS,c=t.endPTS;if(i(d)){const e=Math.abs(d-s);i(t.deltaPTS)?t.deltaPTS=Math.max(e,t.deltaPTS):t.deltaPTS=e,o=Math.max(s,d),s=Math.min(s,d),r=Math.min(r,t.startDTS),l=Math.min(n,c),n=Math.max(n,c),a=Math.max(a,t.endDTS)}const h=s-t.start;0!==t.start&&t.setStart(s),t.setDuration(n-t.start),t.startPTS=s,t.maxStartPTS=o,t.startDTS=r,t.endPTS=n,t.minEndPTS=l,t.endDTS=a;const u=t.sn;if(!e||u<e.startSN||u>e.endSN)return 0;let f;const g=u-e.startSN,m=e.fragments;for(m[g]=t,f=g;f>0;f--)Is(m[f],m[f-1]);for(f=g;f<m.length-1;f++)Is(m[f],m[f+1]);return e.fragmentHint&&Is(m[m.length-1],e.fragmentHint),e.PTSKnown=e.alignedSliding=!0,h}function ks(e,t,s,i,n){return new Error(`${e} ${n.url}\nPlaylist starting @${t.startSN}\n${t.m3u8}\n\nPlaylist starting @${s.startSN}\n${s.m3u8}`)}function Ds(e,t,s=!0){const i=t.startSN+t.skippedSegments-e.startSN,n=e.fragments,r=i>=0;let a=0;if(r&&i<n.length)a=n[i].start;else if(r&&t.startSN===e.endSN+1)a=e.fragmentEnd;else if(r&&s)a=e.fragmentStart+i*t.levelTargetDuration;else{if(t.skippedSegments||0!==t.fragmentStart)return;a=e.fragmentStart}_s(t,a)}function _s(e,t){if(t){const s=e.fragments;for(let i=e.skippedSegments;i<s.length;i++)s[i].addStart(t);e.fragmentHint&&e.fragmentHint.addStart(t)}}function Cs(e,t=1/0){let s=1e3*e.targetduration;if(e.updated){const i=e.fragments,n=4;if(i.length&&s*n>t){const e=1e3*i[i.length-1].duration;e<s&&(s=e)}}else s/=2;return Math.round(s)}function Ps(e,t,s){if(!e)return null;let i=e.fragments[t-e.startSN];return i||(i=e.fragmentHint,i&&i.sn===t?i:t<e.startSN&&s&&s.sn===t?s:null)}function Ms(e,t,s){return e?Os(e.partList,t,s):null}function Os(e,t,s){if(e)for(let i=e.length;i--;){const n=e[i];if(n.index===s&&n.fragment.sn===t)return n}return null}function Fs(e){e.forEach((e,t)=>{var s;null==(s=e.details)||s.fragments.forEach(e=>{e.level=t,e.initSegment&&(e.initSegment.level=t)})})}function Ns(e,t){for(let i=0,n=e.length;i<n;i++){var s;if((null==(s=e[i])?void 0:s.cc)===t)return e[i]}return null}function Bs(e,t){if(e){const s=e.start+t;e.start=e.startPTS=s,e.endPTS=s+e.duration}}function Us(e,t){const s=t.fragments;for(let t=0,i=s.length;t<i;t++)Bs(s[t],e);t.fragmentHint&&Bs(t.fragmentHint,e),t.alignedSliding=!0}function $s(e,t){if(!function(e,t){return!!(e&&t.startCC<e.endCC&&t.endCC>e.startCC)}(t,e))return;const s=Math.min(t.endCC,e.endCC),i=Ns(t.fragments,s),n=Ns(e.fragments,s);i&&n&&(R.log(`Aligning playlist at start of dicontinuity sequence ${s}`),Us(i.start-n.start,e))}function Gs(e,t){if(!e.hasProgramDateTime||!t.hasProgramDateTime)return;const s=e.fragments,i=t.fragments;if(!s.length||!i.length)return;let n,r;const a=Math.min(t.endCC,e.endCC);t.startCC<a&&e.startCC<a&&(n=Ns(i,a),r=Ns(s,a)),n&&r||(n=i[Math.floor(i.length/2)],r=Ns(s,n.cc)||s[Math.floor(s.length/2)]);const o=n.programDateTime,l=r.programDateTime;o&&l&&Us((l-o)/1e3-(r.start-n.start),e)}const js="STOPPED",Hs="IDLE",Vs="KEY_LOADING",Ks="FRAG_LOADING",qs="FRAG_LOADING_WAITING_RETRY",Ys="WAITING_TRACK",Ws="PARSING",zs="PARSED",Xs="ENDED",Zs="ERROR",Qs="WAITING_INIT_PTS",Js="WAITING_LEVEL";class ei extends Mt{constructor(e,t,s,n,r){super(n,e.logger),this.hls=void 0,this.fragPrevious=null,this.fragCurrent=null,this.fragmentTracker=void 0,this.transmuxer=null,this._state=js,this.playlistType=void 0,this.media=null,this.mediaBuffer=null,this.config=void 0,this.bitrateTest=!1,this.lastCurrentTime=0,this.nextLoadPosition=0,this.startPosition=0,this.startTimeOffset=null,this.retryDate=0,this.levels=null,this.fragmentLoader=void 0,this.keyLoader=void 0,this.levelLastLoaded=null,this.startFragRequested=!1,this.decrypter=void 0,this.initPTS=[],this.buffering=!0,this.loadingParts=!1,this.loopSn=void 0,this.onMediaSeeking=()=>{const{config:e,fragCurrent:t,media:s,mediaBuffer:n,state:r}=this,a=s?s.currentTime:0,o=Nt.bufferInfo(n||s,a,e.maxBufferHole),l=!o.len;if(this.log(`Media seeking to ${i(a)?a.toFixed(3):a}, state: ${r}, ${l?"out of":"in"} buffer`),this.state===Xs)this.resetLoadingState();else if(t){const s=e.maxFragLookUpTolerance,i=t.start-s,n=t.start+t.duration+s;if(l||n<o.start||i>o.end){const e=a>n;(a<i||e)&&(e&&t.loader&&(this.log(`Cancelling fragment load for seek (sn: ${t.sn})`),t.abortRequests(),this.resetLoadingState()),this.fragPrevious=null)}}if(s&&(this.fragmentTracker.removeFragmentsInRange(a,1/0,this.playlistType,!0),a>this.lastCurrentTime&&(this.lastCurrentTime=a),!this.loadingParts)){const e=Math.max(o.end,a),t=this.shouldLoadParts(this.getLevelDetails(),e);t&&(this.log(`LL-Part loading ON after seeking to ${a.toFixed(2)} with buffer @${e.toFixed(2)}`),this.loadingParts=t)}this.hls.hasEnoughToStart||(this.log(`Setting ${l?"startPosition":"nextLoadPosition"} to ${a} for seek without enough to start`),this.nextLoadPosition=a,l&&(this.startPosition=a)),this.tickImmediate()},this.onMediaEnded=()=>{this.log("setting startPosition to 0 because media ended"),this.startPosition=this.lastCurrentTime=0},this.playlistType=r,this.hls=e,this.fragmentLoader=new Dt(e.config),this.keyLoader=s,this.fragmentTracker=t,this.config=e.config,this.decrypter=new xt(e.config)}registerListeners(){const{hls:e}=this;e.on(l.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(l.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(l.MANIFEST_LOADING,this.onManifestLoading,this),e.on(l.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(l.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(l.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(l.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(l.MANIFEST_LOADING,this.onManifestLoading,this),e.off(l.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(l.ERROR,this.onError,this)}doTick(){this.onTickEnd()}onTickEnd(){}startLoad(e){}stopLoad(){if(this.state===js)return;this.fragmentLoader.abort(),this.keyLoader.abort(this.playlistType);const e=this.fragCurrent;null!=e&&e.loader&&(e.abortRequests(),this.fragmentTracker.removeFragment(e)),this.resetTransmuxer(),this.fragCurrent=null,this.fragPrevious=null,this.clearInterval(),this.clearNextTick(),this.state=js}get startPositionValue(){const{nextLoadPosition:e,startPosition:t}=this;return-1===t&&e?e:t}get bufferingEnabled(){return this.buffering}pauseBuffering(){this.buffering=!1}resumeBuffering(){this.buffering=!0}get inFlightFrag(){return{frag:this.fragCurrent,state:this.state}}_streamEnded(e,t){if(t.live||!this.media)return!1;const s=e.end||0,i=this.config.timelineOffset||0;if(s<=i)return!1;const n=e.buffered;this.config.maxBufferHole&&n&&n.length>1&&(e=Nt.bufferedInfo(n,e.start,0));const r=e.nextStart;if(r&&r>i&&r<t.edge)return!1;if(this.media.currentTime<e.start)return!1;const a=t.partList;if(null!=a&&a.length){const e=a[a.length-1];return Nt.isBuffered(this.media,e.start+e.duration/2)}const o=t.fragments[t.fragments.length-1].type;return this.fragmentTracker.isEndListAppended(o)}getLevelDetails(){var e;if(this.levels&&null!==this.levelLastLoaded)return null==(e=this.levelLastLoaded)?void 0:e.details}get timelineOffset(){const e=this.config.timelineOffset;var t;return e?(null==(t=this.getLevelDetails())?void 0:t.appliedTimelineOffset)||e:0}onMediaAttached(e,t){const s=this.media=this.mediaBuffer=t.media;s.removeEventListener("seeking",this.onMediaSeeking),s.removeEventListener("ended",this.onMediaEnded),s.addEventListener("seeking",this.onMediaSeeking),s.addEventListener("ended",this.onMediaEnded);const i=this.config;this.levels&&i.autoStartLoad&&this.state===js&&this.startLoad(i.startPosition)}onMediaDetaching(e,t){const s=!!t.transferMedia,i=this.media;if(null!==i){if(i.ended&&(this.log("MSE detaching and video ended, reset startPosition"),this.startPosition=this.lastCurrentTime=0),i.removeEventListener("seeking",this.onMediaSeeking),i.removeEventListener("ended",this.onMediaEnded),this.keyLoader&&!s&&this.keyLoader.detach(),this.media=this.mediaBuffer=null,this.loopSn=void 0,s)return this.resetLoadingState(),void this.resetTransmuxer();this.loadingParts=!1,this.fragmentTracker.removeAllFragments(),this.stopLoad()}}onManifestLoading(){this.initPTS=[],this.levels=this.levelLastLoaded=this.fragCurrent=null,this.lastCurrentTime=this.startPosition=0,this.startFragRequested=!1}onError(e,t){}onManifestLoaded(e,t){this.startTimeOffset=t.startTimeOffset}onHandlerDestroying(){this.stopLoad(),this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null),super.onHandlerDestroying(),this.hls=this.onMediaSeeking=this.onMediaEnded=null}onHandlerDestroyed(){this.state=js,this.fragmentLoader&&this.fragmentLoader.destroy(),this.keyLoader&&this.keyLoader.destroy(),this.decrypter&&this.decrypter.destroy(),this.hls=this.log=this.warn=this.decrypter=this.keyLoader=this.fragmentLoader=this.fragmentTracker=null,super.onHandlerDestroyed()}loadFragment(e,t,s){this.startFragRequested=!0,this._loadFragForPlayback(e,t,s)}_loadFragForPlayback(e,t,s){this._doFragLoad(e,t,s,e=>{const t=e.frag;if(this.fragContextChanged(t))return this.warn(`${t.type} sn: ${t.sn}${e.part?" part: "+e.part.index:""} of ${this.fragInfo(t,!1,e.part)}) was dropped during download.`),void this.fragmentTracker.removeFragment(t);t.stats.chunkCount++,this._handleFragmentLoadProgress(e)}).then(e=>{if(!e)return;const t=this.state,s=e.frag;this.fragContextChanged(s)?(t===Ks||!this.fragCurrent&&t===Ws)&&(this.fragmentTracker.removeFragment(s),this.state=Hs):("payload"in e&&(this.log(`Loaded ${s.type} sn: ${s.sn} of ${this.playlistLabel()} ${s.level}`),this.hls.trigger(l.FRAG_LOADED,e)),this._handleFragmentLoadComplete(e))}).catch(t=>{this.state!==js&&this.state!==Zs&&(this.warn(`Frag error: ${(null==t?void 0:t.message)||t}`),this.resetFragmentLoading(e))})}clearTrackerIfNeeded(e){var t;const{fragmentTracker:s}=this;if(s.getState(e)===vt){const t=e.type,i=this.getFwdBufferInfo(this.mediaBuffer,t),n=Math.max(e.duration,i?i.len:this.config.maxBufferLength),r=this.backtrackFragment;(1===(r?e.sn-r.sn:0)||this.reduceMaxBufferLength(n,e.duration))&&s.removeFragment(e)}else 0===(null==(t=this.mediaBuffer)?void 0:t.buffered.length)?s.removeAllFragments():s.hasParts(e.type)&&(s.detectPartialFragments({frag:e,part:null,stats:e.stats,id:e.type}),s.getState(e)===Et&&s.removeFragment(e))}checkLiveUpdate(e){if(e.updated&&!e.live){const t=e.fragments[e.fragments.length-1];this.fragmentTracker.detectPartialFragments({frag:t,part:null,stats:t.stats,id:t.type})}e.fragments[0]||(e.deltaUpdateFailed=!0)}waitForLive(e){const t=e.details;return(null==t?void 0:t.live)&&"EVENT"!==t.type&&(this.levelLastLoaded!==e||t.expired)}flushMainBuffer(e,t,s=null){if(!(e-t))return;const i={startOffset:e,endOffset:t,type:s};this.hls.trigger(l.BUFFER_FLUSHING,i)}_loadInitSegment(e,t){this._doFragLoad(e,t).then(e=>{const t=null==e?void 0:e.frag;if(!t||this.fragContextChanged(t)||!this.levels)throw new Error("init load aborted");return e}).then(e=>{const{hls:t}=this,{frag:s,payload:i}=e,n=s.decryptdata;if(i&&i.byteLength>0&&null!=n&&n.key&&n.iv&&Xt(n.method)){const r=self.performance.now();return this.decrypter.decrypt(new Uint8Array(i),n.key.buffer,n.iv.buffer,Zt(n.method)).catch(e=>{throw t.trigger(l.ERROR,{type:a.MEDIA_ERROR,details:o.FRAG_DECRYPT_ERROR,fatal:!1,error:e,reason:e.message,frag:s}),e}).then(i=>{const n=self.performance.now();return t.trigger(l.FRAG_DECRYPTED,{frag:s,payload:i,stats:{tstart:r,tdecrypt:n}}),e.payload=i,this.completeInitSegmentLoad(e)})}return this.completeInitSegmentLoad(e)}).catch(t=>{this.state!==js&&this.state!==Zs&&(this.warn(t),this.resetFragmentLoading(e))})}completeInitSegmentLoad(e){const{levels:t}=this;if(!t)throw new Error("init load aborted, missing levels");const s=e.frag.stats;this.state!==js&&(this.state=Hs),e.frag.data=new Uint8Array(e.payload),s.parsing.start=s.buffering.start=self.performance.now(),s.parsing.end=s.buffering.end=self.performance.now(),this.tick()}fragContextChanged(e){const{fragCurrent:t}=this;return!e||!t||e.sn!==t.sn||e.level!==t.level}fragBufferedComplete(e,t){const s=this.mediaBuffer?this.mediaBuffer:this.media;if(this.log(`Buffered ${e.type} sn: ${e.sn}${t?" part: "+t.index:""} of ${this.fragInfo(e,!1,t)} > buffer:${s?function(e){let t="";const s=e.length;for(let i=0;i<s;i++)t+=`[${e.start(i).toFixed(3)}-${e.end(i).toFixed(3)}]`;return t}(Nt.getBuffered(s)):"(detached)"})`),q(e)){var i;if(e.type!==f.SUBTITLE){const t=e.elementaryStreams;if(!Object.keys(t).some(e=>!!t[e]))return void(this.state=Hs)}const t=null==(i=this.levels)?void 0:i[e.level];null!=t&&t.fragmentError&&(this.log(`Resetting level fragment error count of ${t.fragmentError} on frag buffered`),t.fragmentError=0)}this.state=Hs}_handleFragmentLoadComplete(e){const{transmuxer:t}=this;if(!t)return;const{frag:s,part:i,partsLoaded:n}=e,r=!n||0===n.length||n.some(e=>!e),a=new Ot(s.level,s.sn,s.stats.chunkCount+1,0,i?i.index:-1,!r);t.flush(a)}_handleFragmentLoadProgress(e){}_doFragLoad(e,t,s=null,n){var r;this.fragCurrent=e;const a=null==t?void 0:t.details;if(!this.levels||!a)throw new Error(`frag load aborted, missing level${a?"":" detail"}s`);let o=null;!e.encrypted||null!=(r=e.decryptdata)&&r.key?e.encrypted||(o=this.keyLoader.loadClear(e,a.encryptedFragments,this.startFragRequested),o&&this.log("[eme] blocking frag load until media-keys acquired")):(this.log(`Loading key for ${e.sn} of [${a.startSN}-${a.endSN}], ${this.playlistLabel()} ${e.level}`),this.state=Vs,this.fragCurrent=e,o=this.keyLoader.load(e).then(e=>{if(!this.fragContextChanged(e.frag))return this.hls.trigger(l.KEY_LOADED,e),this.state===Vs&&(this.state=Hs),e}),this.hls.trigger(l.KEY_LOADING,{frag:e}),null===this.fragCurrent&&(o=Promise.reject(new Error("frag load aborted, context changed in KEY_LOADING"))));const d=this.fragPrevious;if(q(e)&&(!d||e.sn!==d.sn)){const s=this.shouldLoadParts(t.details,e.end);s!==this.loadingParts&&(this.log(`LL-Part loading ${s?"ON":"OFF"} loading sn ${null==d?void 0:d.sn}->${e.sn}`),this.loadingParts=s)}if(s=Math.max(e.start,s||0),this.loadingParts&&q(e)){const i=a.partList;if(i&&n){s>e.end&&a.fragmentHint&&(e=a.fragmentHint);const r=this.getNextPart(i,e,s);if(r>-1){const d=i[r];let c;return e=this.fragCurrent=d.fragment,this.log(`Loading ${e.type} sn: ${e.sn} part: ${d.index} (${r}/${i.length-1}) of ${this.fragInfo(e,!1,d)}) cc: ${e.cc} [${a.startSN}-${a.endSN}], target: ${parseFloat(s.toFixed(3))}`),this.nextLoadPosition=d.start+d.duration,this.state=Ks,c=o?o.then(s=>!s||this.fragContextChanged(s.frag)?null:this.doFragPartsLoad(e,d,t,n)).catch(e=>this.handleFragLoadError(e)):this.doFragPartsLoad(e,d,t,n).catch(e=>this.handleFragLoadError(e)),this.hls.trigger(l.FRAG_LOADING,{frag:e,part:d,targetBufferTime:s}),null===this.fragCurrent?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING parts")):c}if(!e.url||this.loadedEndOfParts(i,s))return Promise.resolve(null)}}if(q(e)&&this.loadingParts)this.log(`LL-Part loading OFF after next part miss @${s.toFixed(2)}`),this.loadingParts=!1;else if(!e.url)return Promise.resolve(null);this.log(`Loading ${e.type} sn: ${e.sn} of ${this.fragInfo(e,!1)}) cc: ${e.cc} ${a?"["+a.startSN+"-"+a.endSN+"]":""}, target: ${parseFloat(s.toFixed(3))}`),i(e.sn)&&!this.bitrateTest&&(this.nextLoadPosition=e.start+e.duration),this.state=Ks;const c=this.config.progressive;let h;return h=c&&o?o.then(t=>!t||this.fragContextChanged(null==t?void 0:t.frag)?null:this.fragmentLoader.load(e,n)).catch(e=>this.handleFragLoadError(e)):Promise.all([this.fragmentLoader.load(e,c?n:void 0),o]).then(([e])=>(!c&&e&&n&&n(e),e)).catch(e=>this.handleFragLoadError(e)),this.hls.trigger(l.FRAG_LOADING,{frag:e,targetBufferTime:s}),null===this.fragCurrent?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING")):h}doFragPartsLoad(e,t,s,i){return new Promise((n,r)=>{var a;const o=[],d=null==(a=s.details)?void 0:a.partList,c=t=>{this.fragmentLoader.loadPart(e,t,i).then(i=>{o[t.index]=i;const r=i.part;this.hls.trigger(l.FRAG_LOADED,i);const a=Ms(s.details,e.sn,t.index+1)||Os(d,e.sn,t.index+1);if(!a)return n({frag:e,part:r,partsLoaded:o});c(a)}).catch(r)};c(t)})}handleFragLoadError(e){if("data"in e){const t=e.data;e.data&&t.details===o.INTERNAL_ABORTED?this.handleFragLoadAborted(t.frag,t.part):this.hls.trigger(l.ERROR,t)}else this.hls.trigger(l.ERROR,{type:a.OTHER_ERROR,details:o.INTERNAL_EXCEPTION,err:e,error:e,fatal:!0});return null}_handleTransmuxerFlush(e){const t=this.getCurrentContext(e);if(!t||this.state!==Ws)return void(this.fragCurrent||this.state===js||this.state===Zs||(this.state=Hs));const{frag:s,part:i,level:n}=t,r=self.performance.now();s.stats.parsing.end=r,i&&(i.stats.parsing.end=r);const a=this.getLevelDetails(),o=a&&s.sn>a.endSN||this.shouldLoadParts(a,s.end);o!==this.loadingParts&&(this.log(`LL-Part loading ${o?"ON":"OFF"} after parsing segment ending @${s.end.toFixed(2)}`),this.loadingParts=o),this.updateLevelTiming(s,i,n,e.partial)}shouldLoadParts(e,t){if(this.config.lowLatencyMode){if(!e)return this.loadingParts;if(null!=e&&e.partList){var s;const n=e.partList[0];var i;if(t>=n.end+((null==(s=e.fragmentHint)?void 0:s.duration)||0)&&(this.hls.hasEnoughToStart?(null==(i=this.media)?void 0:i.currentTime)||this.lastCurrentTime:this.getLoadPosition())>n.start-n.fragment.duration)return!0}}return!1}getCurrentContext(e){const{levels:t,fragCurrent:s}=this,{level:i,sn:n,part:r}=e;if(null==t||!t[i])return this.warn(`Levels object was unset while buffering fragment ${n} of ${this.playlistLabel()} ${i}. The current chunk will not be buffered.`),null;const a=t[i],o=a.details,l=r>-1?Ms(o,n,r):null,d=l?l.fragment:Ps(o,n,s);return d?(s&&s!==d&&(d.stats=s.stats),{frag:d,part:l,level:a}):null}bufferFragmentData(e,t,s,i,n){var r;if(!e||this.state!==Ws)return;const{data1:a,data2:o}=e;let d=a;if(a&&o&&(d=ue(a,o)),null==(r=d)||!r.length)return;const c=this.initPTS[t.cc],h=c?-c.baseTime/c.timescale:void 0,u={type:e.type,frag:t,part:s,chunkMeta:i,offset:h,parent:t.type,data:d};if(this.hls.trigger(l.BUFFER_APPENDING,u),e.dropped&&e.independent&&!s){if(n)return;this.flushBufferGap(t)}}flushBufferGap(e){const t=this.media;if(!t)return;if(!Nt.isBuffered(t,t.currentTime))return void this.flushMainBuffer(0,e.start);const s=t.currentTime,i=Nt.bufferInfo(t,s,0),n=e.duration,r=Math.min(2*this.config.maxFragLookUpTolerance,.25*n),a=Math.max(Math.min(e.start-r,i.end-r),s+r);e.start-a>r&&this.flushMainBuffer(a,e.start)}getFwdBufferInfo(e,t){var s;const n=this.getLoadPosition();if(!i(n))return null;const r=this.lastCurrentTime>n||null!=(s=this.media)&&s.paused?0:this.config.maxBufferHole;return this.getFwdBufferInfoAtPos(e,n,t,r)}getFwdBufferInfoAtPos(e,t,s,i){const n=Nt.bufferInfo(e,t,i);if(0===n.len&&void 0!==n.nextStart){const r=this.fragmentTracker.getBufferedFrag(t,s);if(r&&(n.nextStart<=r.end||r.gap)){const s=Math.max(Math.min(n.nextStart,r.end)-t,i);return Nt.bufferInfo(e,t,s)}}return n}getMaxBufferLength(e){const{config:t}=this;let s;return s=e?Math.max(8*t.maxBufferSize/e,t.maxBufferLength):t.maxBufferLength,Math.min(s,t.maxMaxBufferLength)}reduceMaxBufferLength(e,t){const s=this.config,i=Math.max(Math.min(e-t,s.maxBufferLength),t),n=Math.max(e-3*t,s.maxMaxBufferLength/2,i);return n>=i&&(s.maxMaxBufferLength=n,this.warn(`Reduce max buffer length to ${n}s`),!0)}getAppendedFrag(e,t=f.MAIN){var s;const i=null==(s=this.fragmentTracker)?void 0:s.getAppendedFrag(e,t);return i&&"fragment"in i?i.fragment:i}getNextFragment(e,t){const s=t.fragments,i=s.length;if(!i)return null;const{config:n}=this,r=s[0].start,a=n.lowLatencyMode&&!!t.partList;let o=null;if(t.live){const s=n.initialLiveManifestSize;if(i<s)return this.warn(`Not enough fragments to start playback (have: ${i}, need: ${s})`),null;if(!t.PTSKnown&&!this.startFragRequested&&-1===this.startPosition||e<r){var l;a&&!this.loadingParts&&(this.log("LL-Part loading ON for initial live fragment"),this.loadingParts=!0),o=this.getInitialLiveFragment(t);const s=this.hls.startPosition,i=this.hls.liveSyncPosition,n=o?(-1!==s&&s>=r?s:i)||o.start:e;this.log(`Setting startPosition to ${n} to match start frag at live edge. mainStart: ${s} liveSyncPosition: ${i} frag.start: ${null==(l=o)?void 0:l.start}`),this.startPosition=this.nextLoadPosition=n}}else e<=r&&(o=s[0]);if(!o){const s=this.loadingParts?t.partEnd:t.fragmentEnd;o=this.getFragmentAtPosition(e,s,t)}let d=this.filterReplacedPrimary(o,t);if(!d&&o){const e=o.sn-t.startSN;d=this.filterReplacedPrimary(s[e+1]||null,t)}return this.mapToInitFragWhenRequired(d)}isLoopLoading(e,t){const s=this.fragmentTracker.getState(e);return(s===Tt||s===Et&&!!e.gap)&&this.nextLoadPosition>t}getNextFragmentLoopLoading(e,t,s,i,n){let r=null;if(e.gap&&(r=this.getNextFragment(this.nextLoadPosition,t),r&&!r.gap&&s.nextStart)){const e=this.getFwdBufferInfoAtPos(this.mediaBuffer?this.mediaBuffer:this.media,s.nextStart,i,0);if(null!==e&&s.len+e.len>=n){const e=r.sn;return this.loopSn!==e&&(this.log(`buffer full after gaps in "${i}" playlist starting at sn: ${e}`),this.loopSn=e),null}}return this.loopSn=void 0,r}get primaryPrefetch(){var e,t;return!(!ti(this.hls.config)||!(null==(e=this.hls.interstitialsManager)||null==(t=e.playingItem)?void 0:t.event))}filterReplacedPrimary(e,t){if(!e)return e;if(ti(this.hls.config)&&e.type!==f.SUBTITLE){const s=this.hls.interstitialsManager,i=null==s?void 0:s.bufferingItem;if(i){const s=i.event;if(s){if(s.appendInPlace||Math.abs(e.start-i.start)>1||0===i.start)return null}else{if(e.end<=i.start&&!1===(null==t?void 0:t.live))return null;if(e.start>i.end&&i.nextEvent&&(i.nextEvent.appendInPlace||e.start-i.end>1))return null}}const n=null==s?void 0:s.playerQueue;if(n)for(let t=n.length;t--;){const s=n[t].interstitial;if(s.appendInPlace&&e.start>=s.startTime&&e.end<=s.resumeTime)return null}}return e}mapToInitFragWhenRequired(e){return null==e||!e.initSegment||null!=e&&e.initSegment.data||this.bitrateTest?e:e.initSegment}getNextPart(e,t,s){let i=-1,n=!1,r=!0;for(let a=0,o=e.length;a<o;a++){const o=e[a];if(r=r&&!o.independent,i>-1&&s<o.start)break;const l=o.loaded;l?i=-1:(n||o.independent||r)&&o.fragment===t&&(i=a),n=l}return i}loadedEndOfParts(e,t){const s=e[e.length-1];return s&&t>s.start&&s.loaded}getInitialLiveFragment(e){const t=e.fragments,s=this.fragPrevious;let n=null;if(s){if(e.hasProgramDateTime&&(this.log(`Live playlist, switching playlist, load frag with same PDT: ${s.programDateTime}`),n=function(e,t,s){if(null===t||!Array.isArray(e)||!e.length||!i(t))return null;if(t<(e[0].programDateTime||0))return null;if(t>=(e[e.length-1].endProgramDateTime||0))return null;for(let i=0;i<e.length;++i){const n=e[i];if(at(t,s,n))return n}return null}(t,s.endProgramDateTime,this.config.maxFragLookUpTolerance)),!n){const i=s.sn+1;if(i>=e.startSN&&i<=e.endSN){const r=t[i-e.startSN];s.cc===r.cc&&(n=r,this.log(`Live playlist, switching playlist, load frag with next SN: ${n.sn}`))}n||(n=ot(e,s.cc,s.end),n&&this.log(`Live playlist, switching playlist, load frag with same CC: ${n.sn}`))}}else{const t=this.hls.liveSyncPosition;null!==t&&(n=this.getFragmentAtPosition(t,this.bitrateTest?e.fragmentEnd:e.edge,e))}return n}getFragmentAtPosition(e,t,s){const{config:i}=this;let{fragPrevious:n}=this,{fragments:r,endSN:a}=s;const{fragmentHint:o}=s,{maxFragLookUpTolerance:l}=i,d=s.partList,c=!!(this.loadingParts&&null!=d&&d.length&&o);let h;var u;if(c&&o&&!this.bitrateTest&&d[d.length-1].fragment.sn===o.sn&&(r=r.concat(o),a=o.sn),h=e<t?nt(n,r,e,e<this.lastCurrentTime||e>t-l||null!=(u=this.media)&&u.paused||!this.startFragRequested?0:l):r[r.length-1],h){const e=h.sn-s.startSN,t=this.fragmentTracker.getState(h);if((t===Tt||t===Et&&h.gap)&&(n=h),n&&h.sn===n.sn&&(!c||d[0].fragment.sn>h.sn||!s.live&&!c)&&n&&h.level===n.level){const t=r[e+1];h=h.sn<a&&this.fragmentTracker.getState(t)!==Tt?t:null}}return h}alignPlaylists(e,t,s){const n=e.fragments.length;if(!n)return this.warn("No fragments in live playlist"),0;const r=e.fragmentStart,a=!t,o=e.alignedSliding&&i(r);if(a||!o&&!r){!function(e,t){e&&($s(t,e),!t.alignedSliding&&e&&Gs(t,e),t.alignedSliding||!e||t.skippedSegments||Ds(e,t,!1))}(s,e);const i=e.fragmentStart;return this.log(`Live playlist sliding: ${i.toFixed(2)} start-sn: ${t?t.startSN:"na"}->${e.startSN} fragments: ${n}`),i}return r}waitForCdnTuneIn(e){return e.live&&e.canBlockReload&&e.partTarget&&e.tuneInGoal>Math.max(e.partHoldBack,3*e.partTarget)}setStartPosition(e,t){let s=this.startPosition;s<t&&(s=-1);const n=this.timelineOffset;if(-1===s){const r=null!==this.startTimeOffset,a=r?this.startTimeOffset:e.startTimeOffset;null!==a&&i(a)?(s=t+a,a<0&&(s+=e.edge),s=Math.min(Math.max(t,s),t+e.totalduration),this.log(`Setting startPosition to ${s} for start time offset ${a} found in ${r?"multivariant":"media"} playlist`),this.startPosition=s):e.live?(s=this.hls.liveSyncPosition||t,this.log(`Setting startPosition to -1 to start at live edge ${s}`),this.startPosition=-1):(this.log("setting startPosition to 0 by default"),this.startPosition=s=0),this.lastCurrentTime=s+n}this.nextLoadPosition=s+n}getLoadPosition(){var e;const{media:t}=this;let s=0;return null!=(e=this.hls)&&e.hasEnoughToStart&&t?s=t.currentTime:this.nextLoadPosition>=0&&(s=this.nextLoadPosition),s}handleFragLoadAborted(e,t){this.transmuxer&&e.type===this.playlistType&&q(e)&&e.stats.aborted&&(this.log(`Fragment ${e.sn}${t?" part "+t.index:""} of ${this.playlistLabel()} ${e.level} was aborted`),this.resetFragmentLoading(e))}resetFragmentLoading(e){this.fragCurrent&&(this.fragContextChanged(e)||this.state===qs)||(this.state=Hs)}onFragmentOrKeyLoadError(e,t){if(t.chunkMeta&&!t.frag){const e=this.getCurrentContext(t.chunkMeta);e&&(t.frag=e.frag)}const s=t.frag;if(!s||s.type!==e||!this.levels)return;var i;if(this.fragContextChanged(s))return void this.warn(`Frag load error must match current frag to retry ${s.url} > ${null==(i=this.fragCurrent)?void 0:i.url}`);const n=t.details===o.FRAG_GAP;n&&this.fragmentTracker.fragBuffered(s,!0);const r=t.errorAction,{action:a,flags:l,retryCount:d=0,retryConfig:c}=r||{},h=!!r&&!!c,u=h&&a===ft.RetryRequest,f=h&&!r.resolved&&l===gt.MoveAllAlternatesMatchingHost;if(!u&&f&&q(s)&&!s.endList)this.resetFragmentErrors(e),this.treatAsGap(s),r.resolved=!0;else if((u||f)&&d<c.maxNumRetry){this.resetStartWhenNotLoaded(this.levelLastLoaded);const i=ct(c,d);this.warn(`Fragment ${s.sn} of ${e} ${s.level} errored with ${t.details}, retrying loading ${d+1}/${c.maxNumRetry} in ${i}ms`),r.resolved=!0,this.retryDate=self.performance.now()+i,this.state=qs}else if(c&&r){if(this.resetFragmentErrors(e),!(d<c.maxNumRetry))return void this.warn(`${t.details} reached or exceeded max retry (${d})`);n||a===ft.RemoveAlternatePermanently||(r.resolved=!0)}else a===ft.SendAlternateToPenaltyBox?this.state=Js:this.state=Zs;this.tickImmediate()}reduceLengthAndFlushBuffer(e){if(this.state===Ws||this.state===zs){const t=e.frag,s=e.parent,i=this.getFwdBufferInfo(this.mediaBuffer,s),n=i&&i.len>.5;n&&this.reduceMaxBufferLength(i.len,(null==t?void 0:t.duration)||10);const r=!n;return r&&this.warn(`Buffer full error while media.currentTime is not buffered, flush ${s} buffer`),t&&(this.fragmentTracker.removeFragment(t),this.nextLoadPosition=t.start),this.resetLoadingState(),r}return!1}resetFragmentErrors(e){e===f.AUDIO&&(this.fragCurrent=null),this.hls.hasEnoughToStart||(this.startFragRequested=!1),this.state!==js&&(this.state=Hs)}afterBufferFlushed(e,t,s){if(!e)return;const i=Nt.getBuffered(e);this.fragmentTracker.detectEvictedFragments(t,i,s),this.state===Xs&&this.resetLoadingState()}resetLoadingState(){this.log("Reset loading state"),this.fragCurrent=null,this.fragPrevious=null,this.state!==js&&(this.state=Hs)}resetStartWhenNotLoaded(e){if(!this.hls.hasEnoughToStart){this.startFragRequested=!1;const t=e?e.details:null;null!=t&&t.live?(this.log("resetting startPosition for live start"),this.startPosition=-1,this.setStartPosition(t,t.fragmentStart),this.resetLoadingState()):this.nextLoadPosition=this.startPosition}}resetWhenMissingContext(e){this.warn(`The loading context changed while buffering fragment ${e.sn} of ${this.playlistLabel()} ${e.level}. This chunk will not be buffered.`),this.removeUnbufferedFrags(),this.resetStartWhenNotLoaded(this.levelLastLoaded),this.resetLoadingState()}removeUnbufferedFrags(e=0){this.fragmentTracker.removeFragmentsInRange(e,1/0,this.playlistType,!1,!0)}updateLevelTiming(e,t,s,i){const n=s.details;if(n){var r;if(!Object.keys(e.elementaryStreams).reduce((t,r)=>{const a=e.elementaryStreams[r];if(a){const o=a.endPTS-a.startPTS;if(o<=0)return this.warn(`Could not parse fragment ${e.sn} ${r} duration reliably (${o})`),t||!1;const d=i?0:xs(n,e,a.startPTS,a.endPTS,a.startDTS,a.endDTS);return this.hls.trigger(l.LEVEL_PTS_UPDATED,{details:n,level:s,drift:d,type:r,frag:e,start:a.startPTS,end:a.endPTS}),!0}return t},!1)&&(0===s.fragmentError&&this.treatAsGap(e,s),null===(null==(r=this.transmuxer)?void 0:r.error))){const t=new Error(`Found no media in fragment ${e.sn} of ${this.playlistLabel()} ${e.level} resetting transmuxer to fallback to playlist timing`);if(this.warn(t.message),this.hls.trigger(l.ERROR,{type:a.MEDIA_ERROR,details:o.FRAG_PARSING_ERROR,fatal:!1,error:t,frag:e,reason:`Found no media in msn ${e.sn} of ${this.playlistLabel()} "${s.url}"`}),!this.hls)return;this.resetTransmuxer()}this.state=zs,this.log(`Parsed ${e.type} sn: ${e.sn}${t?" part: "+t.index:""} of ${this.fragInfo(e,!1,t)})`),this.hls.trigger(l.FRAG_PARSED,{frag:e,part:t})}else this.warn("level.details undefined")}playlistLabel(){return this.playlistType===f.MAIN?"level":"track"}fragInfo(e,t=!0,s){var i,n;return`${this.playlistLabel()} ${e.level} (${s?"part":"frag"}:[${(null!=(i=t&&!s?e.startPTS:(s||e).start)?i:NaN).toFixed(3)}-${(null!=(n=t&&!s?e.endPTS:(s||e).end)?n:NaN).toFixed(3)}]${s&&"main"===e.type?"INDEPENDENT="+(s.independent?"YES":"NO"):""}`}treatAsGap(e,t){t&&t.fragmentError++,e.gap=!0,this.fragmentTracker.removeFragment(e),this.fragmentTracker.fragBuffered(e,!0)}resetTransmuxer(){var e;null==(e=this.transmuxer)||e.reset()}recoverWorkerError(e){"demuxerWorker"===e.event&&(this.fragmentTracker.removeAllFragments(),this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null),this.resetStartWhenNotLoaded(this.levelLastLoaded),this.resetLoadingState())}set state(e){const t=this._state;t!==e&&(this._state=e,this.log(`${t}->${e}`))}get state(){return this._state}}function ti(e){return!!e.interstitialsController&&!1!==e.enableInterstitialPlayback}class si{constructor(){this.chunks=[],this.dataLength=0}push(e){this.chunks.push(e),this.dataLength+=e.length}flush(){const{chunks:e,dataLength:t}=this;let s;return e.length?(s=1===e.length?e[0]:function(e,t){const s=new Uint8Array(t);let i=0;for(let t=0;t<e.length;t++){const n=e[t];s.set(n,i),i+=n.length}return s}(e,t),this.reset(),s):new Uint8Array(0)}reset(){this.chunks.length=0,this.dataLength=0}}var ii,ni={exports:{}},ri=(ii||(ii=1,function(e){var t=Object.prototype.hasOwnProperty,s="~";function i(){}function n(e,t,s){this.fn=e,this.context=t,this.once=s||!1}function r(e,t,i,r,a){if("function"!=typeof i)throw new TypeError("The listener must be a function");var o=new n(i,r||e,a),l=s?s+t:t;return e._events[l]?e._events[l].fn?e._events[l]=[e._events[l],o]:e._events[l].push(o):(e._events[l]=o,e._eventsCount++),e}function a(e,t){0===--e._eventsCount?e._events=new i:delete e._events[t]}function o(){this._events=new i,this._eventsCount=0}Object.create&&(i.prototype=Object.create(null),(new i).__proto__||(s=!1)),o.prototype.eventNames=function(){var e,i,n=[];if(0===this._eventsCount)return n;for(i in e=this._events)t.call(e,i)&&n.push(s?i.slice(1):i);return Object.getOwnPropertySymbols?n.concat(Object.getOwnPropertySymbols(e)):n},o.prototype.listeners=function(e){var t=s?s+e:e,i=this._events[t];if(!i)return[];if(i.fn)return[i.fn];for(var n=0,r=i.length,a=new Array(r);n<r;n++)a[n]=i[n].fn;return a},o.prototype.listenerCount=function(e){var t=s?s+e:e,i=this._events[t];return i?i.fn?1:i.length:0},o.prototype.emit=function(e,t,i,n,r,a){var o=s?s+e:e;if(!this._events[o])return!1;var l,d,c=this._events[o],h=arguments.length;if(c.fn){switch(c.once&&this.removeListener(e,c.fn,void 0,!0),h){case 1:return c.fn.call(c.context),!0;case 2:return c.fn.call(c.context,t),!0;case 3:return c.fn.call(c.context,t,i),!0;case 4:return c.fn.call(c.context,t,i,n),!0;case 5:return c.fn.call(c.context,t,i,n,r),!0;case 6:return c.fn.call(c.context,t,i,n,r,a),!0}for(d=1,l=new Array(h-1);d<h;d++)l[d-1]=arguments[d];c.fn.apply(c.context,l)}else{var u,f=c.length;for(d=0;d<f;d++)switch(c[d].once&&this.removeListener(e,c[d].fn,void 0,!0),h){case 1:c[d].fn.call(c[d].context);break;case 2:c[d].fn.call(c[d].context,t);break;case 3:c[d].fn.call(c[d].context,t,i);break;case 4:c[d].fn.call(c[d].context,t,i,n);break;default:if(!l)for(u=1,l=new Array(h-1);u<h;u++)l[u-1]=arguments[u];c[d].fn.apply(c[d].context,l)}}return!0},o.prototype.on=function(e,t,s){return r(this,e,t,s,!1)},o.prototype.once=function(e,t,s){return r(this,e,t,s,!0)},o.prototype.removeListener=function(e,t,i,n){var r=s?s+e:e;if(!this._events[r])return this;if(!t)return a(this,r),this;var o=this._events[r];if(o.fn)o.fn!==t||n&&!o.once||i&&o.context!==i||a(this,r);else{for(var l=0,d=[],c=o.length;l<c;l++)(o[l].fn!==t||n&&!o[l].once||i&&o[l].context!==i)&&d.push(o[l]);d.length?this._events[r]=1===d.length?d[0]:d:a(this,r)}return this},o.prototype.removeAllListeners=function(e){var t;return e?(t=s?s+e:e,this._events[t]&&a(this,t)):(this._events=new i,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=s,o.EventEmitter=o,e.exports=o}(ni)),ni.exports),ai=C(ri);const oi="1.6.7",li={};function di(e,t){return t+10<=e.length&&51===e[t]&&68===e[t+1]&&73===e[t+2]&&e[t+3]<255&&e[t+4]<255&&e[t+6]<128&&e[t+7]<128&&e[t+8]<128&&e[t+9]<128}function ci(e,t){return t+10<=e.length&&73===e[t]&&68===e[t+1]&&51===e[t+2]&&e[t+3]<255&&e[t+4]<255&&e[t+6]<128&&e[t+7]<128&&e[t+8]<128&&e[t+9]<128}function hi(e,t){let s=0;return s=(127&e[t])<<21,s|=(127&e[t+1])<<14,s|=(127&e[t+2])<<7,s|=127&e[t+3],s}function ui(e,t){const s=t;let i=0;for(;ci(e,t);)i+=10,i+=hi(e,t+6),di(e,t+10)&&(i+=10),t+=i;if(i>0)return e.subarray(s,s+i)}function fi(e,t){return 255===e[t]&&240==(246&e[t+1])}function gi(e,t){return 1&e[t+1]?7:9}function mi(e,t){return(3&e[t+3])<<11|e[t+4]<<3|(224&e[t+5])>>>5}function pi(e,t){return t+1<e.length&&fi(e,t)}function yi(e,t){if(pi(e,t)){const s=gi(e,t);if(t+s>=e.length)return!1;const i=mi(e,t);if(i<=s)return!1;const n=t+i;return n===e.length||pi(e,n)}return!1}function vi(e,t,s,i,n){if(!e.samplerate){const r=function(e,t,s,i){const n=t[s+2],r=n>>2&15;if(r>12){const t=new Error(`invalid ADTS sampling index:${r}`);return void e.emit(l.ERROR,l.ERROR,{type:a.MEDIA_ERROR,details:o.FRAG_PARSING_ERROR,fatal:!0,error:t,reason:t.message})}const d=1+(n>>6&3),c=t[s+3]>>6&3|(1&n)<<2,h="mp4a.40."+d,u=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350][r];let f=r;5!==d&&29!==d||(f-=3);const g=[d<<3|(14&f)>>1,(1&f)<<7|c<<3];return R.log(`manifest codec:${i}, parsed codec:${h}, channels:${c}, rate:${u} (ADTS object type:${d} sampling index:${r})`),{config:g,samplerate:u,channelCount:c,codec:h,parsedCodec:h,manifestCodec:i}}(t,s,i,n);if(!r)return;y(e,r)}}function Ei(e){return 9216e4/e}function Ti(e,t,s,i,n){const r=i+n*Ei(e.samplerate),a=function(e,t){const s=gi(e,t);if(t+s<=e.length){const i=mi(e,t)-s;if(i>0)return{headerLength:s,frameLength:i}}}(t,s);let o;if(a){const{frameLength:i,headerLength:n}=a,l=n+i,d=Math.max(0,s+l-t.length);d?(o=new Uint8Array(l-n),o.set(t.subarray(s+n,t.length),0)):o=t.subarray(s+n,s+l);const c={unit:o,pts:r};return d||e.samples.push(c),{sample:c,length:l,missing:d}}const l=t.length-s;return o=new Uint8Array(l),o.set(t.subarray(s,t.length),0),{sample:{unit:o,pts:r},length:l,missing:-1}}function Si(e,t){return ci(e,t)&&hi(e,t+6)+10<=e.length-t}function bi(e,t=0,s=1/0){return function(e,t,s,i){const n=(r=e)instanceof ArrayBuffer?r:r.buffer;var r;let a=1;"BYTES_PER_ELEMENT"in i&&(a=i.BYTES_PER_ELEMENT);const o=(h=e)&&h.buffer instanceof ArrayBuffer&&void 0!==h.byteLength&&void 0!==h.byteOffset?e.byteOffset:0,l=(o+e.byteLength)/a,d=(o+t)/a,c=Math.floor(Math.max(0,Math.min(d,l)));var h;return new i(n,c,Math.floor(Math.min(c+Math.max(s,0),l))-c)}(e,t,s,Uint8Array)}function Ai(e){return"PRIV"===e.type?function(e){if(e.size<2)return;const t=k(e.data,!0),s=new Uint8Array(e.data.subarray(t.length+1));return{key:e.type,info:t,data:s.buffer}}(e):"W"===e.type[0]?function(e){if("WXXX"===e.type){if(e.size<2)return;let t=1;const s=k(e.data.subarray(t),!0);t+=s.length+1;const i=k(e.data.subarray(t));return{key:e.type,info:s,data:i}}const t=k(e.data);return{key:e.type,info:"",data:t}}(e):"APIC"===e.type?function(e){const t={key:e.type,description:"",data:"",mimeType:null,pictureType:null};if(e.size<2)return;if(3!==e.data[0])return void console.log("Ignore frame with unrecognized character encoding");const s=e.data.subarray(1).indexOf(0);if(-1===s)return;const i=k(bi(e.data,1,s)),n=e.data[2+s],r=e.data.subarray(3+s).indexOf(0);if(-1===r)return;const a=k(bi(e.data,3+s,r));let o;return o="--\x3e"===i?k(bi(e.data,4+s+r)):(l=e.data.subarray(4+s+r))instanceof ArrayBuffer?l:0==l.byteOffset&&l.byteLength==l.buffer.byteLength?l.buffer:new Uint8Array(l).buffer,t.mimeType=i,t.pictureType=n,t.description=a,t.data=o,t;var l}(e):function(e){if(e.size<2)return;if("TXXX"===e.type){let t=1;const s=k(e.data.subarray(t),!0);t+=s.length+1;const i=k(e.data.subarray(t));return{key:e.type,info:s,data:i}}const t=k(e.data.subarray(1));return{key:e.type,info:"",data:t}}(e)}function Li(e){const t=String.fromCharCode(e[0],e[1],e[2],e[3]),s=hi(e,4);return{type:t,size:s,data:e.subarray(10,10+s)}}function wi(e){let t=0;const s=[];for(;ci(e,t);){const i=hi(e,t+6);e[t+5]>>6&1&&(t+=10),t+=10;const n=t+i;for(;t+10<n;){const i=Li(e.subarray(t)),n=Ai(i);n&&s.push(n),t+=i.size+10}di(e,t)&&(t+=10)}return s}function Ri(e){return e&&"PRIV"===e.key&&"com.apple.streaming.transportStreamTimestamp"===e.info}function Ii(e){if(8===e.data.byteLength){const t=new Uint8Array(e.data),s=1&t[3];let i=(t[4]<<23)+(t[5]<<15)+(t[6]<<7)+t[7];return i/=45,s&&(i+=47721858.84),Math.round(i)}}function xi(e){const t=wi(e);for(let e=0;e<t.length;e++){const s=t[e];if(Ri(s))return Ii(s)}}let ki=function(e){return e.audioId3="org.id3",e.dateRange="com.apple.quicktime.HLS",e.emsg="https://aomedia.org/emsg/ID3",e.misbklv="urn:misb:KLV:bin:1910.1",e}({});function Di(e="",t=9e4){return{type:e,id:-1,pid:-1,inputTimeScale:t,sequenceNumber:-1,samples:[],dropped:0}}class _i{constructor(){this._audioTrack=void 0,this._id3Track=void 0,this.frameIndex=0,this.cachedData=null,this.basePTS=null,this.initPTS=null,this.lastPTS=null}resetInitSegment(e,t,s,i){this._id3Track={type:"id3",id:3,pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0}}resetTimeStamp(e){this.initPTS=e,this.resetContiguity()}resetContiguity(){this.basePTS=null,this.lastPTS=null,this.frameIndex=0}canParse(e,t){return!1}appendFrame(e,t,s){}demux(e,t){this.cachedData&&(e=ue(this.cachedData,e),this.cachedData=null);let s,n=ui(e,0),r=n?n.length:0;const a=this._audioTrack,o=this._id3Track,l=n?xi(n):void 0,d=e.length;for((null===this.basePTS||0===this.frameIndex&&i(l))&&(this.basePTS=Ci(l,t,this.initPTS),this.lastPTS=this.basePTS),null===this.lastPTS&&(this.lastPTS=this.basePTS),n&&n.length>0&&o.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:n,type:ki.audioId3,duration:Number.POSITIVE_INFINITY});r<d;){if(this.canParse(e,r)){const t=this.appendFrame(a,e,r);t?(this.frameIndex++,this.lastPTS=t.sample.pts,r+=t.length,s=r):r=d}else Si(e,r)?(n=ui(e,r),o.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:n,type:ki.audioId3,duration:Number.POSITIVE_INFINITY}),r+=n.length,s=r):r++;if(r===d&&s!==d){const t=e.slice(s);this.cachedData?this.cachedData=ue(this.cachedData,t):this.cachedData=t}}return{audioTrack:a,videoTrack:Di(),id3Track:o,textTrack:Di()}}demuxSampleAes(e,t,s){return Promise.reject(new Error(`[${this}] This demuxer does not support Sample-AES decryption`))}flush(e){const t=this.cachedData;return t&&(this.cachedData=null,this.demux(t,0)),{audioTrack:this._audioTrack,videoTrack:Di(),id3Track:this._id3Track,textTrack:Di()}}destroy(){this.cachedData=null,this._audioTrack=this._id3Track=void 0}}const Ci=(e,t,s)=>i(e)?90*e:9e4*t+(s?9e4*s.baseTime/s.timescale:0);let Pi=null;const Mi=[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],Oi=[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],Fi=[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],Ni=[0,1,1,4];function Bi(e,t,s,i,n){if(s+24>t.length)return;const r=Ui(t,s);if(r&&s+r.frameLength<=t.length){const a=i+n*(9e4*r.samplesPerFrame/r.sampleRate),o={unit:t.subarray(s,s+r.frameLength),pts:a,dts:a};return e.config=[],e.channelCount=r.channelCount,e.samplerate=r.sampleRate,e.samples.push(o),{sample:o,length:r.frameLength,missing:0}}}function Ui(e,t){const s=e[t+1]>>3&3,i=e[t+1]>>1&3,n=e[t+2]>>4&15,r=e[t+2]>>2&3;if(1!==s&&0!==n&&15!==n&&3!==r){const a=e[t+2]>>1&1,o=e[t+3]>>6,l=1e3*Mi[14*(3===s?3-i:3===i?3:4)+n-1],d=Oi[3*(3===s?0:2===s?1:2)+r],c=3===o?1:2,h=Fi[s][i],u=Ni[i],f=8*h*u,g=Math.floor(h*l/d+a)*u;if(null===Pi){const e=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);Pi=e?parseInt(e[1]):0}return!!Pi&&Pi<=87&&2===i&&l>=224e3&&0===o&&(e[t+3]=128|e[t+3]),{sampleRate:d,channelCount:c,frameLength:g,samplesPerFrame:f}}}function $i(e,t){return!(255!==e[t]||224&~e[t+1]||!(6&e[t+1]))}function Gi(e,t){return t+1<e.length&&$i(e,t)}function ji(e,t){if(t+1<e.length&&$i(e,t)){const s=4,i=Ui(e,t);let n=s;null!=i&&i.frameLength&&(n=i.frameLength);const r=t+n;return r===e.length||Gi(e,r)}return!1}const Hi=(e,t)=>{let s=0,i=5;t+=i;const n=new Uint32Array(1),r=new Uint32Array(1),a=new Uint8Array(1);for(;i>0;){a[0]=e[t];const o=Math.min(i,8),l=8-o;r[0]=4278190080>>>24+l<<l,n[0]=(a[0]&r[0])>>l,s=s?s<<o|n[0]:n[0],t+=1,i-=o}return s};function Vi(e,t,s,i,n){if(s+8>t.length)return-1;if(11!==t[s]||119!==t[s+1])return-1;const r=t[s+4]>>6;if(r>=3)return-1;const a=[48e3,44100,32e3][r],o=63&t[s+4],l=2*[64,69,96,64,70,96,80,87,120,80,88,120,96,104,144,96,105,144,112,121,168,112,122,168,128,139,192,128,140,192,160,174,240,160,175,240,192,208,288,192,209,288,224,243,336,224,244,336,256,278,384,256,279,384,320,348,480,320,349,480,384,417,576,384,418,576,448,487,672,448,488,672,512,557,768,512,558,768,640,696,960,640,697,960,768,835,1152,768,836,1152,896,975,1344,896,976,1344,1024,1114,1536,1024,1115,1536,1152,1253,1728,1152,1254,1728,1280,1393,1920,1280,1394,1920][3*o+r];if(s+l>t.length)return-1;const d=t[s+6]>>5;let c=0;2===d?c+=2:(1&d&&1!==d&&(c+=2),4&d&&(c+=2));const h=(t[s+6]<<8|t[s+7])>>12-c&1,u=[2,1,2,3,3,4,4,5][d]+h,f=t[s+5]>>3,g=7&t[s+5],m=new Uint8Array([r<<6|f<<1|g>>2,(3&g)<<6|d<<3|h<<2|o>>4,o<<4&224]),p=i+n*(1536/a*9e4),y=t.subarray(s,s+l);return e.config=m,e.channelCount=u,e.samplerate=a,e.samples.push({unit:y,pts:p}),l}const Ki=/\/emsg[-/]ID3/i;function qi(e,t){return i(e.presentationTime)?e.presentationTime/e.timeScale:t+e.presentationTimeDelta/e.timeScale}class Yi{constructor(e,t,s){this.keyData=void 0,this.decrypter=void 0,this.keyData=s,this.decrypter=new xt(t,{removePKCS7Padding:!1})}decryptBuffer(e){return this.decrypter.decrypt(e,this.keyData.key.buffer,this.keyData.iv.buffer,0)}decryptAacSample(e,t,s){const i=e[t].unit;if(i.length<=16)return;const n=i.subarray(16,i.length-i.length%16),r=n.buffer.slice(n.byteOffset,n.byteOffset+n.length);this.decryptBuffer(r).then(n=>{const r=new Uint8Array(n);i.set(r,16),this.decrypter.isSync()||this.decryptAacSamples(e,t+1,s)})}decryptAacSamples(e,t,s){for(;;t++){if(t>=e.length)return void s();if(!(e[t].unit.length<32||(this.decryptAacSample(e,t,s),this.decrypter.isSync())))return}}getAvcEncryptedData(e){const t=16*Math.floor((e.length-48)/160)+16,s=new Int8Array(t);let i=0;for(let t=32;t<e.length-16;t+=160,i+=16)s.set(e.subarray(t,t+16),i);return s}getAvcDecryptedUnit(e,t){const s=new Uint8Array(t);let i=0;for(let t=32;t<e.length-16;t+=160,i+=16)e.set(s.subarray(i,i+16),t);return e}decryptAvcSample(e,t,s,i,n){const r=ye(n.data),a=this.getAvcEncryptedData(r);this.decryptBuffer(a.buffer).then(a=>{n.data=this.getAvcDecryptedUnit(r,a),this.decrypter.isSync()||this.decryptAvcSamples(e,t,s+1,i)})}decryptAvcSamples(e,t,s,i){if(e instanceof Uint8Array)throw new Error("Cannot decrypt samples of type Uint8Array");for(;;t++,s=0){if(t>=e.length)return void i();const n=e[t].units;for(;!(s>=n.length);s++){const r=n[s];if(!(r.data.length<=48||1!==r.type&&5!==r.type||(this.decryptAvcSample(e,t,s,i,r),this.decrypter.isSync())))return}}}}class Wi{constructor(){this.VideoSample=null}createVideoSample(e,t,s){return{key:e,frame:!1,pts:t,dts:s,units:[],length:0}}getLastNalUnit(e){var t;let s,i=this.VideoSample;if(i&&0!==i.units.length||(i=e[e.length-1]),null!=(t=i)&&t.units){const e=i.units;s=e[e.length-1]}return s}pushAccessUnit(e,t){if(e.units.length&&e.frame){if(void 0===e.pts){const s=t.samples,i=s.length;if(!i)return void t.dropped++;{const t=s[i-1];e.pts=t.pts,e.dts=t.dts}}t.samples.push(e)}}parseNALu(e,t,s){const i=t.byteLength;let n=e.naluState||0;const r=n,a=[];let o,l,d,c=0,h=-1,u=0;for(-1===n&&(h=0,u=this.getNALuType(t,0),n=0,c=1);c<i;)if(o=t[c++],n)if(1!==n)if(o)if(1===o){if(l=c-n-1,h>=0){const e={data:t.subarray(h,l),type:u};a.push(e)}else{const s=this.getLastNalUnit(e.samples);s&&(r&&c<=4-r&&s.state&&(s.data=s.data.subarray(0,s.data.byteLength-r)),l>0&&(s.data=ue(s.data,t.subarray(0,l)),s.state=0))}c<i?(d=this.getNALuType(t,c),h=c,u=d,n=0):n=-1}else n=0;else n=3;else n=o?0:2;else n=o?0:1;if(h>=0&&n>=0){const e={data:t.subarray(h,i),type:u,state:n};a.push(e)}if(0===a.length){const s=this.getLastNalUnit(e.samples);s&&(s.data=ue(s.data,t))}return e.naluState=n,a}}class zi{constructor(e){this.data=void 0,this.bytesAvailable=void 0,this.word=void 0,this.bitsAvailable=void 0,this.data=e,this.bytesAvailable=e.byteLength,this.word=0,this.bitsAvailable=0}loadWord(){const e=this.data,t=this.bytesAvailable,s=e.byteLength-t,i=new Uint8Array(4),n=Math.min(4,t);if(0===n)throw new Error("no bytes available");i.set(e.subarray(s,s+n)),this.word=new DataView(i.buffer).getUint32(0),this.bitsAvailable=8*n,this.bytesAvailable-=n}skipBits(e){let t;e=Math.min(e,8*this.bytesAvailable+this.bitsAvailable),this.bitsAvailable>e?(this.word<<=e,this.bitsAvailable-=e):(t=(e-=this.bitsAvailable)>>3,e-=t<<3,this.bytesAvailable-=t,this.loadWord(),this.word<<=e,this.bitsAvailable-=e)}readBits(e){let t=Math.min(this.bitsAvailable,e);const s=this.word>>>32-t;if(e>32&&R.error("Cannot read more than 32 bits at a time"),this.bitsAvailable-=t,this.bitsAvailable>0)this.word<<=t;else{if(!(this.bytesAvailable>0))throw new Error("no bits available");this.loadWord()}return t=e-t,t>0&&this.bitsAvailable?s<<t|this.readBits(t):s}skipLZ(){let e;for(e=0;e<this.bitsAvailable;++e)if(this.word&2147483648>>>e)return this.word<<=e,this.bitsAvailable-=e,e;return this.loadWord(),e+this.skipLZ()}skipUEG(){this.skipBits(1+this.skipLZ())}skipEG(){this.skipBits(1+this.skipLZ())}readUEG(){const e=this.skipLZ();return this.readBits(e+1)-1}readEG(){const e=this.readUEG();return 1&e?1+e>>>1:-1*(e>>>1)}readBoolean(){return 1===this.readBits(1)}readUByte(){return this.readBits(8)}readUShort(){return this.readBits(16)}readUInt(){return this.readBits(32)}}class Xi extends Wi{parsePES(e,t,s,i){const n=this.parseNALu(e,s.data,i);let r,a=this.VideoSample,o=!1;s.data=null,a&&n.length&&!e.audFound&&(this.pushAccessUnit(a,e),a=this.VideoSample=this.createVideoSample(!1,s.pts,s.dts)),n.forEach(i=>{var n,l;switch(i.type){case 1:{let t=!1;r=!0;const n=i.data;if(o&&n.length>4){const e=this.readSliceType(n);2!==e&&4!==e&&7!==e&&9!==e||(t=!0)}var d;t&&null!=(d=a)&&d.frame&&!a.key&&(this.pushAccessUnit(a,e),a=this.VideoSample=null),a||(a=this.VideoSample=this.createVideoSample(!0,s.pts,s.dts)),a.frame=!0,a.key=t;break}case 5:r=!0,null!=(n=a)&&n.frame&&!a.key&&(this.pushAccessUnit(a,e),a=this.VideoSample=null),a||(a=this.VideoSample=this.createVideoSample(!0,s.pts,s.dts)),a.key=!0,a.frame=!0;break;case 6:r=!0,pe(i.data,1,s.pts,t.samples);break;case 7:{var c,h;r=!0,o=!0;const t=i.data,s=this.readSPS(t);if(!e.sps||e.width!==s.width||e.height!==s.height||(null==(c=e.pixelRatio)?void 0:c[0])!==s.pixelRatio[0]||(null==(h=e.pixelRatio)?void 0:h[1])!==s.pixelRatio[1]){e.width=s.width,e.height=s.height,e.pixelRatio=s.pixelRatio,e.sps=[t];const i=t.subarray(1,4);let n="avc1.";for(let e=0;e<3;e++){let t=i[e].toString(16);t.length<2&&(t="0"+t),n+=t}e.codec=n}break}case 8:r=!0,e.pps=[i.data];break;case 9:r=!0,e.audFound=!0,null!=(l=a)&&l.frame&&(this.pushAccessUnit(a,e),a=null),a||(a=this.VideoSample=this.createVideoSample(!1,s.pts,s.dts));break;case 12:r=!0;break;default:r=!1}a&&r&&a.units.push(i)}),i&&a&&(this.pushAccessUnit(a,e),this.VideoSample=null)}getNALuType(e,t){return 31&e[t]}readSliceType(e){const t=new zi(e);return t.readUByte(),t.readUEG(),t.readUEG()}skipScalingList(e,t){let s,i=8,n=8;for(let r=0;r<e;r++)0!==n&&(s=t.readEG(),n=(i+s+256)%256),i=0===n?i:n}readSPS(e){const t=new zi(e);let s,i,n,r=0,a=0,o=0,l=0;const d=t.readUByte.bind(t),c=t.readBits.bind(t),h=t.readUEG.bind(t),u=t.readBoolean.bind(t),f=t.skipBits.bind(t),g=t.skipEG.bind(t),m=t.skipUEG.bind(t),p=this.skipScalingList.bind(this);d();const y=d();if(c(5),f(3),d(),m(),100===y||110===y||122===y||244===y||44===y||83===y||86===y||118===y||128===y){const e=h();if(3===e&&f(1),m(),m(),f(1),u())for(i=3!==e?8:12,n=0;n<i;n++)u()&&p(n<6?16:64,t)}m();const v=h();if(0===v)h();else if(1===v)for(f(1),g(),g(),s=h(),n=0;n<s;n++)g();m(),f(1);const E=h(),T=h(),S=c(1);0===S&&f(1),f(1),u()&&(r=h(),a=h(),o=h(),l=h());let b=[1,1];if(u()&&u())switch(d()){case 1:b=[1,1];break;case 2:b=[12,11];break;case 3:b=[10,11];break;case 4:b=[16,11];break;case 5:b=[40,33];break;case 6:b=[24,11];break;case 7:b=[20,11];break;case 8:b=[32,11];break;case 9:b=[80,33];break;case 10:b=[18,11];break;case 11:b=[15,11];break;case 12:b=[64,33];break;case 13:b=[160,99];break;case 14:b=[4,3];break;case 15:b=[3,2];break;case 16:b=[2,1];break;case 255:b=[d()<<8|d(),d()<<8|d()]}return{width:Math.ceil(16*(E+1)-2*r-2*a),height:(2-S)*(T+1)*16-(S?2:4)*(o+l),pixelRatio:b}}}class Zi extends Wi{constructor(...e){super(...e),this.initVPS=null}parsePES(e,t,s,i){const n=this.parseNALu(e,s.data,i);let r,a=this.VideoSample,o=!1;s.data=null,a&&n.length&&!e.audFound&&(this.pushAccessUnit(a,e),a=this.VideoSample=this.createVideoSample(!1,s.pts,s.dts)),n.forEach(i=>{var n,l;switch(i.type){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:case 8:case 9:a||(a=this.VideoSample=this.createVideoSample(!1,s.pts,s.dts)),a.frame=!0,r=!0;break;case 16:case 17:case 18:case 21:var d;r=!0,o&&null!=(d=a)&&d.frame&&!a.key&&(this.pushAccessUnit(a,e),a=this.VideoSample=null),a||(a=this.VideoSample=this.createVideoSample(!0,s.pts,s.dts)),a.key=!0,a.frame=!0;break;case 19:case 20:r=!0,null!=(n=a)&&n.frame&&!a.key&&(this.pushAccessUnit(a,e),a=this.VideoSample=null),a||(a=this.VideoSample=this.createVideoSample(!0,s.pts,s.dts)),a.key=!0,a.frame=!0;break;case 39:r=!0,pe(i.data,2,s.pts,t.samples);break;case 32:r=!0,e.vps||("object"!=typeof e.params&&(e.params={}),e.params=y(e.params,this.readVPS(i.data)),this.initVPS=i.data),e.vps=[i.data];break;case 33:if(r=!0,o=!0,void 0===e.vps||e.vps[0]===this.initVPS||void 0===e.sps||this.matchSPS(e.sps[0],i.data)||(this.initVPS=e.vps[0],e.sps=e.pps=void 0),!e.sps){const t=this.readSPS(i.data);e.width=t.width,e.height=t.height,e.pixelRatio=t.pixelRatio,e.codec=t.codecString,e.sps=[],"object"!=typeof e.params&&(e.params={});for(const s in t.params)e.params[s]=t.params[s]}this.pushParameterSet(e.sps,i.data,e.vps),a||(a=this.VideoSample=this.createVideoSample(!0,s.pts,s.dts)),a.key=!0;break;case 34:if(r=!0,"object"==typeof e.params){if(!e.pps){e.pps=[];const t=this.readPPS(i.data);for(const s in t)e.params[s]=t[s]}this.pushParameterSet(e.pps,i.data,e.vps)}break;case 35:r=!0,e.audFound=!0,null!=(l=a)&&l.frame&&(this.pushAccessUnit(a,e),a=null),a||(a=this.VideoSample=this.createVideoSample(!1,s.pts,s.dts));break;default:r=!1}a&&r&&a.units.push(i)}),i&&a&&(this.pushAccessUnit(a,e),this.VideoSample=null)}pushParameterSet(e,t,s){(s&&s[0]===this.initVPS||!s&&!e.length)&&e.push(t)}getNALuType(e,t){return(126&e[t])>>>1}ebsp2rbsp(e){const t=new Uint8Array(e.byteLength);let s=0;for(let i=0;i<e.byteLength;i++)i>=2&&3===e[i]&&0===e[i-1]&&0===e[i-2]||(t[s]=e[i],s++);return new Uint8Array(t.buffer,0,s)}pushAccessUnit(e,t){super.pushAccessUnit(e,t),this.initVPS&&(this.initVPS=null)}readVPS(e){const t=new zi(e);return t.readUByte(),t.readUByte(),t.readBits(4),t.skipBits(2),t.readBits(6),{numTemporalLayers:t.readBits(3)+1,temporalIdNested:t.readBoolean()}}readSPS(e){const t=new zi(this.ebsp2rbsp(e));t.readUByte(),t.readUByte(),t.readBits(4);const s=t.readBits(3);t.readBoolean();const i=t.readBits(2),n=t.readBoolean(),r=t.readBits(5),a=t.readUByte(),o=t.readUByte(),l=t.readUByte(),d=t.readUByte(),c=t.readUByte(),h=t.readUByte(),u=t.readUByte(),f=t.readUByte(),g=t.readUByte(),m=t.readUByte(),p=t.readUByte(),y=[],v=[];for(let e=0;e<s;e++)y.push(t.readBoolean()),v.push(t.readBoolean());if(s>0)for(let e=s;e<8;e++)t.readBits(2);for(let e=0;e<s;e++)y[e]&&(t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte(),t.readUByte()),v[e]&&t.readUByte();t.readUEG();const E=t.readUEG();3==E&&t.skipBits(1);const T=t.readUEG(),S=t.readUEG(),b=t.readBoolean();let A=0,L=0,w=0,R=0;b&&(A+=t.readUEG(),L+=t.readUEG(),w+=t.readUEG(),R+=t.readUEG());const I=t.readUEG(),x=t.readUEG(),k=t.readUEG();for(let e=t.readBoolean()?0:s;e<=s;e++)t.skipUEG(),t.skipUEG(),t.skipUEG();if(t.skipUEG(),t.skipUEG(),t.skipUEG(),t.skipUEG(),t.skipUEG(),t.skipUEG(),t.readBoolean()&&t.readBoolean())for(let e=0;e<4;e++)for(let s=0;s<(3===e?2:6);s++)if(t.readBoolean()){const s=Math.min(64,1<<4+(e<<1));e>1&&t.readEG();for(let e=0;e<s;e++)t.readEG()}else t.readUEG();t.readBoolean(),t.readBoolean(),t.readBoolean()&&(t.readUByte(),t.skipUEG(),t.skipUEG(),t.readBoolean());const D=t.readUEG();let _=0;for(let e=0;e<D;e++){let s=!1;if(0!==e&&(s=t.readBoolean()),s){e===D&&t.readUEG(),t.readBoolean(),t.readUEG();let s=0;for(let e=0;e<=_;e++){const e=t.readBoolean();let i=!1;e||(i=t.readBoolean()),(e||i)&&s++}_=s}else{const e=t.readUEG(),s=t.readUEG();_=e+s;for(let s=0;s<e;s++)t.readUEG(),t.readBoolean();for(let e=0;e<s;e++)t.readUEG(),t.readBoolean()}}if(t.readBoolean()){const e=t.readUEG();for(let s=0;s<e;s++){for(let e=0;e<k+4;e++)t.readBits(1);t.readBits(1)}}let C=0,P=1,M=1,O=!0,F=1,N=0;t.readBoolean(),t.readBoolean();let B=!1;if(t.readBoolean()){if(t.readBoolean()){const e=t.readUByte();e>0&&e<16?(P=[1,12,10,16,40,24,20,32,80,18,15,64,160,4,3,2][e-1],M=[1,11,11,11,33,11,11,11,33,11,11,33,99,3,2,1][e-1]):255===e&&(P=t.readBits(16),M=t.readBits(16))}if(t.readBoolean()&&t.readBoolean(),t.readBoolean()&&(t.readBits(3),t.readBoolean(),t.readBoolean()&&(t.readUByte(),t.readUByte(),t.readUByte())),t.readBoolean()&&(t.readUEG(),t.readUEG()),t.readBoolean(),t.readBoolean(),t.readBoolean(),B=t.readBoolean(),B&&(A+=t.readUEG(),L+=t.readUEG(),w+=t.readUEG(),R+=t.readUEG()),t.readBoolean()&&(F=t.readBits(32),N=t.readBits(32),t.readBoolean()&&t.readUEG(),t.readBoolean())){const e=t.readBoolean(),i=t.readBoolean();let n=!1;(e||i)&&(n=t.readBoolean(),n&&(t.readUByte(),t.readBits(5),t.readBoolean(),t.readBits(5)),t.readBits(4),t.readBits(4),n&&t.readBits(4),t.readBits(5),t.readBits(5),t.readBits(5));for(let r=0;r<=s;r++){O=t.readBoolean();let s=!1;O||t.readBoolean()?t.readEG():s=t.readBoolean();const r=s?1:t.readUEG()+1;if(e)for(let e=0;e<r;e++)t.readUEG(),t.readUEG(),n&&(t.readUEG(),t.readUEG()),t.skipBits(1);if(i)for(let e=0;e<r;e++)t.readUEG(),t.readUEG(),n&&(t.readUEG(),t.readUEG()),t.skipBits(1)}}t.readBoolean()&&(t.readBoolean(),t.readBoolean(),t.readBoolean(),C=t.readUEG())}let U=T,$=S;if(b||B){let e=1,t=1;1===E?e=t=2:2==E&&(e=2),U=T-e*L-e*A,$=S-t*R-t*w}const G=i?["A","B","C"][i]:"",j=a<<24|o<<16|l<<8|d;let H=0;for(let e=0;e<32;e++)H=(H|(j>>e&1)<<31-e)>>>0;let V=H.toString(16);return 1===r&&"2"===V&&(V="6"),{codecString:`hvc1.${G}${r}.${V}.${n?"H":"L"}${p}.B0`,params:{general_tier_flag:n,general_profile_idc:r,general_profile_space:i,general_profile_compatibility_flags:[a,o,l,d],general_constraint_indicator_flags:[c,h,u,f,g,m],general_level_idc:p,bit_depth:I+8,bit_depth_luma_minus8:I,bit_depth_chroma_minus8:x,min_spatial_segmentation_idc:C,chroma_format_idc:E,frame_rate:{fixed:O,fps:N/F}},width:U,height:$,pixelRatio:[P,M]}}readPPS(e){const t=new zi(this.ebsp2rbsp(e));t.readUByte(),t.readUByte(),t.skipUEG(),t.skipUEG(),t.skipBits(2),t.skipBits(3),t.skipBits(2),t.skipUEG(),t.skipUEG(),t.skipEG(),t.skipBits(2),t.readBoolean()&&t.skipUEG(),t.skipEG(),t.skipEG(),t.skipBits(4);const s=t.readBoolean(),i=t.readBoolean();let n=1;return i&&s?n=0:i?n=3:s&&(n=2),{parallelismType:n}}matchSPS(e,t){return String.fromCharCode.apply(null,e).substr(3)===String.fromCharCode.apply(null,t).substr(3)}}const Qi=188;class Ji{constructor(e,t,s,i){this.logger=void 0,this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.sampleAes=null,this.pmtParsed=!1,this.audioCodec=void 0,this.videoCodec=void 0,this._pmtId=-1,this._videoTrack=void 0,this._audioTrack=void 0,this._id3Track=void 0,this._txtTrack=void 0,this.aacOverFlow=null,this.remainderData=null,this.videoParser=void 0,this.observer=e,this.config=t,this.typeSupported=s,this.logger=i,this.videoParser=null}static probe(e,t){const s=Ji.syncOffset(e);return s>0&&t.warn(`MPEG2-TS detected but first sync word found @ offset ${s}`),-1!==s}static syncOffset(e){const t=e.length;let s=Math.min(940,t-Qi)+1,i=0;for(;i<s;){let n=!1,r=-1,a=0;for(let o=i;o<t;o+=Qi){if(71!==e[o]||t-o!==Qi&&71!==e[o+Qi]){if(a)return-1;break}if(a++,-1===r&&(r=o,0!==r&&(s=Math.min(r+18612,e.length-Qi)+1)),n||(n=0===en(e,o)),n&&a>1&&(0===r&&a>2||o+Qi>s))return r}i++}return-1}static createTrack(e,t){return{container:"video"===e||"audio"===e?"video/mp2t":void 0,type:e,id:Q[e],pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0,duration:"audio"===e?t:void 0}}resetInitSegment(e,t,s,i){this.pmtParsed=!1,this._pmtId=-1,this._videoTrack=Ji.createTrack("video"),this._videoTrack.duration=i,this._audioTrack=Ji.createTrack("audio",i),this._id3Track=Ji.createTrack("id3"),this._txtTrack=Ji.createTrack("text"),this._audioTrack.segmentCodec="aac",this.aacOverFlow=null,this.remainderData=null,this.audioCodec=t,this.videoCodec=s}resetTimeStamp(){}resetContiguity(){const{_audioTrack:e,_videoTrack:t,_id3Track:s}=this;e&&(e.pesData=null),t&&(t.pesData=null),s&&(s.pesData=null),this.aacOverFlow=null,this.remainderData=null}demux(e,t,s=!1,i=!1){let n;s||(this.sampleAes=null);const r=this._videoTrack,a=this._audioTrack,o=this._id3Track,l=this._txtTrack;let d=r.pid,c=r.pesData,h=a.pid,u=o.pid,f=a.pesData,g=o.pesData,m=null,p=this.pmtParsed,y=this._pmtId,v=e.length;if(this.remainderData&&(v=(e=ue(this.remainderData,e)).length,this.remainderData=null),v<Qi&&!i)return this.remainderData=e,{audioTrack:a,videoTrack:r,id3Track:o,textTrack:l};const E=Math.max(0,Ji.syncOffset(e));v-=(v-E)%Qi,v<e.byteLength&&!i&&(this.remainderData=new Uint8Array(e.buffer,v,e.buffer.byteLength-v));let T=0;for(let t=E;t<v;t+=Qi)if(71===e[t]){const i=!!(64&e[t+1]),v=en(e,t);let T;if((48&e[t+3])>>4>1){if(T=t+5+e[t+4],T===t+Qi)continue}else T=t+4;switch(v){case d:if(i){if(c&&(n=an(c,this.logger))){if(null===this.videoParser)switch(r.segmentCodec){case"avc":this.videoParser=new Xi;break;case"hevc":this.videoParser=new Zi}null!==this.videoParser&&this.videoParser.parsePES(r,l,n,!1)}c={data:[],size:0}}c&&(c.data.push(e.subarray(T,t+Qi)),c.size+=t+Qi-T);break;case h:if(i){if(f&&(n=an(f,this.logger)))switch(a.segmentCodec){case"aac":this.parseAACPES(a,n);break;case"mp3":this.parseMPEGPES(a,n);break;case"ac3":this.parseAC3PES(a,n)}f={data:[],size:0}}f&&(f.data.push(e.subarray(T,t+Qi)),f.size+=t+Qi-T);break;case u:i&&(g&&(n=an(g,this.logger))&&this.parseID3PES(o,n),g={data:[],size:0}),g&&(g.data.push(e.subarray(T,t+Qi)),g.size+=t+Qi-T);break;case 0:i&&(T+=e[T]+1),y=this._pmtId=tn(e,T);break;case y:{i&&(T+=e[T]+1);const n=sn(e,T,this.typeSupported,s,this.observer,this.logger);d=n.videoPid,d>0&&(r.pid=d,r.segmentCodec=n.segmentVideoCodec),h=n.audioPid,h>0&&(a.pid=h,a.segmentCodec=n.segmentAudioCodec),u=n.id3Pid,u>0&&(o.pid=u),null===m||p||(this.logger.warn(`MPEG-TS PMT found at ${t} after unknown PID '${m}'. Backtracking to sync byte @${E} to parse all TS packets.`),m=null,t=E-188),p=this.pmtParsed=!0;break}case 17:case 8191:break;default:m=v}}else T++;T>0&&nn(this.observer,new Error(`Found ${T} TS packet/s that do not start with 0x47`),void 0,this.logger),r.pesData=c,a.pesData=f,o.pesData=g;const S={audioTrack:a,videoTrack:r,id3Track:o,textTrack:l};return i&&this.extractRemainingSamples(S),S}flush(){const{remainderData:e}=this;let t;return this.remainderData=null,t=e?this.demux(e,-1,!1,!0):{videoTrack:this._videoTrack,audioTrack:this._audioTrack,id3Track:this._id3Track,textTrack:this._txtTrack},this.extractRemainingSamples(t),this.sampleAes?this.decrypt(t,this.sampleAes):t}extractRemainingSamples(e){const{audioTrack:t,videoTrack:s,id3Track:i,textTrack:n}=e,r=s.pesData,a=t.pesData,o=i.pesData;let l;if(r&&(l=an(r,this.logger))){if(null===this.videoParser)switch(s.segmentCodec){case"avc":this.videoParser=new Xi;break;case"hevc":this.videoParser=new Zi}null!==this.videoParser&&(this.videoParser.parsePES(s,n,l,!0),s.pesData=null)}else s.pesData=r;if(a&&(l=an(a,this.logger))){switch(t.segmentCodec){case"aac":this.parseAACPES(t,l);break;case"mp3":this.parseMPEGPES(t,l);break;case"ac3":this.parseAC3PES(t,l)}t.pesData=null}else null!=a&&a.size&&this.logger.log("last AAC PES packet truncated,might overlap between fragments"),t.pesData=a;o&&(l=an(o,this.logger))?(this.parseID3PES(i,l),i.pesData=null):i.pesData=o}demuxSampleAes(e,t,s){const i=this.demux(e,s,!0,!this.config.progressive),n=this.sampleAes=new Yi(this.observer,this.config,t);return this.decrypt(i,n)}decrypt(e,t){return new Promise(s=>{const{audioTrack:i,videoTrack:n}=e;i.samples&&"aac"===i.segmentCodec?t.decryptAacSamples(i.samples,0,()=>{n.samples?t.decryptAvcSamples(n.samples,0,0,()=>{s(e)}):s(e)}):n.samples&&t.decryptAvcSamples(n.samples,0,0,()=>{s(e)})})}destroy(){this.observer&&this.observer.removeAllListeners(),this.config=this.logger=this.observer=null,this.aacOverFlow=this.videoParser=this.remainderData=this.sampleAes=null,this._videoTrack=this._audioTrack=this._id3Track=this._txtTrack=void 0}parseAACPES(e,t){let s=0;const i=this.aacOverFlow;let n,r,a,o=t.data;if(i){this.aacOverFlow=null;const t=i.missing,n=i.sample.unit.byteLength;if(-1===t)o=ue(i.sample.unit,o);else{const r=n-t;i.sample.unit.set(o.subarray(0,t),r),e.samples.push(i.sample),s=i.missing}}for(n=s,r=o.length;n<r-1&&!pi(o,n);n++);if(n!==s){let e;const t=n<r-1;if(e=t?`AAC PES did not start with ADTS header,offset:${n}`:"No ADTS header found in AAC PES",nn(this.observer,new Error(e),t,this.logger),!t)return}if(vi(e,this.observer,o,n,this.audioCodec),void 0!==t.pts)a=t.pts;else{if(!i)return void this.logger.warn("[tsdemuxer]: AAC PES unknown PTS");{const t=Ei(e.samplerate);a=i.sample.pts+t}}let l,d=0;for(;n<r;){if(l=Ti(e,o,n,a,d),n+=l.length,l.missing){this.aacOverFlow=l;break}for(d++;n<r-1&&!pi(o,n);n++);}}parseMPEGPES(e,t){const s=t.data,i=s.length;let n=0,r=0;const a=t.pts;if(void 0!==a)for(;r<i;)if(Gi(s,r)){const t=Bi(e,s,r,a,n);if(!t)break;r+=t.length,n++}else r++;else this.logger.warn("[tsdemuxer]: MPEG PES unknown PTS")}parseAC3PES(e,t){{const s=t.data,i=t.pts;if(void 0===i)return void this.logger.warn("[tsdemuxer]: AC3 PES unknown PTS");const n=s.length;let r,a=0,o=0;for(;o<n&&(r=Vi(e,s,o,i,a++))>0;)o+=r}}parseID3PES(e,t){if(void 0===t.pts)return void this.logger.warn("[tsdemuxer]: ID3 PES unknown PTS");const s=y({},t,{type:this._videoTrack?ki.emsg:ki.audioId3,duration:Number.POSITIVE_INFINITY});e.samples.push(s)}}function en(e,t){return((31&e[t+1])<<8)+e[t+2]}function tn(e,t){return(31&e[t+10])<<8|e[t+11]}function sn(e,t,s,i,n,r){const a={audioPid:-1,videoPid:-1,id3Pid:-1,segmentVideoCodec:"avc",segmentAudioCodec:"aac"},o=t+3+((15&e[t+1])<<8|e[t+2])-4;for(t+=12+((15&e[t+10])<<8|e[t+11]);t<o;){const o=en(e,t),l=(15&e[t+3])<<8|e[t+4];switch(e[t]){case 207:if(!i){rn("ADTS AAC",r);break}case 15:-1===a.audioPid&&(a.audioPid=o);break;case 21:-1===a.id3Pid&&(a.id3Pid=o);break;case 219:if(!i){rn("H.264",r);break}case 27:-1===a.videoPid&&(a.videoPid=o);break;case 3:case 4:s.mpeg||s.mp3?-1===a.audioPid&&(a.audioPid=o,a.segmentAudioCodec="mp3"):r.log("MPEG audio found, not supported in this browser");break;case 193:if(!i){rn("AC-3",r);break}case 129:s.ac3?-1===a.audioPid&&(a.audioPid=o,a.segmentAudioCodec="ac3"):r.log("AC-3 audio found, not supported in this browser");break;case 6:if(-1===a.audioPid&&l>0){let i=t+5,n=l;for(;n>2;){106===e[i]&&(!0!==s.ac3?r.log("AC-3 audio found, not supported in this browser for now"):(a.audioPid=o,a.segmentAudioCodec="ac3"));const t=e[i+1]+2;i+=t,n-=t}}break;case 194:case 135:return nn(n,new Error("Unsupported EC-3 in M2TS found"),void 0,r),a;case 36:-1===a.videoPid&&(a.videoPid=o,a.segmentVideoCodec="hevc",r.log("HEVC in M2TS found"))}t+=l+5}return a}function nn(e,t,s,i){i.warn(`parsing error: ${t.message}`),e.emit(l.ERROR,l.ERROR,{type:a.MEDIA_ERROR,details:o.FRAG_PARSING_ERROR,fatal:!1,levelRetry:s,error:t,reason:t.message})}function rn(e,t){t.log(`${e} with AES-128-CBC encryption found in unencrypted stream`)}function an(e,t){let s,i,n,r,a,o=0;const l=e.data;if(!e||0===e.size)return null;for(;l[0].length<19&&l.length>1;)l[0]=ue(l[0],l[1]),l.splice(1,1);if(s=l[0],1===(s[0]<<16)+(s[1]<<8)+s[2]){if(i=(s[4]<<8)+s[5],i&&i>e.size-6)return null;const d=s[7];192&d&&(r=536870912*(14&s[9])+4194304*(255&s[10])+16384*(254&s[11])+128*(255&s[12])+(254&s[13])/2,64&d?(a=536870912*(14&s[14])+4194304*(255&s[15])+16384*(254&s[16])+128*(255&s[17])+(254&s[18])/2,r-a>54e5&&(t.warn(`${Math.round((r-a)/9e4)}s delta between PTS and DTS, align them`),r=a)):a=r),n=s[8];let c=n+9;if(e.size<=c)return null;e.size-=c;const h=new Uint8Array(e.size);for(let e=0,t=l.length;e<t;e++){s=l[e];let t=s.byteLength;if(c){if(c>t){c-=t;continue}s=s.subarray(c),t-=c,c=0}h.set(s,o),o+=t}return i&&(i-=n+3),{data:h,pts:r,dts:a,len:i}}return null}class on{static getSilentFrame(e,t){if("mp4a.40.2"===e){if(1===t)return new Uint8Array([0,200,0,128,35,128]);if(2===t)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(3===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(4===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(5===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(6===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224])}else{if(1===t)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(2===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(3===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94])}}}const ln=Math.pow(2,32)-1;class dn{static init(){let e;for(e in dn.types={avc1:[],avcC:[],hvc1:[],hvcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],dac3:[],"ac-3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]},dn.types)dn.types.hasOwnProperty(e)&&(dn.types[e]=[e.charCodeAt(0),e.charCodeAt(1),e.charCodeAt(2),e.charCodeAt(3)]);const t=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),s=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);dn.HDLR_TYPES={video:t,audio:s};const i=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),n=new Uint8Array([0,0,0,0,0,0,0,0]);dn.STTS=dn.STSC=dn.STCO=n,dn.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),dn.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),dn.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),dn.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);const r=new Uint8Array([105,115,111,109]),a=new Uint8Array([97,118,99,49]),o=new Uint8Array([0,0,0,1]);dn.FTYP=dn.box(dn.types.ftyp,r,o,r,a),dn.DINF=dn.box(dn.types.dinf,dn.box(dn.types.dref,i))}static box(e,...t){let s=8,i=t.length;const n=i;for(;i--;)s+=t[i].byteLength;const r=new Uint8Array(s);for(r[0]=s>>24&255,r[1]=s>>16&255,r[2]=s>>8&255,r[3]=255&s,r.set(e,4),i=0,s=8;i<n;i++)r.set(t[i],s),s+=t[i].byteLength;return r}static hdlr(e){return dn.box(dn.types.hdlr,dn.HDLR_TYPES[e])}static mdat(e){return dn.box(dn.types.mdat,e)}static mdhd(e,t){t*=e;const s=Math.floor(t/(ln+1)),i=Math.floor(t%(ln+1));return dn.box(dn.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,255&e,s>>24,s>>16&255,s>>8&255,255&s,i>>24,i>>16&255,i>>8&255,255&i,85,196,0,0]))}static mdia(e){return dn.box(dn.types.mdia,dn.mdhd(e.timescale||0,e.duration||0),dn.hdlr(e.type),dn.minf(e))}static mfhd(e){return dn.box(dn.types.mfhd,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,255&e]))}static minf(e){return"audio"===e.type?dn.box(dn.types.minf,dn.box(dn.types.smhd,dn.SMHD),dn.DINF,dn.stbl(e)):dn.box(dn.types.minf,dn.box(dn.types.vmhd,dn.VMHD),dn.DINF,dn.stbl(e))}static moof(e,t,s){return dn.box(dn.types.moof,dn.mfhd(e),dn.traf(s,t))}static moov(e){let t=e.length;const s=[];for(;t--;)s[t]=dn.trak(e[t]);return dn.box.apply(null,[dn.types.moov,dn.mvhd(e[0].timescale||0,e[0].duration||0)].concat(s).concat(dn.mvex(e)))}static mvex(e){let t=e.length;const s=[];for(;t--;)s[t]=dn.trex(e[t]);return dn.box.apply(null,[dn.types.mvex,...s])}static mvhd(e,t){t*=e;const s=Math.floor(t/(ln+1)),i=Math.floor(t%(ln+1)),n=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,255&e,s>>24,s>>16&255,s>>8&255,255&s,i>>24,i>>16&255,i>>8&255,255&i,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return dn.box(dn.types.mvhd,n)}static sdtp(e){const t=e.samples||[],s=new Uint8Array(4+t.length);let i,n;for(i=0;i<t.length;i++)n=t[i].flags,s[i+4]=n.dependsOn<<4|n.isDependedOn<<2|n.hasRedundancy;return dn.box(dn.types.sdtp,s)}static stbl(e){return dn.box(dn.types.stbl,dn.stsd(e),dn.box(dn.types.stts,dn.STTS),dn.box(dn.types.stsc,dn.STSC),dn.box(dn.types.stsz,dn.STSZ),dn.box(dn.types.stco,dn.STCO))}static avc1(e){let t,s,i,n=[],r=[];for(t=0;t<e.sps.length;t++)s=e.sps[t],i=s.byteLength,n.push(i>>>8&255),n.push(255&i),n=n.concat(Array.prototype.slice.call(s));for(t=0;t<e.pps.length;t++)s=e.pps[t],i=s.byteLength,r.push(i>>>8&255),r.push(255&i),r=r.concat(Array.prototype.slice.call(s));const a=dn.box(dn.types.avcC,new Uint8Array([1,n[3],n[4],n[5],255,224|e.sps.length].concat(n).concat([e.pps.length]).concat(r))),o=e.width,l=e.height,d=e.pixelRatio[0],c=e.pixelRatio[1];return dn.box(dn.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,o>>8&255,255&o,l>>8&255,255&l,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),a,dn.box(dn.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),dn.box(dn.types.pasp,new Uint8Array([d>>24,d>>16&255,d>>8&255,255&d,c>>24,c>>16&255,c>>8&255,255&c])))}static esds(e){const t=e.config;return new Uint8Array([0,0,0,0,3,25,0,1,0,4,17,64,21,0,0,0,0,0,0,0,0,0,0,0,5,2,...t,6,1,2])}static audioStsd(e){const t=e.samplerate||0;return new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,e.channelCount||0,0,16,0,0,0,0,t>>8&255,255&t,0,0])}static mp4a(e){return dn.box(dn.types.mp4a,dn.audioStsd(e),dn.box(dn.types.esds,dn.esds(e)))}static mp3(e){return dn.box(dn.types[".mp3"],dn.audioStsd(e))}static ac3(e){return dn.box(dn.types["ac-3"],dn.audioStsd(e),dn.box(dn.types.dac3,e.config))}static stsd(e){const{segmentCodec:t}=e;if("audio"===e.type){if("aac"===t)return dn.box(dn.types.stsd,dn.STSD,dn.mp4a(e));if("ac3"===t&&e.config)return dn.box(dn.types.stsd,dn.STSD,dn.ac3(e));if("mp3"===t&&"mp3"===e.codec)return dn.box(dn.types.stsd,dn.STSD,dn.mp3(e))}else{if(!e.pps||!e.sps)throw new Error("video track missing pps or sps");if("avc"===t)return dn.box(dn.types.stsd,dn.STSD,dn.avc1(e));if("hevc"===t&&e.vps)return dn.box(dn.types.stsd,dn.STSD,dn.hvc1(e))}throw new Error(`unsupported ${e.type} segment codec (${t}/${e.codec})`)}static tkhd(e){const t=e.id,s=(e.duration||0)*(e.timescale||0),i=e.width||0,n=e.height||0,r=Math.floor(s/(ln+1)),a=Math.floor(s%(ln+1));return dn.box(dn.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,255&t,0,0,0,0,r>>24,r>>16&255,r>>8&255,255&r,a>>24,a>>16&255,a>>8&255,255&a,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,i>>8&255,255&i,0,0,n>>8&255,255&n,0,0]))}static traf(e,t){const s=dn.sdtp(e),i=e.id,n=Math.floor(t/(ln+1)),r=Math.floor(t%(ln+1));return dn.box(dn.types.traf,dn.box(dn.types.tfhd,new Uint8Array([0,0,0,0,i>>24,i>>16&255,i>>8&255,255&i])),dn.box(dn.types.tfdt,new Uint8Array([1,0,0,0,n>>24,n>>16&255,n>>8&255,255&n,r>>24,r>>16&255,r>>8&255,255&r])),dn.trun(e,s.length+16+20+8+16+8+8),s)}static trak(e){return e.duration=e.duration||4294967295,dn.box(dn.types.trak,dn.tkhd(e),dn.mdia(e))}static trex(e){const t=e.id;return dn.box(dn.types.trex,new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,255&t,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}static trun(e,t){const s=e.samples||[],i=s.length,n=12+16*i,r=new Uint8Array(n);let a,o,l,d,c,h;for(t+=8+n,r.set(["video"===e.type?1:0,0,15,1,i>>>24&255,i>>>16&255,i>>>8&255,255&i,t>>>24&255,t>>>16&255,t>>>8&255,255&t],0),a=0;a<i;a++)o=s[a],l=o.duration,d=o.size,c=o.flags,h=o.cts,r.set([l>>>24&255,l>>>16&255,l>>>8&255,255&l,d>>>24&255,d>>>16&255,d>>>8&255,255&d,c.isLeading<<2|c.dependsOn,c.isDependedOn<<6|c.hasRedundancy<<4|c.paddingValue<<1|c.isNonSync,61440&c.degradPrio,15&c.degradPrio,h>>>24&255,h>>>16&255,h>>>8&255,255&h],12+16*a);return dn.box(dn.types.trun,r)}static initSegment(e){dn.types||dn.init();const t=dn.moov(e);return ue(dn.FTYP,t)}static hvc1(e){const t=e.params,s=[e.vps,e.sps,e.pps],i=new Uint8Array([1,t.general_profile_space<<6|(t.general_tier_flag?32:0)|t.general_profile_idc,t.general_profile_compatibility_flags[0],t.general_profile_compatibility_flags[1],t.general_profile_compatibility_flags[2],t.general_profile_compatibility_flags[3],t.general_constraint_indicator_flags[0],t.general_constraint_indicator_flags[1],t.general_constraint_indicator_flags[2],t.general_constraint_indicator_flags[3],t.general_constraint_indicator_flags[4],t.general_constraint_indicator_flags[5],t.general_level_idc,240|t.min_spatial_segmentation_idc>>8,255&t.min_spatial_segmentation_idc,252|t.parallelismType,252|t.chroma_format_idc,248|t.bit_depth_luma_minus8,248|t.bit_depth_chroma_minus8,0,parseInt(t.frame_rate.fps),3|t.temporal_id_nested<<2|t.num_temporal_layers<<3|(t.frame_rate.fixed?64:0),s.length]);let n=i.length;for(let e=0;e<s.length;e+=1){n+=3;for(let t=0;t<s[e].length;t+=1)n+=2+s[e][t].length}const r=new Uint8Array(n);r.set(i,0),n=i.length;const a=s.length-1;for(let e=0;e<s.length;e+=1){r.set(new Uint8Array([32+e|(e===a?128:0),0,s[e].length]),n),n+=3;for(let t=0;t<s[e].length;t+=1)r.set(new Uint8Array([s[e][t].length>>8,255&s[e][t].length]),n),n+=2,r.set(s[e][t],n),n+=s[e][t].length}const o=dn.box(dn.types.hvcC,r),l=e.width,d=e.height,c=e.pixelRatio[0],h=e.pixelRatio[1];return dn.box(dn.types.hvc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,l>>8&255,255&l,d>>8&255,255&d,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),o,dn.box(dn.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),dn.box(dn.types.pasp,new Uint8Array([c>>24,c>>16&255,c>>8&255,255&c,h>>24,h>>16&255,h>>8&255,255&h])))}}function cn(e,t,s=1,i=!1){const n=e*t*s;return i?Math.round(n):n}function hn(e,t=!1){return cn(e,1e3,1/9e4,t)}dn.types=void 0,dn.HDLR_TYPES=void 0,dn.STTS=void 0,dn.STSC=void 0,dn.STCO=void 0,dn.STSZ=void 0,dn.VMHD=void 0,dn.SMHD=void 0,dn.STSD=void 0,dn.FTYP=void 0,dn.DINF=void 0;let un,fn=null,gn=null;function mn(e,t,s,i){return{duration:t,size:s,cts:i,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:e?2:1,isNonSync:e?0:1}}}class pn extends T{constructor(e,t,s,i){if(super("mp4-remuxer",i),this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.ISGenerated=!1,this._initPTS=null,this._initDTS=null,this.nextVideoTs=null,this.nextAudioTs=null,this.videoSampleDuration=null,this.isAudioContiguous=!1,this.isVideoContiguous=!1,this.videoTrackConfig=void 0,this.observer=e,this.config=t,this.typeSupported=s,this.ISGenerated=!1,null===fn){const e=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);fn=e?parseInt(e[1]):0}if(null===gn){const e=navigator.userAgent.match(/Safari\/(\d+)/i);gn=e?parseInt(e[1]):0}}destroy(){this.config=this.videoTrackConfig=this._initPTS=this._initDTS=null}resetTimeStamp(e){this.log("initPTS & initDTS reset"),this._initPTS=this._initDTS=e}resetNextTimestamp(){this.log("reset next timestamp"),this.isVideoContiguous=!1,this.isAudioContiguous=!1}resetInitSegment(){this.log("ISGenerated flag reset"),this.ISGenerated=!1,this.videoTrackConfig=void 0}getVideoStartPts(e){let t=!1;const s=e[0].pts,i=e.reduce((e,i)=>{let n=i.pts,r=n-e;return r<-4294967296&&(t=!0,n=yn(n,s),r=n-e),r>0?e:n},s);return t&&this.debug("PTS rollover detected"),i}remux(e,t,s,i,n,r,a,o){let l,d,c,h,u,g,m=n,p=n;const y=e.pid>-1,v=t.pid>-1,E=t.samples.length,T=e.samples.length>0,S=a&&E>0||E>1;if((!y||T)&&(!v||S)||this.ISGenerated||a){if(this.ISGenerated){var b,A,L,w;const e=this.videoTrackConfig;(e&&(t.width!==e.width||t.height!==e.height||(null==(b=t.pixelRatio)?void 0:b[0])!==(null==(A=e.pixelRatio)?void 0:A[0])||(null==(L=t.pixelRatio)?void 0:L[1])!==(null==(w=e.pixelRatio)?void 0:w[1]))||!e&&S||null===this.nextAudioTs&&T)&&this.resetInitSegment()}this.ISGenerated||(c=this.generateIS(e,t,n,r));const s=this.isVideoContiguous;let i,a=-1;if(S&&(a=function(e){for(let t=0;t<e.length;t++)if(e[t].key)return t;return-1}(t.samples),!s&&this.config.forceKeyFrameOnDiscontinuity))if(g=!0,a>0){this.warn(`Dropped ${a} out of ${E} video samples due to a missing keyframe`);const e=this.getVideoStartPts(t.samples);t.samples=t.samples.slice(a),t.dropped+=a,p+=(t.samples[0].pts-e)/t.inputTimeScale,i=p}else-1===a&&(this.warn(`No keyframe found out of ${E} video samples`),g=!1);if(this.ISGenerated){if(T&&S){const s=this.getVideoStartPts(t.samples),i=(yn(e.samples[0].pts,s)-s)/t.inputTimeScale;m+=Math.max(0,i),p+=Math.max(0,-i)}if(T){if(e.samplerate||(this.warn("regenerate InitSegment as audio detected"),c=this.generateIS(e,t,n,r)),d=this.remuxAudio(e,m,this.isAudioContiguous,r,v||S||o===f.AUDIO?p:void 0),S){const i=d?d.endPTS-d.startPTS:0;t.inputTimeScale||(this.warn("regenerate InitSegment as video detected"),c=this.generateIS(e,t,n,r)),l=this.remuxVideo(t,p,s,i)}}else S&&(l=this.remuxVideo(t,p,s,0));l&&(l.firstKeyFrame=a,l.independent=-1!==a,l.firstKeyFramePTS=i)}}return this.ISGenerated&&this._initPTS&&this._initDTS&&(s.samples.length&&(u=vn(s,n,this._initPTS,this._initDTS)),i.samples.length&&(h=En(i,n,this._initPTS))),{audio:d,video:l,initSegment:c,independent:g,text:h,id3:u}}generateIS(e,t,s,i){const n=e.samples,r=t.samples,a=this.typeSupported,o={},l=this._initPTS;let d,c,h,u,f=!l||i,g="audio/mp4";if(f&&(d=c=1/0),e.config&&n.length){switch(e.timescale=e.samplerate,e.segmentCodec){case"mp3":a.mpeg?(g="audio/mpeg",e.codec=""):a.mp3&&(e.codec="mp3");break;case"ac3":e.codec="ac-3"}o.audio={id:"audio",container:g,codec:e.codec,initSegment:"mp3"===e.segmentCodec&&a.mpeg?new Uint8Array(0):dn.initSegment([e]),metadata:{channelCount:e.channelCount}},f&&(u=e.id,h=e.inputTimeScale,l&&h===l.timescale?f=!1:d=c=n[0].pts-Math.round(h*s))}if(t.sps&&t.pps&&r.length){if(t.timescale=t.inputTimeScale,o.video={id:"main",container:"video/mp4",codec:t.codec,initSegment:dn.initSegment([t]),metadata:{width:t.width,height:t.height}},f)if(u=t.id,h=t.inputTimeScale,l&&h===l.timescale)f=!1;else{const e=this.getVideoStartPts(r),t=Math.round(h*s);c=Math.min(c,yn(r[0].dts,e)-t),d=Math.min(d,e-t)}this.videoTrackConfig={width:t.width,height:t.height,pixelRatio:t.pixelRatio}}if(Object.keys(o).length)return this.ISGenerated=!0,f?(this._initPTS={baseTime:d,timescale:h},this._initDTS={baseTime:c,timescale:h}):d=h=void 0,{tracks:o,initPTS:d,timescale:h,trackId:u}}remuxVideo(e,t,s,i){const n=e.inputTimeScale,r=e.samples,d=[],c=r.length,h=this._initPTS,u=h.baseTime*n/h.timescale;let f,g,m=this.nextVideoTs,p=8,v=this.videoSampleDuration,E=Number.POSITIVE_INFINITY,T=Number.NEGATIVE_INFINITY,S=!1;if(!s||null===m){const e=u+t*n,i=r[0].pts-yn(r[0].dts,r[0].pts);fn&&null!==m&&Math.abs(e-i-(m+u))<15e3?s=!0:m=e-i-u}const b=m+u;for(let e=0;e<c;e++){const t=r[e];t.pts=yn(t.pts,b),t.dts=yn(t.dts,b),t.dts<r[e>0?e-1:e].dts&&(S=!0)}S&&r.sort(function(e,t){const s=e.dts-t.dts,i=e.pts-t.pts;return s||i}),f=r[0].dts,g=r[r.length-1].dts;const A=g-f,L=A?Math.round(A/(c-1)):v||e.inputTimeScale/30;if(s){const s=f-b,i=s>L,n=s<-1;if((i||n)&&(i?this.warn(`${(e.segmentCodec||"").toUpperCase()}: ${hn(s,!0)} ms (${s}dts) hole between fragments detected at ${t.toFixed(3)}`):this.warn(`${(e.segmentCodec||"").toUpperCase()}: ${hn(-s,!0)} ms (${s}dts) overlapping between fragments detected at ${t.toFixed(3)}`),!n||b>=r[0].pts||fn)){f=b;const e=r[0].pts-s;if(i)r[0].dts=f,r[0].pts=e;else{let t=!0;for(let i=0;i<r.length&&!(r[i].dts>e&&t);i++){const e=r[i].pts;if(r[i].dts-=s,r[i].pts-=s,i<r.length-1){const s=r[i+1].pts;t=s<=r[i].pts==s<=e}}}this.log(`Video: Initial PTS/DTS adjusted: ${hn(e,!0)}/${hn(f,!0)}, delta: ${hn(s,!0)} ms`)}}f=Math.max(0,f);let w=0,R=0,I=f;for(let e=0;e<c;e++){const t=r[e],s=t.units,i=s.length;let n=0;for(let e=0;e<i;e++)n+=s[e].data.length;R+=n,w+=i,t.length=n,t.dts<I?(t.dts=I,I+=L/4|0||1):I=t.dts,E=Math.min(t.pts,E),T=Math.max(t.pts,T)}g=r[c-1].dts;const x=R+4*w+8;let k;try{k=new Uint8Array(x)}catch(e){return void this.observer.emit(l.ERROR,l.ERROR,{type:a.MUX_ERROR,details:o.REMUX_ALLOC_ERROR,fatal:!1,error:e,bytes:x,reason:`fail allocating video mdat ${x}`})}const D=new DataView(k.buffer);D.setUint32(0,x),k.set(dn.types.mdat,4);let _=!1,C=Number.POSITIVE_INFINITY,P=Number.POSITIVE_INFINITY,M=Number.NEGATIVE_INFINITY,O=Number.NEGATIVE_INFINITY;for(let e=0;e<c;e++){const t=r[e],s=t.units;let a,o=0;for(let e=0,t=s.length;e<t;e++){const t=s[e],i=t.data,n=t.data.byteLength;D.setUint32(p,n),p+=4,k.set(i,p),p+=n,o+=4+n}if(e<c-1)v=r[e+1].dts-t.dts,a=r[e+1].pts-t.pts;else{const s=this.config,o=e>0?t.dts-r[e-1].dts:L;if(a=e>0?t.pts-r[e-1].pts:L,s.stretchShortVideoTrack&&null!==this.nextAudioTs){const e=Math.floor(s.maxBufferHole*n),r=(i?E+i*n:this.nextAudioTs+u)-t.pts;r>e?(v=r-o,v<0?v=o:_=!0,this.log(`It is approximately ${r/90} ms to the next segment; using duration ${v/90} ms for the last video frame.`)):v=o}else v=o}const l=Math.round(t.pts-t.dts);C=Math.min(C,v),M=Math.max(M,v),P=Math.min(P,a),O=Math.max(O,a),d.push(mn(t.key,v,o,l))}if(d.length)if(fn){if(fn<70){const e=d[0].flags;e.dependsOn=2,e.isNonSync=0}}else if(gn&&O-P<M-C&&L/M<.025&&0===d[0].cts){this.warn("Found irregular gaps in sample duration. Using PTS instead of DTS to determine MP4 sample duration.");let e=f;for(let t=0,s=d.length;t<s;t++){const i=e+d[t].duration,n=e+d[t].cts;if(t<s-1){const e=i+d[t+1].cts;d[t].duration=e-n}else d[t].duration=t?d[t-1].duration:L;d[t].cts=0,e=i}}v=_||!v?L:v;const F=g+v;this.nextVideoTs=m=F-u,this.videoSampleDuration=v,this.isVideoContiguous=!0;const N={data1:dn.moof(e.sequenceNumber++,f,y(e,{samples:d})),data2:k,startPTS:(E-u)/n,endPTS:(T+v-u)/n,startDTS:(f-u)/n,endDTS:m/n,type:"video",hasAudio:!1,hasVideo:!0,nb:d.length,dropped:e.dropped};return e.samples=[],e.dropped=0,N}getSamplesPerFrame(e){switch(e.segmentCodec){case"mp3":return 1152;case"ac3":return 1536;default:return 1024}}remuxAudio(e,t,s,i,n){const r=e.inputTimeScale,d=r/(e.samplerate?e.samplerate:r),c=this.getSamplesPerFrame(e),h=c*d,u=this._initPTS,f="mp3"===e.segmentCodec&&this.typeSupported.mpeg,g=[],m=void 0!==n;let p=e.samples,v=f?0:8,E=this.nextAudioTs||-1;const T=u.baseTime*r/u.timescale,S=T+t*r;if(this.isAudioContiguous=s=s||p.length&&E>0&&(i&&Math.abs(S-(E+T))<9e3||Math.abs(yn(p[0].pts,S)-(E+T))<20*h),p.forEach(function(e){e.pts=yn(e.pts,S)}),!s||E<0){if(p=p.filter(e=>e.pts>=0),!p.length)return;E=0===n?0:i&&!m?Math.max(0,S-T):p[0].pts-T}if("aac"===e.segmentCodec){const t=this.config.maxAudioFramesDrift;for(let s=0,i=E+T;s<p.length;s++){const n=p[s],a=n.pts,o=a-i,l=Math.abs(1e3*o/r);if(o<=-t*h&&m)0===s&&(this.warn(`Audio frame @ ${(a/r).toFixed(3)}s overlaps marker by ${Math.round(1e3*o/r)} ms.`),this.nextAudioTs=E=a-T,i=a);else if(o>=t*h&&l<1e4&&m){let t=Math.round(o/h);for(i=a-t*h;i<0&&t&&h;)t--,i+=h;0===s&&(this.nextAudioTs=E=i-T),this.warn(`Injecting ${t} audio frames @ ${((i-T)/r).toFixed(3)}s due to ${Math.round(1e3*o/r)} ms gap.`);for(let r=0;r<t;r++){let t=on.getSilentFrame(e.parsedCodec||e.manifestCodec||e.codec,e.channelCount);t||(this.log("Unable to get silent frame for given audio codec; duplicating last frame instead."),t=n.unit.subarray()),p.splice(s,0,{unit:t,pts:i}),i+=h,s++}}n.pts=i,i+=h}}let b,A=null,L=null,w=0,R=p.length;for(;R--;)w+=p[R].unit.byteLength;for(let t=0,i=p.length;t<i;t++){const i=p[t],n=i.unit;let r=i.pts;if(null!==L)g[t-1].duration=Math.round((r-L)/d);else{if(s&&"aac"===e.segmentCodec&&(r=E+T),A=r,!(w>0))return;w+=v;try{b=new Uint8Array(w)}catch(e){return void this.observer.emit(l.ERROR,l.ERROR,{type:a.MUX_ERROR,details:o.REMUX_ALLOC_ERROR,fatal:!1,error:e,bytes:w,reason:`fail allocating audio mdat ${w}`})}f||(new DataView(b.buffer).setUint32(0,w),b.set(dn.types.mdat,4))}b.set(n,v);const h=n.byteLength;v+=h,g.push(mn(!0,c,h,0)),L=r}const I=g.length;if(!I)return;const x=g[g.length-1];E=L-T,this.nextAudioTs=E+d*x.duration;const k=f?new Uint8Array(0):dn.moof(e.sequenceNumber++,A/d,y({},e,{samples:g}));e.samples=[];const D=(A-T)/r,_=E/r,C={data1:k,data2:b,startPTS:D,endPTS:_,startDTS:D,endDTS:_,type:"audio",hasAudio:!0,hasVideo:!1,nb:I};return this.isAudioContiguous=!0,C}}function yn(e,t){let s;if(null===t)return e;for(s=t<e?-8589934592:8589934592;Math.abs(e-t)>4294967296;)e+=s;return e}function vn(e,t,s,i){const n=e.samples.length;if(!n)return;const r=e.inputTimeScale;for(let a=0;a<n;a++){const n=e.samples[a];n.pts=yn(n.pts-s.baseTime*r/s.timescale,t*r)/r,n.dts=yn(n.dts-i.baseTime*r/i.timescale,t*r)/r}const a=e.samples;return e.samples=[],{samples:a}}function En(e,t,s){const i=e.samples.length;if(!i)return;const n=e.inputTimeScale;for(let r=0;r<i;r++){const i=e.samples[r];i.pts=yn(i.pts-s.baseTime*n/s.timescale,t*n)/n}e.samples.sort((e,t)=>e.pts-t.pts);const r=e.samples;return e.samples=[],{samples:r}}function Tn(e,t,s=!1){return void 0!==(null==e?void 0:e.start)?(e.start+(s?e.duration:0))/e.timescale:t}function Sn(e,t,s){const i=null==e?void 0:e.codec;return i&&i.length>4?i:t===j?"ec-3"===i||"ac-3"===i||"alac"===i?i:"fLaC"===i||"Opus"===i?xe(i,!1):(s.warn(`Unhandled audio codec "${i}" in mp4 MAP`),i||"mp4a"):(s.warn(`Unhandled video codec "${i}" in mp4 MAP`),i||"avc1")}try{un=self.performance.now.bind(self.performance)}catch(e){un=Date.now}const bn=[{demux:class{constructor(e,t){this.remainderData=null,this.timeOffset=0,this.config=void 0,this.videoTrack=void 0,this.audioTrack=void 0,this.id3Track=void 0,this.txtTrack=void 0,this.config=t}resetTimeStamp(){}resetInitSegment(e,t,s,i){const n=this.videoTrack=Di("video",1),r=this.audioTrack=Di("audio",1),a=this.txtTrack=Di("text",1);if(this.id3Track=Di("id3",1),this.timeOffset=0,null==e||!e.byteLength)return;const o=ae(e);if(o.video){const{id:e,timescale:t,codec:s,supplemental:i}=o.video;n.id=e,n.timescale=a.timescale=t,n.codec=s,n.supplemental=i}if(o.audio){const{id:e,timescale:t,codec:s}=o.audio;r.id=e,r.timescale=t,r.codec=s}a.id=Q.text,n.sampleDuration=0,n.duration=r.duration=i}resetContiguity(){this.remainderData=null}static probe(e){return function(e){const t=e.byteLength;for(let s=0;s<t;){const i=te(e,s);if(i>8&&109===e[s+4]&&111===e[s+5]&&111===e[s+6]&&102===e[s+7])return!0;s=i>1?s+i:t}return!1}(e)}demux(e,t){this.timeOffset=t;let s=e;const i=this.videoTrack,n=this.txtTrack;if(this.config.progressive){this.remainderData&&(s=ue(this.remainderData,e));const t=function(e){const t={valid:null,remainder:null},s=ne(e,["moof"]);if(s.length<2)return t.remainder=e,t;const i=s[s.length-1];return t.valid=e.slice(0,i.byteOffset-8),t.remainder=e.slice(i.byteOffset-8),t}(s);this.remainderData=t.remainder,i.samples=t.valid||new Uint8Array}else i.samples=s;const r=this.extractID3Track(i,t);return n.samples=fe(t,i),{videoTrack:i,audioTrack:this.audioTrack,id3Track:r,textTrack:this.txtTrack}}flush(){const e=this.timeOffset,t=this.videoTrack,s=this.txtTrack;t.samples=this.remainderData||new Uint8Array,this.remainderData=null;const i=this.extractID3Track(t,this.timeOffset);return s.samples=fe(e,t),{videoTrack:t,audioTrack:Di(),id3Track:i,textTrack:Di()}}extractID3Track(e,t){const s=this.id3Track;if(e.samples.length){const i=ne(e.samples,["emsg"]);i&&i.forEach(e=>{const i=function(e){const t=e[0];let s="",i="",r=0,a=0,o=0,l=0,d=0,c=0;if(0===t){for(;"\0"!==J(e.subarray(c,c+1));)s+=J(e.subarray(c,c+1)),c+=1;for(s+=J(e.subarray(c,c+1)),c+=1;"\0"!==J(e.subarray(c,c+1));)i+=J(e.subarray(c,c+1)),c+=1;i+=J(e.subarray(c,c+1)),c+=1,r=te(e,12),a=te(e,16),l=te(e,20),d=te(e,24),c=28}else if(1===t){c+=4,r=te(e,c),c+=4;const t=te(e,c);c+=4;const a=te(e,c);for(c+=4,o=2**32*t+a,n(o)||(o=Number.MAX_SAFE_INTEGER,R.warn("Presentation time exceeds safe integer limit and wrapped to max safe integer in parsing emsg box")),l=te(e,c),c+=4,d=te(e,c),c+=4;"\0"!==J(e.subarray(c,c+1));)s+=J(e.subarray(c,c+1)),c+=1;for(s+=J(e.subarray(c,c+1)),c+=1;"\0"!==J(e.subarray(c,c+1));)i+=J(e.subarray(c,c+1)),c+=1;i+=J(e.subarray(c,c+1)),c+=1}return{schemeIdUri:s,value:i,timeScale:r,presentationTime:o,presentationTimeDelta:a,eventDuration:l,id:d,payload:e.subarray(c,e.byteLength)}}(e);if(Ki.test(i.schemeIdUri)){const e=qi(i,t);let n=4294967295===i.eventDuration?Number.POSITIVE_INFINITY:i.eventDuration/i.timeScale;n<=.001&&(n=Number.POSITIVE_INFINITY);const r=i.payload;s.samples.push({data:r,len:r.byteLength,dts:e,pts:e,type:ki.emsg,duration:n})}else if(this.config.enableEmsgKLVMetadata&&i.schemeIdUri.startsWith("urn:misb:KLV:bin:1910.1")){const e=qi(i,t);s.samples.push({data:i.payload,len:i.payload.byteLength,dts:e,pts:e,type:ki.misbklv,duration:Number.POSITIVE_INFINITY})}})}return s}demuxSampleAes(e,t,s){return Promise.reject(new Error("The MP4 demuxer does not support SAMPLE-AES decryption"))}destroy(){this.config=null,this.remainderData=null,this.videoTrack=this.audioTrack=this.id3Track=this.txtTrack=void 0}},remux:class extends T{constructor(e,t,s,i){super("passthrough-remuxer",i),this.emitInitSegment=!1,this.audioCodec=void 0,this.videoCodec=void 0,this.initData=void 0,this.initPTS=null,this.initTracks=void 0,this.lastEndTime=null,this.isVideoContiguous=!1}destroy(){}resetTimeStamp(e){this.lastEndTime=null;const t=this.initPTS;t&&e&&t.baseTime===e.baseTime&&t.timescale===e.timescale||(this.initPTS=e)}resetNextTimestamp(){this.isVideoContiguous=!1,this.lastEndTime=null}resetInitSegment(e,t,s,i){this.audioCodec=t,this.videoCodec=s,this.generateInitSegment(function(e,t){if(!e||!t)return e;const s=t.keyId;return s&&t.isCommonEncryption&&ne(e,["moov","trak"]).forEach(e=>{const t=ne(e,["mdia","minf","stbl","stsd"])[0].subarray(8);let i=ne(t,["enca"]);const n=i.length>0;n||(i=ne(t,["encv"])),i.forEach(e=>{ne(n?e.subarray(28):e.subarray(78),["sinf"]).forEach(e=>{const t=function(e){const t=ne(e,["schm"])[0];if(t){const s=J(t.subarray(4,8));if("cbcs"===s||"cenc"===s)return ne(e,["schi","tenc"])[0]}return null}(e);if(t){const e=t.subarray(8,24);e.some(e=>0!==e)||(R.log(`[eme] Patching keyId in 'enc${n?"a":"v"}>sinf>>tenc' box: ${D(e)} -> ${D(s)}`),t.set(s,8))}})})}),e}(e,i)),this.emitInitSegment=!0}generateInitSegment(e){let{audioCodec:t,videoCodec:s}=this;if(null==e||!e.byteLength)return this.initTracks=void 0,void(this.initData=void 0);const i=this.initData=ae(e);i.audio&&(t=Sn(i.audio,j,this)),i.video&&(s=Sn(i.video,H,this));const n={};i.audio&&i.video?n.audiovideo={container:"video/mp4",codec:t+","+s,supplemental:i.video.supplemental,initSegment:e,id:"main"}:i.audio?n.audio={container:"audio/mp4",codec:t,initSegment:e,id:"audio"}:i.video?n.video={container:"video/mp4",codec:s,supplemental:i.video.supplemental,initSegment:e,id:"main"}:this.warn("initSegment does not contain moov or trak boxes."),this.initTracks=n}remux(e,t,s,n,r,a){var o,l;let{initPTS:d,lastEndTime:c}=this;const h={audio:void 0,video:void 0,text:n,id3:s,initSegment:void 0};i(c)||(c=this.lastEndTime=r||0);const u=t.samples;if(null==u||!u.length)return h;const f={initPTS:void 0,timescale:void 0,trackId:void 0};let g=this.initData;if(null!=(o=g)&&o.length||(this.generateInitSegment(u),g=this.initData),null==(l=g)||!l.length)return this.warn("Failed to generate initSegment."),h;this.emitInitSegment&&(f.tracks=this.initTracks,this.emitInitSegment=!1);const m=function(e,t,s){const n={},r=ne(e,["moof","traf"]);for(let e=0;e<r.length;e++){const a=r[e],o=ne(a,["tfhd"])[0],l=te(o,4),d=t[l];if(!d)continue;const c=n[l]||(n[l]={start:NaN,duration:0,sampleCount:0,timescale:d.timescale,type:d.type}),h=ne(a,["tfdt"])[0];if(h){const e=h[0];let t=te(h,4);1===e&&(t===X?s.warn("[mp4-demuxer]: Ignoring assumed invalid signed 64-bit track fragment decode time"):(t*=X+1,t+=te(h,8))),i(t)&&(!i(c.start)||t<c.start)&&(c.start=t)}const u=d.default,f=te(o,0)|(null==u?void 0:u.flags);let g=(null==u?void 0:u.duration)||0;8&f&&(g=te(o,2&f?12:8));const m=ne(a,["trun"]);let p=c.start||0,y=0,v=g;for(let e=0;e<m.length;e++){const t=m[e],s=te(t,4),i=c.sampleCount;c.sampleCount+=s;const n=1&t[3],r=4&t[3],a=1&t[2],o=2&t[2],l=4&t[2],d=8&t[2];let h=8,u=s;for(n&&(h+=4),r&&s&&(1&t[h+1]||void 0!==c.keyFrameIndex||(c.keyFrameIndex=i),h+=4,a?(v=te(t,h),h+=4):v=g,o&&(h+=4),d&&(h+=4),p+=v,y+=v,u--);u--;)a?(v=te(t,h),h+=4):v=g,o&&(h+=4),l&&(1&t[h+1]||void 0===c.keyFrameIndex&&(c.keyFrameIndex=c.sampleCount-(u+1),c.keyFrameStart=p),h+=4),d&&(h+=4),p+=v,y+=v;!y&&g&&(y+=g*s)}c.duration+=y}if(!Object.keys(n).some(e=>n[e].duration)){let t=1/0,s=0;const r=ne(e,["sidx"]);for(let e=0;e<r.length;e++){const i=re(r[e]);if(null!=i&&i.references){t=Math.min(t,i.earliestPresentationTime/i.timescale);const e=i.references.reduce((e,t)=>e+t.info.duration||0,0);s=Math.max(s,e+i.earliestPresentationTime/i.timescale)}}s&&i(s)&&Object.keys(n).forEach(e=>{n[e].duration||(n[e].duration=s*n[e].timescale-n[e].start)})}return n}(u,g,this),p=g.audio?m[g.audio.id]:null,y=g.video?m[g.video.id]:null,v=Tn(y,1/0),E=Tn(p,1/0),T=Tn(y,0,!0),S=Tn(p,0,!0);let b,A=r,L=0;if(p&&(!y||!d&&E<v||d&&d.trackId===g.audio.id)?(f.trackId=g.audio.id,b=p,L=S-E):y&&(f.trackId=g.video.id,b=y,L=T-v),b){const e=b.timescale;A=b.start/e,f.initPTS=b.start-r*e,f.timescale=e,d||(this.initPTS=d={baseTime:f.initPTS,timescale:e,trackId:f.trackId})}!a&&d||!function(e,t,s,i){if(null===e)return!0;const n=Math.max(i,1),r=t-e.baseTime/e.timescale;return Math.abs(r-s)>n}(d,A,r,L)&&f.timescale===d.timescale||(f.initPTS=A-r,f.timescale=1,d&&1===d.timescale&&this.warn(`Adjusting initPTS @${r} from ${d.baseTime/d.timescale} to ${f.initPTS}`),this.initPTS=d={baseTime:f.initPTS,timescale:1});const w=e?A-d.baseTime/d.timescale:c,R=w+L;L>0?this.lastEndTime=R:(this.warn("Duration parsed from mp4 should be greater than zero"),this.resetNextTimestamp());const I=!!g.audio,x=!!g.video;let k="";I&&(k+="audio"),x&&(k+="video");const D={data1:u,startPTS:w,startDTS:w,endPTS:R,endDTS:R,type:k,hasAudio:I,hasVideo:x,nb:1,dropped:0};h.audio=I&&!x?D:void 0,h.video=x?D:void 0;const _=null==y?void 0:y.sampleCount;if(_){const e=y.keyFrameIndex,t=-1!==e;D.nb=_,D.dropped=0===e||this.isVideoContiguous?0:t?e:_,D.independent=t,D.firstKeyFrame=e,t&&y.keyFrameStart&&(D.firstKeyFramePTS=(y.keyFrameStart-d.baseTime)/d.timescale),this.isVideoContiguous||(h.independent=t),this.isVideoContiguous||(this.isVideoContiguous=t),D.dropped&&this.warn(`fmp4 does not start with IDR: firstIDR ${e}/${_} dropped: ${D.dropped} start: ${D.firstKeyFramePTS||"NA"}`)}return h.initSegment=f,h.id3=vn(s,r,d,d),n.samples.length&&(h.text=En(n,r,d)),h}}},{demux:Ji,remux:pn},{demux:class extends _i{constructor(e,t){super(),this.observer=void 0,this.config=void 0,this.observer=e,this.config=t}resetInitSegment(e,t,s,i){super.resetInitSegment(e,t,s,i),this._audioTrack={container:"audio/adts",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"aac",samples:[],manifestCodec:t,duration:i,inputTimeScale:9e4,dropped:0}}static probe(e,t){if(!e)return!1;const s=ui(e,0);let i=(null==s?void 0:s.length)||0;if(ji(e,i))return!1;for(let s=e.length;i<s;i++)if(yi(e,i))return t.log("ADTS sync word found !"),!0;return!1}canParse(e,t){return function(e,t){return function(e,t){return t+5<e.length}(e,t)&&fi(e,t)&&mi(e,t)<=e.length-t}(e,t)}appendFrame(e,t,s){vi(e,this.observer,t,s,e.manifestCodec);const i=Ti(e,t,s,this.basePTS,this.frameIndex);if(i&&0===i.missing)return i}},remux:pn},{demux:class extends _i{resetInitSegment(e,t,s,i){super.resetInitSegment(e,t,s,i),this._audioTrack={container:"audio/mpeg",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"mp3",samples:[],manifestCodec:t,duration:i,inputTimeScale:9e4,dropped:0}}static probe(e){if(!e)return!1;const t=ui(e,0);let s=(null==t?void 0:t.length)||0;if(t&&11===e[s]&&119===e[s+1]&&void 0!==xi(t)&&Hi(e,s)<=16)return!1;for(let t=e.length;s<t;s++)if(ji(e,s))return R.log("MPEG Audio sync word found !"),!0;return!1}canParse(e,t){return function(e,t){return $i(e,t)&&4<=e.length-t}(e,t)}appendFrame(e,t,s){if(null!==this.basePTS)return Bi(e,t,s,this.basePTS,this.frameIndex)}},remux:pn}];bn.splice(2,0,{demux:class extends _i{constructor(e){super(),this.observer=void 0,this.observer=e}resetInitSegment(e,t,s,i){super.resetInitSegment(e,t,s,i),this._audioTrack={container:"audio/ac-3",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"ac3",samples:[],manifestCodec:t,duration:i,inputTimeScale:9e4,dropped:0}}canParse(e,t){return t+64<e.length}appendFrame(e,t,s){const i=Vi(e,t,s,this.basePTS,this.frameIndex);if(-1!==i)return{sample:e.samples[e.samples.length-1],length:i,missing:0}}static probe(e){if(!e)return!1;const t=ui(e,0);if(!t)return!1;const s=t.length;return 11===e[s]&&119===e[s+1]&&void 0!==xi(t)&&Hi(e,s)<16}},remux:pn});class An{constructor(e,t,s,i,n,r){this.asyncResult=!1,this.logger=void 0,this.observer=void 0,this.typeSupported=void 0,this.config=void 0,this.id=void 0,this.demuxer=void 0,this.remuxer=void 0,this.decrypter=void 0,this.probe=void 0,this.decryptionPromise=null,this.transmuxConfig=void 0,this.currentTransmuxState=void 0,this.observer=e,this.typeSupported=t,this.config=s,this.id=n,this.logger=r}configure(e){this.transmuxConfig=e,this.decrypter&&this.decrypter.reset()}push(e,t,s,i){const n=s.transmuxing;n.executeStart=un();let r=new Uint8Array(e);const{currentTransmuxState:d,transmuxConfig:c}=this;i&&(this.currentTransmuxState=i);const{contiguous:h,discontinuity:u,trackSwitch:f,accurateTimeOffset:g,timeOffset:m,initSegmentChange:p}=i||d,{audioCodec:y,videoCodec:v,defaultInitPts:E,duration:T,initSegmentData:S}=c,b=function(e,t){let s=null;return e.byteLength>0&&null!=(null==t?void 0:t.key)&&null!==t.iv&&null!=t.method&&(s=t),s}(r,t);if(b&&Xt(b.method)){const e=this.getDecrypter(),t=Zt(b.method);if(!e.isSync())return this.asyncResult=!0,this.decryptionPromise=e.webCryptoDecrypt(r,b.key.buffer,b.iv.buffer,t).then(e=>{const t=this.push(e,null,s);return this.decryptionPromise=null,t}),this.decryptionPromise;{let i=e.softwareDecrypt(r,b.key.buffer,b.iv.buffer,t);if(s.part>-1){const t=e.flush();i=t?t.buffer:t}if(!i)return n.executeEnd=un(),Ln(s);r=new Uint8Array(i)}}const A=this.needsProbing(u,f);if(A){const e=this.configureTransmuxer(r);if(e)return this.logger.warn(`[transmuxer] ${e.message}`),this.observer.emit(l.ERROR,l.ERROR,{type:a.MEDIA_ERROR,details:o.FRAG_PARSING_ERROR,fatal:!1,error:e,reason:e.message}),n.executeEnd=un(),Ln(s)}(u||f||p||A)&&this.resetInitSegment(S,y,v,T,t),(u||p||A)&&this.resetInitialTimestamp(E),h||this.resetContiguity();const L=this.transmux(r,b,m,g,s);this.asyncResult=wn(L);const w=this.currentTransmuxState;return w.contiguous=!0,w.discontinuity=!1,w.trackSwitch=!1,n.executeEnd=un(),L}flush(e){const t=e.transmuxing;t.executeStart=un();const{decrypter:s,currentTransmuxState:i,decryptionPromise:n}=this;if(n)return this.asyncResult=!0,n.then(()=>this.flush(e));const r=[],{timeOffset:a}=i;if(s){const t=s.flush();t&&r.push(this.push(t.buffer,null,e))}const{demuxer:o,remuxer:l}=this;if(!o||!l){t.executeEnd=un();const s=[Ln(e)];return this.asyncResult?Promise.resolve(s):s}const d=o.flush(a);return wn(d)?(this.asyncResult=!0,d.then(t=>(this.flushRemux(r,t,e),r))):(this.flushRemux(r,d,e),this.asyncResult?Promise.resolve(r):r)}flushRemux(e,t,s){const{audioTrack:i,videoTrack:n,id3Track:r,textTrack:a}=t,{accurateTimeOffset:o,timeOffset:l}=this.currentTransmuxState;this.logger.log(`[transmuxer.ts]: Flushed ${this.id} sn: ${s.sn}${s.part>-1?" part: "+s.part:""} of ${this.id===f.MAIN?"level":"track"} ${s.level}`);const d=this.remuxer.remux(i,n,r,a,l,o,!0,this.id);e.push({remuxResult:d,chunkMeta:s}),s.transmuxing.executeEnd=un()}resetInitialTimestamp(e){const{demuxer:t,remuxer:s}=this;t&&s&&(t.resetTimeStamp(e),s.resetTimeStamp(e))}resetContiguity(){const{demuxer:e,remuxer:t}=this;e&&t&&(e.resetContiguity(),t.resetNextTimestamp())}resetInitSegment(e,t,s,i,n){const{demuxer:r,remuxer:a}=this;r&&a&&(r.resetInitSegment(e,t,s,i),a.resetInitSegment(e,t,s,n))}destroy(){this.demuxer&&(this.demuxer.destroy(),this.demuxer=void 0),this.remuxer&&(this.remuxer.destroy(),this.remuxer=void 0)}transmux(e,t,s,i,n){let r;return r=t&&"SAMPLE-AES"===t.method?this.transmuxSampleAes(e,t,s,i,n):this.transmuxUnencrypted(e,s,i,n),r}transmuxUnencrypted(e,t,s,i){const{audioTrack:n,videoTrack:r,id3Track:a,textTrack:o}=this.demuxer.demux(e,t,!1,!this.config.progressive);return{remuxResult:this.remuxer.remux(n,r,a,o,t,s,!1,this.id),chunkMeta:i}}transmuxSampleAes(e,t,s,i,n){return this.demuxer.demuxSampleAes(e,t,s).then(e=>({remuxResult:this.remuxer.remux(e.audioTrack,e.videoTrack,e.id3Track,e.textTrack,s,i,!1,this.id),chunkMeta:n}))}configureTransmuxer(e){const{config:t,observer:s,typeSupported:i}=this;let n;for(let t=0,s=bn.length;t<s;t++){var r;if(null!=(r=bn[t].demux)&&r.probe(e,this.logger)){n=bn[t];break}}if(!n)return new Error("Failed to find demuxer by probing fragment data");const a=this.demuxer,o=this.remuxer,l=n.remux,d=n.demux;o&&o instanceof l||(this.remuxer=new l(s,t,i,this.logger)),a&&a instanceof d||(this.demuxer=new d(s,t,i,this.logger),this.probe=d.probe)}needsProbing(e,t){return!this.demuxer||!this.remuxer||e||t}getDecrypter(){let e=this.decrypter;return e||(e=this.decrypter=new xt(this.config)),e}}const Ln=e=>({remuxResult:{},chunkMeta:e});function wn(e){return"then"in e&&e.then instanceof Function}class Rn{constructor(e,t,s,i,n){this.audioCodec=void 0,this.videoCodec=void 0,this.initSegmentData=void 0,this.duration=void 0,this.defaultInitPts=void 0,this.audioCodec=e,this.videoCodec=t,this.initSegmentData=s,this.duration=i,this.defaultInitPts=n||null}}class In{constructor(e,t,s,i,n,r){this.discontinuity=void 0,this.contiguous=void 0,this.accurateTimeOffset=void 0,this.trackSwitch=void 0,this.timeOffset=void 0,this.initSegmentChange=void 0,this.discontinuity=e,this.contiguous=t,this.accurateTimeOffset=s,this.trackSwitch=i,this.timeOffset=n,this.initSegmentChange=r}}let xn=0;class kn{constructor(e,t,s,i){this.error=null,this.hls=void 0,this.id=void 0,this.instanceNo=xn++,this.observer=void 0,this.frag=null,this.part=null,this.useWorker=void 0,this.workerContext=null,this.transmuxer=null,this.onTransmuxComplete=void 0,this.onFlush=void 0,this.onWorkerMessage=e=>{const t=e.data,s=this.hls;if(s&&null!=t&&t.event&&t.instanceNo===this.instanceNo)switch(t.event){case"init":{var i;const e=null==(i=this.workerContext)?void 0:i.objectURL;e&&self.URL.revokeObjectURL(e);break}case"transmuxComplete":this.handleTransmuxComplete(t.data);break;case"flush":this.onFlush(t.data);break;case"workerLog":s.logger[t.data.logType]&&s.logger[t.data.logType](t.data.message);break;default:t.data=t.data||{},t.data.frag=this.frag,t.data.part=this.part,t.data.id=this.id,s.trigger(t.event,t.data)}},this.onWorkerError=e=>{if(!this.hls)return;const t=new Error(`${e.message}  (${e.filename}:${e.lineno})`);this.hls.config.enableWorker=!1,this.hls.logger.warn(`Error in "${this.id}" Web Worker, fallback to inline`),this.hls.trigger(l.ERROR,{type:a.OTHER_ERROR,details:o.INTERNAL_EXCEPTION,fatal:!1,event:"demuxerWorker",error:t})};const n=e.config;this.hls=e,this.id=t,this.useWorker=!!n.enableWorker,this.onTransmuxComplete=s,this.onFlush=i;const r=(e,t)=>{(t=t||{}).frag=this.frag||void 0,e===l.ERROR&&(t.parent=this.id,t.part=this.part,this.error=t.error),this.hls.trigger(e,t)};this.observer=new ai,this.observer.on(l.FRAG_DECRYPTED,r),this.observer.on(l.ERROR,r);const d=Ce(n.preferManagedMediaSource);if(this.useWorker&&"undefined"!=typeof Worker){const s=this.hls.logger;if(n.workerPath||"function"==typeof __HLS_WORKER_BUNDLE__){try{n.workerPath?(s.log(`loading Web Worker ${n.workerPath} for "${t}"`),this.workerContext=function(e){const t=li[e];if(t)return t.clientCount++,t;const s=new self.URL(e,self.location.href).href,i={worker:new self.Worker(s),scriptURL:s,clientCount:1};return li[e]=i,i}(n.workerPath)):(s.log(`injecting Web Worker for "${t}"`),this.workerContext=function(){const e=li[oi];if(e)return e.clientCount++,e;const t=new self.Blob([`var exports={};var module={exports:exports};function define(f){f()};define.amd=true;(${__HLS_WORKER_BUNDLE__.toString()})(true);`],{type:"text/javascript"}),s=self.URL.createObjectURL(t),i={worker:new self.Worker(s),objectURL:s,clientCount:1};return li[oi]=i,i}());const{worker:e}=this.workerContext;e.addEventListener("message",this.onWorkerMessage),e.addEventListener("error",this.onWorkerError),e.postMessage({instanceNo:this.instanceNo,cmd:"init",typeSupported:d,id:t,config:Ye(n)})}catch(i){s.warn(`Error setting up "${t}" Web Worker, fallback to inline`,i),this.terminateWorker(),this.error=null,this.transmuxer=new An(this.observer,d,n,"",t,e.logger)}return}}this.transmuxer=new An(this.observer,d,n,"",t,e.logger)}reset(){if(this.frag=null,this.part=null,this.workerContext){const e=this.instanceNo;this.instanceNo=xn++;const t=this.hls.config,s=Ce(t.preferManagedMediaSource);this.workerContext.worker.postMessage({instanceNo:this.instanceNo,cmd:"reset",resetNo:e,typeSupported:s,id:this.id,config:Ye(t)})}}terminateWorker(){if(this.workerContext){const{worker:e}=this.workerContext;this.workerContext=null,e.removeEventListener("message",this.onWorkerMessage),e.removeEventListener("error",this.onWorkerError),function(e){const t=li[e||oi];if(t&&1===t.clientCount--){const{worker:s,objectURL:i}=t;delete li[e||oi],i&&self.URL.revokeObjectURL(i),s.terminate()}}(this.hls.config.workerPath)}}destroy(){if(this.workerContext)this.terminateWorker(),this.onWorkerMessage=this.onWorkerError=null;else{const e=this.transmuxer;e&&(e.destroy(),this.transmuxer=null)}const e=this.observer;e&&e.removeAllListeners(),this.frag=null,this.part=null,this.observer=null,this.hls=null}push(e,t,s,i,n,r,a,o,l,d){var c,h;l.transmuxing.start=self.performance.now();const{instanceNo:u,transmuxer:g}=this,m=r?r.start:n.start,p=n.decryptdata,y=this.frag,v=!(y&&n.cc===y.cc),E=!(y&&l.level===y.level),T=y?l.sn-y.sn:-1,S=this.part?l.part-this.part.index:-1,b=0===T&&l.id>1&&l.id===(null==y?void 0:y.stats.chunkCount),A=!E&&(1===T||0===T&&(1===S||b&&S<=0)),L=self.performance.now();(E||T||0===n.stats.parsing.start)&&(n.stats.parsing.start=L),!r||!S&&A||(r.stats.parsing.start=L);const w=!(y&&(null==(c=n.initSegment)?void 0:c.url)===(null==(h=y.initSegment)?void 0:h.url)),R=new In(v,A,o,E,m,w);if(!A||v||w){this.hls.logger.log(`[transmuxer-interface]: Starting new transmux session for ${n.type} sn: ${l.sn}${l.part>-1?" part: "+l.part:""} ${this.id===f.MAIN?"level":"track"}: ${l.level} id: ${l.id}\n        discontinuity: ${v}\n        trackSwitch: ${E}\n        contiguous: ${A}\n        accurateTimeOffset: ${o}\n        timeOffset: ${m}\n        initSegmentChange: ${w}`);const e=new Rn(s,i,t,a,d);this.configureTransmuxer(e)}if(this.frag=n,this.part=r,this.workerContext)this.workerContext.worker.postMessage({instanceNo:u,cmd:"demux",data:e,decryptdata:p,chunkMeta:l,state:R},e instanceof ArrayBuffer?[e]:[]);else if(g){const t=g.push(e,p,l,R);wn(t)?t.then(e=>{this.handleTransmuxComplete(e)}).catch(e=>{this.transmuxerError(e,l,"transmuxer-interface push error")}):this.handleTransmuxComplete(t)}}flush(e){e.transmuxing.start=self.performance.now();const{instanceNo:t,transmuxer:s}=this;if(this.workerContext)this.workerContext.worker.postMessage({instanceNo:t,cmd:"flush",chunkMeta:e});else if(s){const t=s.flush(e);wn(t)?t.then(t=>{this.handleFlushResult(t,e)}).catch(t=>{this.transmuxerError(t,e,"transmuxer-interface flush error")}):this.handleFlushResult(t,e)}}transmuxerError(e,t,s){this.hls&&(this.error=e,this.hls.trigger(l.ERROR,{type:a.MEDIA_ERROR,details:o.FRAG_PARSING_ERROR,chunkMeta:t,frag:this.frag||void 0,part:this.part||void 0,fatal:!1,error:e,err:e,reason:s}))}handleFlushResult(e,t){e.forEach(e=>{this.handleTransmuxComplete(e)}),this.onFlush(t)}configureTransmuxer(e){const{instanceNo:t,transmuxer:s}=this;this.workerContext?this.workerContext.worker.postMessage({instanceNo:t,cmd:"configure",config:e}):s&&s.configure(e)}handleTransmuxComplete(e){e.chunkMeta.transmuxing.end=self.performance.now(),this.onTransmuxComplete(e)}}class Dn extends ei{constructor(e,t,s){super(e,t,s,"audio-stream-controller",f.AUDIO),this.mainAnchor=null,this.mainFragLoading=null,this.audioOnly=!1,this.bufferedTrack=null,this.switchingTrack=null,this.trackId=-1,this.waitingData=null,this.mainDetails=null,this.flushing=!1,this.bufferFlushed=!1,this.cachedTrackLoadedData=null,this.registerListeners()}onHandlerDestroying(){this.unregisterListeners(),super.onHandlerDestroying(),this.resetItem()}resetItem(){this.mainDetails=this.mainAnchor=this.mainFragLoading=this.bufferedTrack=this.switchingTrack=this.waitingData=this.cachedTrackLoadedData=null}registerListeners(){super.registerListeners();const{hls:e}=this;e.on(l.LEVEL_LOADED,this.onLevelLoaded,this),e.on(l.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.on(l.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(l.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.on(l.BUFFER_RESET,this.onBufferReset,this),e.on(l.BUFFER_CREATED,this.onBufferCreated,this),e.on(l.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(l.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(l.INIT_PTS_FOUND,this.onInitPtsFound,this),e.on(l.FRAG_LOADING,this.onFragLoading,this),e.on(l.FRAG_BUFFERED,this.onFragBuffered,this)}unregisterListeners(){const{hls:e}=this;e&&(super.unregisterListeners(),e.off(l.LEVEL_LOADED,this.onLevelLoaded,this),e.off(l.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.off(l.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(l.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.off(l.BUFFER_RESET,this.onBufferReset,this),e.off(l.BUFFER_CREATED,this.onBufferCreated,this),e.off(l.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(l.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(l.INIT_PTS_FOUND,this.onInitPtsFound,this),e.off(l.FRAG_LOADING,this.onFragLoading,this),e.off(l.FRAG_BUFFERED,this.onFragBuffered,this))}onInitPtsFound(e,{frag:t,id:s,initPTS:i,timescale:n}){if(s===f.MAIN){const e=t.cc,s=this.fragCurrent;if(this.initPTS[e]={baseTime:i,timescale:n},this.log(`InitPTS for cc: ${e} found from main: ${i}/${n}`),this.mainAnchor=t,this.state===Qs){const s=this.waitingData;(!s&&!this.loadingParts||s&&s.frag.cc!==e)&&this.syncWithAnchor(t,null==s?void 0:s.frag)}else!this.hls.hasEnoughToStart&&s&&s.cc!==e?(s.abortRequests(),this.syncWithAnchor(t,s)):this.state===Hs&&this.tick()}}getLoadPosition(){return!this.startFragRequested&&this.nextLoadPosition>=0?this.nextLoadPosition:super.getLoadPosition()}syncWithAnchor(e,t){var s;const i=(null==(s=this.mainFragLoading)?void 0:s.frag)||null;if(t&&(null==i?void 0:i.cc)===t.cc)return;const n=(i||e).cc,r=ot(this.getLevelDetails(),n,this.getLoadPosition());r&&(this.log(`Syncing with main frag at ${r.start} cc ${r.cc}`),this.startFragRequested=!1,this.nextLoadPosition=r.start,this.resetLoadingState(),this.state===Hs&&this.doTickIdle())}startLoad(e,t){if(!this.levels)return this.startPosition=e,void(this.state=js);const s=this.lastCurrentTime;this.stopLoad(),this.setInterval(100),s>0&&-1===e?(this.log(`Override startPosition with lastCurrentTime @${s.toFixed(3)}`),e=s,this.state=Hs):this.state=Ys,this.nextLoadPosition=this.lastCurrentTime=e+this.timelineOffset,this.startPosition=t?-1:e,this.tick()}doTick(){switch(this.state){case Hs:this.doTickIdle();break;case Ys:{const{levels:e,trackId:t}=this,s=null==e?void 0:e[t],i=null==s?void 0:s.details;if(i&&!this.waitForLive(s)){if(this.waitForCdnTuneIn(i))break;this.state=Qs}break}case qs:{var e;const t=performance.now(),s=this.retryDate;if(!s||t>=s||null!=(e=this.media)&&e.seeking){const{levels:e,trackId:t}=this;this.log("RetryDate reached, switch back to IDLE state"),this.resetStartWhenNotLoaded((null==e?void 0:e[t])||null),this.state=Hs}break}case Qs:{const e=this.waitingData;if(e){const{frag:t,part:s,cache:i,complete:n}=e,r=this.mainAnchor;if(void 0!==this.initPTS[t.cc]){this.waitingData=null,this.state=Ks;const e={frag:t,part:s,payload:i.flush().buffer,networkDetails:null};this._handleFragmentLoadProgress(e),n&&super._handleFragmentLoadComplete(e)}else r&&r.cc!==e.frag.cc&&this.syncWithAnchor(r,e.frag)}else this.state=Hs}}this.onTickEnd()}resetLoadingState(){const e=this.waitingData;e&&(this.fragmentTracker.removeFragment(e.frag),this.waitingData=null),super.resetLoadingState()}onTickEnd(){const{media:e}=this;null!=e&&e.readyState&&(this.lastCurrentTime=e.currentTime)}doTickIdle(){var e;const{hls:t,levels:s,media:i,trackId:n}=this,r=t.config;if(!this.buffering||!i&&!this.primaryPrefetch&&(this.startFragRequested||!r.startFragPrefetch)||null==s||!s[n])return;const a=s[n],o=a.details;if(!o||this.waitForLive(a)||this.waitForCdnTuneIn(o))return this.state=Ys,void(this.startFragRequested=!1);const d=this.mediaBuffer?this.mediaBuffer:this.media;this.bufferFlushed&&d&&(this.bufferFlushed=!1,this.afterBufferFlushed(d,j,f.AUDIO));const c=this.getFwdBufferInfo(d,f.AUDIO);if(null===c)return;if(!this.switchingTrack&&this._streamEnded(c,o))return t.trigger(l.BUFFER_EOS,{type:"audio"}),void(this.state=Xs);const h=c.len,u=t.maxBufferLength,g=o.fragments,m=g[0].start,p=this.getLoadPosition(),y=this.flushing?p:c.end;if(this.switchingTrack&&i){const e=p;o.PTSKnown&&e<m&&(c.end>m||c.nextStart)&&(this.log("Alt audio track ahead of main track, seek to start of alt audio track"),i.currentTime=m+.05)}if(h>=u&&!this.switchingTrack&&y<g[g.length-1].start)return;let v=this.getNextFragment(y,o);if(v&&this.isLoopLoading(v,y)&&(v=this.getNextFragmentLoopLoading(v,o,c,f.MAIN,u)),!v)return void(this.bufferFlushed=!0);let E=(null==(e=this.mainFragLoading)?void 0:e.frag)||null;if(!this.audioOnly&&this.startFragRequested&&E&&q(v)&&!v.endList&&(!o.live||!this.loadingParts&&y<this.hls.liveSyncPosition)&&(this.fragmentTracker.getState(E)===Tt&&(this.mainFragLoading=E=null),E&&q(E))){if(v.start>E.end){const e=this.fragmentTracker.getFragAtPos(y,f.MAIN);e&&e.end>E.end&&(E=e,this.mainFragLoading={frag:e,targetBufferTime:null})}if(v.start>E.end)return}this.loadFragment(v,a,y)}onMediaDetaching(e,t){this.bufferFlushed=this.flushing=!1,super.onMediaDetaching(e,t)}onAudioTracksUpdated(e,{audioTracks:t}){this.resetTransmuxer(),this.levels=t.map(e=>new Ke(e))}onAudioTrackSwitching(e,t){const s=!!t.url;this.trackId=t.id;const{fragCurrent:i}=this;i&&(i.abortRequests(),this.removeUnbufferedFrags(i.start)),this.resetLoadingState(),s?(this.switchingTrack=t,this.flushAudioIfNeeded(t),this.state!==js&&(this.setInterval(100),this.state=Hs,this.tick())):(this.resetTransmuxer(),this.switchingTrack=null,this.bufferedTrack=t,this.clearInterval())}onManifestLoading(){super.onManifestLoading(),this.bufferFlushed=this.flushing=this.audioOnly=!1,this.resetItem(),this.trackId=-1}onLevelLoaded(e,t){this.mainDetails=t.details;const s=this.cachedTrackLoadedData;s&&(this.cachedTrackLoadedData=null,this.onAudioTrackLoaded(l.AUDIO_TRACK_LOADED,s))}onAudioTrackLoaded(e,t){var s;const{levels:i}=this,{details:n,id:r,groupId:a,track:o}=t;if(!i)return void this.warn(`Audio tracks reset while loading track ${r} "${o.name}" of "${a}"`);const d=this.mainDetails;if(!d||n.endCC>d.endCC||d.expired)return this.cachedTrackLoadedData=t,void(this.state!==js&&(this.state=Ys));this.cachedTrackLoadedData=null,this.log(`Audio track ${r} "${o.name}" of "${a}" loaded [${n.startSN},${n.endSN}]${n.lastPartSn?`[part-${n.lastPartSn}-${n.lastPartIndex}]`:""},duration:${n.totalduration}`);const c=i[r];let h=0;if(n.live||null!=(s=c.details)&&s.live){if(this.checkLiveUpdate(n),n.deltaUpdateFailed)return;var u;c.details&&(h=this.alignPlaylists(n,c.details,null==(u=this.levelLastLoaded)?void 0:u.details)),n.alignedSliding||($s(n,d),n.alignedSliding||Gs(n,d),h=n.fragmentStart)}c.details=n,this.levelLastLoaded=c,this.startFragRequested||this.setStartPosition(d,h),this.hls.trigger(l.AUDIO_TRACK_UPDATED,{details:n,id:r,groupId:t.groupId}),this.state!==Ys||this.waitForCdnTuneIn(n)||(this.state=Hs),this.tick()}_handleFragmentLoadProgress(e){var t;const s=e.frag,{part:i,payload:n}=e,{config:r,trackId:a,levels:o}=this;if(!o)return void this.warn(`Audio tracks were reset while fragment load was in progress. Fragment ${s.sn} of level ${s.level} will not be buffered`);const l=o[a];if(!l)return void this.warn("Audio track is undefined on fragment load progress");const d=l.details;if(!d)return this.warn("Audio track details undefined on fragment load progress"),void this.removeUnbufferedFrags(s.start);const c=r.defaultAudioCodec||l.audioCodec||"mp4a.40.2";let h=this.transmuxer;h||(h=this.transmuxer=new kn(this.hls,f.AUDIO,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)));const u=this.initPTS[s.cc],g=null==(t=s.initSegment)?void 0:t.data;if(void 0!==u){const e=!1,t=i?i.index:-1,r=-1!==t,a=new Ot(s.level,s.sn,s.stats.chunkCount,n.byteLength,t,r);h.push(n,g,c,"",s,i,d.totalduration,e,a,u)}else{this.log(`Unknown video PTS for cc ${s.cc}, waiting for video PTS before demuxing audio frag ${s.sn} of [${d.startSN} ,${d.endSN}],track ${a}`);const{cache:e}=this.waitingData=this.waitingData||{frag:s,part:i,cache:new si,complete:!1};e.push(new Uint8Array(n)),this.state!==js&&(this.state=Qs)}}_handleFragmentLoadComplete(e){this.waitingData?this.waitingData.complete=!0:super._handleFragmentLoadComplete(e)}onBufferReset(){this.mediaBuffer=null}onBufferCreated(e,t){this.bufferFlushed=this.flushing=!1;const s=t.tracks.audio;s&&(this.mediaBuffer=s.buffer||null)}onFragLoading(e,t){!this.audioOnly&&t.frag.type===f.MAIN&&q(t.frag)&&(this.mainFragLoading=t,this.state===Hs&&this.tick())}onFragBuffered(e,t){const{frag:s,part:i}=t;if(s.type===f.AUDIO)if(this.fragContextChanged(s))this.warn(`Fragment ${s.sn}${i?" p: "+i.index:""} of level ${s.level} finished buffering, but was aborted. state: ${this.state}, audioSwitch: ${this.switchingTrack?this.switchingTrack.name:"false"}`);else{if(q(s)){this.fragPrevious=s;const e=this.switchingTrack;e&&(this.bufferedTrack=e,this.switchingTrack=null,this.hls.trigger(l.AUDIO_TRACK_SWITCHED,E({},e)))}this.fragBufferedComplete(s,i),this.media&&this.tick()}else this.audioOnly||s.type!==f.MAIN||s.elementaryStreams.video||s.elementaryStreams.audiovideo||(this.audioOnly=!0,this.mainFragLoading=null)}onError(e,t){var s;if(t.fatal)this.state=Zs;else switch(t.details){case o.FRAG_GAP:case o.FRAG_PARSING_ERROR:case o.FRAG_DECRYPT_ERROR:case o.FRAG_LOAD_ERROR:case o.FRAG_LOAD_TIMEOUT:case o.KEY_LOAD_ERROR:case o.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(f.AUDIO,t);break;case o.AUDIO_TRACK_LOAD_ERROR:case o.AUDIO_TRACK_LOAD_TIMEOUT:case o.LEVEL_PARSING_ERROR:t.levelRetry||this.state!==Ys||(null==(s=t.context)?void 0:s.type)!==h||(this.state=Hs);break;case o.BUFFER_ADD_CODEC_ERROR:case o.BUFFER_APPEND_ERROR:if("audio"!==t.parent)return;this.reduceLengthAndFlushBuffer(t)||this.resetLoadingState();break;case o.BUFFER_FULL_ERROR:if("audio"!==t.parent)return;this.reduceLengthAndFlushBuffer(t)&&(this.bufferedTrack=null,super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"));break;case o.INTERNAL_EXCEPTION:this.recoverWorkerError(t)}}onBufferFlushing(e,{type:t}){t!==H&&(this.flushing=!0)}onBufferFlushed(e,{type:t}){if(t!==H){this.flushing=!1,this.bufferFlushed=!0,this.state===Xs&&(this.state=Hs);const e=this.mediaBuffer||this.media;e&&(this.afterBufferFlushed(e,t,f.AUDIO),this.tick())}}_handleTransmuxComplete(e){var t;const s="audio",{hls:i}=this,{remuxResult:n,chunkMeta:r}=e,a=this.getCurrentContext(r);if(!a)return void this.resetWhenMissingContext(r);const{frag:o,part:d,level:c}=a,{details:h}=c,{audio:u,text:f,id3:g,initSegment:m}=n;if(!this.fragContextChanged(o)&&h){if(this.state=Ws,this.switchingTrack&&u&&this.completeAudioSwitch(this.switchingTrack),null!=m&&m.tracks){const e=o.initSegment||o;this._bufferInitSegment(c,m.tracks,e,r),i.trigger(l.FRAG_PARSING_INIT_SEGMENT,{frag:e,id:s,tracks:m.tracks})}if(u){const{startPTS:e,endPTS:t,startDTS:s,endDTS:i}=u;d&&(d.elementaryStreams[j]={startPTS:e,endPTS:t,startDTS:s,endDTS:i}),o.setElementaryStreamInfo(j,e,t,s,i),this.bufferFragmentData(u,o,d,r)}if(null!=g&&null!=(t=g.samples)&&t.length){const e=y({id:s,frag:o,details:h},g);i.trigger(l.FRAG_PARSING_METADATA,e)}if(f){const e=y({id:s,frag:o,details:h},f);i.trigger(l.FRAG_PARSING_USERDATA,e)}}else this.fragmentTracker.removeFragment(o)}_bufferInitSegment(e,t,s,i){if(this.state!==Ws)return;if(t.video&&delete t.video,t.audiovideo&&delete t.audiovideo,!t.audio)return;const n=t.audio;n.id=f.AUDIO;const r=e.audioCodec;this.log(`Init audio buffer, container:${n.container}, codecs[level/parsed]=[${r}/${n.codec}]`),r&&1===r.split(",").length&&(n.levelCodec=r),this.hls.trigger(l.BUFFER_CODECS,t);const a=n.initSegment;if(null!=a&&a.byteLength){const e={type:"audio",frag:s,part:null,chunkMeta:i,parent:s.type,data:a};this.hls.trigger(l.BUFFER_APPENDING,e)}this.tickImmediate()}loadFragment(e,t,s){const i=this.fragmentTracker.getState(e);var n;if(this.switchingTrack||i===yt||i===Et)if(q(e))if(null!=(n=t.details)&&n.live&&!this.initPTS[e.cc]){this.log(`Waiting for video PTS in continuity counter ${e.cc} of live stream before loading audio fragment ${e.sn} of level ${this.trackId}`),this.state=Qs;const s=this.mainDetails;s&&s.fragmentStart!==t.details.fragmentStart&&Gs(t.details,s)}else super.loadFragment(e,t,s);else this._loadInitSegment(e,t);else this.clearTrackerIfNeeded(e)}flushAudioIfNeeded(e){if(this.media&&this.bufferedTrack){const{name:t,lang:s,assocLang:i,characteristics:n,audioCodec:r,channels:a}=this.bufferedTrack;Qe({name:t,lang:s,assocLang:i,characteristics:n,audioCodec:r,channels:a},e,Je)||(tt(e.url,this.hls)?(this.log("Switching audio track : flushing all audio"),super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"),this.bufferedTrack=null):this.bufferedTrack=e)}}completeAudioSwitch(e){const{hls:t}=this;this.flushAudioIfNeeded(e),this.bufferedTrack=e,this.switchingTrack=null,t.trigger(l.AUDIO_TRACK_SWITCHED,E({},e))}}class _n extends T{constructor(e,t){super(t,e.logger),this.hls=void 0,this.canLoad=!1,this.timer=-1,this.hls=e}destroy(){this.clearTimer(),this.hls=this.log=this.warn=null}clearTimer(){-1!==this.timer&&(self.clearTimeout(this.timer),this.timer=-1)}startLoad(){this.canLoad=!0,this.loadPlaylist()}stopLoad(){this.canLoad=!1,this.clearTimer()}switchParams(e,t,s){const i=null==t?void 0:t.renditionReports;if(i){let n=-1;for(let s=0;s<i.length;s++){const r=i[s];let a;try{a=new self.URL(r.URI,t.url).href}catch(e){this.warn(`Could not construct new URL for Rendition Report: ${e}`),a=r.URI||""}if(a===e){n=s;break}a===e.substring(0,a.length)&&(n=s)}if(-1!==n){const e=i[n],r=parseInt(e["LAST-MSN"])||(null==t?void 0:t.lastPartSn);let a=parseInt(e["LAST-PART"])||(null==t?void 0:t.lastPartIndex);if(this.hls.config.lowLatencyMode){const e=Math.min(t.age-t.partTarget,t.targetduration);a>=0&&e>t.partTarget&&(a+=1)}const o=s&&He(s);return new Ve(r,a>=0?a:void 0,o)}}}loadPlaylist(e){this.clearTimer()}loadingPlaylist(e,t){this.clearTimer()}shouldLoadPlaylist(e){return this.canLoad&&!!e&&!!e.url&&(!e.details||e.details.live)}getUrlWithDirectives(e,t){if(t)try{return t.addDirectives(e)}catch(e){this.warn(`Could not construct new URL with HLS Delivery Directives: ${e}`)}return e}playlistLoaded(e,t,s){const{details:n,stats:r}=t,d=self.performance.now(),c=r.loading.first?Math.max(0,d-r.loading.first):0;n.advancedDateTime=Date.now()-c;const h=this.hls.config.timelineOffset;if(h!==n.appliedTimelineOffset){const e=Math.max(h||0,0);n.appliedTimelineOffset=e,n.fragments.forEach(t=>{t.start=t.playlistOffset+e})}if(n.live||null!=s&&s.live){const h="levelInfo"in t?t.levelInfo:t.track;if(n.reloaded(s),s&&n.fragments.length>0){!function(e,t){if(e===t)return;let s=null;const n=e.fragments;for(let e=n.length-1;e>=0;e--){const t=n[e].initSegment;if(t){s=t;break}}let r;e.fragmentHint&&delete e.fragmentHint.endPTS,function(e,t,s){const i=t.skippedSegments,n=Math.max(e.startSN,t.startSN)-t.startSN,r=(e.fragmentHint?1:0)+(i?t.endSN:Math.min(e.endSN,t.endSN))-t.startSN,a=t.startSN-e.startSN,o=t.fragmentHint?t.fragments.concat(t.fragmentHint):t.fragments,l=e.fragmentHint?e.fragments.concat(e.fragmentHint):e.fragments;for(let d=n;d<=r;d++){const n=l[a+d];let r=o[d];if(i&&!r&&n&&(r=t.fragments[d]=n),n&&r){if(s(n,r,d,o),n.url&&n.url!==r.url)return void(t.playlistParsingError=ks(`media sequence mismatch ${r.sn}:`,e,t,0,r));if(n.cc!==r.cc)return void(t.playlistParsingError=ks(`discontinuity sequence mismatch (${n.cc}!=${r.cc})`,e,t,0,r))}}}(e,t,(e,n,a,o)=>{if((!t.startCC||t.skippedSegments)&&n.cc!==e.cc){const s=e.cc-n.cc;for(let e=a;e<o.length;e++)o[e].cc+=s;t.endCC=o[o.length-1].cc}i(e.startPTS)&&i(e.endPTS)&&(n.setStart(n.startPTS=e.startPTS),n.startDTS=e.startDTS,n.maxStartPTS=e.maxStartPTS,n.endPTS=e.endPTS,n.endDTS=e.endDTS,n.minEndPTS=e.minEndPTS,n.setDuration(e.endPTS-e.startPTS),n.duration&&(r=n),t.PTSKnown=t.alignedSliding=!0),e.hasStreams&&(n.elementaryStreams=e.elementaryStreams),n.loader=e.loader,e.hasStats&&(n.stats=e.stats),e.initSegment&&(n.initSegment=e.initSegment,s=e.initSegment)});const a=t.fragments,o=t.fragmentHint?a.concat(t.fragmentHint):a;if(s&&o.forEach(e=>{var t;!e||e.initSegment&&e.initSegment.relurl!==(null==(t=s)?void 0:t.relurl)||(e.initSegment=s)}),t.skippedSegments){if(t.deltaUpdateFailed=a.some(e=>!e),t.deltaUpdateFailed){R.warn("[level-helper] Previous playlist missing segments skipped in delta playlist");for(let e=t.skippedSegments;e--;)a.shift();t.startSN=a[0].sn}else{t.canSkipDateRanges&&(t.dateRanges=function(e,t){const{dateRanges:s,recentlyRemovedDateranges:i}=t,n=y({},e);i&&i.forEach(e=>{delete n[e]});const r=Object.keys(n).length;return r&&Object.keys(s).forEach(e=>{const t=n[e],i=new Wt(s[e].attr,t);i.isValid?(n[e]=i,t||(i.tagOrder+=r)):R.warn(`Ignoring invalid Playlist Delta Update DATERANGE tag: "${Ye(s[e].attr)}"`)}),n}(e.dateRanges,t));const s=e.fragments.filter(e=>e.rawProgramDateTime);if(e.hasProgramDateTime&&!t.hasProgramDateTime)for(let e=1;e<o.length;e++)null===o[e].programDateTime&&bs(o[e],o[e-1],s);ps(s,t)}t.endCC=a[a.length-1].cc}if(!t.startCC){var l;const s=Ps(e,t.startSN-1);t.startCC=null!=(l=null==s?void 0:s.cc)?l:a[0].cc}!function(e,t,s){if(e&&t){let i=0;for(let n=0,r=e.length;n<=r;n++){const r=e[n],a=t[n+i];r&&a&&r.index===a.index&&r.fragment.sn===a.fragment.sn?s(r,a):i--}}}(e.partList,t.partList,(e,t)=>{t.elementaryStreams=e.elementaryStreams,t.stats=e.stats}),r?xs(t,r,r.startPTS,r.endPTS,r.startDTS,r.endDTS):Ds(e,t),a.length&&(t.totalduration=t.edge-a[0].start),t.driftStartTime=e.driftStartTime,t.driftStart=e.driftStart;const d=t.advancedDateTime;if(t.advanced&&d){const e=t.edge;t.driftStart||(t.driftStartTime=d,t.driftStart=e),t.driftEndTime=d,t.driftEnd=e}else t.driftEndTime=e.driftEndTime,t.driftEnd=e.driftEnd,t.advancedDateTime=e.advancedDateTime;-1===t.requestScheduled&&(t.requestScheduled=e.requestScheduled)}(s,n);const e=n.playlistParsingError;if(e){this.warn(e);const s=this.hls;if(!s.config.ignorePlaylistParsingErrors){var u;const{networkDetails:i}=t;return void s.trigger(l.ERROR,{type:a.NETWORK_ERROR,details:o.LEVEL_PARSING_ERROR,fatal:!1,url:n.url,error:e,reason:e.message,level:t.level||void 0,parent:null==(u=n.fragments[0])?void 0:u.type,networkDetails:i,stats:r})}n.playlistParsingError=null}}-1===n.requestScheduled&&(n.requestScheduled=r.loading.start);const f=this.hls.mainForwardBufferInfo,g=f?f.end-f.len:0,m=Cs(n,1e3*(n.edge-g));if(n.requestScheduled+m<d?n.requestScheduled=d:n.requestScheduled+=m,this.log(`live playlist ${e} ${n.advanced?"REFRESHED "+n.lastPartSn+"-"+n.lastPartIndex:n.updated?"UPDATED":"MISSED"}`),!this.canLoad||!n.live)return;let p,v,E;if(n.canBlockReload&&n.endSN&&n.advanced){const e=this.hls.config.lowLatencyMode,i=n.lastPartSn,r=n.endSN,a=n.lastPartIndex,o=i===r;-1!==a?o?(v=r+1,E=e?0:a):(v=i,E=e?a+1:n.maxPartIndex):v=r+1;const l=n.age,c=l+n.ageHeader;let u=Math.min(c-n.partTarget,1.5*n.targetduration);if(u>0){if(c>3*n.targetduration)this.log(`Playlist last advanced ${l.toFixed(2)}s ago. Omitting segment and part directives.`),v=void 0,E=void 0;else if(null!=s&&s.tuneInGoal&&c-n.partTarget>s.tuneInGoal)this.warn(`CDN Tune-in goal increased from: ${s.tuneInGoal} to: ${u} with playlist age: ${n.age}`),u=0;else{const e=Math.floor(u/n.targetduration);v+=e,void 0!==E&&(E+=Math.round(u%n.targetduration/n.partTarget)),this.log(`CDN Tune-in age: ${n.ageHeader}s last advanced ${l.toFixed(2)}s goal: ${u} skip sn ${e} to part ${E}`)}n.tuneInGoal=u}if(p=this.getDeliveryDirectives(n,t.deliveryDirectives,v,E),e||!o)return n.requestScheduled=d,void this.loadingPlaylist(h,p)}else(n.canBlockReload||n.canSkipUntil)&&(p=this.getDeliveryDirectives(n,t.deliveryDirectives,v,E));p&&void 0!==v&&n.canBlockReload&&(n.requestScheduled=r.loading.first+Math.max(m-2*c,m/2)),this.scheduleLoading(h,p,n)}else this.clearTimer()}scheduleLoading(e,t,s){const i=s||e.details;if(!i)return void this.loadingPlaylist(e,t);const n=self.performance.now(),r=i.requestScheduled;if(n>=r)return void this.loadingPlaylist(e,t);const a=r-n;this.log(`reload live playlist ${e.name||e.bitrate+"bps"} in ${Math.round(a)} ms`),this.clearTimer(),this.timer=self.setTimeout(()=>this.loadingPlaylist(e,t),a)}getDeliveryDirectives(e,t,s,i){let n=He(e);return null!=t&&t.skip&&e.deltaUpdateFailed&&(s=t.msn,i=t.part,n=je.No),new Ve(s,i,n)}checkRetry(e){const t=e.details,s=lt(e),i=e.errorAction,{action:n,retryCount:r=0,retryConfig:a}=i||{},o=!!i&&!!a&&(n===ft.RetryRequest||!i.resolved&&n===ft.SendAlternateToPenaltyBox);if(o){var l;if(r>=a.maxNumRetry)return!1;if(s&&null!=(l=e.context)&&l.deliveryDirectives)this.warn(`Retrying playlist loading ${r+1}/${a.maxNumRetry} after "${t}" without delivery-directives`),this.loadPlaylist();else{const e=ct(a,r);this.clearTimer(),this.timer=self.setTimeout(()=>this.loadPlaylist(),e),this.warn(`Retrying playlist loading ${r+1}/${a.maxNumRetry} after "${t}" in ${e}ms`)}e.levelRetry=!0,i.resolved=!0}return o}}function Cn(e,t){if(e.length!==t.length)return!1;for(let s=0;s<e.length;s++)if(!Pn(e[s].attrs,t[s].attrs))return!1;return!0}function Pn(e,t,s){const i=e["STABLE-RENDITION-ID"];return i&&!s?i===t["STABLE-RENDITION-ID"]:!(s||["LANGUAGE","NAME","CHARACTERISTICS","AUTOSELECT","DEFAULT","FORCED","ASSOC-LANGUAGE"]).some(s=>e[s]!==t[s])}function Mn(e,t){return t.label.toLowerCase()===e.name.toLowerCase()&&(!t.language||t.language.toLowerCase()===(e.lang||"").toLowerCase())}class On extends _n{constructor(e){super(e,"audio-track-controller"),this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.registerListeners()}registerListeners(){const{hls:e}=this;e.on(l.MANIFEST_LOADING,this.onManifestLoading,this),e.on(l.MANIFEST_PARSED,this.onManifestParsed,this),e.on(l.LEVEL_LOADING,this.onLevelLoading,this),e.on(l.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(l.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.on(l.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(l.MANIFEST_LOADING,this.onManifestLoading,this),e.off(l.MANIFEST_PARSED,this.onManifestParsed,this),e.off(l.LEVEL_LOADING,this.onLevelLoading,this),e.off(l.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(l.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.off(l.ERROR,this.onError,this)}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,super.destroy()}onManifestLoading(){this.tracks=[],this.tracksInGroup=[],this.groupIds=null,this.currentTrack=null,this.trackId=-1,this.selectDefaultTrack=!0}onManifestParsed(e,t){this.tracks=t.audioTracks||[]}onAudioTrackLoaded(e,t){const{id:s,groupId:i,details:n}=t,r=this.tracksInGroup[s];if(!r||r.groupId!==i)return void this.warn(`Audio track with id:${s} and group:${i} not found in active group ${null==r?void 0:r.groupId}`);const a=r.details;r.details=t.details,this.log(`Audio track ${s} "${r.name}" lang:${r.lang} group:${i} loaded [${n.startSN}-${n.endSN}]`),s===this.trackId&&this.playlistLoaded(s,t,a)}onLevelLoading(e,t){this.switchLevel(t.level)}onLevelSwitching(e,t){this.switchLevel(t.level)}switchLevel(e){const t=this.hls.levels[e];if(!t)return;const s=t.audioGroups||null,i=this.groupIds;let n=this.currentTrack;if(!s||(null==i?void 0:i.length)!==(null==s?void 0:s.length)||null!=s&&s.some(e=>-1===(null==i?void 0:i.indexOf(e)))){this.groupIds=s,this.trackId=-1,this.currentTrack=null;const e=this.tracks.filter(e=>!s||-1!==s.indexOf(e.groupId));if(e.length)this.selectDefaultTrack&&!e.some(e=>e.default)&&(this.selectDefaultTrack=!1),e.forEach((e,t)=>{e.id=t});else if(!n&&!this.tracksInGroup.length)return;this.tracksInGroup=e;const t=this.hls.config.audioPreference;if(!n&&t){const s=Ze(t,e,Je);if(s>-1)n=e[s];else{const e=Ze(t,this.tracks);n=this.tracks[e]}}let i=this.findTrackId(n);-1===i&&n&&(i=this.findTrackId(null));const d={audioTracks:e};this.log(`Updating audio tracks, ${e.length} track(s) found in group(s): ${null==s?void 0:s.join(",")}`),this.hls.trigger(l.AUDIO_TRACKS_UPDATED,d);const c=this.trackId;if(-1!==i&&-1===c)this.setAudioTrack(i);else if(e.length&&-1===c){var r;const t=new Error(`No audio track selected for current audio group-ID(s): ${null==(r=this.groupIds)?void 0:r.join(",")} track count: ${e.length}`);this.warn(t.message),this.hls.trigger(l.ERROR,{type:a.MEDIA_ERROR,details:o.AUDIO_TRACK_LOAD_ERROR,fatal:!0,error:t})}}}onError(e,t){!t.fatal&&t.context&&(t.context.type!==h||t.context.id!==this.trackId||this.groupIds&&-1===this.groupIds.indexOf(t.context.groupId)||this.checkRetry(t))}get allAudioTracks(){return this.tracks}get audioTracks(){return this.tracksInGroup}get audioTrack(){return this.trackId}set audioTrack(e){this.selectDefaultTrack=!1,this.setAudioTrack(e)}setAudioOption(e){const t=this.hls;if(t.config.audioPreference=e,e){const s=this.allAudioTracks;if(this.selectDefaultTrack=!1,s.length){const i=this.currentTrack;if(i&&Qe(e,i,Je))return i;const n=Ze(e,this.tracksInGroup,Je);if(n>-1){const e=this.tracksInGroup[n];return this.setAudioTrack(n),e}if(i){let i=t.loadLevel;-1===i&&(i=t.firstAutoLevel);const n=function(e,t,s,i,n){const r=t[i],a=t.reduce((e,t,s)=>{const i=t.uri;return(e[i]||(e[i]=[])).push(s),e},{})[r.uri];a.length>1&&(i=Math.max.apply(Math,a));const o=r.videoRange,l=r.frameRate,d=r.codecSet.substring(0,4),c=et(t,i,t=>{if(t.videoRange!==o||t.frameRate!==l||t.codecSet.substring(0,4)!==d)return!1;const i=t.audioGroups,r=s.filter(e=>!i||-1!==i.indexOf(e.groupId));return Ze(e,r,n)>-1});return c>-1?c:et(t,i,t=>{const i=t.audioGroups,r=s.filter(e=>!i||-1!==i.indexOf(e.groupId));return Ze(e,r,n)>-1})}(e,t.levels,s,i,Je);if(-1===n)return null;t.nextLoadLevel=n}if(e.channels||e.audioCodec){const t=Ze(e,s);if(t>-1)return s[t]}}}return null}setAudioTrack(e){const t=this.tracksInGroup;if(e<0||e>=t.length)return void this.warn(`Invalid audio track id: ${e}`);this.selectDefaultTrack=!1;const s=this.currentTrack,i=t[e],n=i.details&&!i.details.live;if(e===this.trackId&&i===s&&n)return;if(this.log(`Switching to audio-track ${e} "${i.name}" lang:${i.lang} group:${i.groupId} channels:${i.channels}`),this.trackId=e,this.currentTrack=i,this.hls.trigger(l.AUDIO_TRACK_SWITCHING,E({},i)),n)return;const r=this.switchParams(i.url,null==s?void 0:s.details,i.details);this.loadPlaylist(r)}findTrackId(e){const t=this.tracksInGroup;for(let s=0;s<t.length;s++){const i=t[s];if((!this.selectDefaultTrack||i.default)&&(!e||Qe(e,i,Je)))return s}if(e){const{name:s,lang:i,assocLang:n,characteristics:r,audioCodec:a,channels:o}=e;for(let e=0;e<t.length;e++)if(Qe({name:s,lang:i,assocLang:n,characteristics:r,audioCodec:a,channels:o},t[e],Je))return e;for(let s=0;s<t.length;s++){const i=t[s];if(Pn(e.attrs,i.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return s}for(let s=0;s<t.length;s++){const i=t[s];if(Pn(e.attrs,i.attrs,["LANGUAGE"]))return s}}return-1}loadPlaylist(e){super.loadPlaylist();const t=this.currentTrack;this.shouldLoadPlaylist(t)&&tt(t.url,this.hls)&&this.scheduleLoading(t,e)}loadingPlaylist(e,t){super.loadingPlaylist(e,t);const s=e.id,i=e.groupId,n=this.getUrlWithDirectives(e.url,t),r=e.details,a=null==r?void 0:r.age;this.log(`Loading audio-track ${s} "${e.name}" lang:${e.lang} group:${i}${void 0!==(null==t?void 0:t.msn)?" at sn "+t.msn+" part "+t.part:""}${a&&r.live?" age "+a.toFixed(1)+(r.type?" "+r.type||0:""):""} ${n}`),this.hls.trigger(l.AUDIO_TRACK_LOADING,{url:n,id:s,groupId:i,deliveryDirectives:t||null,track:e})}}class Fn{constructor(e){this.tracks=void 0,this.queues={video:[],audio:[],audiovideo:[]},this.tracks=e}destroy(){this.tracks=this.queues=null}append(e,t,s){if(null===this.queues||null===this.tracks)return;const i=this.queues[t];i.push(e),1!==i.length||s||this.executeNext(t)}appendBlocker(e){return new Promise(t=>{const s={label:"async-blocker",execute:t,onStart:()=>{},onComplete:()=>{},onError:()=>{}};this.append(s,e)})}prependBlocker(e){return new Promise(t=>{if(this.queues){const s={label:"async-blocker-prepend",execute:t,onStart:()=>{},onComplete:()=>{},onError:()=>{}};this.queues[e].unshift(s)}})}removeBlockers(){null!==this.queues&&[this.queues.video,this.queues.audio,this.queues.audiovideo].forEach(e=>{var t;const s=null==(t=e[0])?void 0:t.label;"async-blocker"!==s&&"async-blocker-prepend"!==s||(e[0].execute(),e.splice(0,1))})}unblockAudio(e){null!==this.queues&&this.queues.audio[0]===e&&this.shiftAndExecuteNext("audio")}executeNext(e){if(null===this.queues||null===this.tracks)return;const t=this.queues[e];if(t.length){const i=t[0];try{i.execute()}catch(t){var s;if(i.onError(t),null===this.queues||null===this.tracks)return;const n=null==(s=this.tracks[e])?void 0:s.buffer;null!=n&&n.updating||this.shiftAndExecuteNext(e)}}}shiftAndExecuteNext(e){null!==this.queues&&(this.queues[e].shift(),this.executeNext(e))}current(e){var t;return(null==(t=this.queues)?void 0:t[e][0])||null}toString(){const{queues:e,tracks:t}=this;return null===e||null===t?"<destroyed>":`\n${this.list("video")}\n${this.list("audio")}\n${this.list("audiovideo")}}`}list(e){var t,s;return null!=(t=this.queues)&&t[e]||null!=(s=this.tracks)&&s[e]?`${e}: (${this.listSbInfo(e)}) ${this.listOps(e)}`:""}listSbInfo(e){var t;const s=null==(t=this.tracks)?void 0:t[e],i=null==s?void 0:s.buffer;return i?`SourceBuffer${i.updating?" updating":""}${s.ended?" ended":""}${s.ending?" ending":""}`:"none"}listOps(e){var t;return(null==(t=this.queues)?void 0:t[e].map(e=>e.label).join(", "))||""}}const Nn=/(avc[1234]|hvc1|hev1|dvh[1e]|vp09|av01)(?:\.[^.,]+)+/,Bn="HlsJsTrackRemovedError";class Un extends Error{constructor(e){super(e),this.name=Bn}}class $n extends T{constructor(e,t){var s;super("buffer-controller",e.logger),this.hls=void 0,this.fragmentTracker=void 0,this.details=null,this._objectUrl=null,this.operationQueue=null,this.bufferCodecEventsTotal=0,this.media=null,this.mediaSource=null,this.lastMpegAudioChunk=null,this.blockedAudioAppend=null,this.lastVideoAppendEnd=0,this.appendSource=void 0,this.transferData=void 0,this.overrides=void 0,this.appendErrors={audio:0,video:0,audiovideo:0},this.tracks={},this.sourceBuffers=[[null,null],[null,null]],this._onEndStreaming=e=>{var t;this.hls&&"open"===(null==(t=this.mediaSource)?void 0:t.readyState)&&this.hls.pauseBuffering()},this._onStartStreaming=e=>{this.hls&&this.hls.resumeBuffering()},this._onMediaSourceOpen=e=>{const{media:t,mediaSource:s}=this;e&&this.log("Media source opened"),t&&s&&(s.removeEventListener("sourceopen",this._onMediaSourceOpen),t.removeEventListener("emptied",this._onMediaEmptied),this.updateDuration(),this.hls.trigger(l.MEDIA_ATTACHED,{media:t,mediaSource:s}),null!==this.mediaSource&&this.checkPendingTracks())},this._onMediaSourceClose=()=>{this.log("Media source closed")},this._onMediaSourceEnded=()=>{this.log("Media source ended")},this._onMediaEmptied=()=>{const{mediaSrc:e,_objectUrl:t}=this;e!==t&&this.error(`Media element src was set while attaching MediaSource (${t} > ${e})`)},this.hls=e,this.fragmentTracker=t,this.appendSource=(s=I(e.config.preferManagedMediaSource),"undefined"!=typeof self&&s===self.ManagedMediaSource),this.initTracks(),this.registerListeners()}hasSourceTypes(){return Object.keys(this.tracks).length>0}destroy(){this.unregisterListeners(),this.details=null,this.lastMpegAudioChunk=this.blockedAudioAppend=null,this.transferData=this.overrides=void 0,this.operationQueue&&(this.operationQueue.destroy(),this.operationQueue=null),this.hls=this.fragmentTracker=null,this._onMediaSourceOpen=this._onMediaSourceClose=null,this._onMediaSourceEnded=null,this._onStartStreaming=this._onEndStreaming=null}registerListeners(){const{hls:e}=this;e.on(l.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(l.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(l.MANIFEST_LOADING,this.onManifestLoading,this),e.on(l.MANIFEST_PARSED,this.onManifestParsed,this),e.on(l.BUFFER_RESET,this.onBufferReset,this),e.on(l.BUFFER_APPENDING,this.onBufferAppending,this),e.on(l.BUFFER_CODECS,this.onBufferCodecs,this),e.on(l.BUFFER_EOS,this.onBufferEos,this),e.on(l.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(l.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(l.FRAG_PARSED,this.onFragParsed,this),e.on(l.FRAG_CHANGED,this.onFragChanged,this),e.on(l.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(l.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(l.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(l.MANIFEST_LOADING,this.onManifestLoading,this),e.off(l.MANIFEST_PARSED,this.onManifestParsed,this),e.off(l.BUFFER_RESET,this.onBufferReset,this),e.off(l.BUFFER_APPENDING,this.onBufferAppending,this),e.off(l.BUFFER_CODECS,this.onBufferCodecs,this),e.off(l.BUFFER_EOS,this.onBufferEos,this),e.off(l.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(l.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(l.FRAG_PARSED,this.onFragParsed,this),e.off(l.FRAG_CHANGED,this.onFragChanged,this),e.off(l.ERROR,this.onError,this)}transferMedia(){const{media:e,mediaSource:t}=this;if(!e)return null;const s={};if(this.operationQueue){const e=this.isUpdating();e||this.operationQueue.removeBlockers();const t=this.isQueued();(e||t)&&this.warn(`Transfering MediaSource with${t?" operations in queue":""}${e?" updating SourceBuffer(s)":""} ${this.operationQueue}`),this.operationQueue.destroy()}const i=this.transferData;return!this.sourceBufferCount&&i&&i.mediaSource===t?y(s,i.tracks):this.sourceBuffers.forEach(e=>{const[t]=e;t&&(s[t]=y({},this.tracks[t]),this.removeBuffer(t)),e[0]=e[1]=null}),{media:e,mediaSource:t,tracks:s}}initTracks(){this.sourceBuffers=[[null,null],[null,null]],this.tracks={},this.resetQueue(),this.resetAppendErrors(),this.lastMpegAudioChunk=this.blockedAudioAppend=null,this.lastVideoAppendEnd=0}onManifestLoading(){this.bufferCodecEventsTotal=0,this.details=null}onManifestParsed(e,t){var s;let i=2;(t.audio&&!t.video||!t.altAudio)&&(i=1),this.bufferCodecEventsTotal=i,this.log(`${i} bufferCodec event(s) expected.`),null!=(s=this.transferData)&&s.mediaSource&&this.sourceBufferCount&&i&&this.bufferCreated()}onMediaAttaching(e,t){const s=this.media=t.media,i=I(this.appendSource);if(this.transferData=this.overrides=void 0,s&&i){const e=!!t.mediaSource;(e||t.overrides)&&(this.transferData=t,this.overrides=t.overrides);const n=this.mediaSource=t.mediaSource||new i;if(this.assignMediaSource(n),e)this._objectUrl=s.src,this.attachTransferred();else{const e=this._objectUrl=self.URL.createObjectURL(n);if(this.appendSource)try{s.removeAttribute("src");const t=self.ManagedMediaSource;s.disableRemotePlayback=s.disableRemotePlayback||t&&n instanceof t,Gn(s),function(e,t){const s=self.document.createElement("source");s.type="video/mp4",s.src=t,e.appendChild(s)}(s,e),s.load()}catch(t){s.src=e}else s.src=e}s.addEventListener("emptied",this._onMediaEmptied)}}assignMediaSource(e){var t,s;this.log(`${(null==(t=this.transferData)?void 0:t.mediaSource)===e?"transferred":"created"} media source: ${null==(s=e.constructor)?void 0:s.name}`),e.addEventListener("sourceopen",this._onMediaSourceOpen),e.addEventListener("sourceended",this._onMediaSourceEnded),e.addEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(e.addEventListener("startstreaming",this._onStartStreaming),e.addEventListener("endstreaming",this._onEndStreaming))}attachTransferred(){const e=this.media,t=this.transferData;if(!t||!e)return;const s=this.tracks,i=t.tracks,n=i?Object.keys(i):null,r=n?n.length:0,a=()=>{this.media&&this.mediaSourceOpenOrEnded&&this._onMediaSourceOpen()};if(i&&n&&r){if(!this.tracksReady)return this.hls.config.startFragPrefetch=!0,void this.log("attachTransferred: waiting for SourceBuffer track info");if(this.log(`attachTransferred: (bufferCodecEventsTotal ${this.bufferCodecEventsTotal})\nrequired tracks: ${Ye(s,(e,t)=>"initSegment"===e?void 0:t)};\ntransfer tracks: ${Ye(i,(e,t)=>"initSegment"===e?void 0:t)}}`),!x(i,s)){t.mediaSource=null,t.tracks=void 0;const n=e.currentTime,r=this.details,a=Math.max(n,(null==r?void 0:r.fragments[0].start)||0);return a-n>1?void this.log(`attachTransferred: waiting for playback to reach new tracks start time ${n} -> ${a}`):(this.warn(`attachTransferred: resetting MediaSource for incompatible tracks ("${Object.keys(i)}"->"${Object.keys(s)}") start time: ${a} currentTime: ${n}`),this.onMediaDetaching(l.MEDIA_DETACHING,{}),this.onMediaAttaching(l.MEDIA_ATTACHING,t),void(e.currentTime=a))}this.transferData=void 0,n.forEach(e=>{const t=e,s=i[t];if(s){const e=s.buffer;if(e){const i=this.fragmentTracker,n=s.id;if(i.hasFragments(n)||i.hasParts(n)){const s=Nt.getBuffered(e);i.detectEvictedFragments(t,s,n,null,!0)}const r=jn(t),a=[t,e];this.sourceBuffers[r]=a,e.updating&&this.operationQueue&&this.operationQueue.prependBlocker(t),this.trackSourceBuffer(t,s)}}}),a(),this.bufferCreated()}else this.log("attachTransferred: MediaSource w/o SourceBuffers"),a()}get mediaSourceOpenOrEnded(){var e;const t=null==(e=this.mediaSource)?void 0:e.readyState;return"open"===t||"ended"===t}onMediaDetaching(e,t){const s=!!t.transferMedia;this.transferData=this.overrides=void 0;const{media:i,mediaSource:n,_objectUrl:r}=this;if(n){if(this.log("media source "+(s?"transferring":"detaching")),s)this.sourceBuffers.forEach(([e])=>{e&&this.removeBuffer(e)}),this.resetQueue();else{if(this.mediaSourceOpenOrEnded){const e="open"===n.readyState;try{const t=n.sourceBuffers;for(let s=t.length;s--;)e&&t[s].abort(),n.removeSourceBuffer(t[s]);e&&n.endOfStream()}catch(e){this.warn(`onMediaDetaching: ${e.message} while calling endOfStream`)}}this.sourceBufferCount&&this.onBufferReset()}n.removeEventListener("sourceopen",this._onMediaSourceOpen),n.removeEventListener("sourceended",this._onMediaSourceEnded),n.removeEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(n.removeEventListener("startstreaming",this._onStartStreaming),n.removeEventListener("endstreaming",this._onEndStreaming)),this.mediaSource=null,this._objectUrl=null}i&&(i.removeEventListener("emptied",this._onMediaEmptied),s||(r&&self.URL.revokeObjectURL(r),this.mediaSrc===r?(i.removeAttribute("src"),this.appendSource&&Gn(i),i.load()):this.warn("media|source.src was changed by a third party - skip cleanup")),this.media=null),this.hls.trigger(l.MEDIA_DETACHED,t)}onBufferReset(){this.sourceBuffers.forEach(([e])=>{e&&this.resetBuffer(e)}),this.initTracks()}resetBuffer(e){var t;const s=null==(t=this.tracks[e])?void 0:t.buffer;if(this.removeBuffer(e),s)try{var i;null!=(i=this.mediaSource)&&i.sourceBuffers.length&&this.mediaSource.removeSourceBuffer(s)}catch(t){this.warn(`onBufferReset ${e}`,t)}delete this.tracks[e]}removeBuffer(e){this.removeBufferListeners(e),this.sourceBuffers[jn(e)]=[null,null];const t=this.tracks[e];t&&(t.buffer=void 0)}resetQueue(){this.operationQueue&&this.operationQueue.destroy(),this.operationQueue=new Fn(this.tracks)}onBufferCodecs(e,t){const s=this.tracks,i=Object.keys(t);this.log(`BUFFER_CODECS: "${i}" (current SB count ${this.sourceBufferCount})`);const n="audiovideo"in t&&(s.audio||s.video)||s.audiovideo&&("audio"in t||"video"in t),r=!n&&this.sourceBufferCount&&this.media&&i.some(e=>!s[e]);n||r?this.warn(`Unsupported transition between "${Object.keys(s)}" and "${i}" SourceBuffers`):(i.forEach(e=>{var i,n,r;const a=t[e],{id:o,codec:l,levelCodec:d,container:c,metadata:h,supplemental:u}=a;let f=s[e];const g=null==(i=this.transferData)||null==(n=i.tracks)?void 0:n[e],m=null!=g&&g.buffer?g:f,p=(null==m?void 0:m.pendingCodec)||(null==m?void 0:m.codec),y=null==m?void 0:m.levelCodec;f||(f=s[e]={buffer:void 0,listeners:[],codec:l,supplemental:u,container:c,levelCodec:d,metadata:h,id:o});const v=ke(p,y),E=null==v?void 0:v.replace(Nn,"$1");let T=ke(l,d);const S=null==(r=T)?void 0:r.replace(Nn,"$1");T&&v&&E!==S&&("audio"===e.slice(0,5)&&(T=xe(T,this.appendSource)),this.log(`switching codec ${p} to ${T}`),T!==(f.pendingCodec||f.codec)&&(f.pendingCodec=T),f.container=c,this.appendChangeType(e,c,T))}),(this.tracksReady||this.sourceBufferCount)&&(t.tracks=this.sourceBufferTracks),this.sourceBufferCount||this.mediaSourceOpenOrEnded&&this.checkPendingTracks())}get sourceBufferTracks(){return Object.keys(this.tracks).reduce((e,t)=>{const s=this.tracks[t];return e[t]={id:s.id,container:s.container,codec:s.codec,levelCodec:s.levelCodec},e},{})}appendChangeType(e,t,s){const i=`${t};codecs=${s}`,n={label:`change-type=${i}`,execute:()=>{const n=this.tracks[e];if(n){const r=n.buffer;null!=r&&r.changeType&&(this.log(`changing ${e} sourceBuffer type to ${i}`),r.changeType(i),n.codec=s,n.container=t)}this.shiftAndExecuteNext(e)},onStart:()=>{},onComplete:()=>{},onError:t=>{this.warn(`Failed to change ${e} SourceBuffer type`,t)}};this.append(n,e,this.isPending(this.tracks[e]))}blockAudio(e){var t;const s=e.start,i=s+.05*e.duration;if(!0===(null==(t=this.fragmentTracker.getAppendedFrag(s,f.MAIN))?void 0:t.gap))return;const n={label:"block-audio",execute:()=>{var e;const t=this.tracks.video;(this.lastVideoAppendEnd>i||null!=t&&t.buffer&&Nt.isBuffered(t.buffer,i)||!0===(null==(e=this.fragmentTracker.getAppendedFrag(i,f.MAIN))?void 0:e.gap))&&(this.blockedAudioAppend=null,this.shiftAndExecuteNext("audio"))},onStart:()=>{},onComplete:()=>{},onError:e=>{this.warn("Error executing block-audio operation",e)}};this.blockedAudioAppend={op:n,frag:e},this.append(n,"audio",!0)}unblockAudio(){const{blockedAudioAppend:e,operationQueue:t}=this;e&&t&&(this.blockedAudioAppend=null,t.unblockAudio(e.op))}onBufferAppending(e,t){const{tracks:s}=this,{data:n,type:r,parent:d,frag:c,part:h,chunkMeta:u,offset:f}=t,g=u.buffering[r],{sn:m,cc:p}=c,y=self.performance.now();g.start=y;const v=c.stats.buffering,E=h?h.stats.buffering:null;0===v.start&&(v.start=y),E&&0===E.start&&(E.start=y);const T=s.audio;let S=!1;"audio"===r&&"audio/mpeg"===(null==T?void 0:T.container)&&(S=!this.lastMpegAudioChunk||1===u.id||this.lastMpegAudioChunk.sn!==u.sn,this.lastMpegAudioChunk=u);const b=s.video,A=null==b?void 0:b.buffer;if(A&&"initSegment"!==m){const e=h||c,t=this.blockedAudioAppend;if("audio"!==r||"main"===d||this.blockedAudioAppend){if("video"===r){const s=e.end;if(t){const e=t.frag.start;(s>e||s<this.lastVideoAppendEnd||Nt.isBuffered(A,e))&&this.unblockAudio()}this.lastVideoAppendEnd=s}}else{const t=e.start+.05*e.duration,s=A.buffered,i=this.currentOp("video");s.length||i?!i&&!Nt.isBuffered(A,t)&&this.lastVideoAppendEnd<t&&this.blockAudio(e):this.blockAudio(e)}}const L=(h||c).start,w={label:`append-${r}`,execute:()=>{var e;g.executeStart=self.performance.now();const t=null==(e=this.tracks[r])?void 0:e.buffer;t&&(S?this.updateTimestampOffset(t,L,.1,r,m,p):void 0!==f&&i(f)&&this.updateTimestampOffset(t,f,1e-6,r,m,p)),this.appendExecutor(n,r)},onStart:()=>{},onComplete:()=>{const e=self.performance.now();g.executeEnd=g.end=e,0===v.first&&(v.first=e),E&&0===E.first&&(E.first=e);const t={};this.sourceBuffers.forEach(([e,s])=>{e&&(t[e]=Nt.getBuffered(s))}),this.appendErrors[r]=0,"audio"===r||"video"===r?this.appendErrors.audiovideo=0:(this.appendErrors.audio=0,this.appendErrors.video=0),this.hls.trigger(l.BUFFER_APPENDED,{type:r,frag:c,part:h,chunkMeta:u,parent:c.type,timeRanges:t})},onError:e=>{var t;const s={type:a.MEDIA_ERROR,parent:c.type,details:o.BUFFER_APPEND_ERROR,sourceBufferName:r,frag:c,part:h,chunkMeta:u,error:e,err:e,fatal:!1},i=null==(t=this.media)?void 0:t.error;if(e.code===DOMException.QUOTA_EXCEEDED_ERR||"QuotaExceededError"==e.name||"quota"in e)s.details=o.BUFFER_FULL_ERROR;else if(e.code===DOMException.INVALID_STATE_ERR&&this.mediaSourceOpenOrEnded&&!i)s.errorAction=pt(!0);else if(e.name===Bn&&0===this.sourceBufferCount)s.errorAction=pt(!0);else{const e=++this.appendErrors[r];this.warn(`Failed ${e}/${this.hls.config.appendErrorMaxRetry} times to append segment in "${r}" sourceBuffer (${i||"no media error"})`),(e>=this.hls.config.appendErrorMaxRetry||i)&&(s.fatal=!0)}this.hls.trigger(l.ERROR,s)}};this.append(w,r,this.isPending(this.tracks[r]))}getFlushOp(e,t,s){return this.log(`queuing "${e}" remove ${t}-${s}`),{label:"remove",execute:()=>{this.removeExecutor(e,t,s)},onStart:()=>{},onComplete:()=>{this.hls.trigger(l.BUFFER_FLUSHED,{type:e})},onError:i=>{this.warn(`Failed to remove ${t}-${s} from "${e}" SourceBuffer`,i)}}}onBufferFlushing(e,t){const{type:s,startOffset:i,endOffset:n}=t;s?this.append(this.getFlushOp(s,i,n),s):this.sourceBuffers.forEach(([e])=>{e&&this.append(this.getFlushOp(e,i,n),e)})}onFragParsed(e,t){const{frag:s,part:i}=t,n=[],r=i?i.elementaryStreams:s.elementaryStreams;r[V]?n.push("audiovideo"):(r[j]&&n.push("audio"),r[H]&&n.push("video")),0===n.length&&this.warn(`Fragments must have at least one ElementaryStreamType set. type: ${s.type} level: ${s.level} sn: ${s.sn}`),this.blockBuffers(()=>{const e=self.performance.now();s.stats.buffering.end=e,i&&(i.stats.buffering.end=e);const t=i?i.stats:s.stats;this.hls.trigger(l.FRAG_BUFFERED,{frag:s,part:i,stats:t,id:s.type})},n).catch(e=>{this.warn(`Fragment buffered callback ${e}`),this.stepOperationQueue(this.sourceBufferTypes)})}onFragChanged(e,t){this.trimBuffers()}get bufferedToEnd(){return this.sourceBufferCount>0&&!this.sourceBuffers.some(([e])=>{var t,s;return e&&(!(null!=(t=this.tracks[e])&&t.ended)||(null==(s=this.tracks[e])?void 0:s.ending))})}onBufferEos(e,t){var s;this.sourceBuffers.forEach(([e])=>{if(e){const s=this.tracks[e];t.type&&t.type!==e||(s.ending=!0,s.ended||(s.ended=!0,this.log(`${e} buffer reached EOS`)))}});const i=!1!==(null==(s=this.overrides)?void 0:s.endOfStream);this.sourceBufferCount>0&&!this.sourceBuffers.some(([e])=>{var t;return e&&!(null!=(t=this.tracks[e])&&t.ended)})&&(i?(this.log("Queueing EOS"),this.blockUntilOpen(()=>{this.tracksEnded();const{mediaSource:e}=this;e&&"open"===e.readyState?(this.log("Calling mediaSource.endOfStream()"),e.endOfStream(),this.hls.trigger(l.BUFFERED_TO_END,void 0)):e&&this.log(`Could not call mediaSource.endOfStream(). mediaSource.readyState: ${e.readyState}`)})):(this.tracksEnded(),this.hls.trigger(l.BUFFERED_TO_END,void 0)))}tracksEnded(){this.sourceBuffers.forEach(([e])=>{if(null!==e){const t=this.tracks[e];t&&(t.ending=!1)}})}onLevelUpdated(e,{details:t}){t.fragments.length&&(this.details=t,this.updateDuration())}updateDuration(){this.blockUntilOpen(()=>{const e=this.getDurationAndRange();e&&this.updateMediaSource(e)})}onError(e,t){if(t.details===o.BUFFER_APPEND_ERROR&&t.frag){var s;const e=null==(s=t.errorAction)?void 0:s.nextAutoLevel;i(e)&&e!==t.frag.level&&this.resetAppendErrors()}}resetAppendErrors(){this.appendErrors={audio:0,video:0,audiovideo:0}}trimBuffers(){const{hls:e,details:t,media:s}=this;if(!s||null===t)return;if(!this.sourceBufferCount)return;const n=e.config,r=s.currentTime,a=t.levelTargetDuration,o=t.live&&null!==n.liveBackBufferLength?n.liveBackBufferLength:n.backBufferLength;if(i(o)&&o>=0){const e=Math.max(o,a),t=Math.floor(r/a)*a-e;this.flushBackBuffer(r,a,t)}if(i(n.frontBufferFlushThreshold)&&n.frontBufferFlushThreshold>0){const e=Math.max(n.maxBufferLength,n.frontBufferFlushThreshold),t=Math.max(e,a),s=Math.floor(r/a)*a+t;this.flushFrontBuffer(r,a,s)}}flushBackBuffer(e,t,s){this.sourceBuffers.forEach(([e,t])=>{if(t){const n=Nt.getBuffered(t);if(n.length>0&&s>n.start(0)){var i;this.hls.trigger(l.BACK_BUFFER_REACHED,{bufferEnd:s});const t=this.tracks[e];if(null!=(i=this.details)&&i.live)this.hls.trigger(l.LIVE_BACK_BUFFER_REACHED,{bufferEnd:s});else if(null!=t&&t.ended)return void this.log(`Cannot flush ${e} back buffer while SourceBuffer is in ended state`);this.hls.trigger(l.BUFFER_FLUSHING,{startOffset:0,endOffset:s,type:e})}}})}flushFrontBuffer(e,t,s){this.sourceBuffers.forEach(([t,i])=>{if(i){const n=Nt.getBuffered(i),r=n.length;if(r<2)return;const a=n.start(r-1),o=n.end(r-1);if(s>a||e>=a&&e<=o)return;this.hls.trigger(l.BUFFER_FLUSHING,{startOffset:a,endOffset:1/0,type:t})}})}getDurationAndRange(){var e;const{details:t,mediaSource:s}=this;if(!t||!this.media||"open"!==(null==s?void 0:s.readyState))return null;const n=t.edge;if(t.live&&this.hls.config.liveDurationInfinity){if(t.fragments.length&&t.live&&s.setLiveSeekableRange){const e=Math.max(0,t.fragmentStart);return{duration:1/0,start:e,end:Math.max(e,n)}}return{duration:1/0}}const r=null==(e=this.overrides)?void 0:e.duration;if(r)return i(r)?{duration:r}:null;const a=this.media.duration;return n>(i(s.duration)?s.duration:0)&&n>a||!i(a)?{duration:n}:null}updateMediaSource({duration:e,start:t,end:s}){const n=this.mediaSource;this.media&&n&&"open"===n.readyState&&(n.duration!==e&&(i(e)&&this.log(`Updating MediaSource duration to ${e.toFixed(3)}`),n.duration=e),void 0!==t&&void 0!==s&&(this.log(`MediaSource duration is set to ${n.duration}. Setting seekable range to ${t}-${s}.`),n.setLiveSeekableRange(t,s)))}get tracksReady(){const e=this.pendingTrackCount;return e>0&&(e>=this.bufferCodecEventsTotal||this.isPending(this.tracks.audiovideo))}checkPendingTracks(){const{bufferCodecEventsTotal:e,pendingTrackCount:t,tracks:s}=this;if(this.log(`checkPendingTracks (pending: ${t} codec events expected: ${e}) ${Ye(s)}`),this.tracksReady){var i;const e=null==(i=this.transferData)?void 0:i.tracks;e&&Object.keys(e).length?this.attachTransferred():this.createSourceBuffers()}}bufferCreated(){if(this.sourceBufferCount){const e={};this.sourceBuffers.forEach(([t,s])=>{if(t){const i=this.tracks[t];e[t]={buffer:s,container:i.container,codec:i.codec,supplemental:i.supplemental,levelCodec:i.levelCodec,id:i.id,metadata:i.metadata}}}),this.hls.trigger(l.BUFFER_CREATED,{tracks:e}),this.log(`SourceBuffers created. Running queue: ${this.operationQueue}`),this.sourceBuffers.forEach(([e])=>{this.executeNext(e)})}else{const e=new Error("could not create source buffer for media codec(s)");this.hls.trigger(l.ERROR,{type:a.MEDIA_ERROR,details:o.BUFFER_INCOMPATIBLE_CODECS_ERROR,fatal:!0,error:e,reason:e.message})}}createSourceBuffers(){const{tracks:e,sourceBuffers:t,mediaSource:s}=this;if(!s)throw new Error("createSourceBuffers called when mediaSource was null");for(const n in e){const r=n,d=e[r];if(this.isPending(d)){const e=this.getTrackCodec(d,r),n=`${d.container};codecs=${e}`;d.codec=e,this.log(`creating sourceBuffer(${n})${this.currentOp(r)?" Queued":""} ${Ye(d)}`);try{const e=s.addSourceBuffer(n),i=jn(r),a=[r,e];t[i]=a,d.buffer=e}catch(e){var i;return this.error(`error while trying to add sourceBuffer: ${e.message}`),this.shiftAndExecuteNext(r),null==(i=this.operationQueue)||i.removeBlockers(),delete this.tracks[r],void this.hls.trigger(l.ERROR,{type:a.MEDIA_ERROR,details:o.BUFFER_ADD_CODEC_ERROR,fatal:!1,error:e,sourceBufferName:r,mimeType:n,parent:d.id})}this.trackSourceBuffer(r,d)}}this.bufferCreated()}getTrackCodec(e,t){const s=e.supplemental;let i=e.codec;s&&("video"===t||"audiovideo"===t)&&Se(s,"video")&&(i=function(e,t){const s=[];if(e){const t=e.split(",");for(let e=0;e<t.length;e++)Te(t[e],"video")||s.push(t[e])}return t&&s.push(t),s.join(",")}(i,s));const n=ke(i,e.levelCodec);return n?"audio"===t.slice(0,5)?xe(n,this.appendSource):n:""}trackSourceBuffer(e,t){const s=t.buffer;if(!s)return;const i=this.getTrackCodec(t,e);this.tracks[e]={buffer:s,codec:i,container:t.container,levelCodec:t.levelCodec,supplemental:t.supplemental,metadata:t.metadata,id:t.id,listeners:[]},this.removeBufferListeners(e),this.addBufferListener(e,"updatestart",this.onSBUpdateStart),this.addBufferListener(e,"updateend",this.onSBUpdateEnd),this.addBufferListener(e,"error",this.onSBUpdateError),this.appendSource&&this.addBufferListener(e,"bufferedchange",(e,t)=>{const s=t.removedRanges;null!=s&&s.length&&this.hls.trigger(l.BUFFER_FLUSHED,{type:e})})}get mediaSrc(){var e,t;const s=(null==(e=this.media)||null==(t=e.querySelector)?void 0:t.call(e,"source"))||this.media;return null==s?void 0:s.src}onSBUpdateStart(e){const t=this.currentOp(e);t&&t.onStart()}onSBUpdateEnd(e){var t;if("closed"===(null==(t=this.mediaSource)?void 0:t.readyState))return void this.resetBuffer(e);const s=this.currentOp(e);s&&(s.onComplete(),this.shiftAndExecuteNext(e))}onSBUpdateError(e,t){var s;const i=new Error(`${e} SourceBuffer error. MediaSource readyState: ${null==(s=this.mediaSource)?void 0:s.readyState}`);this.error(`${i}`,t),this.hls.trigger(l.ERROR,{type:a.MEDIA_ERROR,details:o.BUFFER_APPENDING_ERROR,sourceBufferName:e,error:i,fatal:!1});const n=this.currentOp(e);n&&n.onError(i)}updateTimestampOffset(e,t,s,i,n,r){const a=t-e.timestampOffset;Math.abs(a)>=s&&(this.log(`Updating ${i} SourceBuffer timestampOffset to ${t} (sn: ${n} cc: ${r})`),e.timestampOffset=t)}removeExecutor(e,t,s){const{media:n,mediaSource:r}=this,a=this.tracks[e],o=null==a?void 0:a.buffer;if(!n||!r||!o)return this.warn(`Attempting to remove from the ${e} SourceBuffer, but it does not exist`),void this.shiftAndExecuteNext(e);const l=i(n.duration)?n.duration:1/0,d=i(r.duration)?r.duration:1/0,c=Math.max(0,t),h=Math.min(s,l,d);h>c&&(!a.ending||a.ended)?(a.ended=!1,this.log(`Removing [${c},${h}] from the ${e} SourceBuffer`),o.remove(c,h)):this.shiftAndExecuteNext(e)}appendExecutor(e,t){const s=this.tracks[t],i=null==s?void 0:s.buffer;if(!i)throw new Un(`Attempting to append to the ${t} SourceBuffer, but it does not exist`);s.ending=!1,s.ended=!1,i.appendBuffer(e)}blockUntilOpen(e){if(this.isUpdating()||this.isQueued())this.blockBuffers(e).catch(e=>{this.warn(`SourceBuffer blocked callback ${e}`),this.stepOperationQueue(this.sourceBufferTypes)});else try{e()}catch(e){this.warn(`Callback run without blocking ${this.operationQueue} ${e}`)}}isUpdating(){return this.sourceBuffers.some(([e,t])=>e&&t.updating)}isQueued(){return this.sourceBuffers.some(([e])=>e&&!!this.currentOp(e))}isPending(e){return!!e&&!e.buffer}blockBuffers(e,t=this.sourceBufferTypes){if(!t.length)return this.log("Blocking operation requested, but no SourceBuffers exist"),Promise.resolve().then(e);const{operationQueue:s}=this,i=t.map(e=>this.appendBlocker(e));return t.length>1&&!!this.blockedAudioAppend&&this.unblockAudio(),Promise.all(i).then(t=>{s===this.operationQueue&&(e(),this.stepOperationQueue(this.sourceBufferTypes))})}stepOperationQueue(e){e.forEach(e=>{var t;const s=null==(t=this.tracks[e])?void 0:t.buffer;s&&!s.updating&&this.shiftAndExecuteNext(e)})}append(e,t,s){this.operationQueue&&this.operationQueue.append(e,t,s)}appendBlocker(e){if(this.operationQueue)return this.operationQueue.appendBlocker(e)}currentOp(e){return this.operationQueue?this.operationQueue.current(e):null}executeNext(e){e&&this.operationQueue&&this.operationQueue.executeNext(e)}shiftAndExecuteNext(e){this.operationQueue&&this.operationQueue.shiftAndExecuteNext(e)}get pendingTrackCount(){return Object.keys(this.tracks).reduce((e,t)=>e+(this.isPending(this.tracks[t])?1:0),0)}get sourceBufferCount(){return this.sourceBuffers.reduce((e,[t])=>e+(t?1:0),0)}get sourceBufferTypes(){return this.sourceBuffers.map(([e])=>e).filter(e=>!!e)}addBufferListener(e,t,s){const i=this.tracks[e];if(!i)return;const n=i.buffer;if(!n)return;const r=s.bind(this,e);i.listeners.push({event:t,listener:r}),n.addEventListener(t,r)}removeBufferListeners(e){const t=this.tracks[e];if(!t)return;const s=t.buffer;s&&(t.listeners.forEach(e=>{s.removeEventListener(e.event,e.listener)}),t.listeners.length=0)}}function Gn(e){const t=e.querySelectorAll("source");[].slice.call(t).forEach(t=>{e.removeChild(t)})}function jn(e){return"audio"===e?1:0}class Hn{constructor(e){this.hls=void 0,this.autoLevelCapping=void 0,this.firstLevel=void 0,this.media=void 0,this.restrictedLevels=void 0,this.timer=void 0,this.clientRect=void 0,this.streamController=void 0,this.hls=e,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.firstLevel=-1,this.media=null,this.restrictedLevels=[],this.timer=void 0,this.clientRect=null,this.registerListeners()}setStreamController(e){this.streamController=e}destroy(){this.hls&&this.unregisterListener(),this.timer&&this.stopCapping(),this.media=null,this.clientRect=null,this.hls=this.streamController=null}registerListeners(){const{hls:e}=this;e.on(l.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.on(l.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(l.MANIFEST_PARSED,this.onManifestParsed,this),e.on(l.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(l.BUFFER_CODECS,this.onBufferCodecs,this),e.on(l.MEDIA_DETACHING,this.onMediaDetaching,this)}unregisterListener(){const{hls:e}=this;e.off(l.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.off(l.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(l.MANIFEST_PARSED,this.onManifestParsed,this),e.off(l.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(l.BUFFER_CODECS,this.onBufferCodecs,this),e.off(l.MEDIA_DETACHING,this.onMediaDetaching,this)}onFpsDropLevelCapping(e,t){const s=this.hls.levels[t.droppedLevel];this.isLevelAllowed(s)&&this.restrictedLevels.push({bitrate:s.bitrate,height:s.height,width:s.width})}onMediaAttaching(e,t){this.media=t.media instanceof HTMLVideoElement?t.media:null,this.clientRect=null,this.timer&&this.hls.levels.length&&this.detectPlayerSize()}onManifestParsed(e,t){const s=this.hls;this.restrictedLevels=[],this.firstLevel=t.firstLevel,s.config.capLevelToPlayerSize&&t.video&&this.startCapping()}onLevelsUpdated(e,t){this.timer&&i(this.autoLevelCapping)&&this.detectPlayerSize()}onBufferCodecs(e,t){this.hls.config.capLevelToPlayerSize&&t.video&&this.startCapping()}onMediaDetaching(){this.stopCapping(),this.media=null}detectPlayerSize(){if(this.media){if(this.mediaHeight<=0||this.mediaWidth<=0)return void(this.clientRect=null);const e=this.hls.levels;if(e.length){const t=this.hls,s=this.getMaxLevel(e.length-1);s!==this.autoLevelCapping&&t.logger.log(`Setting autoLevelCapping to ${s}: ${e[s].height}p@${e[s].bitrate} for media ${this.mediaWidth}x${this.mediaHeight}`),t.autoLevelCapping=s,t.autoLevelEnabled&&t.autoLevelCapping>this.autoLevelCapping&&this.streamController&&this.streamController.nextLevelSwitch(),this.autoLevelCapping=t.autoLevelCapping}}}getMaxLevel(e){const t=this.hls.levels;if(!t.length)return-1;const s=t.filter((t,s)=>this.isLevelAllowed(t)&&s<=e);return this.clientRect=null,Hn.getMaxLevelByMediaSize(s,this.mediaWidth,this.mediaHeight)}startCapping(){this.timer||(this.autoLevelCapping=Number.POSITIVE_INFINITY,self.clearInterval(this.timer),this.timer=self.setInterval(this.detectPlayerSize.bind(this),1e3),this.detectPlayerSize())}stopCapping(){this.restrictedLevels=[],this.firstLevel=-1,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.timer&&(self.clearInterval(this.timer),this.timer=void 0)}getDimensions(){if(this.clientRect)return this.clientRect;const e=this.media,t={width:0,height:0};if(e){const s=e.getBoundingClientRect();t.width=s.width,t.height=s.height,t.width||t.height||(t.width=s.right-s.left||e.width||0,t.height=s.bottom-s.top||e.height||0)}return this.clientRect=t,t}get mediaWidth(){return this.getDimensions().width*this.contentScaleFactor}get mediaHeight(){return this.getDimensions().height*this.contentScaleFactor}get contentScaleFactor(){let e=1;if(!this.hls.config.ignoreDevicePixelRatio)try{e=self.devicePixelRatio}catch(e){}return Math.min(e,this.hls.config.maxDevicePixelRatio)}isLevelAllowed(e){return!this.restrictedLevels.some(t=>e.bitrate===t.bitrate&&e.width===t.width&&e.height===t.height)}static getMaxLevelByMediaSize(e,t,s){if(null==e||!e.length)return-1;const i=(e,t)=>!t||e.width!==t.width||e.height!==t.height;let n=e.length-1;const r=Math.max(t,s);for(let t=0;t<e.length;t+=1){const s=e[t];if((s.width>=r||s.height>=r)&&i(s,e[t+1])){n=t;break}}return n}}const Vn="a",Kn="av",qn="CMCD-Object",Yn="CMCD-Request",Wn="CMCD-Session",zn="CMCD-Status",Xn={[qn]:["br","ab","d","ot","tb","tpb","lb","tab","lab","url"],[Yn]:["pb","bl","tbl","dl","ltc","mtp","nor","nrr","rc","sn","sta","su","ttfb","ttfbb","ttlb","cmsdd","cmsds","smrt","df","cs"],[Wn]:["cid","pr","sf","sid","st","v","msd"],[zn]:["bs","bsd","cdn","rtp","bg","pt","ec","e"]};class Zn{constructor(e,t){Array.isArray(e)&&(e=e.map(e=>e instanceof Zn?e:new Zn(e))),this.value=e,this.params=t}}function Qn(e,t,s){return function(e,t,s,i){return new Error(`failed to serialize "${n=t,Array.isArray(n)?JSON.stringify(n):n instanceof Map?"Map{}":n instanceof Set?"Set{}":"object"==typeof n?JSON.stringify(n):String(n)}" as ${s}`,{cause:i});var n}(0,e,t,s)}class Jn{constructor(e){this.description=e}}const er="Bare Item";function tr(e){if(function(e){return e<-999999999999999||999999999999999<e}(e))throw Qn(e,"Integer");return e.toString()}function sr(e,t){if(e<0)return-sr(-e,t);const s=Math.pow(10,t);if(Math.abs(e*s%1-.5)<Number.EPSILON){const t=Math.floor(e*s);return(t%2==0?t:t+1)/s}return Math.round(e*s)/s}function ir(e){const t=sr(e,3);if(Math.floor(Math.abs(t)).toString().length>12)throw Qn(e,"Decimal");const s=t.toString();return s.includes(".")?s:`${s}.0`}const nr=/[\x00-\x1f\x7f]+/;function rr(e){const t=(s=e).description||s.toString().slice(7,-1);var s;if(!1===/^([a-zA-Z*])([!#$%&'*+\-.^_`|~\w:/]*)$/.test(t))throw Qn(t,"Token");return t}function ar(e){switch(typeof e){case"number":if(!i(e))throw Qn(e,er);return Number.isInteger(e)?tr(e):ir(e);case"string":return function(e){if(nr.test(e))throw Qn(e,"String");return`"${e.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}"`}(e);case"symbol":return rr(e);case"boolean":return function(e){if("boolean"!=typeof e)throw Qn(e,"Boolean");return e?"?1":"?0"}(e);case"object":if(e instanceof Date)return function(e){return`@${tr(e.getTime()/1e3)}`}(e);if(e instanceof Uint8Array)return function(e){if(!1===ArrayBuffer.isView(e))throw Qn(e,"Byte Sequence");return`:${t=e,btoa(String.fromCharCode(...t))}:`;var t}(e);if(e instanceof Jn)return rr(e);default:throw Qn(e,er)}}function or(e){if(!1===/^[a-z*][a-z0-9\-_.*]*$/.test(e))throw Qn(e,"Key");return e}function lr(e){return null==e?"":Object.entries(e).map(([e,t])=>!0===t?`;${or(e)}`:`;${or(e)}=${ar(t)}`).join("")}function dr(e){return e instanceof Zn?`${ar(e.value)}${lr(e.params)}`:ar(e)}const cr=e=>Math.round(e),hr=e=>100*cr(e/100),ur={br:cr,d:cr,bl:hr,dl:hr,mtp:hr,nor:(e,t)=>((null==t?void 0:t.baseUrl)&&(e=function(e,t){const s=new URL(e),i=new URL(t);if(s.origin!==i.origin)return e;const n=s.pathname.split("/").slice(1),r=i.pathname.split("/").slice(1,-1);for(;n[0]===r[0];)n.shift(),r.shift();for(;r.length;)r.shift(),n.unshift("..");return n.join("/")}(e,t.baseUrl)),encodeURIComponent(e)),rtp:hr,tb:cr};function fr(e,t={}){return e?function(e,t){return function(e,t={whitespace:!0}){if("object"!=typeof e)throw Qn(e,"Dict");const s=e instanceof Map?e.entries():Object.entries(e),i=(null==t?void 0:t.whitespace)?" ":"";return Array.from(s).map(([e,t])=>{t instanceof Zn==0&&(t=new Zn(t));let s=or(e);var i;return!0===t.value?s+=lr(t.params):(s+="=",Array.isArray(t.value)?s+=`(${(i=t).value.map(dr).join(" ")})${lr(i.params)}`:s+=dr(t)),s}).join(`,${i}`)}(e,t)}(function(e,t){const s={};if(null==e||"object"!=typeof e)return s;const n=Object.keys(e).sort(),r=y({},ur,null==t?void 0:t.formatters),a=null==t?void 0:t.filter;return n.forEach(n=>{if(!1===(null==a?void 0:a(n)))return;let o=e[n];const l=r[n];l&&(o=l(o,t)),"v"===n&&1===o||"pr"==n&&1===o||function(e){return"number"==typeof e?i(e):null!=e&&""!==e&&!1!==e}(o)&&(function(e){return["ot","sf","st","e","sta"].includes(e)}(n)&&"string"==typeof o&&(o=new Jn(o)),s[n]=o)}),s}(e,t),y({whitespace:!1},t)):""}const gr=/CMCD=[^&#]+/;class mr{constructor(e){this.hls=void 0,this.config=void 0,this.media=void 0,this.sid=void 0,this.cid=void 0,this.useHeaders=!1,this.includeKeys=void 0,this.initialized=!1,this.starved=!1,this.buffering=!0,this.audioBuffer=void 0,this.videoBuffer=void 0,this.onWaiting=()=>{this.initialized&&(this.starved=!0),this.buffering=!0},this.onPlaying=()=>{this.initialized||(this.initialized=!0),this.buffering=!1},this.applyPlaylistData=e=>{try{this.apply(e,{ot:"m",su:!this.initialized})}catch(e){this.hls.logger.warn("Could not generate manifest CMCD data.",e)}},this.applyFragmentData=e=>{try{const{frag:t,part:s}=e,i=this.hls.levels[t.level],n=this.getObjectType(t),r={d:1e3*(s||t).duration,ot:n};"v"!==n&&n!==Vn&&n!=Kn||(r.br=i.bitrate/1e3,r.tb=this.getTopBandwidth(n)/1e3,r.bl=this.getBufferLength(n));const a=s?this.getNextPart(s):this.getNextFrag(t);null!=a&&a.url&&a.url!==t.url&&(r.nor=a.url),this.apply(e,r)}catch(e){this.hls.logger.warn("Could not generate segment CMCD data.",e)}},this.hls=e;const t=this.config=e.config,{cmcd:s}=t;null!=s&&(t.pLoader=this.createPlaylistLoader(),t.fLoader=this.createFragmentLoader(),this.sid=s.sessionId||e.sessionId,this.cid=s.contentId,this.useHeaders=!0===s.useHeaders,this.includeKeys=s.includeKeys,this.registerListeners())}registerListeners(){const e=this.hls;e.on(l.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(l.MEDIA_DETACHED,this.onMediaDetached,this),e.on(l.BUFFER_CREATED,this.onBufferCreated,this)}unregisterListeners(){const e=this.hls;e.off(l.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(l.MEDIA_DETACHED,this.onMediaDetached,this),e.off(l.BUFFER_CREATED,this.onBufferCreated,this)}destroy(){this.unregisterListeners(),this.onMediaDetached(),this.hls=this.config=this.audioBuffer=this.videoBuffer=null,this.onWaiting=this.onPlaying=this.media=null}onMediaAttached(e,t){this.media=t.media,this.media.addEventListener("waiting",this.onWaiting),this.media.addEventListener("playing",this.onPlaying)}onMediaDetached(){this.media&&(this.media.removeEventListener("waiting",this.onWaiting),this.media.removeEventListener("playing",this.onPlaying),this.media=null)}onBufferCreated(e,t){var s,i;this.audioBuffer=null==(s=t.tracks.audio)?void 0:s.buffer,this.videoBuffer=null==(i=t.tracks.video)?void 0:i.buffer}createData(){var e;return{v:1,sf:"h",sid:this.sid,cid:this.cid,pr:null==(e=this.media)?void 0:e.playbackRate,mtp:this.hls.bandwidthEstimate/1e3}}apply(e,t={}){y(t,this.createData());const s="i"===t.ot||"v"===t.ot||t.ot===Kn;this.starved&&s&&(t.bs=!0,t.su=!0,this.starved=!1),null==t.su&&(t.su=this.buffering);const{includeKeys:i}=this;i&&(t=Object.keys(t).reduce((e,s)=>(i.includes(s)&&(e[s]=t[s]),e),{}));const n={baseUrl:e.url};this.useHeaders?(e.headers||(e.headers={}),function(e,t,s){y(e,function(e,t={}){const s={};if(!e)return s;const i=Object.entries(e),n=Object.entries(Xn).concat(Object.entries((null==t?void 0:t.customHeaderMap)||{})),r=i.reduce((e,t)=>{var s,i;const[r,a]=t,o=(null===(s=n.find(e=>e[1].includes(r)))||void 0===s?void 0:s[0])||Yn;return null!==(i=e[o])&&void 0!==i||(e[o]={}),e[o][r]=a,e},{});return Object.entries(r).reduce((e,[s,i])=>(e[s]=fr(i,t),e),s)}(t,s))}(e.headers,t,n)):e.url=function(e,t,s){const i=function(e,t={}){if(!e)return"";const s=fr(e,t);return`CMCD=${encodeURIComponent(s)}`}(t,s);if(!i)return e;if(gr.test(e))return e.replace(gr,i);const n=e.includes("?")?"&":"?";return`${e}${n}${i}`}(e.url,t,n)}getNextFrag(e){var t;const s=null==(t=this.hls.levels[e.level])?void 0:t.details;if(s){const t=e.sn-s.startSN;return s.fragments[t+1]}}getNextPart(e){var t,s;const{index:i,fragment:n}=e,r=null==(t=this.hls.levels[n.level])||null==(s=t.details)?void 0:s.partList;if(r){const{sn:e}=n;for(let t=r.length-1;t>=0;t--){const s=r[t];if(s.index===i&&s.fragment.sn===e)return r[t+1]}}}getObjectType(e){const{type:t}=e;return"subtitle"===t?"tt":"initSegment"===e.sn?"i":"audio"===t?Vn:"main"===t?this.hls.audioTracks.length?"v":Kn:void 0}getTopBandwidth(e){let t,s=0;const i=this.hls;if(e===Vn)t=i.audioTracks;else{const e=i.maxAutoLevel,s=e>-1?e+1:i.levels.length;t=i.levels.slice(0,s)}return t.forEach(e=>{e.bitrate>s&&(s=e.bitrate)}),s>0?s:NaN}getBufferLength(e){const t=this.media,s=e===Vn?this.audioBuffer:this.videoBuffer;return s&&t?1e3*Nt.bufferInfo(s,t.currentTime,this.config.maxBufferHole).len:NaN}createPlaylistLoader(){const{pLoader:e}=this.config,t=this.applyPlaylistData,s=e||this.config.loader;return class{constructor(e){this.loader=void 0,this.loader=new s(e)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(e,s,i){t(e),this.loader.load(e,s,i)}}}createFragmentLoader(){const{fLoader:e}=this.config,t=this.applyFragmentData,s=e||this.config.loader;return class{constructor(e){this.loader=void 0,this.loader=new s(e)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(e,s,i){t(e),this.loader.load(e,s,i)}}}}class pr extends T{constructor(e){super("content-steering",e.logger),this.hls=void 0,this.loader=null,this.uri=null,this.pathwayId=".",this._pathwayPriority=null,this.timeToLoad=300,this.reloadTimer=-1,this.updated=0,this.started=!1,this.enabled=!0,this.levels=null,this.audioTracks=null,this.subtitleTracks=null,this.penalizedPathways={},this.hls=e,this.registerListeners()}registerListeners(){const e=this.hls;e.on(l.MANIFEST_LOADING,this.onManifestLoading,this),e.on(l.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(l.MANIFEST_PARSED,this.onManifestParsed,this),e.on(l.ERROR,this.onError,this)}unregisterListeners(){const e=this.hls;e&&(e.off(l.MANIFEST_LOADING,this.onManifestLoading,this),e.off(l.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(l.MANIFEST_PARSED,this.onManifestParsed,this),e.off(l.ERROR,this.onError,this))}pathways(){return(this.levels||[]).reduce((e,t)=>(-1===e.indexOf(t.pathwayId)&&e.push(t.pathwayId),e),[])}get pathwayPriority(){return this._pathwayPriority}set pathwayPriority(e){this.updatePathwayPriority(e)}startLoad(){if(this.started=!0,this.clearTimeout(),this.enabled&&this.uri){if(this.updated){const e=1e3*this.timeToLoad-(performance.now()-this.updated);if(e>0)return void this.scheduleRefresh(this.uri,e)}this.loadSteeringManifest(this.uri)}}stopLoad(){this.started=!1,this.loader&&(this.loader.destroy(),this.loader=null),this.clearTimeout()}clearTimeout(){-1!==this.reloadTimer&&(self.clearTimeout(this.reloadTimer),this.reloadTimer=-1)}destroy(){this.unregisterListeners(),this.stopLoad(),this.hls=null,this.levels=this.audioTracks=this.subtitleTracks=null}removeLevel(e){const t=this.levels;t&&(this.levels=t.filter(t=>t!==e))}onManifestLoading(){this.stopLoad(),this.enabled=!0,this.timeToLoad=300,this.updated=0,this.uri=null,this.pathwayId=".",this.levels=this.audioTracks=this.subtitleTracks=null}onManifestLoaded(e,t){const{contentSteering:s}=t;null!==s&&(this.pathwayId=s.pathwayId,this.uri=s.uri,this.started&&this.startLoad())}onManifestParsed(e,t){this.audioTracks=t.audioTracks,this.subtitleTracks=t.subtitleTracks}onError(e,t){const{errorAction:s}=t;if((null==s?void 0:s.action)===ft.SendAlternateToPenaltyBox&&s.flags===gt.MoveAllAlternatesMatchingHost){const e=this.levels;let i=this._pathwayPriority,n=this.pathwayId;if(t.context){const{groupId:s,pathwayId:i,type:r}=t.context;s&&e?n=this.getPathwayForGroupId(s,r,n):i&&(n=i)}n in this.penalizedPathways||(this.penalizedPathways[n]=performance.now()),!i&&e&&(i=this.pathways()),i&&i.length>1&&(this.updatePathwayPriority(i),s.resolved=this.pathwayId!==n),t.details!==o.BUFFER_APPEND_ERROR||t.fatal?s.resolved||this.warn(`Could not resolve ${t.details} ("${t.error.message}") with content-steering for Pathway: ${n} levels: ${e?e.length:e} priorities: ${Ye(i)} penalized: ${Ye(this.penalizedPathways)}`):s.resolved=!0}}filterParsedLevels(e){this.levels=e;let t=this.getLevelsForPathway(this.pathwayId);if(0===t.length){const s=e[0].pathwayId;this.log(`No levels found in Pathway ${this.pathwayId}. Setting initial Pathway to "${s}"`),t=this.getLevelsForPathway(s),this.pathwayId=s}return t.length!==e.length&&this.log(`Found ${t.length}/${e.length} levels in Pathway "${this.pathwayId}"`),t}getLevelsForPathway(e){return null===this.levels?[]:this.levels.filter(t=>e===t.pathwayId)}updatePathwayPriority(e){let t;this._pathwayPriority=e;const s=this.penalizedPathways,i=performance.now();Object.keys(s).forEach(e=>{i-s[e]>3e5&&delete s[e]});for(let i=0;i<e.length;i++){const n=e[i];if(n in s)continue;if(n===this.pathwayId)return;const r=this.hls.nextLoadLevel,a=this.hls.levels[r];if(t=this.getLevelsForPathway(n),t.length>0){this.log(`Setting Pathway to "${n}"`),this.pathwayId=n,Fs(t),this.hls.trigger(l.LEVELS_UPDATED,{levels:t});const e=this.hls.levels[r];a&&e&&this.levels&&(e.attrs["STABLE-VARIANT-ID"]!==a.attrs["STABLE-VARIANT-ID"]&&e.bitrate!==a.bitrate&&this.log(`Unstable Pathways change from bitrate ${a.bitrate} to ${e.bitrate}`),this.hls.nextLoadLevel=r);break}}}getPathwayForGroupId(e,t,s){const i=this.getLevelsForPathway(s).concat(this.levels||[]);for(let s=0;s<i.length;s++)if(t===h&&i[s].hasAudioGroup(e)||t===u&&i[s].hasSubtitleGroup(e))return i[s].pathwayId;return s}clonePathways(e){const t=this.levels;if(!t)return;const s={},i={};e.forEach(e=>{const{ID:n,"BASE-ID":r,"URI-REPLACEMENT":a}=e;if(t.some(e=>e.pathwayId===n))return;const o=this.getLevelsForPathway(r).map(e=>{const t=new Kt(e.attrs);t["PATHWAY-ID"]=n;const r=t.AUDIO&&`${t.AUDIO}_clone_${n}`,o=t.SUBTITLES&&`${t.SUBTITLES}_clone_${n}`;r&&(s[t.AUDIO]=r,t.AUDIO=r),o&&(i[t.SUBTITLES]=o,t.SUBTITLES=o);const l=vr(e.uri,t["STABLE-VARIANT-ID"],"PER-VARIANT-URIS",a),d=new Ke({attrs:t,audioCodec:e.audioCodec,bitrate:e.bitrate,height:e.height,name:e.name,url:l,videoCodec:e.videoCodec,width:e.width});if(e.audioGroups)for(let t=1;t<e.audioGroups.length;t++)d.addGroupId("audio",`${e.audioGroups[t]}_clone_${n}`);if(e.subtitleGroups)for(let t=1;t<e.subtitleGroups.length;t++)d.addGroupId("text",`${e.subtitleGroups[t]}_clone_${n}`);return d});t.push(...o),yr(this.audioTracks,s,a,n),yr(this.subtitleTracks,i,a,n)})}loadSteeringManifest(e){const t=this.hls.config,s=t.loader;let i;this.loader&&this.loader.destroy(),this.loader=new s(t);try{i=new self.URL(e)}catch(t){return this.enabled=!1,void this.log(`Failed to parse Steering Manifest URI: ${e}`)}if("data:"!==i.protocol){const e=0|(this.hls.bandwidthEstimate||t.abrEwmaDefaultEstimate);i.searchParams.set("_HLS_pathway",this.pathwayId),i.searchParams.set("_HLS_throughput",""+e)}const n={responseType:"json",url:i.href},r=t.steeringManifestLoadPolicy.default,a=r.errorRetry||r.timeoutRetry||{},o={loadPolicy:r,timeout:r.maxLoadTimeMs,maxRetry:a.maxNumRetry||0,retryDelay:a.retryDelayMs||0,maxRetryDelay:a.maxRetryDelayMs||0},d={onSuccess:(e,t,s,n)=>{this.log(`Loaded steering manifest: "${i}"`);const r=e.data;if(1!==(null==r?void 0:r.VERSION))return void this.log(`Steering VERSION ${r.VERSION} not supported!`);this.updated=performance.now(),this.timeToLoad=r.TTL;const{"RELOAD-URI":a,"PATHWAY-CLONES":o,"PATHWAY-PRIORITY":d}=r;if(a)try{this.uri=new self.URL(a,i).href}catch(e){return this.enabled=!1,void this.log(`Failed to parse Steering Manifest RELOAD-URI: ${a}`)}this.scheduleRefresh(this.uri||s.url),o&&this.clonePathways(o);const c={steeringManifest:r,url:i.toString()};this.hls.trigger(l.STEERING_MANIFEST_LOADED,c),d&&this.updatePathwayPriority(d)},onError:(e,t,s,i)=>{if(this.log(`Error loading steering manifest: ${e.code} ${e.text} (${t.url})`),this.stopLoad(),410===e.code)return this.enabled=!1,void this.log(`Steering manifest ${t.url} no longer available`);let n=1e3*this.timeToLoad;if(429===e.code){const e=this.loader;if("function"==typeof(null==e?void 0:e.getResponseHeader)){const t=e.getResponseHeader("Retry-After");t&&(n=1e3*parseFloat(t))}return void this.log(`Steering manifest ${t.url} rate limited`)}this.scheduleRefresh(this.uri||t.url,n)},onTimeout:(e,t,s)=>{this.log(`Timeout loading steering manifest (${t.url})`),this.scheduleRefresh(this.uri||t.url)}};this.log(`Requesting steering manifest: ${i}`),this.loader.load(n,o,d)}scheduleRefresh(e,t=1e3*this.timeToLoad){this.clearTimeout(),this.reloadTimer=self.setTimeout(()=>{var t;const s=null==(t=this.hls)?void 0:t.media;!s||s.ended?this.scheduleRefresh(e,1e3*this.timeToLoad):this.loadSteeringManifest(e)},t)}}function yr(e,t,s,i){e&&Object.keys(t).forEach(n=>{const r=e.filter(e=>e.groupId===n).map(e=>{const r=y({},e);return r.details=void 0,r.attrs=new Kt(r.attrs),r.url=r.attrs.URI=vr(e.url,e.attrs["STABLE-RENDITION-ID"],"PER-RENDITION-URIS",s),r.groupId=r.attrs["GROUP-ID"]=t[n],r.attrs["PATHWAY-ID"]=i,r});e.push(...r)})}function vr(e,t,s,i){const{HOST:n,PARAMS:r,[s]:a}=i;let o;t&&(o=null==a?void 0:a[t],o&&(e=o));const l=new self.URL(e);return n&&!o&&(l.host=n),r&&Object.keys(r).sort().forEach(e=>{e&&l.searchParams.set(e,r[e])}),l.href}function Er(e,t,s){Tr(e,t,s),e.addEventListener(t,s)}function Tr(e,t,s){e.removeEventListener(t,s)}class Sr extends T{constructor(e){super("eme",e.logger),this.hls=void 0,this.config=void 0,this.media=null,this.keyFormatPromise=null,this.keySystemAccessPromises={},this._requestLicenseFailureCount=0,this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},this.mediaKeys=null,this.setMediaKeysQueue=Sr.CDMCleanupPromise?[Sr.CDMCleanupPromise]:[],this.onWaitingForKey=e=>{this.log(`"${e.type}" event`)},this.hls=e,this.config=e.config,this.registerListeners()}destroy(){this.onDestroying(),this.onMediaDetached();const e=this.config;e.requestMediaKeySystemAccessFunc=null,e.licenseXhrSetup=e.licenseResponseCallback=void 0,e.drmSystems=e.drmSystemOptions={},this.hls=this.config=this.keyIdToKeySessionPromise=null,this.onWaitingForKey=null}registerListeners(){this.hls.on(l.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(l.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.on(l.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(l.MANIFEST_LOADED,this.onManifestLoaded,this),this.hls.on(l.DESTROYING,this.onDestroying,this)}unregisterListeners(){this.hls.off(l.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(l.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.off(l.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.off(l.MANIFEST_LOADED,this.onManifestLoaded,this),this.hls.off(l.DESTROYING,this.onDestroying,this)}getLicenseServerUrl(e){const{drmSystems:t,widevineLicenseUrl:s}=this.config,i=t[e];return i?i.licenseUrl:e===ts.WIDEVINE&&s?s:void 0}getLicenseServerUrlOrThrow(e){const t=this.getLicenseServerUrl(e);if(void 0===t)throw new Error(`no license server URL configured for key-system "${e}"`);return t}getServerCertificateUrl(e){const{drmSystems:t}=this.config,s=t[e];if(s)return s.serverCertificateUrl;this.log(`No Server Certificate in config.drmSystems["${e}"]`)}attemptKeySystemAccess(e){const t=this.hls.levels,s=(e,t,s)=>!!e&&s.indexOf(e)===t,i=t.map(e=>e.audioCodec).filter(s),n=t.map(e=>e.videoCodec).filter(s);return i.length+n.length===0&&n.push("avc1.42e01e"),new Promise((t,s)=>{const r=e=>{const l=e.shift();this.getMediaKeysPromise(l,i,n).then(e=>t({keySystem:l,mediaKeys:e})).catch(t=>{e.length?r(e):s(t instanceof br?t:new br({type:a.KEY_SYSTEM_ERROR,details:o.KEY_SYSTEM_NO_ACCESS,error:t,fatal:!0},t.message))})};r(e)})}requestMediaKeySystemAccess(e,t){const{requestMediaKeySystemAccessFunc:s}=this.config;if("function"!=typeof s){let e=`Configured requestMediaKeySystemAccess is not a function ${s}`;return null===as&&"http:"===self.location.protocol&&(e=`navigator.requestMediaKeySystemAccess is not available over insecure protocol ${location.protocol}`),Promise.reject(new Error(e))}return s(e,t)}getMediaKeysPromise(e,t,s){const i=function(e,t,s,i){let n;switch(e){case ts.FAIRPLAY:n=["cenc","sinf"];break;case ts.WIDEVINE:case ts.PLAYREADY:n=["cenc"];break;case ts.CLEARKEY:n=["cenc","keyids"];break;default:throw new Error(`Unknown key-system: ${e}`)}return function(e,t,s,i){return[{initDataTypes:e,persistentState:i.persistentState||"optional",distinctiveIdentifier:i.distinctiveIdentifier||"optional",sessionTypes:i.sessionTypes||[i.sessionType||"temporary"],audioCapabilities:t.map(e=>({contentType:`audio/mp4; codecs=${e}`,robustness:i.audioRobustness||"",encryptionScheme:i.audioEncryptionScheme||null})),videoCapabilities:s.map(e=>({contentType:`video/mp4; codecs=${e}`,robustness:i.videoRobustness||"",encryptionScheme:i.videoEncryptionScheme||null}))}]}(n,t,s,i)}(e,t,s,this.config.drmSystemOptions),n=this.keySystemAccessPromises[e];let r=null==n?void 0:n.keySystemAccess;if(!r){this.log(`Requesting encrypted media "${e}" key-system access with config: ${Ye(i)}`),r=this.requestMediaKeySystemAccess(e,i);const t=this.keySystemAccessPromises[e]={keySystemAccess:r};return r.catch(t=>{this.log(`Failed to obtain access to key-system "${e}": ${t}`)}),r.then(s=>{this.log(`Access for key-system "${s.keySystem}" obtained`);const i=this.fetchServerCertificate(e);return this.log(`Create media-keys for "${e}"`),t.mediaKeys=s.createMediaKeys().then(s=>(this.log(`Media-keys created for "${e}"`),t.hasMediaKeys=!0,i.then(t=>t?this.setMediaKeysServerCertificate(s,e,t):s))),t.mediaKeys.catch(t=>{this.error(`Failed to create media-keys for "${e}"}: ${t}`)}),t.mediaKeys})}return r.then(()=>n.mediaKeys)}createMediaKeySessionContext({decryptdata:e,keySystem:t,mediaKeys:s}){this.log(`Creating key-system session "${t}" keyId: ${D(e.keyId||[])}`);const i=s.createSession(),n={decryptdata:e,keySystem:t,mediaKeys:s,mediaKeysSession:i,keyStatus:"status-pending"};return this.mediaKeySessions.push(n),n}renewKeySession(e){const t=e.decryptdata;if(t.pssh){const s=this.createMediaKeySessionContext(e),i=this.getKeyIdString(t),n="cenc";this.keyIdToKeySessionPromise[i]=this.generateRequestWithPreferredKeySession(s,n,t.pssh.buffer,"expired")}else this.warn("Could not renew expired session. Missing pssh initData.");this.removeSession(e)}getKeyIdString(e){if(!e)throw new Error("Could not read keyId of undefined decryptdata");if(null===e.keyId)throw new Error("keyId is null");return D(e.keyId)}updateKeySession(e,t){var s;const i=e.mediaKeysSession;return this.log(`Updating key-session "${i.sessionId}" for keyID ${D((null==(s=e.decryptdata)?void 0:s.keyId)||[])}\n      } (data length: ${t?t.byteLength:t})`),i.update(t)}getSelectedKeySystemFormats(){return Object.keys(this.keySystemAccessPromises).map(e=>({keySystem:e,hasMediaKeys:this.keySystemAccessPromises[e].hasMediaKeys})).filter(({hasMediaKeys:e})=>!!e).map(({keySystem:e})=>ns(e)).filter(e=>!!e)}getKeySystemAccess(e){return this.getKeySystemSelectionPromise(e).then(({keySystem:e,mediaKeys:t})=>this.attemptSetMediaKeys(e,t))}selectKeySystem(e){return new Promise((t,s)=>this.getKeySystemSelectionPromise(e).then(({keySystem:e})=>{const i=ns(e);i?t(i):s(new Error(`Unable to find format for key-system "${e}"`))}).catch(s))}selectKeySystemFormat(e){const t=Object.keys(e.levelkeys||{});return this.keyFormatPromise||(this.log(`Selecting key-system from fragment (sn: ${e.sn} ${e.type}: ${e.level}) key formats ${t.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(t)),this.keyFormatPromise}getKeyFormatPromise(e){const t=rs(this.config),s=e.map(is).filter(e=>!!e&&-1!==t.indexOf(e));return this.selectKeySystem(s)}loadKey(e){const t=e.keyInfo.decryptdata,s=this.getKeyIdString(t),i=`(keyId: ${s} format: "${t.keyFormat}" method: ${t.method} uri: ${t.uri})`;this.log(`Starting session for key ${i}`);let n=this.keyIdToKeySessionPromise[s];return n||(n=this.getKeySystemForKeyPromise(t).then(({keySystem:s,mediaKeys:n})=>(this.throwIfDestroyed(),this.log(`Handle encrypted media sn: ${e.frag.sn} ${e.frag.type}: ${e.frag.level} using key ${i}`),this.attemptSetMediaKeys(s,n).then(()=>(this.throwIfDestroyed(),this.createMediaKeySessionContext({keySystem:s,mediaKeys:n,decryptdata:t}))))),(this.keyIdToKeySessionPromise[s]=n.then(e=>{const s=t.pssh?t.pssh.buffer:null;return this.generateRequestWithPreferredKeySession(e,"cenc",s,"playlist-key")})).catch(e=>this.handleError(e))),n}throwIfDestroyed(e="Invalid state"){if(!this.hls)throw new Error("invalid state")}handleError(e){this.hls&&(this.error(e.message),e instanceof br?this.hls.trigger(l.ERROR,e.data):this.hls.trigger(l.ERROR,{type:a.KEY_SYSTEM_ERROR,details:o.KEY_SYSTEM_NO_KEYS,error:e,fatal:!0}))}getKeySystemForKeyPromise(e){const t=this.getKeyIdString(e),s=this.keyIdToKeySessionPromise[t];if(!s){const t=is(e.keyFormat),s=t?[t]:rs(this.config);return this.attemptKeySystemAccess(s)}return s}getKeySystemSelectionPromise(e){if(e.length||(e=rs(this.config)),0===e.length)throw new br({type:a.KEY_SYSTEM_ERROR,details:o.KEY_SYSTEM_NO_CONFIGURED_LICENSE,fatal:!0},`Missing key-system license configuration options ${Ye({drmSystems:this.config.drmSystems})}`);return this.attemptKeySystemAccess(e)}attemptSetMediaKeys(e,t){if(this.mediaKeys===t)return Promise.resolve();const s=this.setMediaKeysQueue.slice();this.log(`Setting media-keys for "${e}"`);const i=Promise.all(s).then(()=>{if(!this.media)throw this.mediaKeys=null,new Error("Attempted to set mediaKeys without media element attached");return this.media.setMediaKeys(t)});return this.mediaKeys=t,this.setMediaKeysQueue.push(i),i.then(()=>{this.log(`Media-keys set for "${e}"`),s.push(i),this.setMediaKeysQueue=this.setMediaKeysQueue.filter(e=>-1===s.indexOf(e))})}generateRequestWithPreferredKeySession(e,t,s,i){var n,r;const l=null==(n=this.config.drmSystems)||null==(r=n[e.keySystem])?void 0:r.generateRequest;if(l)try{const i=l.call(this.hls,t,s,e);if(!i)throw new Error("Invalid response from configured generateRequest filter");t=i.initDataType,s=i.initData?i.initData:null,e.decryptdata.pssh=s?new Uint8Array(s):null}catch(e){var d;if(this.warn(e.message),null!=(d=this.hls)&&d.config.debug)throw e}if(null===s)return this.log(`Skipping key-session request for "${i}" (no initData)`),Promise.resolve(e);const c=this.getKeyIdString(e.decryptdata);this.log(`Generating key-session request for "${i}": ${c} (init data type: ${t} length: ${s?s.byteLength:null})`);const h=new ai,u=e._onmessage=t=>{const s=e.mediaKeysSession;if(!s)return void h.emit("error",new Error("invalid state"));const{messageType:i,message:n}=t;this.log(`"${i}" message event for session "${s.sessionId}" message size: ${n.byteLength}`),"license-request"===i||"license-renewal"===i?this.renewLicense(e,n).catch(e=>{h.eventNames().length?h.emit("error",e):this.handleError(e)}):"license-release"===i?e.keySystem===ts.FAIRPLAY&&(this.updateKeySession(e,Jt("acknowledged")),this.removeSession(e)):this.warn(`unhandled media key message type "${i}"`)},f=e._onkeystatuseschange=t=>{if(!e.mediaKeysSession)return void h.emit("error",new Error("invalid state"));this.onKeyStatusChange(e);const s=e.keyStatus;h.emit("keyStatus",s),"expired"===s&&(this.warn(`${e.keySystem} expired for key ${c}`),this.renewKeySession(e))};Er(e.mediaKeysSession,"message",u),Er(e.mediaKeysSession,"keystatuseschange",f);const g=new Promise((e,t)=>{h.on("error",t),h.on("keyStatus",s=>{s.startsWith("usable")?e():"output-restricted"===s?t(new br({type:a.KEY_SYSTEM_ERROR,details:o.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED,fatal:!1},"HDCP level output restricted")):"internal-error"===s?t(new br({type:a.KEY_SYSTEM_ERROR,details:o.KEY_SYSTEM_STATUS_INTERNAL_ERROR,fatal:!0},`key status changed to "${s}"`)):"expired"===s?t(new Error("key expired while generating request")):this.warn(`unhandled key status change "${s}"`)})});return e.mediaKeysSession.generateRequest(t,s).then(()=>{var t;this.log(`Request generated for key-session "${null==(t=e.mediaKeysSession)?void 0:t.sessionId}" keyId: ${c}`)}).catch(e=>{throw new br({type:a.KEY_SYSTEM_ERROR,details:o.KEY_SYSTEM_NO_SESSION,error:e,fatal:!1},`Error generating key-session request: ${e}`)}).then(()=>g).catch(t=>{throw h.removeAllListeners(),this.removeSession(e),t}).then(()=>(h.removeAllListeners(),e))}onKeyStatusChange(e){e.mediaKeysSession.keyStatuses.forEach((t,s)=>{if("string"==typeof s&&"object"==typeof t){const e=s;s=t,t=e}this.log(`key status change "${t}" for keyStatuses keyId: ${D("buffer"in s?new Uint8Array(s.buffer,s.byteOffset,s.byteLength):new Uint8Array(s))} session keyId: ${D(new Uint8Array(e.decryptdata.keyId||[]))} uri: ${e.decryptdata.uri}`),e.keyStatus=t})}fetchServerCertificate(e){const t=this.config,s=new(0,t.loader)(t),i=this.getServerCertificateUrl(e);return i?(this.log(`Fetching server certificate for "${e}"`),new Promise((n,r)=>{const l={responseType:"arraybuffer",url:i},d=t.certLoadPolicy.default,c={loadPolicy:d,timeout:d.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},h={onSuccess:(e,t,s,i)=>{n(e.data)},onError:(t,s,n,d)=>{r(new br({type:a.KEY_SYSTEM_ERROR,details:o.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:n,response:E({url:l.url,data:void 0},t)},`"${e}" certificate request failed (${i}). Status: ${t.code} (${t.text})`))},onTimeout:(t,s,n)=>{r(new br({type:a.KEY_SYSTEM_ERROR,details:o.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:n,response:{url:l.url,data:void 0}},`"${e}" certificate request timed out (${i})`))},onAbort:(e,t,s)=>{r(new Error("aborted"))}};s.load(l,c,h)})):Promise.resolve()}setMediaKeysServerCertificate(e,t,s){return new Promise((i,n)=>{e.setServerCertificate(s).then(n=>{this.log(`setServerCertificate ${n?"success":"not supported by CDM"} (${null==s?void 0:s.byteLength}) on "${t}"`),i(e)}).catch(e=>{n(new br({type:a.KEY_SYSTEM_ERROR,details:o.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED,error:e,fatal:!0},e.message))})})}renewLicense(e,t){return this.requestLicense(e,new Uint8Array(t)).then(t=>this.updateKeySession(e,new Uint8Array(t)).catch(e=>{throw new br({type:a.KEY_SYSTEM_ERROR,details:o.KEY_SYSTEM_SESSION_UPDATE_FAILED,error:e,fatal:!0},e.message)}))}unpackPlayReadyKeyMessage(e,t){const s=String.fromCharCode.apply(null,new Uint16Array(t.buffer));if(!s.includes("PlayReadyKeyMessage"))return e.setRequestHeader("Content-Type","text/xml; charset=utf-8"),t;const i=(new DOMParser).parseFromString(s,"application/xml"),n=i.querySelectorAll("HttpHeader");if(n.length>0){let t;for(let s=0,i=n.length;s<i;s++){var r,a;t=n[s];const i=null==(r=t.querySelector("name"))?void 0:r.textContent,o=null==(a=t.querySelector("value"))?void 0:a.textContent;i&&o&&e.setRequestHeader(i,o)}}const o=i.querySelector("Challenge"),l=null==o?void 0:o.textContent;if(!l)throw new Error("Cannot find <Challenge> in key message");return Jt(atob(l))}setupLicenseXHR(e,t,s,i){const n=this.config.licenseXhrSetup;return n?Promise.resolve().then(()=>{if(!s.decryptdata)throw new Error("Key removed");return n.call(this.hls,e,t,s,i)}).catch(r=>{if(!s.decryptdata)throw r;return e.open("POST",t,!0),n.call(this.hls,e,t,s,i)}).then(s=>(e.readyState||e.open("POST",t,!0),{xhr:e,licenseChallenge:s||i})):(e.open("POST",t,!0),Promise.resolve({xhr:e,licenseChallenge:i}))}requestLicense(e,t){const s=this.config.keyLoadPolicy.default;return new Promise((i,n)=>{const r=this.getLicenseServerUrlOrThrow(e.keySystem);this.log(`Sending license request to URL: ${r}`);const l=new XMLHttpRequest;l.responseType="arraybuffer",l.onreadystatechange=()=>{if(!this.hls||!e.mediaKeysSession)return n(new Error("invalid state"));if(4===l.readyState)if(200===l.status){this._requestLicenseFailureCount=0;let t=l.response;this.log(`License received ${t instanceof ArrayBuffer?t.byteLength:t}`);const s=this.config.licenseResponseCallback;if(s)try{t=s.call(this.hls,l,r,e)}catch(e){this.error(e)}i(t)}else{const d=s.errorRetry,c=d?d.maxNumRetry:0;if(this._requestLicenseFailureCount++,this._requestLicenseFailureCount>c||l.status>=400&&l.status<500)n(new br({type:a.KEY_SYSTEM_ERROR,details:o.KEY_SYSTEM_LICENSE_REQUEST_FAILED,fatal:!0,networkDetails:l,response:{url:r,data:void 0,code:l.status,text:l.statusText}},`License Request XHR failed (${r}). Status: ${l.status} (${l.statusText})`));else{const s=c-this._requestLicenseFailureCount+1;this.warn(`Retrying license request, ${s} attempts left`),this.requestLicense(e,t).then(i,n)}}},e.licenseXhr&&e.licenseXhr.readyState!==XMLHttpRequest.DONE&&e.licenseXhr.abort(),e.licenseXhr=l,this.setupLicenseXHR(l,r,e,t).then(({xhr:t,licenseChallenge:s})=>{e.keySystem==ts.PLAYREADY&&(s=this.unpackPlayReadyKeyMessage(t,s)),t.send(s)})})}onDestroying(){this.unregisterListeners(),this._clear()}onMediaAttached(e,t){if(!this.config.emeEnabled)return;const s=t.media;this.media=s,Er(s,"waitingforkey",this.onWaitingForKey)}onMediaDetached(){const e=this.media;e&&(Tr(e,"waitingforkey",this.onWaitingForKey),this.media=null,this.mediaKeys=null)}_clear(){var e;if(this._requestLicenseFailureCount=0,this.keyIdToKeySessionPromise={},!this.mediaKeys&&!this.mediaKeySessions.length)return;const t=this.media,s=this.mediaKeySessions.slice();this.mediaKeySessions=[],this.mediaKeys=null,ds.clearKeyUriToKeyIdMap();const i=s.length;Sr.CDMCleanupPromise=Promise.all(s.map(e=>this.removeSession(e)).concat(null==t||null==(e=t.setMediaKeys(null))?void 0:e.catch(e=>{var t;this.log(`Could not clear media keys: ${e}`),null==(t=this.hls)||t.trigger(l.ERROR,{type:a.OTHER_ERROR,details:o.KEY_SYSTEM_DESTROY_MEDIA_KEYS_ERROR,fatal:!1,error:new Error(`Could not clear media keys: ${e}`)})}))).catch(e=>{var t;this.log(`Could not close sessions and clear media keys: ${e}`),null==(t=this.hls)||t.trigger(l.ERROR,{type:a.OTHER_ERROR,details:o.KEY_SYSTEM_DESTROY_CLOSE_SESSION_ERROR,fatal:!1,error:new Error(`Could not close sessions and clear media keys: ${e}`)})}).then(()=>{i&&this.log("finished closing key sessions and clearing media keys")})}onManifestLoading(){this.keyFormatPromise=null}onManifestLoaded(e,{sessionKeys:t}){if(t&&this.config.emeEnabled&&!this.keyFormatPromise){const e=t.reduce((e,t)=>(-1===e.indexOf(t.keyFormat)&&e.push(t.keyFormat),e),[]);this.log(`Selecting key-system from session-keys ${e.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(e)}}removeSession(e){const{mediaKeysSession:t,licenseXhr:s}=e;if(t){this.log(`Remove licenses and keys and close session ${t.sessionId}`),e._onmessage&&(t.removeEventListener("message",e._onmessage),e._onmessage=void 0),e._onkeystatuseschange&&(t.removeEventListener("keystatuseschange",e._onkeystatuseschange),e._onkeystatuseschange=void 0),s&&s.readyState!==XMLHttpRequest.DONE&&s.abort(),e.mediaKeysSession=e.decryptdata=e.licenseXhr=void 0;const i=this.mediaKeySessions.indexOf(e);i>-1&&this.mediaKeySessions.splice(i,1);const{drmSystemOptions:n}=this.config,r=function(e){var t;return"persistent-license"===e.sessionType||!(null==(t=e.sessionTypes)||!t.some(e=>"persistent-license"===e))}(n)?new Promise((e,s)=>{self.setTimeout(()=>s(new Error("MediaKeySession.remove() timeout")),8e3),t.remove().then(e)}):Promise.resolve();return r.catch(e=>{var t;this.log(`Could not remove session: ${e}`),null==(t=this.hls)||t.trigger(l.ERROR,{type:a.OTHER_ERROR,details:o.KEY_SYSTEM_DESTROY_REMOVE_SESSION_ERROR,fatal:!1,error:new Error(`Could not remove session: ${e}`)})}).then(()=>t.close()).catch(e=>{var t;this.log(`Could not close session: ${e}`),null==(t=this.hls)||t.trigger(l.ERROR,{type:a.OTHER_ERROR,details:o.KEY_SYSTEM_DESTROY_CLOSE_SESSION_ERROR,fatal:!1,error:new Error(`Could not close session: ${e}`)})})}}}Sr.CDMCleanupPromise=void 0;class br extends Error{constructor(e,t){super(t),this.data=void 0,e.error||(e.error=new Error(t)),this.data=e,e.err=e.error}}class Ar{constructor(e){this.hls=void 0,this.isVideoPlaybackQualityAvailable=!1,this.timer=void 0,this.media=null,this.lastTime=void 0,this.lastDroppedFrames=0,this.lastDecodedFrames=0,this.streamController=void 0,this.hls=e,this.registerListeners()}setStreamController(e){this.streamController=e}registerListeners(){this.hls.on(l.MEDIA_ATTACHING,this.onMediaAttaching,this),this.hls.on(l.MEDIA_DETACHING,this.onMediaDetaching,this)}unregisterListeners(){this.hls.off(l.MEDIA_ATTACHING,this.onMediaAttaching,this),this.hls.off(l.MEDIA_DETACHING,this.onMediaDetaching,this)}destroy(){this.timer&&clearInterval(this.timer),this.unregisterListeners(),this.isVideoPlaybackQualityAvailable=!1,this.media=null}onMediaAttaching(e,t){const s=this.hls.config;if(s.capLevelOnFPSDrop){const e=t.media instanceof self.HTMLVideoElement?t.media:null;this.media=e,e&&"function"==typeof e.getVideoPlaybackQuality&&(this.isVideoPlaybackQualityAvailable=!0),self.clearInterval(this.timer),this.timer=self.setInterval(this.checkFPSInterval.bind(this),s.fpsDroppedMonitoringPeriod)}}onMediaDetaching(){this.media=null}checkFPS(e,t,s){const i=performance.now();if(t){if(this.lastTime){const e=i-this.lastTime,n=s-this.lastDroppedFrames,r=t-this.lastDecodedFrames,a=1e3*n/e,o=this.hls;if(o.trigger(l.FPS_DROP,{currentDropped:n,currentDecoded:r,totalDroppedFrames:s}),a>0&&n>o.config.fpsDroppedMonitoringThreshold*r){let e=o.currentLevel;o.logger.warn("drop FPS ratio greater than max allowed value for currentLevel: "+e),e>0&&(-1===o.autoLevelCapping||o.autoLevelCapping>=e)&&(e-=1,o.trigger(l.FPS_DROP_LEVEL_CAPPING,{level:e,droppedLevel:o.currentLevel}),o.autoLevelCapping=e,this.streamController.nextLevelSwitch())}}this.lastTime=i,this.lastDroppedFrames=s,this.lastDecodedFrames=t}}checkFPSInterval(){const e=this.media;if(e)if(this.isVideoPlaybackQualityAvailable){const t=e.getVideoPlaybackQuality();this.checkFPS(e,t.totalVideoFrames,t.droppedVideoFrames)}else this.checkFPS(e,e.webkitDecodedFrameCount,e.webkitDroppedFrameCount)}}function Lr(e,t){let s;try{s=new Event("addtrack")}catch(e){s=document.createEvent("Event"),s.initEvent("addtrack",!1,!1)}s.track=e,t.dispatchEvent(s)}function wr(e,t){const s=e.mode;if("disabled"===s&&(e.mode="hidden"),e.cues&&!e.cues.getCueById(t.id))try{if(e.addCue(t),!e.cues.getCueById(t.id))throw new Error(`addCue is failed for: ${t}`)}catch(s){R.debug(`[texttrack-utils]: ${s}`);try{const s=new self.TextTrackCue(t.startTime,t.endTime,t.text);s.id=t.id,e.addCue(s)}catch(e){R.debug(`[texttrack-utils]: Legacy TextTrackCue fallback failed: ${e}`)}}"disabled"===s&&(e.mode=s)}function Rr(e,t){const s=e.mode;if("disabled"===s&&(e.mode="hidden"),e.cues)for(let s=e.cues.length;s--;)t&&e.cues[s].removeEventListener("enter",t),e.removeCue(e.cues[s]);"disabled"===s&&(e.mode=s)}function Ir(e,t,s,i){const n=e.mode;if("disabled"===n&&(e.mode="hidden"),e.cues&&e.cues.length>0){const n=function(e,t,s){const i=[],n=function(e,t){if(t<=e[0].startTime)return 0;const s=e.length-1;if(t>e[s].endTime)return-1;let i,n=0,r=s;for(;n<=r;)if(i=Math.floor((r+n)/2),t<e[i].startTime)r=i-1;else{if(!(t>e[i].startTime&&n<s))return i;n=i+1}return e[n].startTime-t<t-e[r].startTime?n:r}(e,t);if(n>-1)for(let r=n,a=e.length;r<a;r++){const n=e[r];if(n.startTime>=t&&n.endTime<=s)i.push(n);else if(n.startTime>s)return i}return i}(e.cues,t,s);for(let t=0;t<n.length;t++)i&&!i(n[t])||e.removeCue(n[t])}"disabled"===n&&(e.mode=n)}function xr(e){const t=[];for(let s=0;s<e.length;s++){const i=e[s];"subtitles"!==i.kind&&"captions"!==i.kind||!i.label||t.push(e[s])}return t}class kr extends _n{constructor(e){super(e,"subtitle-track-controller"),this.media=null,this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.queuedDefaultTrack=-1,this.useTextTrackPolling=!1,this.subtitlePollingInterval=-1,this._subtitleDisplay=!0,this.asyncPollTrackChange=()=>this.pollTrackChange(0),this.onTextTracksChanged=()=>{if(this.useTextTrackPolling||self.clearInterval(this.subtitlePollingInterval),!this.media||!this.hls.config.renderTextTracksNatively)return;let e=null;const t=xr(this.media.textTracks);for(let s=0;s<t.length;s++)if("hidden"===t[s].mode)e=t[s];else if("showing"===t[s].mode){e=t[s];break}const s=this.findTrackForTextTrack(e);this.subtitleTrack!==s&&this.setSubtitleTrack(s)},this.registerListeners()}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,this.onTextTracksChanged=this.asyncPollTrackChange=null,super.destroy()}get subtitleDisplay(){return this._subtitleDisplay}set subtitleDisplay(e){this._subtitleDisplay=e,this.trackId>-1&&this.toggleTrackModes()}registerListeners(){const{hls:e}=this;e.on(l.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(l.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(l.MANIFEST_LOADING,this.onManifestLoading,this),e.on(l.MANIFEST_PARSED,this.onManifestParsed,this),e.on(l.LEVEL_LOADING,this.onLevelLoading,this),e.on(l.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(l.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.on(l.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(l.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(l.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(l.MANIFEST_LOADING,this.onManifestLoading,this),e.off(l.MANIFEST_PARSED,this.onManifestParsed,this),e.off(l.LEVEL_LOADING,this.onLevelLoading,this),e.off(l.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(l.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.off(l.ERROR,this.onError,this)}onMediaAttached(e,t){this.media=t.media,this.media&&(this.queuedDefaultTrack>-1&&(this.subtitleTrack=this.queuedDefaultTrack,this.queuedDefaultTrack=-1),this.useTextTrackPolling=!(this.media.textTracks&&"onchange"in this.media.textTracks),this.useTextTrackPolling?this.pollTrackChange(500):this.media.textTracks.addEventListener("change",this.asyncPollTrackChange))}pollTrackChange(e){self.clearInterval(this.subtitlePollingInterval),this.subtitlePollingInterval=self.setInterval(this.onTextTracksChanged,e)}onMediaDetaching(e,t){const s=this.media;if(!s)return;const i=!!t.transferMedia;self.clearInterval(this.subtitlePollingInterval),this.useTextTrackPolling||s.textTracks.removeEventListener("change",this.asyncPollTrackChange),this.trackId>-1&&(this.queuedDefaultTrack=this.trackId),this.subtitleTrack=-1,this.media=null,i||xr(s.textTracks).forEach(e=>{Rr(e)})}onManifestLoading(){this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0}onManifestParsed(e,t){this.tracks=t.subtitleTracks}onSubtitleTrackLoaded(e,t){const{id:s,groupId:i,details:n}=t,r=this.tracksInGroup[s];if(!r||r.groupId!==i)return void this.warn(`Subtitle track with id:${s} and group:${i} not found in active group ${null==r?void 0:r.groupId}`);const a=r.details;r.details=t.details,this.log(`Subtitle track ${s} "${r.name}" lang:${r.lang} group:${i} loaded [${n.startSN}-${n.endSN}]`),s===this.trackId&&this.playlistLoaded(s,t,a)}onLevelLoading(e,t){this.switchLevel(t.level)}onLevelSwitching(e,t){this.switchLevel(t.level)}switchLevel(e){const t=this.hls.levels[e];if(!t)return;const s=t.subtitleGroups||null,i=this.groupIds;let n=this.currentTrack;if(!s||(null==i?void 0:i.length)!==(null==s?void 0:s.length)||null!=s&&s.some(e=>-1===(null==i?void 0:i.indexOf(e)))){this.groupIds=s,this.trackId=-1,this.currentTrack=null;const e=this.tracks.filter(e=>!s||-1!==s.indexOf(e.groupId));if(e.length)this.selectDefaultTrack&&!e.some(e=>e.default)&&(this.selectDefaultTrack=!1),e.forEach((e,t)=>{e.id=t});else if(!n&&!this.tracksInGroup.length)return;this.tracksInGroup=e;const t=this.hls.config.subtitlePreference;if(!n&&t){this.selectDefaultTrack=!1;const s=Ze(t,e);if(s>-1)n=e[s];else{const e=Ze(t,this.tracks);n=this.tracks[e]}}let i=this.findTrackId(n);-1===i&&n&&(i=this.findTrackId(null));const r={subtitleTracks:e};this.log(`Updating subtitle tracks, ${e.length} track(s) found in "${null==s?void 0:s.join(",")}" group-id`),this.hls.trigger(l.SUBTITLE_TRACKS_UPDATED,r),-1!==i&&-1===this.trackId&&this.setSubtitleTrack(i)}}findTrackId(e){const t=this.tracksInGroup,s=this.selectDefaultTrack;for(let i=0;i<t.length;i++){const n=t[i];if((!s||n.default)&&(s||e)&&(!e||Qe(n,e)))return i}if(e){for(let s=0;s<t.length;s++){const i=t[s];if(Pn(e.attrs,i.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return s}for(let s=0;s<t.length;s++){const i=t[s];if(Pn(e.attrs,i.attrs,["LANGUAGE"]))return s}}return-1}findTrackForTextTrack(e){if(e){const t=this.tracksInGroup;for(let s=0;s<t.length;s++)if(Mn(t[s],e))return s}return-1}onError(e,t){!t.fatal&&t.context&&(t.context.type!==u||t.context.id!==this.trackId||this.groupIds&&-1===this.groupIds.indexOf(t.context.groupId)||this.checkRetry(t))}get allSubtitleTracks(){return this.tracks}get subtitleTracks(){return this.tracksInGroup}get subtitleTrack(){return this.trackId}set subtitleTrack(e){this.selectDefaultTrack=!1,this.setSubtitleTrack(e)}setSubtitleOption(e){if(this.hls.config.subtitlePreference=e,e){if(-1===e.id)return this.setSubtitleTrack(-1),null;const t=this.allSubtitleTracks;if(this.selectDefaultTrack=!1,t.length){const s=this.currentTrack;if(s&&Qe(e,s))return s;const i=Ze(e,this.tracksInGroup);if(i>-1){const e=this.tracksInGroup[i];return this.setSubtitleTrack(i),e}if(s)return null;{const s=Ze(e,t);if(s>-1)return t[s]}}}return null}loadPlaylist(e){super.loadPlaylist(),this.shouldLoadPlaylist(this.currentTrack)&&this.scheduleLoading(this.currentTrack,e)}loadingPlaylist(e,t){super.loadingPlaylist(e,t);const s=e.id,i=e.groupId,n=this.getUrlWithDirectives(e.url,t),r=e.details,a=null==r?void 0:r.age;this.log(`Loading subtitle ${s} "${e.name}" lang:${e.lang} group:${i}${void 0!==(null==t?void 0:t.msn)?" at sn "+t.msn+" part "+t.part:""}${a&&r.live?" age "+a.toFixed(1)+(r.type?" "+r.type||0:""):""} ${n}`),this.hls.trigger(l.SUBTITLE_TRACK_LOADING,{url:n,id:s,groupId:i,deliveryDirectives:t||null,track:e})}toggleTrackModes(){const{media:e}=this;if(!e)return;const t=xr(e.textTracks),s=this.currentTrack;let i;if(s&&(i=t.filter(e=>Mn(s,e))[0],i||this.warn(`Unable to find subtitle TextTrack with name "${s.name}" and language "${s.lang}"`)),[].slice.call(t).forEach(e=>{"disabled"!==e.mode&&e!==i&&(e.mode="disabled")}),i){const e=this.subtitleDisplay?"showing":"hidden";i.mode!==e&&(i.mode=e)}}setSubtitleTrack(e){const t=this.tracksInGroup;if(!this.media)return void(this.queuedDefaultTrack=e);if(e<-1||e>=t.length||!i(e))return void this.warn(`Invalid subtitle track id: ${e}`);this.selectDefaultTrack=!1;const s=this.currentTrack,n=t[e]||null;if(this.trackId=e,this.currentTrack=n,this.toggleTrackModes(),!n)return void this.hls.trigger(l.SUBTITLE_TRACK_SWITCH,{id:e});const r=!!n.details&&!n.details.live;if(e===this.trackId&&n===s&&r)return;this.log(`Switching to subtitle-track ${e}`+(n?` "${n.name}" lang:${n.lang} group:${n.groupId}`:""));const{id:a,groupId:o="",name:d,type:c,url:h}=n;this.hls.trigger(l.SUBTITLE_TRACK_SWITCH,{id:a,groupId:o,name:d,type:c,url:h});const u=this.switchParams(n.url,null==s?void 0:s.details,n.details);this.loadPlaylist(u)}}function Dr(e){let t=5381,s=e.length;for(;s;)t=33*t^e.charCodeAt(--s);return(t>>>0).toString()}const _r=.025;let Cr=function(e){return e[e.Point=0]="Point",e[e.Range=1]="Range",e}({});function Pr(e,t,s){return`${e.identifier}-${s+1}-${Dr(t)}`}class Mr{constructor(e,t){this.base=void 0,this._duration=null,this._timelineStart=null,this.appendInPlaceDisabled=void 0,this.appendInPlaceStarted=void 0,this.dateRange=void 0,this.hasPlayed=!1,this.cumulativeDuration=0,this.resumeOffset=NaN,this.playoutLimit=NaN,this.restrictions={skip:!1,jump:!1},this.snapOptions={out:!1,in:!1},this.assetList=[],this.assetListLoader=void 0,this.assetListResponse=null,this.resumeAnchor=void 0,this.error=void 0,this.resetOnResume=void 0,this.base=t,this.dateRange=e,this.setDateRange(e)}setDateRange(e){this.dateRange=e,this.resumeOffset=e.attr.optionalFloat("X-RESUME-OFFSET",this.resumeOffset),this.playoutLimit=e.attr.optionalFloat("X-PLAYOUT-LIMIT",this.playoutLimit),this.restrictions=e.attr.enumeratedStringList("X-RESTRICT",this.restrictions),this.snapOptions=e.attr.enumeratedStringList("X-SNAP",this.snapOptions)}reset(){var e;this.appendInPlaceStarted=!1,null==(e=this.assetListLoader)||e.destroy(),this.assetListLoader=void 0,this.supplementsPrimary||(this.assetListResponse=null,this.assetList=[],this._duration=null)}isAssetPastPlayoutLimit(e){var t;if(e>0&&e>=this.assetList.length)return!0;const s=this.playoutLimit;return!(e<=0||isNaN(s))&&(0===s||((null==(t=this.assetList[e])?void 0:t.startOffset)||0)>s)}findAssetIndex(e){return this.assetList.indexOf(e)}get identifier(){return this.dateRange.id}get startDate(){return this.dateRange.startDate}get startTime(){const e=this.dateRange.startTime;if(this.snapOptions.out){const t=this.dateRange.tagAnchor;if(t)return Or(e,t)}return e}get startOffset(){return this.cue.pre?0:this.startTime}get startIsAligned(){if(0===this.startTime||this.snapOptions.out)return!0;const e=this.dateRange.tagAnchor;if(e){const t=this.dateRange.startTime;return t-Or(t,e)<.1}return!1}get resumptionOffset(){const e=this.resumeOffset,t=i(e)?e:this.duration;return this.cumulativeDuration+t}get resumeTime(){const e=this.startOffset+this.resumptionOffset;if(this.snapOptions.in){const t=this.resumeAnchor;if(t)return Or(e,t)}return e}get appendInPlace(){return!!this.appendInPlaceStarted||!this.appendInPlaceDisabled&&!(this.cue.once||this.cue.pre||!this.startIsAligned||!(isNaN(this.playoutLimit)&&isNaN(this.resumeOffset)||this.resumeOffset&&this.duration&&Math.abs(this.resumeOffset-this.duration)<_r))}set appendInPlace(e){this.appendInPlaceStarted?this.resetOnResume=!e:this.appendInPlaceDisabled=!e}get timelineStart(){return null!==this._timelineStart?this._timelineStart:this.startTime}set timelineStart(e){this._timelineStart=e}get duration(){const e=this.playoutLimit;let t;return t=null!==this._duration?this._duration:this.dateRange.duration?this.dateRange.duration:this.dateRange.plannedDuration||0,!isNaN(e)&&e<t&&(t=e),t}set duration(e){this._duration=e}get cue(){return this.dateRange.cue}get timelineOccupancy(){return"RANGE"===this.dateRange.attr["X-TIMELINE-OCCUPIES"]?Cr.Range:Cr.Point}get supplementsPrimary(){return"PRIMARY"===this.dateRange.attr["X-TIMELINE-STYLE"]}get contentMayVary(){return"NO"!==this.dateRange.attr["X-CONTENT-MAY-VARY"]}get assetUrl(){return this.dateRange.attr["X-ASSET-URI"]}get assetListUrl(){return this.dateRange.attr["X-ASSET-LIST"]}get baseUrl(){return this.base.url}get assetListLoaded(){return this.assetList.length>0||null!==this.assetListResponse}toString(){return`["${(e=this).identifier}" ${e.cue.pre?"<pre>":e.cue.post?"<post>":""}${e.timelineStart.toFixed(2)}-${e.resumeTime.toFixed(2)}]`;var e}}function Or(e,t){return e-t.start<t.duration/2&&!(Math.abs(e-(t.start+t.duration))<_r)?t.start:t.start+t.duration}function Fr(e,t,s){const i=new self.URL(e,s);return"data:"!==i.protocol&&i.searchParams.set("_HLS_primary_id",t),i}function Nr(e,t){for(;null!=(s=e.assetList[++t])&&s.error;)var s;return t}function Br(e){const t=e.timelineStart,s=e.duration||0;return`["${e.identifier}" ${t.toFixed(2)}-${(t+s).toFixed(2)}]`}class Ur{constructor(e,t,s,i){this.hls=void 0,this.interstitial=void 0,this.assetItem=void 0,this.tracks=null,this.hasDetails=!1,this.mediaAttached=null,this._currentTime=void 0,this._bufferedEosTime=void 0,this.checkPlayout=()=>{this.reachedPlayout(this.currentTime)&&this.hls.trigger(l.PLAYOUT_LIMIT_REACHED,{})};const n=this.hls=new e(t);this.interstitial=s,this.assetItem=i;let r=i.uri;try{r=Fr(r,t.primarySessionId).href}catch(e){}n.loadSource(r);const a=()=>{this.hasDetails=!0};n.once(l.LEVEL_LOADED,a),n.once(l.AUDIO_TRACK_LOADED,a),n.once(l.SUBTITLE_TRACK_LOADED,a),n.on(l.MEDIA_ATTACHING,(e,{media:t})=>{this.removeMediaListeners(),this.mediaAttached=t,this.interstitial.playoutLimit&&(t.addEventListener("timeupdate",this.checkPlayout),this.appendInPlace&&n.on(l.BUFFER_APPENDED,()=>{const e=this.bufferedEnd;this.reachedPlayout(e)&&(this._bufferedEosTime=e,n.trigger(l.BUFFERED_TO_END,void 0))}))})}get appendInPlace(){var e;return(null==(e=this.interstitial)?void 0:e.appendInPlace)||!1}bufferedInPlaceToEnd(e){var t;if(!this.appendInPlace)return!1;if(null!=(t=this.hls)&&t.bufferedToEnd)return!0;if(!e||!this._bufferedEosTime)return!1;const s=this.timelineOffset,i=Nt.bufferInfo(e,s,0);return this.getAssetTime(i.end)>=this._bufferedEosTime-.02}reachedPlayout(e){const t=this.interstitial.playoutLimit;return this.startOffset+e>=t}get destroyed(){var e;return!(null!=(e=this.hls)&&e.userConfig)}get assetId(){return this.assetItem.identifier}get interstitialId(){return this.assetItem.parentIdentifier}get media(){var e;return(null==(e=this.hls)?void 0:e.media)||null}get bufferedEnd(){const e=this.media||this.mediaAttached;if(!e)return this._bufferedEosTime?this._bufferedEosTime:this.currentTime;const t=Nt.bufferInfo(e,e.currentTime,.001);return this.getAssetTime(t.end)}get currentTime(){const e=this.media||this.mediaAttached;return e?this.getAssetTime(e.currentTime):this._currentTime||0}get duration(){return this.assetItem.duration||0}get remaining(){const e=this.duration;return e?Math.max(0,e-this.currentTime):0}get startOffset(){return this.assetItem.startOffset}get timelineOffset(){var e;return(null==(e=this.hls)?void 0:e.config.timelineOffset)||0}set timelineOffset(e){const t=this.timelineOffset;if(e!==t){const s=e-t;if(Math.abs(s)>1/9e4){if(this.hasDetails)throw new Error("Cannot set timelineOffset after playlists are loaded");this.hls.config.timelineOffset=e}}}getAssetTime(e){const t=this.timelineOffset,s=this.duration;return Math.min(Math.max(0,e-t),s)}removeMediaListeners(){const e=this.mediaAttached;e&&(this._currentTime=e.currentTime,this.bufferSnapShot(),e.removeEventListener("timeupdate",this.checkPlayout))}bufferSnapShot(){var e;this.mediaAttached&&null!=(e=this.hls)&&e.bufferedToEnd&&(this._bufferedEosTime=this.bufferedEnd)}destroy(){this.removeMediaListeners(),this.hls.destroy(),this.hls=this.interstitial=null,this.tracks=this.mediaAttached=this.checkPlayout=null}attachMedia(e){this.hls.attachMedia(e)}detachMedia(){this.removeMediaListeners(),this.mediaAttached=null,this.hls.detachMedia()}resumeBuffering(){this.hls.resumeBuffering()}pauseBuffering(){this.hls.pauseBuffering()}transferMedia(){return this.bufferSnapShot(),this.hls.transferMedia()}resetDetails(){const e=this.hls;if(this.hasDetails){e.stopLoad();const t=e=>delete e.details;e.levels.forEach(t),e.allAudioTracks.forEach(t),e.allSubtitleTracks.forEach(t),this.hasDetails=!1}}on(e,t,s){this.hls.on(e,t)}once(e,t,s){this.hls.once(e,t)}off(e,t,s){this.hls.off(e,t)}toString(){var e;return`HlsAssetPlayer: ${Br(this.assetItem)} ${null==(e=this.hls)?void 0:e.sessionId} ${this.appendInPlace?"append-in-place":""}`}}class $r extends T{constructor(e,t){super("interstitials-sched",t),this.onScheduleUpdate=void 0,this.eventMap={},this.events=null,this.items=null,this.durations={primary:0,playout:0,integrated:0},this.onScheduleUpdate=e}destroy(){this.reset(),this.onScheduleUpdate=null}reset(){this.eventMap={},this.setDurations(0,0,0),this.events&&this.events.forEach(e=>e.reset()),this.events=this.items=null}resetErrorsInRange(e,t){return this.events?this.events.reduce((s,i)=>e<=i.startOffset&&t>i.startOffset?(delete i.error,s+1):s,0):0}get duration(){const e=this.items;return e?e[e.length-1].end:0}get length(){return this.items?this.items.length:0}getEvent(e){return e&&this.eventMap[e]||null}hasEvent(e){return e in this.eventMap}findItemIndex(e,t){if(e.event)return this.findEventIndex(e.event.identifier);let s=-1;e.nextEvent?s=this.findEventIndex(e.nextEvent.identifier)-1:e.previousEvent&&(s=this.findEventIndex(e.previousEvent.identifier)+1);const i=this.items;if(i)for(i[s]||(void 0===t&&(t=e.start),s=this.findItemIndexAtTime(t));s>=0&&null!=(n=i[s])&&n.event;){var n;s--}return s}findItemIndexAtTime(e,t){const s=this.items;if(s)for(let i=0;i<s.length;i++){let n=s[i];if(t&&"primary"!==t&&(n=n[t]),e===n.start||e>n.start&&e<n.end)return i}return-1}findJumpRestrictedIndex(e,t){const s=this.items;if(s)for(let i=e;i<=t&&s[i];i++){const e=s[i].event;if(null!=e&&e.restrictions.jump&&!e.appendInPlace)return i}return-1}findEventIndex(e){const t=this.items;if(t)for(let i=t.length;i--;){var s;if((null==(s=t[i].event)?void 0:s.identifier)===e)return i}return-1}findAssetIndex(e,t){const s=e.assetList,i=s.length;if(i>1)for(let e=0;e<i;e++){const i=s[e];if(!i.error){const s=i.timelineStart;if(t===s||t>s&&t<s+(i.duration||0))return e}}return 0}get assetIdAtEnd(){var e,t;const s=null==(e=this.items)||null==(t=e[this.length-1])?void 0:t.event;if(s){const e=s.assetList,t=e[e.length-1];if(t)return t.identifier}return null}parseInterstitialDateRanges(e,t){const s=e.main.details,{dateRanges:i}=s,n=this.events,r=this.parseDateRanges(i,{url:s.url},t),a=Object.keys(i),o=n?n.filter(e=>!a.includes(e.identifier)):[];r.length&&r.sort((e,t)=>{const s=e.cue.pre,i=e.cue.post,n=t.cue.pre,r=t.cue.post;if(s&&!n)return-1;if(n&&!s)return 1;if(i&&!r)return 1;if(r&&!i)return-1;if(!(s||n||i||r)){const s=e.startTime,i=t.startTime;if(s!==i)return s-i}return e.dateRange.tagOrder-t.dateRange.tagOrder}),this.events=r,o.forEach(e=>{this.removeEvent(e)}),this.updateSchedule(e,o)}updateSchedule(e,t=[]){const s=this.events||[];if(s.length||t.length||this.length<2){const i=this.items,n=this.parseSchedule(s,e);(t.length||(null==i?void 0:i.length)!==n.length||n.some((e,t)=>Math.abs(e.playout.start-i[t].playout.start)>.005||Math.abs(e.playout.end-i[t].playout.end)>.005))&&(this.items=n,this.onScheduleUpdate(t,i))}}parseDateRanges(e,t,s){const i=[],n=Object.keys(e);for(let r=0;r<n.length;r++){const a=n[r],o=e[a];if(o.isInterstitial){let e=this.eventMap[a];e?e.setDateRange(o):(e=new Mr(o,t),this.eventMap[a]=e,!1===s&&(e.appendInPlace=s)),i.push(e)}}return i}parseSchedule(e,t){const s=[],i=t.main.details,n=i.live?1/0:i.edge;let r=0;if((e=e.filter(e=>!(e.error||e.cue.once&&e.hasPlayed))).length){this.resolveOffsets(e,t);let i=0,o=0;if(e.forEach((t,a)=>{const l=t.cue.pre,d=t.cue.post,c=e[a-1]||null,h=t.appendInPlace,u=d?n:t.startOffset,f=t.duration,g=t.timelineOccupancy===Cr.Range?f:0,m=t.resumptionOffset,p=(null==c?void 0:c.startTime)===u,y=u+t.cumulativeDuration;let v=h?y+f:u+m;if(l||!d&&u<=0){const e=o;o+=g,t.timelineStart=y;const i=r;r+=f,s.push({event:t,start:y,end:v,playout:{start:i,end:r},integrated:{start:e,end:o}})}else{if(!(u<=n))return;{if(!p){const n=u-i;if(n>.033){const l=i,d=o;o+=n;const c=r;r+=n;const h={previousEvent:e[a-1]||null,nextEvent:t,start:l,end:l+n,playout:{start:c,end:r},integrated:{start:d,end:o}};s.push(h)}else n>0&&c&&(c.cumulativeDuration+=n,s[s.length-1].end=u)}d&&(v=y),t.timelineStart=y;const n=o;o+=g;const l=r;r+=f,s.push({event:t,start:y,end:v,playout:{start:l,end:r},integrated:{start:n,end:o}})}}const E=t.resumeTime;i=d||E>n?n:E}),i<n){var a;const e=i,t=o,l=n-i;o+=l;const d=r;r+=l,s.push({previousEvent:(null==(a=s[s.length-1])?void 0:a.event)||null,nextEvent:null,start:i,end:e+l,playout:{start:d,end:r},integrated:{start:t,end:o}})}this.setDurations(n,r,o)}else{const e=0;s.push({previousEvent:null,nextEvent:null,start:e,end:n,playout:{start:e,end:n},integrated:{start:e,end:n}}),this.setDurations(n,n,n)}return s}setDurations(e,t,s){this.durations={primary:e,playout:t,integrated:s}}resolveOffsets(e,t){const s=t.main.details,n=s.live?1/0:s.edge;let r=0,a=-1;e.forEach((o,l)=>{const d=o.cue.pre,c=o.cue.post,h=d?0:c?n:o.startTime;this.updateAssetDurations(o),a===h?o.cumulativeDuration=r:(r=0,a=h),!c&&o.snapOptions.in&&(o.resumeAnchor=nt(null,s.fragments,o.startOffset+o.resumptionOffset,0,0)||void 0),o.appendInPlace&&!o.appendInPlaceStarted&&(this.primaryCanResumeInPlaceAt(o,t)||(o.appendInPlace=!1)),!o.appendInPlace&&l+1<e.length&&e[l+1].startTime-e[l].resumeTime<.033&&(e[l+1].appendInPlace=!1,e[l+1].appendInPlace&&this.warn(`Could not change append strategy for abutting event ${o}`));const u=i(o.resumeOffset)?o.resumeOffset:o.duration;r+=u})}primaryCanResumeInPlaceAt(e,t){const s=e.resumeTime,i=e.startTime+e.resumptionOffset;return Math.abs(s-i)>_r?(this.log(`"${e.identifier}" resumption ${s} not aligned with estimated timeline end ${i}`),!1):t?!Object.keys(t).some(i=>{const n=t[i].details,r=n.edge;if(s>=r)return this.log(`"${e.identifier}" resumption ${s} past ${i} playlist end ${r}`),!1;const a=nt(null,n.fragments,s);if(!a)return this.log(`"${e.identifier}" resumption ${s} does not align with any fragments in ${i} playlist (${n.fragStart}-${n.fragmentEnd})`),!0;const o="audio"===i?.175:0;return!(Math.abs(a.start-s)<_r+o||Math.abs(a.end-s)<_r+o||(this.log(`"${e.identifier}" resumption ${s} not aligned with ${i} fragment bounds (${a.start}-${a.end} sn: ${a.sn} cc: ${a.cc})`),0))}):(this.log(`"${e.identifier}" resumption ${s} can not be aligned with media (none selected)`),!1)}updateAssetDurations(e){if(!e.assetListLoaded)return;const t=e.timelineStart;let s=0,i=!1,n=!1;e.assetList.forEach((e,r)=>{const a=t+s;e.startOffset=s,e.timelineStart=a,i||(i=null===e.duration),n||(n=!!e.error);const o=e.error?0:e.duration||0;s+=o}),e.duration=i&&!n?Math.max(s,e.duration):s}removeEvent(e){e.reset(),delete this.eventMap[e.identifier]}}function Gr(e){return`[${e.event?'"'+e.event.identifier+'"':"primary"}: ${e.start.toFixed(2)}-${e.end.toFixed(2)}]`}class jr{constructor(e){this.hls=void 0,this.hls=e}destroy(){this.hls=null}loadAssetList(e,t){const s=e.assetListUrl;let i;try{i=Fr(s,this.hls.sessionId,e.baseUrl)}catch(t){const i=this.assignAssetListError(e,o.ASSET_LIST_LOAD_ERROR,t,s);return void this.hls.trigger(l.ERROR,i)}t&&"data:"!==i.protocol&&i.searchParams.set("_HLS_start_offset",""+t);const n=this.hls.config,r=new(0,n.loader)(n),a={responseType:"json",url:i.href},d=n.interstitialAssetListLoadPolicy.default,c={loadPolicy:d,timeout:d.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},h={onSuccess:(t,s,i,n)=>{const r=t.data,a=null==r?void 0:r.ASSETS;if(!Array.isArray(a)){const t=this.assignAssetListError(e,o.ASSET_LIST_PARSING_ERROR,new Error("Invalid interstitial asset list"),i.url,s,n);return void this.hls.trigger(l.ERROR,t)}e.assetListResponse=r,this.hls.trigger(l.ASSET_LIST_LOADED,{event:e,assetListResponse:r,networkDetails:n})},onError:(t,s,i,n)=>{const r=this.assignAssetListError(e,o.ASSET_LIST_LOAD_ERROR,new Error(`Error loading X-ASSET-LIST: HTTP status ${t.code} ${t.text} (${s.url})`),s.url,n,i);this.hls.trigger(l.ERROR,r)},onTimeout:(t,s,i)=>{const n=this.assignAssetListError(e,o.ASSET_LIST_LOAD_TIMEOUT,new Error(`Timeout loading X-ASSET-LIST (${s.url})`),s.url,t,i);this.hls.trigger(l.ERROR,n)}};return r.load(a,c,h),this.hls.trigger(l.ASSET_LIST_LOADING,{event:e}),r}assignAssetListError(e,t,s,i,n,r){return e.error=s,{type:a.NETWORK_ERROR,details:t,fatal:!1,interstitial:e,url:i,error:s,networkDetails:r,stats:n}}}function Hr(e){null==e||e.play().catch(()=>{})}class Vr extends ei{constructor(e,t,s){super(e,t,s,"subtitle-stream-controller",f.SUBTITLE),this.currentTrackId=-1,this.tracksBuffered=[],this.mainDetails=null,this.registerListeners()}onHandlerDestroying(){this.unregisterListeners(),super.onHandlerDestroying(),this.mainDetails=null}registerListeners(){super.registerListeners();const{hls:e}=this;e.on(l.LEVEL_LOADED,this.onLevelLoaded,this),e.on(l.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.on(l.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.on(l.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.on(l.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),e.on(l.BUFFER_FLUSHING,this.onBufferFlushing,this)}unregisterListeners(){super.unregisterListeners();const{hls:e}=this;e.off(l.LEVEL_LOADED,this.onLevelLoaded,this),e.off(l.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.off(l.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.off(l.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.off(l.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),e.off(l.BUFFER_FLUSHING,this.onBufferFlushing,this)}startLoad(e,t){this.stopLoad(),this.state=Hs,this.setInterval(500),this.nextLoadPosition=this.lastCurrentTime=e+this.timelineOffset,this.startPosition=t?-1:e,this.tick()}onManifestLoading(){super.onManifestLoading(),this.mainDetails=null}onMediaDetaching(e,t){this.tracksBuffered=[],super.onMediaDetaching(e,t)}onLevelLoaded(e,t){this.mainDetails=t.details}onSubtitleFragProcessed(e,t){const{frag:s,success:i}=t;if(this.fragContextChanged(s)||(q(s)&&(this.fragPrevious=s),this.state=Hs),!i)return;const n=this.tracksBuffered[this.currentTrackId];if(!n)return;let r;const a=s.start;for(let e=0;e<n.length;e++)if(a>=n[e].start&&a<=n[e].end){r=n[e];break}const o=s.start+s.duration;r?r.end=o:(r={start:a,end:o},n.push(r)),this.fragmentTracker.fragBuffered(s),this.fragBufferedComplete(s,null),this.media&&this.tick()}onBufferFlushing(e,t){const{startOffset:s,endOffset:i}=t;if(0===s&&i!==Number.POSITIVE_INFINITY){const e=i-1;if(e<=0)return;t.endOffsetSubtitles=Math.max(0,e),this.tracksBuffered.forEach(t=>{for(let s=0;s<t.length;)if(t[s].end<=e)t.shift();else{if(!(t[s].start<e))break;t[s].start=e,s++}}),this.fragmentTracker.removeFragmentsInRange(s,e,f.SUBTITLE)}}onError(e,t){const s=t.frag;(null==s?void 0:s.type)===f.SUBTITLE&&(t.details===o.FRAG_GAP&&this.fragmentTracker.fragBuffered(s,!0),this.fragCurrent&&this.fragCurrent.abortRequests(),this.state!==js&&(this.state=Hs))}onSubtitleTracksUpdated(e,{subtitleTracks:t}){this.levels&&Cn(this.levels,t)?this.levels=t.map(e=>new Ke(e)):(this.tracksBuffered=[],this.levels=t.map(e=>{const t=new Ke(e);return this.tracksBuffered[t.id]=[],t}),this.fragmentTracker.removeFragmentsInRange(0,Number.POSITIVE_INFINITY,f.SUBTITLE),this.fragPrevious=null,this.mediaBuffer=null)}onSubtitleTrackSwitch(e,t){var s;if(this.currentTrackId=t.id,null==(s=this.levels)||!s.length||-1===this.currentTrackId)return void this.clearInterval();const i=this.levels[this.currentTrackId];null!=i&&i.details?this.mediaBuffer=this.mediaBufferTimeRanges:this.mediaBuffer=null,i&&this.state!==js&&this.setInterval(500)}onSubtitleTrackLoaded(e,t){var s;const{currentTrackId:i,levels:n}=this,{details:r,id:a}=t;if(!n)return void this.warn(`Subtitle tracks were reset while loading level ${a}`);const o=n[a];if(a>=n.length||!o)return;this.log(`Subtitle track ${a} loaded [${r.startSN},${r.endSN}]${r.lastPartSn?`[part-${r.lastPartSn}-${r.lastPartIndex}]`:""},duration:${r.totalduration}`),this.mediaBuffer=this.mediaBufferTimeRanges;let d=0;if(r.live||null!=(s=o.details)&&s.live){if(r.deltaUpdateFailed)return;const e=this.mainDetails;if(!e)return void(this.startFragRequested=!1);const t=e.fragments[0];var c;o.details?(d=this.alignPlaylists(r,o.details,null==(c=this.levelLastLoaded)?void 0:c.details),0===d&&t&&(d=t.start,_s(r,d))):r.hasProgramDateTime&&e.hasProgramDateTime?(Gs(r,e),d=r.fragmentStart):t&&(d=t.start,_s(r,d)),e&&!this.startFragRequested&&this.setStartPosition(e,d)}o.details=r,this.levelLastLoaded=o,a===i&&(this.hls.trigger(l.SUBTITLE_TRACK_UPDATED,{details:r,id:a,groupId:t.groupId}),this.tick(),r.live&&!this.fragCurrent&&this.media&&this.state===Hs)&&(nt(null,r.fragments,this.media.currentTime,0)||(this.warn("Subtitle playlist not aligned with playback"),o.details=void 0))}_handleFragmentLoadComplete(e){const{frag:t,payload:s}=e,i=t.decryptdata,n=this.hls;if(!this.fragContextChanged(t)&&s&&s.byteLength>0&&null!=i&&i.key&&i.iv&&Xt(i.method)){const e=performance.now();this.decrypter.decrypt(new Uint8Array(s),i.key.buffer,i.iv.buffer,Zt(i.method)).catch(e=>{throw n.trigger(l.ERROR,{type:a.MEDIA_ERROR,details:o.FRAG_DECRYPT_ERROR,fatal:!1,error:e,reason:e.message,frag:t}),e}).then(s=>{const i=performance.now();n.trigger(l.FRAG_DECRYPTED,{frag:t,payload:s,stats:{tstart:e,tdecrypt:i}})}).catch(e=>{this.warn(`${e.name}: ${e.message}`),this.state=Hs})}}doTick(){if(this.media){if(this.state===Hs){const{currentTrackId:e,levels:t}=this,s=null==t?void 0:t[e];if(!s||!t.length||!s.details)return;if(this.waitForLive(s))return;const{config:i}=this,n=this.getLoadPosition(),r=Nt.bufferedInfo(this.tracksBuffered[this.currentTrackId]||[],n,i.maxBufferHole),{end:a,len:o}=r,l=s.details;if(o>this.hls.maxBufferLength+l.levelTargetDuration)return;const d=l.fragments,c=d.length,h=l.edge;let u=null;const f=this.fragPrevious;if(a<h){const e=i.maxFragLookUpTolerance,t=a>h-e?0:e;u=nt(f,d,Math.max(d[0].start,a),t),!u&&f&&f.start<d[0].start&&(u=d[0])}else u=d[c-1];if(u=this.filterReplacedPrimary(u,s.details),!u)return;const g=d[u.sn-l.startSN-1];if(g&&g.cc===u.cc&&this.fragmentTracker.getState(g)===yt&&(u=g),this.fragmentTracker.getState(u)===yt){const e=this.mapToInitFragWhenRequired(u);e&&this.loadFragment(e,s,a)}}}else this.state=Hs}loadFragment(e,t,s){q(e)?super.loadFragment(e,t,s):this._loadInitSegment(e,t)}get mediaBufferTimeRanges(){return new Kr(this.tracksBuffered[this.currentTrackId]||[])}}class Kr{constructor(e){this.buffered=void 0;const t=(t,s,i)=>{if((s>>>=0)>i-1)throw new DOMException(`Failed to execute '${t}' on 'TimeRanges': The index provided (${s}) is greater than the maximum bound (${i})`);return e[s][t]};this.buffered={get length(){return e.length},end:s=>t("end",s,e.length),start:s=>t("start",s,e.length)}}}const qr={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608,128:174,129:176,130:189,131:191,132:8482,133:162,134:163,135:9834,136:224,137:32,138:232,139:226,140:234,141:238,142:244,143:251,144:193,145:201,146:211,147:218,148:220,149:252,150:8216,151:161,152:42,153:8217,154:9473,155:169,156:8480,157:8226,158:8220,159:8221,160:192,161:194,162:199,163:200,164:202,165:203,166:235,167:206,168:207,169:239,170:212,171:217,172:249,173:219,174:171,175:187,176:195,177:227,178:205,179:204,180:236,181:210,182:242,183:213,184:245,185:123,186:125,187:92,188:94,189:95,190:124,191:8764,192:196,193:228,194:214,195:246,196:223,197:165,198:164,199:9475,200:197,201:229,202:216,203:248,204:9487,205:9491,206:9495,207:9499},Yr=e=>String.fromCharCode(qr[e]||e),Wr=15,zr=100,Xr={17:1,18:3,21:5,22:7,23:9,16:11,19:12,20:14},Zr={17:2,18:4,21:6,22:8,23:10,19:13,20:15},Qr={25:1,26:3,29:5,30:7,31:9,24:11,27:12,28:14},Jr={25:2,26:4,29:6,30:8,31:10,27:13,28:15},ea=["white","green","blue","cyan","red","yellow","magenta","black","transparent"];class ta{constructor(){this.time=null,this.verboseLevel=0}log(e,t){if(this.verboseLevel>=e){const s="function"==typeof t?t():t;R.log(`${this.time} [${e}] ${s}`)}}}const sa=function(e){const t=[];for(let s=0;s<e.length;s++)t.push(e[s].toString(16));return t};class ia{constructor(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}reset(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}setStyles(e){const t=["foreground","underline","italics","background","flash"];for(let s=0;s<t.length;s++){const i=t[s];e.hasOwnProperty(i)&&(this[i]=e[i])}}isDefault(){return"white"===this.foreground&&!this.underline&&!this.italics&&"black"===this.background&&!this.flash}equals(e){return this.foreground===e.foreground&&this.underline===e.underline&&this.italics===e.italics&&this.background===e.background&&this.flash===e.flash}copy(e){this.foreground=e.foreground,this.underline=e.underline,this.italics=e.italics,this.background=e.background,this.flash=e.flash}toString(){return"color="+this.foreground+", underline="+this.underline+", italics="+this.italics+", background="+this.background+", flash="+this.flash}}class na{constructor(){this.uchar=" ",this.penState=new ia}reset(){this.uchar=" ",this.penState.reset()}setChar(e,t){this.uchar=e,this.penState.copy(t)}setPenState(e){this.penState.copy(e)}equals(e){return this.uchar===e.uchar&&this.penState.equals(e.penState)}copy(e){this.uchar=e.uchar,this.penState.copy(e.penState)}isEmpty(){return" "===this.uchar&&this.penState.isDefault()}}class ra{constructor(e){this.chars=[],this.pos=0,this.currPenState=new ia,this.cueStartTime=null,this.logger=void 0;for(let e=0;e<zr;e++)this.chars.push(new na);this.logger=e}equals(e){for(let t=0;t<zr;t++)if(!this.chars[t].equals(e.chars[t]))return!1;return!0}copy(e){for(let t=0;t<zr;t++)this.chars[t].copy(e.chars[t])}isEmpty(){let e=!0;for(let t=0;t<zr;t++)if(!this.chars[t].isEmpty()){e=!1;break}return e}setCursor(e){this.pos!==e&&(this.pos=e),this.pos<0?(this.logger.log(3,"Negative cursor position "+this.pos),this.pos=0):this.pos>zr&&(this.logger.log(3,"Too large cursor position "+this.pos),this.pos=zr)}moveCursor(e){const t=this.pos+e;if(e>1)for(let e=this.pos+1;e<t+1;e++)this.chars[e].setPenState(this.currPenState);this.setCursor(t)}backSpace(){this.moveCursor(-1),this.chars[this.pos].setChar(" ",this.currPenState)}insertChar(e){e>=144&&this.backSpace();const t=Yr(e);this.pos>=zr?this.logger.log(0,()=>"Cannot insert "+e.toString(16)+" ("+t+") at position "+this.pos+". Skipping it!"):(this.chars[this.pos].setChar(t,this.currPenState),this.moveCursor(1))}clearFromPos(e){let t;for(t=e;t<zr;t++)this.chars[t].reset()}clear(){this.clearFromPos(0),this.pos=0,this.currPenState.reset()}clearToEndOfRow(){this.clearFromPos(this.pos)}getTextString(){const e=[];let t=!0;for(let s=0;s<zr;s++){const i=this.chars[s].uchar;" "!==i&&(t=!1),e.push(i)}return t?"":e.join("")}setPenStyles(e){this.currPenState.setStyles(e),this.chars[this.pos].setPenState(this.currPenState)}}class aa{constructor(e){this.rows=[],this.currRow=14,this.nrRollUpRows=null,this.lastOutputScreen=null,this.logger=void 0;for(let t=0;t<Wr;t++)this.rows.push(new ra(e));this.logger=e}reset(){for(let e=0;e<Wr;e++)this.rows[e].clear();this.currRow=14}equals(e){let t=!0;for(let s=0;s<Wr;s++)if(!this.rows[s].equals(e.rows[s])){t=!1;break}return t}copy(e){for(let t=0;t<Wr;t++)this.rows[t].copy(e.rows[t])}isEmpty(){let e=!0;for(let t=0;t<Wr;t++)if(!this.rows[t].isEmpty()){e=!1;break}return e}backSpace(){this.rows[this.currRow].backSpace()}clearToEndOfRow(){this.rows[this.currRow].clearToEndOfRow()}insertChar(e){this.rows[this.currRow].insertChar(e)}setPen(e){this.rows[this.currRow].setPenStyles(e)}moveCursor(e){this.rows[this.currRow].moveCursor(e)}setCursor(e){this.logger.log(2,"setCursor: "+e),this.rows[this.currRow].setCursor(e)}setPAC(e){this.logger.log(2,()=>"pacData = "+Ye(e));let t=e.row-1;if(this.nrRollUpRows&&t<this.nrRollUpRows-1&&(t=this.nrRollUpRows-1),this.nrRollUpRows&&this.currRow!==t){for(let e=0;e<Wr;e++)this.rows[e].clear();const e=this.currRow+1-this.nrRollUpRows,s=this.lastOutputScreen;if(s){const i=s.rows[e].cueStartTime,n=this.logger.time;if(null!==i&&null!==n&&i<n)for(let i=0;i<this.nrRollUpRows;i++)this.rows[t-this.nrRollUpRows+i+1].copy(s.rows[e+i])}}this.currRow=t;const s=this.rows[this.currRow];if(null!==e.indent){const t=e.indent,i=Math.max(t-1,0);s.setCursor(e.indent),e.color=s.chars[i].penState.foreground}const i={foreground:e.color,underline:e.underline,italics:e.italics,background:"black",flash:!1};this.setPen(i)}setBkgData(e){this.logger.log(2,()=>"bkgData = "+Ye(e)),this.backSpace(),this.setPen(e),this.insertChar(32)}setRollUpRows(e){this.nrRollUpRows=e}rollUp(){if(null===this.nrRollUpRows)return void this.logger.log(3,"roll_up but nrRollUpRows not set yet");this.logger.log(1,()=>this.getDisplayText());const e=this.currRow+1-this.nrRollUpRows,t=this.rows.splice(e,1)[0];t.clear(),this.rows.splice(this.currRow,0,t),this.logger.log(2,"Rolling up")}getDisplayText(e){e=e||!1;const t=[];let s="",i=-1;for(let s=0;s<Wr;s++){const n=this.rows[s].getTextString();n&&(i=s+1,e?t.push("Row "+i+": '"+n+"'"):t.push(n.trim()))}return t.length>0&&(s=e?"["+t.join(" | ")+"]":t.join("\n")),s}getTextAndFormat(){return this.rows}}class oa{constructor(e,t,s){this.chNr=void 0,this.outputFilter=void 0,this.mode=void 0,this.verbose=void 0,this.displayedMemory=void 0,this.nonDisplayedMemory=void 0,this.lastOutputScreen=void 0,this.currRollUpRow=void 0,this.writeScreen=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chNr=e,this.outputFilter=t,this.mode=null,this.verbose=0,this.displayedMemory=new aa(s),this.nonDisplayedMemory=new aa(s),this.lastOutputScreen=new aa(s),this.currRollUpRow=this.displayedMemory.rows[14],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null,this.logger=s}reset(){this.mode=null,this.displayedMemory.reset(),this.nonDisplayedMemory.reset(),this.lastOutputScreen.reset(),this.outputFilter.reset(),this.currRollUpRow=this.displayedMemory.rows[14],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null}getHandler(){return this.outputFilter}setHandler(e){this.outputFilter=e}setPAC(e){this.writeScreen.setPAC(e)}setBkgData(e){this.writeScreen.setBkgData(e)}setMode(e){e!==this.mode&&(this.mode=e,this.logger.log(2,()=>"MODE="+e),"MODE_POP-ON"===this.mode?this.writeScreen=this.nonDisplayedMemory:(this.writeScreen=this.displayedMemory,this.writeScreen.reset()),"MODE_ROLL-UP"!==this.mode&&(this.displayedMemory.nrRollUpRows=null,this.nonDisplayedMemory.nrRollUpRows=null),this.mode=e)}insertChars(e){for(let t=0;t<e.length;t++)this.writeScreen.insertChar(e[t]);const t=this.writeScreen===this.displayedMemory?"DISP":"NON_DISP";this.logger.log(2,()=>t+": "+this.writeScreen.getDisplayText(!0)),"MODE_PAINT-ON"!==this.mode&&"MODE_ROLL-UP"!==this.mode||(this.logger.log(1,()=>"DISPLAYED: "+this.displayedMemory.getDisplayText(!0)),this.outputDataUpdate())}ccRCL(){this.logger.log(2,"RCL - Resume Caption Loading"),this.setMode("MODE_POP-ON")}ccBS(){this.logger.log(2,"BS - BackSpace"),"MODE_TEXT"!==this.mode&&(this.writeScreen.backSpace(),this.writeScreen===this.displayedMemory&&this.outputDataUpdate())}ccAOF(){}ccAON(){}ccDER(){this.logger.log(2,"DER- Delete to End of Row"),this.writeScreen.clearToEndOfRow(),this.outputDataUpdate()}ccRU(e){this.logger.log(2,"RU("+e+") - Roll Up"),this.writeScreen=this.displayedMemory,this.setMode("MODE_ROLL-UP"),this.writeScreen.setRollUpRows(e)}ccFON(){this.logger.log(2,"FON - Flash On"),this.writeScreen.setPen({flash:!0})}ccRDC(){this.logger.log(2,"RDC - Resume Direct Captioning"),this.setMode("MODE_PAINT-ON")}ccTR(){this.logger.log(2,"TR"),this.setMode("MODE_TEXT")}ccRTD(){this.logger.log(2,"RTD"),this.setMode("MODE_TEXT")}ccEDM(){this.logger.log(2,"EDM - Erase Displayed Memory"),this.displayedMemory.reset(),this.outputDataUpdate(!0)}ccCR(){this.logger.log(2,"CR - Carriage Return"),this.writeScreen.rollUp(),this.outputDataUpdate(!0)}ccENM(){this.logger.log(2,"ENM - Erase Non-displayed Memory"),this.nonDisplayedMemory.reset()}ccEOC(){if(this.logger.log(2,"EOC - End Of Caption"),"MODE_POP-ON"===this.mode){const e=this.displayedMemory;this.displayedMemory=this.nonDisplayedMemory,this.nonDisplayedMemory=e,this.writeScreen=this.nonDisplayedMemory,this.logger.log(1,()=>"DISP: "+this.displayedMemory.getDisplayText())}this.outputDataUpdate(!0)}ccTO(e){this.logger.log(2,"TO("+e+") - Tab Offset"),this.writeScreen.moveCursor(e)}ccMIDROW(e){const t={flash:!1};if(t.underline=e%2==1,t.italics=e>=46,t.italics)t.foreground="white";else{const s=Math.floor(e/2)-16,i=["white","green","blue","cyan","red","yellow","magenta"];t.foreground=i[s]}this.logger.log(2,"MIDROW: "+Ye(t)),this.writeScreen.setPen(t)}outputDataUpdate(e=!1){const t=this.logger.time;null!==t&&this.outputFilter&&(null!==this.cueStartTime||this.displayedMemory.isEmpty()?this.displayedMemory.equals(this.lastOutputScreen)||(this.outputFilter.newCue(this.cueStartTime,t,this.lastOutputScreen),e&&this.outputFilter.dispatchCue&&this.outputFilter.dispatchCue(),this.cueStartTime=this.displayedMemory.isEmpty()?null:t):this.cueStartTime=t,this.lastOutputScreen.copy(this.displayedMemory))}cueSplitAtTime(e){this.outputFilter&&(this.displayedMemory.isEmpty()||(this.outputFilter.newCue&&this.outputFilter.newCue(this.cueStartTime,e,this.displayedMemory),this.cueStartTime=e))}}class la{constructor(e,t,s){this.channels=void 0,this.currentChannel=0,this.cmdHistory={a:null,b:null},this.logger=void 0;const i=this.logger=new ta;this.channels=[null,new oa(e,t,i),new oa(e+1,s,i)]}getHandler(e){return this.channels[e].getHandler()}setHandler(e,t){this.channels[e].setHandler(t)}addData(e,t){this.logger.time=e;for(let e=0;e<t.length;e+=2){const s=127&t[e],i=127&t[e+1];let n=!1,r=null;if(0===s&&0===i)continue;this.logger.log(3,()=>"["+sa([t[e],t[e+1]])+"] -> ("+sa([s,i])+")");const a=this.cmdHistory;if(s>=16&&s<=31){if(ca(s,i,a)){da(null,null,a),this.logger.log(3,()=>"Repeated command ("+sa([s,i])+") is dropped");continue}da(s,i,this.cmdHistory),n=this.parseCmd(s,i),n||(n=this.parseMidrow(s,i)),n||(n=this.parsePAC(s,i)),n||(n=this.parseBackgroundAttributes(s,i))}else da(null,null,a);if(!n&&(r=this.parseChars(s,i),r)){const e=this.currentChannel;e&&e>0?this.channels[e].insertChars(r):this.logger.log(2,"No channel found yet. TEXT-MODE?")}n||r||this.logger.log(2,()=>"Couldn't parse cleaned data "+sa([s,i])+" orig: "+sa([t[e],t[e+1]]))}}parseCmd(e,t){if(!((20===e||28===e||21===e||29===e)&&t>=32&&t<=47||(23===e||31===e)&&t>=33&&t<=35))return!1;const s=20===e||21===e||23===e?1:2,i=this.channels[s];return 20===e||21===e||28===e||29===e?32===t?i.ccRCL():33===t?i.ccBS():34===t?i.ccAOF():35===t?i.ccAON():36===t?i.ccDER():37===t?i.ccRU(2):38===t?i.ccRU(3):39===t?i.ccRU(4):40===t?i.ccFON():41===t?i.ccRDC():42===t?i.ccTR():43===t?i.ccRTD():44===t?i.ccEDM():45===t?i.ccCR():46===t?i.ccENM():47===t&&i.ccEOC():i.ccTO(t-32),this.currentChannel=s,!0}parseMidrow(e,t){let s=0;if((17===e||25===e)&&t>=32&&t<=47){if(s=17===e?1:2,s!==this.currentChannel)return this.logger.log(0,"Mismatch channel in midrow parsing"),!1;const i=this.channels[s];return!!i&&(i.ccMIDROW(t),this.logger.log(3,()=>"MIDROW ("+sa([e,t])+")"),!0)}return!1}parsePAC(e,t){let s;if(!((e>=17&&e<=23||e>=25&&e<=31)&&t>=64&&t<=127||(16===e||24===e)&&t>=64&&t<=95))return!1;const i=e<=23?1:2;s=t>=64&&t<=95?1===i?Xr[e]:Qr[e]:1===i?Zr[e]:Jr[e];const n=this.channels[i];return!!n&&(n.setPAC(this.interpretPAC(s,t)),this.currentChannel=i,!0)}interpretPAC(e,t){let s;const i={color:null,italics:!1,indent:null,underline:!1,row:e};return s=t>95?t-96:t-64,i.underline=!(1&~s),s<=13?i.color=["white","green","blue","cyan","red","yellow","magenta","white"][Math.floor(s/2)]:s<=15?(i.italics=!0,i.color="white"):i.indent=4*Math.floor((s-16)/2),i}parseChars(e,t){let s,i=null,n=null;if(e>=25?(s=2,n=e-8):(s=1,n=e),n>=17&&n<=19){let e;e=17===n?t+80:18===n?t+112:t+144,this.logger.log(2,()=>"Special char '"+Yr(e)+"' in channel "+s),i=[e]}else e>=32&&e<=127&&(i=0===t?[e]:[e,t]);return i&&this.logger.log(3,()=>"Char codes =  "+sa(i).join(",")),i}parseBackgroundAttributes(e,t){if(!((16===e||24===e)&&t>=32&&t<=47||(23===e||31===e)&&t>=45&&t<=47))return!1;let s;const i={};16===e||24===e?(s=Math.floor((t-32)/2),i.background=ea[s],t%2==1&&(i.background=i.background+"_semi")):45===t?i.background="transparent":(i.foreground="black",47===t&&(i.underline=!0));const n=e<=23?1:2;return this.channels[n].setBkgData(i),!0}reset(){for(let e=0;e<Object.keys(this.channels).length;e++){const t=this.channels[e];t&&t.reset()}da(null,null,this.cmdHistory)}cueSplitAtTime(e){for(let t=0;t<this.channels.length;t++){const s=this.channels[t];s&&s.cueSplitAtTime(e)}}}function da(e,t,s){s.a=e,s.b=t}function ca(e,t,s){return s.a===e&&s.b===t}var ha=function(){if(null!=es&&es.VTTCue)return self.VTTCue;const e=["","lr","rl"],t=["start","middle","end","left","right"];function s(e,t){if("string"!=typeof t)return!1;if(!Array.isArray(e))return!1;const s=t.toLowerCase();return!!~e.indexOf(s)&&s}function i(e){return s(t,e)}function n(e,...t){let s=1;for(;s<arguments.length;s++){const t=arguments[s];for(const s in t)e[s]=t[s]}return e}function r(t,r,a){const o=this,l={enumerable:!0};o.hasBeenReset=!1;let d="",c=!1,h=t,u=r,f=a,g=null,m="",p=!0,y="auto",v="start",E=50,T="middle",S=50,b="middle";Object.defineProperty(o,"id",n({},l,{get:function(){return d},set:function(e){d=""+e}})),Object.defineProperty(o,"pauseOnExit",n({},l,{get:function(){return c},set:function(e){c=!!e}})),Object.defineProperty(o,"startTime",n({},l,{get:function(){return h},set:function(e){if("number"!=typeof e)throw new TypeError("Start time must be set to a number.");h=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"endTime",n({},l,{get:function(){return u},set:function(e){if("number"!=typeof e)throw new TypeError("End time must be set to a number.");u=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"text",n({},l,{get:function(){return f},set:function(e){f=""+e,this.hasBeenReset=!0}})),Object.defineProperty(o,"region",n({},l,{get:function(){return g},set:function(e){g=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"vertical",n({},l,{get:function(){return m},set:function(t){const i=function(t){return s(e,t)}(t);if(!1===i)throw new SyntaxError("An invalid or illegal string was specified.");m=i,this.hasBeenReset=!0}})),Object.defineProperty(o,"snapToLines",n({},l,{get:function(){return p},set:function(e){p=!!e,this.hasBeenReset=!0}})),Object.defineProperty(o,"line",n({},l,{get:function(){return y},set:function(e){if("number"!=typeof e&&"auto"!==e)throw new SyntaxError("An invalid number or illegal string was specified.");y=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"lineAlign",n({},l,{get:function(){return v},set:function(e){const t=i(e);if(!t)throw new SyntaxError("An invalid or illegal string was specified.");v=t,this.hasBeenReset=!0}})),Object.defineProperty(o,"position",n({},l,{get:function(){return E},set:function(e){if(e<0||e>100)throw new Error("Position must be between 0 and 100.");E=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"positionAlign",n({},l,{get:function(){return T},set:function(e){const t=i(e);if(!t)throw new SyntaxError("An invalid or illegal string was specified.");T=t,this.hasBeenReset=!0}})),Object.defineProperty(o,"size",n({},l,{get:function(){return S},set:function(e){if(e<0||e>100)throw new Error("Size must be between 0 and 100.");S=e,this.hasBeenReset=!0}})),Object.defineProperty(o,"align",n({},l,{get:function(){return b},set:function(e){const t=i(e);if(!t)throw new SyntaxError("An invalid or illegal string was specified.");b=t,this.hasBeenReset=!0}})),o.displayState=void 0}return r.prototype.getCueAsHTML=function(){return self.WebVTT.convertCueToDOMTree(self,this.text)},r}();class ua{decode(e,t){if(!e)return"";if("string"!=typeof e)throw new Error("Error - expected string data.");return decodeURIComponent(encodeURIComponent(e))}}function fa(e){function t(e,t,s,i){return 3600*(0|e)+60*(0|t)+(0|s)+parseFloat(i||0)}const s=e.match(/^(?:(\d+):)?(\d{2}):(\d{2})(\.\d+)?/);return s?parseFloat(s[2])>59?t(s[2],s[3],0,s[4]):t(s[1],s[2],s[3],s[4]):null}class ga{constructor(){this.values=Object.create(null)}set(e,t){this.get(e)||""===t||(this.values[e]=t)}get(e,t,s){return s?this.has(e)?this.values[e]:t[s]:this.has(e)?this.values[e]:t}has(e){return e in this.values}alt(e,t,s){for(let i=0;i<s.length;++i)if(t===s[i]){this.set(e,t);break}}integer(e,t){/^-?\d+$/.test(t)&&this.set(e,parseInt(t,10))}percent(e,t){if(/^([\d]{1,3})(\.[\d]*)?%$/.test(t)){const s=parseFloat(t);if(s>=0&&s<=100)return this.set(e,s),!0}return!1}}function ma(e,t,s,i){const n=i?e.split(i):[e];for(const e in n){if("string"!=typeof n[e])continue;const i=n[e].split(s);2===i.length&&t(i[0],i[1])}}const pa=new ha(0,0,""),ya="middle"===pa.align?"middle":"center";function va(e,t,s){const i=e;function n(){const t=fa(e);if(null===t)throw new Error("Malformed timestamp: "+i);return e=e.replace(/^[^\sa-zA-Z-]+/,""),t}function r(){e=e.replace(/^\s+/,"")}if(r(),t.startTime=n(),r(),"--\x3e"!==e.slice(0,3))throw new Error("Malformed time stamp (time stamps must be separated by '--\x3e'): "+i);e=e.slice(3),r(),t.endTime=n(),r(),function(e,t){const i=new ga;ma(e,function(e,t){let n;switch(e){case"region":for(let n=s.length-1;n>=0;n--)if(s[n].id===t){i.set(e,s[n].region);break}break;case"vertical":i.alt(e,t,["rl","lr"]);break;case"line":n=t.split(","),i.integer(e,n[0]),i.percent(e,n[0])&&i.set("snapToLines",!1),i.alt(e,n[0],["auto"]),2===n.length&&i.alt("lineAlign",n[1],["start",ya,"end"]);break;case"position":n=t.split(","),i.percent(e,n[0]),2===n.length&&i.alt("positionAlign",n[1],["start",ya,"end","line-left","line-right","auto"]);break;case"size":i.percent(e,t);break;case"align":i.alt(e,t,["start",ya,"end","left","right"])}},/:/,/\s/),t.region=i.get("region",null),t.vertical=i.get("vertical","");let n=i.get("line","auto");"auto"===n&&-1===pa.line&&(n=-1),t.line=n,t.lineAlign=i.get("lineAlign","start"),t.snapToLines=i.get("snapToLines",!0),t.size=i.get("size",100),t.align=i.get("align",ya);let r=i.get("position","auto");"auto"===r&&50===pa.position&&(r="start"===t.align||"left"===t.align?0:"end"===t.align||"right"===t.align?100:50),t.position=r}(e,t)}function Ea(e){return e.replace(/<br(?: \/)?>/gi,"\n")}class Ta{constructor(){this.state="INITIAL",this.buffer="",this.decoder=new ua,this.regionList=[],this.cue=null,this.oncue=void 0,this.onparsingerror=void 0,this.onflush=void 0}parse(e){const t=this;function s(){let e=t.buffer,s=0;for(e=Ea(e);s<e.length&&"\r"!==e[s]&&"\n"!==e[s];)++s;const i=e.slice(0,s);return"\r"===e[s]&&++s,"\n"===e[s]&&++s,t.buffer=e.slice(s),i}function i(e){ma(e,function(e,t){},/:/)}e&&(t.buffer+=t.decoder.decode(e,{stream:!0}));try{let e="";if("INITIAL"===t.state){if(!/\r\n|\n/.test(t.buffer))return this;e=s();const i=e.match(/^(Ã¯Â»Â¿)?WEBVTT([ \t].*)?$/);if(null==i||!i[0])throw new Error("Malformed WebVTT signature.");t.state="HEADER"}let n=!1;for(;t.buffer;){if(!/\r\n|\n/.test(t.buffer))return this;switch(n?n=!1:e=s(),t.state){case"HEADER":/:/.test(e)?i(e):e||(t.state="ID");continue;case"NOTE":e||(t.state="ID");continue;case"ID":if(/^NOTE($|[ \t])/.test(e)){t.state="NOTE";break}if(!e)continue;if(t.cue=new ha(0,0,""),t.state="CUE",-1===e.indexOf("--\x3e")){t.cue.id=e;continue}case"CUE":if(!t.cue){t.state="BADCUE";continue}try{va(e,t.cue,t.regionList)}catch(e){t.cue=null,t.state="BADCUE";continue}t.state="CUETEXT";continue;case"CUETEXT":{const s=-1!==e.indexOf("--\x3e");if(!e||s&&(n=!0)){t.oncue&&t.cue&&t.oncue(t.cue),t.cue=null,t.state="ID";continue}if(null===t.cue)continue;t.cue.text&&(t.cue.text+="\n"),t.cue.text+=e}continue;case"BADCUE":e||(t.state="ID")}}}catch(e){"CUETEXT"===t.state&&t.cue&&t.oncue&&t.oncue(t.cue),t.cue=null,t.state="INITIAL"===t.state?"BADWEBVTT":"BADCUE"}return this}flush(){const e=this;try{if((e.cue||"HEADER"===e.state)&&(e.buffer+="\n\n",e.parse()),"INITIAL"===e.state||"BADWEBVTT"===e.state)throw new Error("Malformed WebVTT signature.")}catch(t){e.onparsingerror&&e.onparsingerror(t)}return e.onflush&&e.onflush(),this}}const Sa=/\r\n|\n\r|\n|\r/g,ba=function(e,t,s=0){return e.slice(s,s+t.length)===t};function Aa(e,t,s){return Dr(e.toString())+Dr(t.toString())+Dr(s)}const La="stpp.ttml.im1t",wa=/^(\d{2,}):(\d{2}):(\d{2}):(\d{2})\.?(\d+)?$/,Ra=/^(\d*(?:\.\d*)?)(h|m|s|ms|f|t)$/,Ia={left:"start",center:"center",right:"end",start:"start",end:"end"};function xa(e,t,s,i){const n=ne(new Uint8Array(e),["mdat"]);if(0===n.length)return void i(new Error("Could not parse IMSC1 mdat"));const r=n.map(e=>k(e)),a=function(e,t,s=1,i=!1){return cn(e,t,1/s,i)}(t.baseTime,1,t.timescale);try{r.forEach(e=>s(function(e,t){const s=(new DOMParser).parseFromString(e,"text/xml").getElementsByTagName("tt")[0];if(!s)throw new Error("Invalid ttml");const i={frameRate:30,subFrameRate:1,frameRateMultiplier:0,tickRate:0},n=Object.keys(i).reduce((e,t)=>(e[t]=s.getAttribute(`ttp:${t}`)||i[t],e),{}),r="preserve"!==s.getAttribute("xml:space"),a=Da(ka(s,"styling","style")),o=Da(ka(s,"layout","region")),l=ka(s,"body","[begin]");return[].map.call(l,e=>{const s=_a(e,r);if(!s||!e.hasAttribute("begin"))return null;const i=Ma(e.getAttribute("begin"),n),l=Ma(e.getAttribute("dur"),n);let d=Ma(e.getAttribute("end"),n);if(null===i)throw Pa(e);if(null===d){if(null===l)throw Pa(e);d=i+l}const c=new ha(i-t,d-t,s);c.id=Aa(c.startTime,c.endTime,c.text);const h=function(e,t,s){const i="http://www.w3.org/ns/ttml#styling";let n=null;const r=null!=e&&e.hasAttribute("style")?e.getAttribute("style"):null;return r&&s.hasOwnProperty(r)&&(n=s[r]),["displayAlign","textAlign","color","backgroundColor","fontSize","fontFamily"].reduce((s,r)=>{const a=Ca(t,i,r)||Ca(e,i,r)||Ca(n,i,r);return a&&(s[r]=a),s},{})}(o[e.getAttribute("region")],a[e.getAttribute("style")],a),{textAlign:u}=h;if(u){const e=Ia[u];e&&(c.lineAlign=e),c.align=u}return y(c,h),c}).filter(e=>null!==e)}(e,a)))}catch(e){i(e)}}function ka(e,t,s){const i=e.getElementsByTagName(t)[0];return i?[].slice.call(i.querySelectorAll(s)):[]}function Da(e){return e.reduce((e,t)=>{const s=t.getAttribute("xml:id");return s&&(e[s]=t),e},{})}function _a(e,t){return[].slice.call(e.childNodes).reduce((e,s,i)=>{var n;return"br"===s.nodeName&&i?e+"\n":null!=(n=s.childNodes)&&n.length?_a(s,t):t?e+s.textContent.trim().replace(/\s+/g," "):e+s.textContent},"")}function Ca(e,t,s){return e&&e.hasAttributeNS(t,s)?e.getAttributeNS(t,s):null}function Pa(e){return new Error(`Could not parse ttml timestamp ${e}`)}function Ma(e,t){if(!e)return null;let s=fa(e);return null===s&&(wa.test(e)?s=function(e,t){const s=wa.exec(e),i=(0|s[4])+(0|s[5])/t.subFrameRate;return 3600*(0|s[1])+60*(0|s[2])+(0|s[3])+i/t.frameRate}(e,t):Ra.test(e)&&(s=function(e,t){const s=Ra.exec(e),i=Number(s[1]);switch(s[2]){case"h":return 3600*i;case"m":return 60*i;case"ms":return 1e3*i;case"f":return i/t.frameRate;case"t":return i/t.tickRate}return i}(e,t))),s}class Oa{constructor(e,t){this.timelineController=void 0,this.cueRanges=[],this.trackName=void 0,this.startTime=null,this.endTime=null,this.screen=null,this.timelineController=e,this.trackName=t}dispatchCue(){null!==this.startTime&&(this.timelineController.addCues(this.trackName,this.startTime,this.endTime,this.screen,this.cueRanges),this.startTime=null)}newCue(e,t,s){(null===this.startTime||this.startTime>e)&&(this.startTime=e),this.endTime=t,this.screen=s,this.timelineController.createCaptionsTrack(this.trackName)}reset(){this.cueRanges=[],this.startTime=null}}class Fa{constructor(e){this.hls=void 0,this.media=null,this.config=void 0,this.enabled=!0,this.Cues=void 0,this.textTracks=[],this.tracks=[],this.initPTS=[],this.unparsedVttFrags=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.cea608Parser1=void 0,this.cea608Parser2=void 0,this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs={ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!0}},this.captionsProperties=void 0,this.hls=e,this.config=e.config,this.Cues=e.config.cueHandler,this.captionsProperties={textTrack1:{label:this.config.captionsTextTrack1Label,languageCode:this.config.captionsTextTrack1LanguageCode},textTrack2:{label:this.config.captionsTextTrack2Label,languageCode:this.config.captionsTextTrack2LanguageCode},textTrack3:{label:this.config.captionsTextTrack3Label,languageCode:this.config.captionsTextTrack3LanguageCode},textTrack4:{label:this.config.captionsTextTrack4Label,languageCode:this.config.captionsTextTrack4LanguageCode}},e.on(l.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(l.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(l.MANIFEST_LOADING,this.onManifestLoading,this),e.on(l.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(l.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.on(l.FRAG_LOADING,this.onFragLoading,this),e.on(l.FRAG_LOADED,this.onFragLoaded,this),e.on(l.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),e.on(l.FRAG_DECRYPTED,this.onFragDecrypted,this),e.on(l.INIT_PTS_FOUND,this.onInitPtsFound,this),e.on(l.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),e.on(l.BUFFER_FLUSHING,this.onBufferFlushing,this)}destroy(){const{hls:e}=this;e.off(l.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(l.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(l.MANIFEST_LOADING,this.onManifestLoading,this),e.off(l.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(l.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.off(l.FRAG_LOADING,this.onFragLoading,this),e.off(l.FRAG_LOADED,this.onFragLoaded,this),e.off(l.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),e.off(l.FRAG_DECRYPTED,this.onFragDecrypted,this),e.off(l.INIT_PTS_FOUND,this.onInitPtsFound,this),e.off(l.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),e.off(l.BUFFER_FLUSHING,this.onBufferFlushing,this),this.hls=this.config=this.media=null,this.cea608Parser1=this.cea608Parser2=void 0}initCea608Parsers(){const e=new Oa(this,"textTrack1"),t=new Oa(this,"textTrack2"),s=new Oa(this,"textTrack3"),i=new Oa(this,"textTrack4");this.cea608Parser1=new la(1,e,t),this.cea608Parser2=new la(3,s,i)}addCues(e,t,s,i,n){let r=!1;for(let e=n.length;e--;){const i=n[e],a=Ua(i[0],i[1],t,s);if(a>=0&&(i[0]=Math.min(i[0],t),i[1]=Math.max(i[1],s),r=!0,a/(s-t)>.5))return}if(r||n.push([t,s]),this.config.renderTextTracksNatively){const n=this.captionsTracks[e];this.Cues.newCue(n,t,s,i)}else{const n=this.Cues.newCue(null,t,s,i);this.hls.trigger(l.CUES_PARSED,{type:"captions",cues:n,track:e})}}onInitPtsFound(e,{frag:t,id:s,initPTS:i,timescale:n}){const{unparsedVttFrags:r}=this;s===f.MAIN&&(this.initPTS[t.cc]={baseTime:i,timescale:n}),r.length&&(this.unparsedVttFrags=[],r.forEach(e=>{this.initPTS[e.frag.cc]?this.onFragLoaded(l.FRAG_LOADED,e):this.hls.trigger(l.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:e.frag,error:new Error("Subtitle discontinuity domain does not match main")})}))}getExistingTrack(e,t){const{media:s}=this;if(s)for(let i=0;i<s.textTracks.length;i++){const n=s.textTracks[i];if(Ba(n,{name:e,lang:t,characteristics:"transcribes-spoken-dialog,describes-music-and-sound"}))return n}return null}createCaptionsTrack(e){this.config.renderTextTracksNatively?this.createNativeTrack(e):this.createNonNativeTrack(e)}createNativeTrack(e){if(this.captionsTracks[e])return;const{captionsProperties:t,captionsTracks:s,media:i}=this,{label:n,languageCode:r}=t[e],a=this.getExistingTrack(n,r);if(a)s[e]=a,Rr(s[e]),Lr(s[e],i);else{const t=this.createTextTrack("captions",n,r);t&&(t[e]=!0,s[e]=t)}}createNonNativeTrack(e){if(this.nonNativeCaptionsTracks[e])return;const t=this.captionsProperties[e];if(!t)return;const s={_id:e,label:t.label,kind:"captions",default:!!t.media&&!!t.media.default,closedCaptions:t.media};this.nonNativeCaptionsTracks[e]=s,this.hls.trigger(l.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:[s]})}createTextTrack(e,t,s){const i=this.media;if(i)return i.addTextTrack(e,t,s)}onMediaAttaching(e,t){this.media=t.media,t.mediaSource||this._cleanTracks()}onMediaDetaching(e,t){const s=!!t.transferMedia;if(this.media=null,s)return;const{captionsTracks:i}=this;Object.keys(i).forEach(e=>{Rr(i[e]),delete i[e]}),this.nonNativeCaptionsTracks={}}onManifestLoading(){this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs={ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!0}},this._cleanTracks(),this.tracks=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.textTracks=[],this.unparsedVttFrags=[],this.initPTS=[],this.cea608Parser1&&this.cea608Parser2&&(this.cea608Parser1.reset(),this.cea608Parser2.reset())}_cleanTracks(){const{media:e}=this;if(!e)return;const t=e.textTracks;if(t)for(let e=0;e<t.length;e++)Rr(t[e])}onSubtitleTracksUpdated(e,t){const s=t.subtitleTracks||[],i=s.some(e=>e.textCodec===La);if(this.config.enableWebVTT||i&&this.config.enableIMSC1){if(Cn(this.tracks,s))return void(this.tracks=s);if(this.textTracks=[],this.tracks=s,this.config.renderTextTracksNatively){const e=this.media,t=e?xr(e.textTracks):null;if(this.tracks.forEach((e,s)=>{let i;if(t){let s=null;for(let i=0;i<t.length;i++)if(t[i]&&Ba(t[i],e)){s=t[i],t[i]=null;break}s&&(i=s)}if(i)Rr(i);else{const t=Na(e);i=this.createTextTrack(t,e.name,e.lang),i&&(i.mode="disabled")}i&&this.textTracks.push(i)}),null!=t&&t.length){const e=t.filter(e=>null!==e).map(e=>e.label);e.length&&this.hls.logger.warn(`Media element contains unused subtitle tracks: ${e.join(", ")}. Replace media element for each source to clear TextTracks and captions menu.`)}}else if(this.tracks.length){const e=this.tracks.map(e=>({label:e.name,kind:e.type.toLowerCase(),default:e.default,subtitleTrack:e}));this.hls.trigger(l.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:e})}}}onManifestLoaded(e,t){this.config.enableCEA708Captions&&t.captions&&t.captions.forEach(e=>{const t=/(?:CC|SERVICE)([1-4])/.exec(e.instreamId);if(!t)return;const s=`textTrack${t[1]}`,i=this.captionsProperties[s];i&&(i.label=e.name,e.lang&&(i.languageCode=e.lang),i.media=e)})}closedCaptionsForLevel(e){const t=this.hls.levels[e.level];return null==t?void 0:t.attrs["CLOSED-CAPTIONS"]}onFragLoading(e,t){if(this.enabled&&t.frag.type===f.MAIN){var s,i;const{cea608Parser1:e,cea608Parser2:n,lastSn:r}=this,{cc:a,sn:o}=t.frag,l=null!=(s=null==(i=t.part)?void 0:i.index)?s:-1;e&&n&&(o!==r+1||o===r&&l!==this.lastPartIndex+1||a!==this.lastCc)&&(e.reset(),n.reset()),this.lastCc=a,this.lastSn=o,this.lastPartIndex=l}}onFragLoaded(e,t){const{frag:s,payload:i}=t;if(s.type===f.SUBTITLE)if(i.byteLength){const e=s.decryptdata,n="stats"in t;if(null==e||!e.encrypted||n){const e=this.tracks[s.level],n=this.vttCCs;n[s.cc]||(n[s.cc]={start:s.start,prevCC:this.prevCC,new:!0},this.prevCC=s.cc),e&&e.textCodec===La?this._parseIMSC1(s,i):this._parseVTTs(t)}}else this.hls.trigger(l.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:s,error:new Error("Empty subtitle payload")})}_parseIMSC1(e,t){const s=this.hls;xa(t,this.initPTS[e.cc],t=>{this._appendCues(t,e.level),s.trigger(l.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:e})},t=>{s.logger.log(`Failed to parse IMSC1: ${t}`),s.trigger(l.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:e,error:t})})}_parseVTTs(e){var t;const{frag:s,payload:n}=e,{initPTS:r,unparsedVttFrags:a}=this,o=r.length-1;if(!r[s.cc]&&-1===o)return void a.push(e);const d=this.hls;!function(e,t,s,n,r,a,o){const l=new Ta,d=k(new Uint8Array(e)).trim().replace(Sa,"\n").split("\n"),c=[],h=t?function(e,t=1){return cn(e,9e4,1/t)}(t.baseTime,t.timescale):0;let u,f="00:00.000",g=0,m=0,p=!0;l.oncue=function(e){const i=s[n];let a=s.ccOffset;const o=(g-h)/9e4;if(null!=i&&i.new&&(void 0!==m?a=s.ccOffset=i.start:function(e,t,s){let i=e[t],n=e[i.prevCC];if(!n||!n.new&&i.new)return e.ccOffset=e.presentationOffset=i.start,void(i.new=!1);for(;null!=(r=n)&&r.new;){var r;e.ccOffset+=i.start-n.start,i.new=!1,i=n,n=e[i.prevCC]}e.presentationOffset=s}(s,n,o)),o){if(!t)return void(u=new Error("Missing initPTS for VTT MPEGTS"));a=o-s.presentationOffset}const l=e.endTime-e.startTime,d=yn(9e4*(e.startTime+a-m),9e4*r)/9e4;e.startTime=Math.max(d,0),e.endTime=Math.max(d+l,0);const f=e.text.trim();e.text=decodeURIComponent(encodeURIComponent(f)),e.id||(e.id=Aa(e.startTime,e.endTime,f)),e.endTime>0&&c.push(e)},l.onparsingerror=function(e){u=e},l.onflush=function(){u?o(u):a(c)},d.forEach(e=>{if(p){if(ba(e,"X-TIMESTAMP-MAP=")){p=!1,e.slice(16).split(",").forEach(e=>{ba(e,"LOCAL:")?f=e.slice(6):ba(e,"MPEGTS:")&&(g=parseInt(e.slice(7)))});try{m=function(e){let t=parseInt(e.slice(-3));const s=parseInt(e.slice(-6,-4)),n=parseInt(e.slice(-9,-7)),r=e.length>9?parseInt(e.substring(0,e.indexOf(":"))):0;if(!(i(t)&&i(s)&&i(n)&&i(r)))throw Error(`Malformed X-TIMESTAMP-MAP: Local:${e}`);return t+=1e3*s,t+=6e4*n,t+=36e5*r,t}(f)/1e3}catch(e){u=e}return}""===e&&(p=!1)}l.parse(e+"\n")}),l.flush()}(null!=(t=s.initSegment)&&t.data?ue(s.initSegment.data,new Uint8Array(n)).buffer:n,this.initPTS[s.cc],this.vttCCs,s.cc,s.start,e=>{this._appendCues(e,s.level),d.trigger(l.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:s})},t=>{const i="Missing initPTS for VTT MPEGTS"===t.message;i?a.push(e):this._fallbackToIMSC1(s,n),d.logger.log(`Failed to parse VTT cue: ${t}`),i&&o>s.cc||d.trigger(l.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:s,error:t})})}_fallbackToIMSC1(e,t){const s=this.tracks[e.level];s.textCodec||xa(t,this.initPTS[e.cc],()=>{s.textCodec=La,this._parseIMSC1(e,t)},()=>{s.textCodec="wvtt"})}_appendCues(e,t){const s=this.hls;if(this.config.renderTextTracksNatively){const s=this.textTracks[t];if(!s||"disabled"===s.mode)return;e.forEach(e=>wr(s,e))}else{const i=this.tracks[t];if(!i)return;const n=i.default?"default":"subtitles"+t;s.trigger(l.CUES_PARSED,{type:"subtitles",cues:e,track:n})}}onFragDecrypted(e,t){const{frag:s}=t;s.type===f.SUBTITLE&&this.onFragLoaded(l.FRAG_LOADED,t)}onSubtitleTracksCleared(){this.tracks=[],this.captionsTracks={}}onFragParsingUserdata(e,t){if(!this.enabled||!this.config.enableCEA708Captions)return;const{frag:s,samples:i}=t;if(s.type!==f.MAIN||"NONE"!==this.closedCaptionsForLevel(s))for(let e=0;e<i.length;e++){const t=i[e].bytes;if(t){this.cea608Parser1||this.initCea608Parsers();const s=this.extractCea608Data(t);this.cea608Parser1.addData(i[e].pts,s[0]),this.cea608Parser2.addData(i[e].pts,s[1])}}}onBufferFlushing(e,{startOffset:t,endOffset:s,endOffsetSubtitles:i,type:n}){const{media:r}=this;if(r&&!(r.currentTime<s)){if(!n||"video"===n){const{captionsTracks:e}=this;Object.keys(e).forEach(i=>Ir(e[i],t,s))}if(this.config.renderTextTracksNatively&&0===t&&void 0!==i){const{textTracks:e}=this;Object.keys(e).forEach(s=>Ir(e[s],t,i))}}}extractCea608Data(e){const t=[[],[]],s=31&e[0];let i=2;for(let n=0;n<s;n++){const s=e[i++],n=127&e[i++],r=127&e[i++];if((0!==n||0!==r)&&4&s){const e=3&s;0!==e&&1!==e||(t[e].push(n),t[e].push(r))}}return t}}function Na(e){return e.characteristics&&/transcribes-spoken-dialog/gi.test(e.characteristics)&&/describes-music-and-sound/gi.test(e.characteristics)?"captions":"subtitles"}function Ba(e,t){return!!e&&e.kind===Na(t)&&Mn(t,e)}function Ua(e,t,s,i){return Math.min(t,i)-Math.max(e,s)}const $a=/\s/,Ga={newCue(e,t,s,i){const n=[];let r,a,o,l,d;const c=self.VTTCue||self.TextTrackCue;for(let u=0;u<i.rows.length;u++)if(r=i.rows[u],o=!0,l=0,d="",!r.isEmpty()){var h;for(let e=0;e<r.chars.length;e++)$a.test(r.chars[e].uchar)&&o?l++:(d+=r.chars[e].uchar,o=!1);r.cueStartTime=t,t===s&&(s+=1e-4),l>=16?l--:l++;const i=Ea(d.trim()),f=Aa(t,s,i);null!=e&&null!=(h=e.cues)&&h.getCueById(f)||(a=new c(t,s,i),a.id=f,a.line=u+1,a.align="left",a.position=10+Math.min(80,10*Math.floor(8*l/32)),n.push(a))}return e&&n.length&&(n.sort((e,t)=>"auto"===e.line||"auto"===t.line?0:e.line>8&&t.line>8?t.line-e.line:e.line-t.line),n.forEach(t=>wr(e,t))),n}};function ja(){if(self.fetch&&self.AbortController&&self.ReadableStream&&self.Request)try{return new self.ReadableStream({}),!0}catch(e){}return!1}const Ha=/(\d+)-(\d+)\/(\d+)/;class Va{constructor(e){this.fetchSetup=void 0,this.requestTimeout=void 0,this.request=null,this.response=null,this.controller=void 0,this.context=null,this.config=null,this.callbacks=null,this.stats=void 0,this.loader=null,this.fetchSetup=e.fetchSetup||Ka,this.controller=new self.AbortController,this.stats=new G}destroy(){this.loader=this.callbacks=this.context=this.config=this.request=null,this.abortInternal(),this.response=null,this.fetchSetup=this.controller=this.stats=null}abortInternal(){this.controller&&!this.stats.loading.end&&(this.stats.aborted=!0,this.controller.abort())}abort(){var e;this.abortInternal(),null!=(e=this.callbacks)&&e.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.response)}load(e,t,s){const n=this.stats;if(n.loading.start)throw new Error("Loader can only be used once.");n.loading.start=self.performance.now();const r=function(e,t){const s={method:"GET",mode:"cors",credentials:"same-origin",signal:t,headers:new self.Headers(y({},e.headers))};return e.rangeEnd&&s.headers.set("Range","bytes="+e.rangeStart+"-"+String(e.rangeEnd-1)),s}(e,this.controller.signal),a="arraybuffer"===e.responseType,o=a?"byteLength":"length",{maxTimeToFirstByteMs:l,maxLoadTimeMs:d}=t.loadPolicy;this.context=e,this.config=t,this.callbacks=s,this.request=this.fetchSetup(e,r),self.clearTimeout(this.requestTimeout),t.timeout=l&&i(l)?l:d,this.requestTimeout=self.setTimeout(()=>{this.callbacks&&(this.abortInternal(),this.callbacks.onTimeout(n,e,this.response))},t.timeout),(wn(this.request)?this.request.then(self.fetch):self.fetch(this.request)).then(s=>{var r;this.response=this.loader=s;const o=Math.max(self.performance.now(),n.loading.start);if(self.clearTimeout(this.requestTimeout),t.timeout=d,this.requestTimeout=self.setTimeout(()=>{this.callbacks&&(this.abortInternal(),this.callbacks.onTimeout(n,e,this.response))},d-(o-n.loading.start)),!s.ok){const{status:e,statusText:t}=s;throw new qa(t||"fetch, bad network response",e,s)}n.loading.first=o,n.total=function(e){const t=e.get("Content-Range");if(t){const e=function(e){const t=Ha.exec(e);if(t)return parseInt(t[2])-parseInt(t[1])+1}(t);if(i(e))return e}const s=e.get("Content-Length");if(s)return parseInt(s)}(s.headers)||n.total;const l=null==(r=this.callbacks)?void 0:r.onProgress;return l&&i(t.highWaterMark)?this.loadProgressively(s,n,e,t.highWaterMark,l):a?s.arrayBuffer():"json"===e.responseType?s.json():s.text()}).then(s=>{var r,a;const l=this.response;if(!l)throw new Error("loader destroyed");self.clearTimeout(this.requestTimeout),n.loading.end=Math.max(self.performance.now(),n.loading.first);const d=s[o];d&&(n.loaded=n.total=d);const c={url:l.url,data:s,code:l.status},h=null==(r=this.callbacks)?void 0:r.onProgress;h&&!i(t.highWaterMark)&&h(n,e,s,l),null==(a=this.callbacks)||a.onSuccess(c,n,e,l)}).catch(t=>{var s;if(self.clearTimeout(this.requestTimeout),n.aborted)return;const i=t&&t.code||0,r=t?t.message:null;null==(s=this.callbacks)||s.onError({code:i,text:r},e,t?t.details:null,n)})}getCacheAge(){let e=null;if(this.response){const t=this.response.headers.get("age");e=t?parseFloat(t):null}return e}getResponseHeader(e){return this.response?this.response.headers.get(e):null}loadProgressively(e,t,s,i=0,n){const r=new si,a=e.body.getReader(),o=()=>a.read().then(a=>{if(a.done)return r.dataLength&&n(t,s,r.flush().buffer,e),Promise.resolve(new ArrayBuffer(0));const l=a.value,d=l.length;return t.loaded+=d,d<i||r.dataLength?(r.push(l),r.dataLength>=i&&n(t,s,r.flush().buffer,e)):n(t,s,l.buffer,e),o()}).catch(()=>Promise.reject());return o()}}function Ka(e,t){return new self.Request(e.url,t)}class qa extends Error{constructor(e,t,s){super(e),this.code=void 0,this.details=void 0,this.code=t,this.details=s}}const Ya=/^age:\s*[\d.]+\s*$/im;class Wa{constructor(e){this.xhrSetup=void 0,this.requestTimeout=void 0,this.retryTimeout=void 0,this.retryDelay=void 0,this.config=null,this.callbacks=null,this.context=null,this.loader=null,this.stats=void 0,this.xhrSetup=e&&e.xhrSetup||null,this.stats=new G,this.retryDelay=0}destroy(){this.callbacks=null,this.abortInternal(),this.loader=null,this.config=null,this.context=null,this.xhrSetup=null}abortInternal(){const e=this.loader;self.clearTimeout(this.requestTimeout),self.clearTimeout(this.retryTimeout),e&&(e.onreadystatechange=null,e.onprogress=null,4!==e.readyState&&(this.stats.aborted=!0,e.abort()))}abort(){var e;this.abortInternal(),null!=(e=this.callbacks)&&e.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.loader)}load(e,t,s){if(this.stats.loading.start)throw new Error("Loader can only be used once.");this.stats.loading.start=self.performance.now(),this.context=e,this.config=t,this.callbacks=s,this.loadInternal()}loadInternal(){const{config:e,context:t}=this;if(!e||!t)return;const s=this.loader=new self.XMLHttpRequest,i=this.stats;i.loading.first=0,i.loaded=0,i.aborted=!1;const n=this.xhrSetup;n?Promise.resolve().then(()=>{if(this.loader===s&&!this.stats.aborted)return n(s,t.url)}).catch(e=>{if(this.loader===s&&!this.stats.aborted)return s.open("GET",t.url,!0),n(s,t.url)}).then(()=>{this.loader!==s||this.stats.aborted||this.openAndSendXhr(s,t,e)}).catch(e=>{var n;null==(n=this.callbacks)||n.onError({code:s.status,text:e.message},t,s,i)}):this.openAndSendXhr(s,t,e)}openAndSendXhr(e,t,s){e.readyState||e.open("GET",t.url,!0);const n=t.headers,{maxTimeToFirstByteMs:r,maxLoadTimeMs:a}=s.loadPolicy;if(n)for(const t in n)e.setRequestHeader(t,n[t]);t.rangeEnd&&e.setRequestHeader("Range","bytes="+t.rangeStart+"-"+(t.rangeEnd-1)),e.onreadystatechange=this.readystatechange.bind(this),e.onprogress=this.loadprogress.bind(this),e.responseType=t.responseType,self.clearTimeout(this.requestTimeout),s.timeout=r&&i(r)?r:a,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),s.timeout),e.send()}readystatechange(){const{context:e,loader:t,stats:s}=this;if(!e||!t)return;const i=t.readyState,n=this.config;if(!s.aborted&&i>=2&&(0===s.loading.first&&(s.loading.first=Math.max(self.performance.now(),s.loading.start),n.timeout!==n.loadPolicy.maxLoadTimeMs&&(self.clearTimeout(this.requestTimeout),n.timeout=n.loadPolicy.maxLoadTimeMs,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),n.loadPolicy.maxLoadTimeMs-(s.loading.first-s.loading.start)))),4===i)){self.clearTimeout(this.requestTimeout),t.onreadystatechange=null,t.onprogress=null;const i=t.status,l="text"===t.responseType?t.responseText:null;if(i>=200&&i<300){const n=null!=l?l:t.response;if(null!=n){var r,a;s.loading.end=Math.max(self.performance.now(),s.loading.first);const o="arraybuffer"===t.responseType?n.byteLength:n.length;s.loaded=s.total=o,s.bwEstimate=8e3*s.total/(s.loading.end-s.loading.first);const l=null==(r=this.callbacks)?void 0:r.onProgress;l&&l(s,e,n,t);const d={url:t.responseURL,data:n,code:i};return void(null==(a=this.callbacks)||a.onSuccess(d,s,e,t))}}const d=n.loadPolicy.errorRetry;var o;ut(d,s.retry,!1,{url:e.url,data:void 0,code:i})?this.retry(d):(R.error(`${i} while loading ${e.url}`),null==(o=this.callbacks)||o.onError({code:i,text:t.statusText},e,t,s))}}loadtimeout(){if(!this.config)return;const e=this.config.loadPolicy.timeoutRetry;if(ut(e,this.stats.retry,!0))this.retry(e);else{var t;R.warn(`timeout while loading ${null==(t=this.context)?void 0:t.url}`);const e=this.callbacks;e&&(this.abortInternal(),e.onTimeout(this.stats,this.context,this.loader))}}retry(e){const{context:t,stats:s}=this;this.retryDelay=ct(e,s.retry),s.retry++,R.warn(`${status?"HTTP Status "+status:"Timeout"} while loading ${null==t?void 0:t.url}, retrying ${s.retry}/${e.maxNumRetry} in ${this.retryDelay}ms`),this.abortInternal(),this.loader=null,self.clearTimeout(this.retryTimeout),this.retryTimeout=self.setTimeout(this.loadInternal.bind(this),this.retryDelay)}loadprogress(e){const t=this.stats;t.loaded=e.loaded,e.lengthComputable&&(t.total=e.total)}getCacheAge(){let e=null;if(this.loader&&Ya.test(this.loader.getAllResponseHeaders())){const t=this.loader.getResponseHeader("age");e=t?parseFloat(t):null}return e}getResponseHeader(e){return this.loader&&new RegExp(`^${e}:\\s*[\\d.]+\\s*$`,"im").test(this.loader.getAllResponseHeaders())?this.loader.getResponseHeader(e):null}}const za=E(E({autoStartLoad:!0,startPosition:-1,defaultAudioCodec:void 0,debug:!1,capLevelOnFPSDrop:!1,capLevelToPlayerSize:!1,ignoreDevicePixelRatio:!1,maxDevicePixelRatio:Number.POSITIVE_INFINITY,preferManagedMediaSource:!0,initialLiveManifestSize:1,maxBufferLength:30,backBufferLength:1/0,frontBufferFlushThreshold:1/0,startOnSegmentBoundary:!1,maxBufferSize:6e7,maxFragLookUpTolerance:.25,maxBufferHole:.1,detectStallWithCurrentTimeMs:1250,highBufferWatchdogPeriod:2,nudgeOffset:.1,nudgeMaxRetry:3,nudgeOnVideoHole:!0,liveSyncMode:"edge",liveSyncDurationCount:3,liveSyncOnStallIncrease:1,liveMaxLatencyDurationCount:1/0,liveSyncDuration:void 0,liveMaxLatencyDuration:void 0,maxLiveSyncPlaybackRate:1,liveDurationInfinity:!1,liveBackBufferLength:null,maxMaxBufferLength:600,enableWorker:!0,workerPath:null,enableSoftwareAES:!0,startLevel:void 0,startFragPrefetch:!1,fpsDroppedMonitoringPeriod:5e3,fpsDroppedMonitoringThreshold:.2,appendErrorMaxRetry:3,ignorePlaylistParsingErrors:!1,loader:Wa,fLoader:void 0,pLoader:void 0,xhrSetup:void 0,licenseXhrSetup:void 0,licenseResponseCallback:void 0,abrController:st,bufferController:$n,capLevelController:Hn,errorController:mt,fpsController:Ar,stretchShortVideoTrack:!1,maxAudioFramesDrift:1,forceKeyFrameOnDiscontinuity:!0,abrEwmaFastLive:3,abrEwmaSlowLive:9,abrEwmaFastVoD:3,abrEwmaSlowVoD:9,abrEwmaDefaultEstimate:5e5,abrEwmaDefaultEstimateMax:5e6,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,abrMaxWithRealBitrate:!1,maxStarvationDelay:4,maxLoadingDelay:4,minAutoBitrate:0,emeEnabled:!1,widevineLicenseUrl:void 0,drmSystems:{},drmSystemOptions:{},requestMediaKeySystemAccessFunc:as,requireKeySystemAccessOnStart:!1,testBandwidth:!0,progressive:!1,lowLatencyMode:!0,cmcd:void 0,enableDateRangeMetadataCues:!0,enableEmsgMetadataCues:!0,enableEmsgKLVMetadata:!1,enableID3MetadataCues:!0,enableInterstitialPlayback:!0,interstitialAppendInPlace:!0,interstitialLiveLookAhead:10,useMediaCapabilities:!0,preserveManualLevelOnError:!1,certLoadPolicy:{default:{maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:null,errorRetry:null}},keyLoadPolicy:{default:{maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"},errorRetry:{maxNumRetry:8,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"}}},manifestLoadPolicy:{default:{maxTimeToFirstByteMs:1/0,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},playlistLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:2,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},fragLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:12e4,timeoutRetry:{maxNumRetry:4,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:6,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},steeringManifestLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},interstitialAssetListLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:3e4,timeoutRetry:{maxNumRetry:0,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:0,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,manifestLoadingRetryDelay:1e3,manifestLoadingMaxRetryTimeout:64e3,levelLoadingTimeOut:1e4,levelLoadingMaxRetry:4,levelLoadingRetryDelay:1e3,levelLoadingMaxRetryTimeout:64e3,fragLoadingTimeOut:2e4,fragLoadingMaxRetry:6,fragLoadingRetryDelay:1e3,fragLoadingMaxRetryTimeout:64e3},{cueHandler:Ga,enableWebVTT:!0,enableIMSC1:!0,enableCEA708Captions:!0,captionsTextTrack1Label:"English",captionsTextTrack1LanguageCode:"en",captionsTextTrack2Label:"Spanish",captionsTextTrack2LanguageCode:"es",captionsTextTrack3Label:"Unknown CC",captionsTextTrack3LanguageCode:"",captionsTextTrack4Label:"Unknown CC",captionsTextTrack4LanguageCode:"",renderTextTracksNatively:!0}),{},{subtitleStreamController:Vr,subtitleTrackController:kr,timelineController:Fa,audioStreamController:Dn,audioTrackController:On,emeController:Sr,cmcdController:mr,contentSteeringController:pr,interstitialsController:class extends T{constructor(e,t){super("interstitials",e.logger),this.HlsPlayerClass=void 0,this.hls=void 0,this.assetListLoader=void 0,this.mediaSelection=null,this.altSelection=null,this.media=null,this.detachedData=null,this.requiredTracks=null,this.manager=null,this.playerQueue=[],this.bufferedPos=-1,this.timelinePos=-1,this.schedule=void 0,this.playingItem=null,this.bufferingItem=null,this.waitingItem=null,this.endedItem=null,this.playingAsset=null,this.endedAsset=null,this.bufferingAsset=null,this.shouldPlay=!1,this.onPlay=()=>{this.shouldPlay=!0},this.onPause=()=>{this.shouldPlay=!1},this.onSeeking=()=>{const e=this.currentTime;if(void 0===e||this.playbackDisabled)return;const t=e-this.timelinePos;if(Math.abs(t)<1/7056e5)return;const s=t<=-.01;this.timelinePos=e,this.bufferedPos=e;const i=this.playingItem;if(!i)return void this.checkBuffer();if(s&&this.schedule.resetErrorsInRange(e,e-t)&&this.updateSchedule(),this.checkBuffer(),s&&e<i.start||e>=i.end){var n;const e=this.schedule.findItemIndexAtTime(this.timelinePos);if(!this.isInterstitial(i)&&null!=(n=this.media)&&n.paused&&(this.shouldPlay=!1),!s){const t=this.findItemIndex(i);if(e>t){const s=this.schedule.findJumpRestrictedIndex(t+1,e);if(s>t)return void this.setSchedulePosition(s)}}return void this.setSchedulePosition(e)}const r=this.playingAsset;if(!r){if(this.playingLastItem&&this.isInterstitial(i)){const t=i.event.assetList[0];t&&(this.endedItem=this.playingItem,this.playingItem=null,this.setScheduleToAssetAtTime(e,t))}return}const a=r.timelineStart,o=r.duration||0;(s&&e<a||e>=a+o)&&this.setScheduleToAssetAtTime(e,r)},this.onTimeupdate=()=>{const e=this.currentTime;if(void 0===e||this.playbackDisabled)return;if(!(e>this.timelinePos))return;this.timelinePos=e,e>this.bufferedPos&&this.checkBuffer();const t=this.playingItem;if(!t||this.playingLastItem)return;if(e>=t.end){this.timelinePos=t.end;const e=this.findItemIndex(t);this.setSchedulePosition(e+1)}const s=this.playingAsset;s&&e>=s.timelineStart+(s.duration||0)&&this.setScheduleToAssetAtTime(e,s)},this.onScheduleUpdate=(e,t)=>{const s=this.schedule,i=this.playingItem,n=s.events||[],r=s.items||[],a=s.durations,o=e.map(e=>e.identifier),d=!(!n.length&&!o.length);(d||t)&&this.log(`INTERSTITIALS_UPDATED (${n.length}): ${n}\nSchedule: ${r.map(e=>Gr(e))} pos: ${this.timelinePos}`),o.length&&this.log(`Removed events ${o}`),this.playerQueue.forEach(e=>{if(e.interstitial.appendInPlace){const t=e.assetItem.timelineStart,s=e.timelineOffset-t;if(s)try{e.timelineOffset=t}catch(i){Math.abs(s)>_r&&this.warn(`${i} ("${e.assetId}" ${e.timelineOffset}->${t})`)}}});let c=null;if(i){const e=this.updateItem(i,this.timelinePos);this.itemsMatch(i,e)&&(this.playingItem=e,this.waitingItem=this.endedItem=null,c=()=>this.trimInPlace(e,i))}else this.waitingItem=this.updateItem(this.waitingItem),this.endedItem=this.updateItem(this.endedItem);const h=this.bufferingItem;if(h){const e=this.updateItem(h,this.bufferedPos);this.itemsMatch(h,e)?(this.bufferingItem=e,c||(c=()=>this.trimInPlace(e,h))):h.event&&(this.bufferingItem=this.playingItem,this.clearInterstitial(h.event,null))}if(e.forEach(e=>{e.assetList.forEach(e=>{this.clearAssetPlayer(e.identifier,null)})}),d||t){if(this.hls.trigger(l.INTERSTITIALS_UPDATED,{events:n.slice(0),schedule:r.slice(0),durations:a,removedIds:o}),this.isInterstitial(i)&&o.includes(i.event.identifier))return this.warn(`Interstitial "${i.event.identifier}" removed while playing`),void this.primaryFallback(i.event);c&&c(),this.checkBuffer()}},this.hls=e,this.HlsPlayerClass=t,this.assetListLoader=new jr(e),this.schedule=new $r(this.onScheduleUpdate,e.logger),this.registerListeners()}registerListeners(){const e=this.hls;e.on(l.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(l.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(l.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(l.MANIFEST_LOADING,this.onManifestLoading,this),e.on(l.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(l.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(l.AUDIO_TRACK_UPDATED,this.onAudioTrackUpdated,this),e.on(l.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.on(l.SUBTITLE_TRACK_UPDATED,this.onSubtitleTrackUpdated,this),e.on(l.EVENT_CUE_ENTER,this.onInterstitialCueEnter,this),e.on(l.ASSET_LIST_LOADED,this.onAssetListLoaded,this),e.on(l.BUFFER_APPENDED,this.onBufferAppended,this),e.on(l.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(l.BUFFERED_TO_END,this.onBufferedToEnd,this),e.on(l.MEDIA_ENDED,this.onMediaEnded,this),e.on(l.ERROR,this.onError,this),e.on(l.DESTROYING,this.onDestroying,this)}unregisterListeners(){const e=this.hls;e&&(e.off(l.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(l.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(l.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(l.MANIFEST_LOADING,this.onManifestLoading,this),e.off(l.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(l.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(l.AUDIO_TRACK_UPDATED,this.onAudioTrackUpdated,this),e.off(l.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.off(l.SUBTITLE_TRACK_UPDATED,this.onSubtitleTrackUpdated,this),e.off(l.EVENT_CUE_ENTER,this.onInterstitialCueEnter,this),e.off(l.ASSET_LIST_LOADED,this.onAssetListLoaded,this),e.off(l.BUFFER_CODECS,this.onBufferCodecs,this),e.off(l.BUFFER_APPENDED,this.onBufferAppended,this),e.off(l.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(l.BUFFERED_TO_END,this.onBufferedToEnd,this),e.off(l.MEDIA_ENDED,this.onMediaEnded,this),e.off(l.ERROR,this.onError,this),e.off(l.DESTROYING,this.onDestroying,this))}startLoad(){this.resumeBuffering()}stopLoad(){this.pauseBuffering()}resumeBuffering(){var e;null==(e=this.getBufferingPlayer())||e.resumeBuffering()}pauseBuffering(){var e;null==(e=this.getBufferingPlayer())||e.pauseBuffering()}destroy(){this.unregisterListeners(),this.stopLoad(),this.assetListLoader&&this.assetListLoader.destroy(),this.emptyPlayerQueue(),this.clearScheduleState(),this.schedule&&this.schedule.destroy(),this.media=this.detachedData=this.mediaSelection=this.requiredTracks=this.altSelection=this.manager=null,this.hls=this.HlsPlayerClass=this.schedule=this.log=null,this.assetListLoader=null,this.onPlay=this.onPause=this.onSeeking=this.onTimeupdate=null,this.onScheduleUpdate=null}onDestroying(){const e=this.primaryMedia||this.media;e&&this.removeMediaListeners(e)}removeMediaListeners(e){Tr(e,"play",this.onPlay),Tr(e,"pause",this.onPause),Tr(e,"seeking",this.onSeeking),Tr(e,"timeupdate",this.onTimeupdate)}onMediaAttaching(e,t){const s=this.media=t.media;Er(s,"seeking",this.onSeeking),Er(s,"timeupdate",this.onTimeupdate),Er(s,"play",this.onPlay),Er(s,"pause",this.onPause)}onMediaAttached(e,t){const s=this.effectivePlayingItem,i=this.detachedData;if(this.detachedData=null,null===s)this.checkStart();else if(!i){this.clearScheduleState();const e=this.findItemIndex(s);this.setSchedulePosition(e)}}clearScheduleState(){this.playingItem=this.bufferingItem=this.waitingItem=this.endedItem=this.playingAsset=this.endedAsset=this.bufferingAsset=null}onMediaDetaching(e,t){const s=!!t.transferMedia,i=this.media;if(this.media=null,!s&&(i&&this.removeMediaListeners(i),this.detachedData)){const e=this.getBufferingPlayer();e&&(this.playingAsset=this.endedAsset=this.bufferingAsset=this.bufferingItem=this.waitingItem=this.detachedData=null,e.detachMedia()),this.shouldPlay=!1}}get interstitialsManager(){if(!this.manager){if(!this.hls)return null;const e=this,t=()=>e.bufferingItem||e.waitingItem,s=t=>t?e.getAssetPlayer(t.identifier):t,i=(t,i,n,a,o)=>{if(t){let l=t[i].start;const d=t.event;if(d){if("playout"===i||d.timelineOccupancy!==Cr.Point){const e=s(n);(null==e?void 0:e.interstitial)===d&&(l+=e.assetItem.startOffset+e[o])}}else l+=("bufferedPos"===a?r():e[a])-t.start;return l}return 0},n=(t,s)=>{if(0!==t&&"primary"!==s&&e.schedule.length){var i;const n=e.schedule.findItemIndexAtTime(t),r=null==(i=e.schedule.items)?void 0:i[n];if(r)return t+(r[s].start-r.start)}return t},r=()=>{const t=e.bufferedPos;return t===Number.MAX_VALUE?a("primary"):Math.max(t,0)},a=t=>{var s;return null!=(s=e.primaryDetails)&&s.live?e.primaryDetails.edge:e.schedule.durations[t]},o=(t,n)=>{var r,a;const o=e.effectivePlayingItem;if(null!=o&&null!=(r=o.event)&&r.restrictions.skip)return;e.log(`seek to ${t} "${n}"`);const l=e.effectivePlayingItem,d=e.schedule.findItemIndexAtTime(t,n),c=null==(a=e.schedule.items)?void 0:a[d],h=e.getBufferingPlayer(),u=null==h?void 0:h.interstitial,f=null==u?void 0:u.appendInPlace,g=l&&e.itemsMatch(l,c);if(l&&(f||g)){const r=s(e.playingAsset),a=(null==r?void 0:r.media)||e.primaryMedia;if(a){const s="primary"===n?a.currentTime:i(l,n,e.playingAsset,"timelinePos","currentTime"),o=t-s,d=(f?s:a.currentTime)+o;if(d>=0&&(!r||f||d<=r.duration))return void(a.currentTime=d)}}if(c){let s=t;if("primary"!==n){const e=t-c[n].start;s=c.start+e}const i=!e.isInterstitial(c);if(e.isInterstitial(l)&&!l.event.appendInPlace||!i&&!c.event.appendInPlace){if(l){const r=e.findItemIndex(l);if(d>r){const t=e.schedule.findJumpRestrictedIndex(r+1,d);if(t>r)return void e.setSchedulePosition(t)}let a=0;if(i)e.timelinePos=s,e.checkBuffer();else{var m;const e=null==c||null==(m=c.event)?void 0:m.assetList;if(e){const s=t-(c[n]||c).start;for(let t=e.length;t--;){const i=e[t];if(i.duration&&s>=i.startOffset&&s<i.startOffset+i.duration){a=t;break}}}}e.setSchedulePosition(d,a)}}else{const t=e.media||(f?null==h?void 0:h.media:null);t&&(t.currentTime=s)}}},l=()=>{const s=e.effectivePlayingItem;if(e.isInterstitial(s))return s;const i=t();return e.isInterstitial(i)?i:null},d={get currentTime(){const t=l(),s=e.effectivePlayingItem;return s&&s===t?i(s,"playout",e.effectivePlayingAsset,"timelinePos","currentTime")-s.playout.start:0},set currentTime(t){const s=l(),i=e.effectivePlayingItem;i&&i===s&&o(t+i.playout.start,"playout")},get duration(){const e=l();return e?e.playout.end-e.playout.start:0},get assetPlayers(){var t;const s=null==(t=l())?void 0:t.event.assetList;return s?s.map(t=>e.getAssetPlayer(t.identifier)):[]},get playingIndex(){var t;const s=null==(t=l())?void 0:t.event;return s&&e.effectivePlayingAsset?s.findAssetIndex(e.effectivePlayingAsset):-1},get scheduleItem(){return l()}};this.manager={get events(){var t,s;return(null==(t=e.schedule)||null==(s=t.events)?void 0:s.slice(0))||[]},get schedule(){var t,s;return(null==(t=e.schedule)||null==(s=t.items)?void 0:s.slice(0))||[]},get interstitialPlayer(){return l()?d:null},get playerQueue(){return e.playerQueue.slice(0)},get bufferingAsset(){return e.bufferingAsset},get bufferingItem(){return t()},get bufferingIndex(){const s=t();return e.findItemIndex(s)},get playingAsset(){return e.effectivePlayingAsset},get playingItem(){return e.effectivePlayingItem},get playingIndex(){const t=e.effectivePlayingItem;return e.findItemIndex(t)},primary:{get bufferedEnd(){return r()},get currentTime(){const t=e.timelinePos;return t>0?t:0},set currentTime(e){o(e,"primary")},get duration(){return a("primary")},get seekableStart(){var t;return(null==(t=e.primaryDetails)?void 0:t.fragmentStart)||0}},integrated:{get bufferedEnd(){return i(t(),"integrated",e.bufferingAsset,"bufferedPos","bufferedEnd")},get currentTime(){return i(e.effectivePlayingItem,"integrated",e.effectivePlayingAsset,"timelinePos","currentTime")},set currentTime(e){o(e,"integrated")},get duration(){return a("integrated")},get seekableStart(){var t;return n((null==(t=e.primaryDetails)?void 0:t.fragmentStart)||0,"integrated")}},skip:()=>{const t=e.effectivePlayingItem,s=null==t?void 0:t.event;if(s&&!s.restrictions.skip){const i=e.findItemIndex(t);if(s.appendInPlace){const e=t.playout.start+t.event.duration;o(e+.001,"playout")}else e.advanceAfterAssetEnded(s,i,1/0)}}}}return this.manager}get effectivePlayingItem(){return this.waitingItem||this.playingItem||this.endedItem}get effectivePlayingAsset(){return this.playingAsset||this.endedAsset}get playingLastItem(){var e;const t=this.playingItem,s=null==(e=this.schedule)?void 0:e.items;return!!(this.playbackStarted&&t&&s)&&this.findItemIndex(t)===s.length-1}get playbackStarted(){return null!==this.effectivePlayingItem}get currentTime(){var e,t,s;if(null===this.mediaSelection)return;const n=this.waitingItem||this.playingItem;if(this.isInterstitial(n)&&!n.event.appendInPlace)return;let r=this.media;!r&&null!=(e=this.bufferingItem)&&null!=(t=e.event)&&t.appendInPlace&&(r=this.primaryMedia);const a=null==(s=r)?void 0:s.currentTime;return void 0!==a&&i(a)?a:void 0}get primaryMedia(){var e;return this.media||(null==(e=this.detachedData)?void 0:e.media)||null}isInterstitial(e){return!(null==e||!e.event)}retreiveMediaSource(e,t){const s=this.getAssetPlayer(e);s&&this.transferMediaFromPlayer(s,t)}transferMediaFromPlayer(e,t){const s=e.interstitial.appendInPlace,i=e.media;if(s&&i===this.primaryMedia){if(this.bufferingAsset=null,(!t||this.isInterstitial(t)&&!t.event.appendInPlace)&&t&&i)return void(this.detachedData={media:i});const s=e.transferMedia();this.log(`transfer MediaSource from ${e} ${Ye(s)}`),this.detachedData=s}else t&&i&&(this.shouldPlay||(this.shouldPlay=!i.paused))}transferMediaTo(e,t){var s,i;if(e.media===t)return;let n=null;const r=this.hls,a=e!==r,o=a&&e.interstitial.appendInPlace,l=null==(s=this.detachedData)?void 0:s.mediaSource;let d;if(r.media)o&&(n=r.transferMedia(),this.detachedData=n),d="Primary";else if(l){const e=this.getBufferingPlayer();e?(n=e.transferMedia(),d=`${e}`):d="detached MediaSource"}else d="detached media";if(!n)if(l)n=this.detachedData,this.log(`using detachedData: MediaSource ${Ye(n)}`);else if(!this.detachedData||r.media===t){const e=this.playerQueue;e.length>1&&e.forEach(e=>{if(a&&e.interstitial.appendInPlace!==o){const t=e.interstitial;this.clearInterstitial(e.interstitial,null),t.appendInPlace=!1,t.appendInPlace&&this.warn(`Could not change append strategy for queued assets ${t}`)}}),this.hls.detachMedia(),this.detachedData={media:t}}const c=n&&"mediaSource"in n&&"closed"!==(null==(i=n.mediaSource)?void 0:i.readyState),h=c&&n?n:t;if(this.log(`${c?"transfering MediaSource":"attaching media"} to ${a?e:"Primary"} from ${d}`),h===n){const t=a&&e.assetId===this.schedule.assetIdAtEnd;h.overrides={duration:this.schedule.duration,endOfStream:!a||t,cueRemoval:!a}}e.attachMedia(h)}onInterstitialCueEnter(){this.onTimeupdate()}checkStart(){const e=this.schedule,t=e.events;if(!t||this.playbackDisabled||!this.media)return;-1===this.bufferedPos&&(this.bufferedPos=0);const s=this.timelinePos,i=this.effectivePlayingItem;if(-1===s){const s=this.hls.startPosition;if(this.timelinePos=s,t.length&&t[0].cue.pre){const s=e.findEventIndex(t[0].identifier);this.setSchedulePosition(s)}else if(s>=0||!this.primaryLive){const t=this.timelinePos=s>0?s:0,i=e.findItemIndexAtTime(t);this.setSchedulePosition(i)}}else if(i&&!this.playingItem){const t=e.findItemIndex(i);this.setSchedulePosition(t)}}advanceAfterAssetEnded(e,t,s){const i=Nr(e,s);if(e.isAssetPastPlayoutLimit(i)){const s=this.schedule.items;if(s){const i=t+1;if(i>=s.length)return void this.setSchedulePosition(-1);const n=e.resumeTime;this.timelinePos<n&&(this.timelinePos=n,this.checkBuffer()),this.setSchedulePosition(i)}}else this.setSchedulePosition(t,i)}setScheduleToAssetAtTime(e,t){const s=this.schedule,i=t.parentIdentifier,n=s.getEvent(i);if(n){const t=s.findEventIndex(i),r=s.findAssetIndex(n,e);this.advanceAfterAssetEnded(n,t,r-1)}}setSchedulePosition(e,t){const s=this.schedule.items;if(!s||this.playbackDisabled)return;this.log(`setSchedulePosition ${e}, ${t}`);const i=e>=0?s[e]:null,n=this.playingItem,r=this.playingLastItem;if(this.isInterstitial(n)){var a;const d=n.event,c=this.playingAsset,h=null==c?void 0:c.identifier,u=h?this.getAssetPlayer(h):null;if(u&&h&&(!this.eventItemsMatch(n,i)||void 0!==t&&h!==(null==(a=d.assetList)?void 0:a[t].identifier))){var o;const t=d.findAssetIndex(c);if(this.log(`INTERSTITIAL_ASSET_ENDED ${t+1}/${d.assetList.length} ${Br(c)}`),this.endedAsset=c,this.playingAsset=null,this.hls.trigger(l.INTERSTITIAL_ASSET_ENDED,{asset:c,assetListIndex:t,event:d,schedule:s.slice(0),scheduleIndex:e,player:u}),n!==this.playingItem)return void(this.itemsMatch(n,this.playingItem)&&!this.playingAsset&&this.advanceAfterAssetEnded(d,this.findItemIndex(this.playingItem),t));this.retreiveMediaSource(h,i),!u.media||null!=(o=this.detachedData)&&o.mediaSource||u.detachMedia()}if(!this.eventItemsMatch(n,i)&&(this.endedItem=n,this.playingItem=null,this.log(`INTERSTITIAL_ENDED ${d} ${Gr(n)}`),d.hasPlayed=!0,this.hls.trigger(l.INTERSTITIAL_ENDED,{event:d,schedule:s.slice(0),scheduleIndex:e}),d.cue.once)){this.updateSchedule();const e=this.schedule.items;if(i&&e){const s=this.findItemIndex(i);this.advanceSchedule(s,e,t,n,r)}return}}this.advanceSchedule(e,s,t,n,r)}advanceSchedule(e,t,s,i,n){const r=e>=0?t[e]:null,a=this.primaryMedia,o=this.playerQueue;if(o.length&&o.forEach(t=>{const s=t.interstitial,i=this.schedule.findEventIndex(s.identifier);(i<e||i>e+1)&&this.clearInterstitial(s,r)}),this.isInterstitial(r)){this.timelinePos=Math.min(Math.max(this.timelinePos,r.start),r.end);const n=r.event;if(void 0===s){const t=Nr(n,(s=this.schedule.findAssetIndex(n,this.timelinePos))-1);if(n.isAssetPastPlayoutLimit(t))return void this.advanceAfterAssetEnded(n,e,s);s=t}const o=this.waitingItem;this.assetsBuffered(r,a)||this.setBufferingItem(r);let d=this.preloadAssets(n,s);if(this.eventItemsMatch(r,o||i)||(this.waitingItem=r,this.log(`INTERSTITIAL_STARTED ${Gr(r)} ${n.appendInPlace?"append in place":""}`),this.hls.trigger(l.INTERSTITIAL_STARTED,{event:n,schedule:t.slice(0),scheduleIndex:e})),!n.assetListLoaded)return void this.log(`Waiting for ASSET-LIST to complete loading ${n}`);if(n.assetListLoader&&(n.assetListLoader.destroy(),n.assetListLoader=void 0),!a)return void this.log(`Waiting for attachMedia to start Interstitial ${n}`);this.waitingItem=this.endedItem=null,this.playingItem=r;const c=n.assetList[s];if(!c){const i=t[e+1],r=this.media;return i&&r&&!this.isInterstitial(i)&&r.currentTime<i.start&&(r.currentTime=this.timelinePos=i.start),void this.advanceAfterAssetEnded(n,e,s||0)}if(d||(d=this.getAssetPlayer(c.identifier)),null===d||d.destroyed){const e=n.assetList.length;this.warn(`asset ${s+1}/${e} player destroyed ${n}`),d=this.createAssetPlayer(n,c,s)}if(!this.eventItemsMatch(r,this.bufferingItem)&&n.appendInPlace&&this.isAssetBuffered(c))return;this.startAssetPlayer(d,s,t,e,a),this.shouldPlay&&Hr(d.media)}else null!==r?(this.resumePrimary(r,e,i),this.shouldPlay&&Hr(this.hls.media)):n&&this.isInterstitial(i)&&(this.endedItem=null,this.playingItem=i,i.event.appendInPlace||this.attachPrimary(this.schedule.durations.primary,null))}get playbackDisabled(){return!1===this.hls.config.enableInterstitialPlayback}get primaryDetails(){var e,t;return null==(e=this.mediaSelection)||null==(t=e.main)?void 0:t.details}get primaryLive(){var e;return!(null==(e=this.primaryDetails)||!e.live)}resumePrimary(e,t,s){var i;if(this.playingItem=e,this.playingAsset=this.endedAsset=null,this.waitingItem=this.endedItem=null,this.bufferedToItem(e),this.log(`resuming ${Gr(e)}`),null==(i=this.detachedData)||!i.mediaSource){let s=this.timelinePos;(s<e.start||s>=e.end)&&(s=this.getPrimaryResumption(e,t),this.timelinePos=s),this.attachPrimary(s,e)}if(!s)return;const n=this.schedule.items;n&&(this.log(`INTERSTITIALS_PRIMARY_RESUMED ${Gr(e)}`),this.hls.trigger(l.INTERSTITIALS_PRIMARY_RESUMED,{schedule:n.slice(0),scheduleIndex:t}),this.checkBuffer())}getPrimaryResumption(e,t){const s=e.start;if(this.primaryLive){const e=this.primaryDetails;if(0===t)return this.hls.startPosition;if(e&&(s<e.fragmentStart||s>e.edge))return this.hls.liveSyncPosition||-1}return s}isAssetBuffered(e){const t=this.getAssetPlayer(e.identifier);return null!=t&&t.hls?t.hls.bufferedToEnd:Nt.bufferInfo(this.primaryMedia,this.timelinePos,0).end+1>=e.timelineStart+(e.duration||0)}attachPrimary(e,t,s){t?this.setBufferingItem(t):this.bufferingItem=this.playingItem,this.bufferingAsset=null;const i=this.primaryMedia;if(!i)return;const n=this.hls;n.media?this.checkBuffer():(this.transferMediaTo(n,i),s&&this.startLoadingPrimaryAt(e,s)),s||(this.timelinePos=e,this.startLoadingPrimaryAt(e,s))}startLoadingPrimaryAt(e,t){var s;const i=this.hls;!i.loadingEnabled||!i.media||Math.abs(((null==(s=i.mainForwardBufferInfo)?void 0:s.start)||i.media.currentTime)-e)>.5?i.startLoad(e,t):i.bufferingEnabled||i.resumeBuffering()}onManifestLoading(){this.stopLoad(),this.schedule.reset(),this.emptyPlayerQueue(),this.clearScheduleState(),this.shouldPlay=!1,this.bufferedPos=this.timelinePos=-1,this.mediaSelection=this.altSelection=this.manager=this.requiredTracks=null,this.hls.off(l.BUFFER_CODECS,this.onBufferCodecs,this),this.hls.on(l.BUFFER_CODECS,this.onBufferCodecs,this)}onLevelUpdated(e,t){if(-1===t.level)return;const s=this.hls.levels[t.level],i=E(E({},this.mediaSelection||this.altSelection),{},{main:s});this.mediaSelection=i,this.schedule.parseInterstitialDateRanges(i,this.hls.config.interstitialAppendInPlace),!this.effectivePlayingItem&&this.schedule.items&&this.checkStart()}onAudioTrackUpdated(e,t){const s=this.hls.audioTracks[t.id],i=this.mediaSelection;if(!i)return void(this.altSelection=E(E({},this.altSelection),{},{audio:s}));const n=E(E({},i),{},{audio:s});this.mediaSelection=n}onSubtitleTrackUpdated(e,t){const s=this.hls.subtitleTracks[t.id],i=this.mediaSelection;if(!i)return void(this.altSelection=E(E({},this.altSelection),{},{subtitles:s}));const n=E(E({},i),{},{subtitles:s});this.mediaSelection=n}onAudioTrackSwitching(e,t){const s=Xe(t);this.playerQueue.forEach(e=>e.hls.setAudioOption(t)||e.hls.setAudioOption(s))}onSubtitleTrackSwitch(e,t){const s=Xe(t);this.playerQueue.forEach(e=>e.hls.setSubtitleOption(t)||-1!==t.id&&e.hls.setSubtitleOption(s))}onBufferCodecs(e,t){const s=t.tracks;s&&(this.requiredTracks=s)}onBufferAppended(e,t){this.checkBuffer()}onBufferFlushed(e,t){const s=this.playingItem;if(s&&!this.itemsMatch(s,this.bufferingItem)&&!this.isInterstitial(s)){const e=this.timelinePos;this.bufferedPos=e,this.checkBuffer()}}onBufferedToEnd(e){const t=this.schedule.events;if(this.bufferedPos<Number.MAX_VALUE&&t){for(let e=0;e<t.length;e++){const i=t[e];if(i.cue.post){var s;const e=this.schedule.findEventIndex(i.identifier),t=null==(s=this.schedule.items)?void 0:s[e];this.isInterstitial(t)&&this.eventItemsMatch(t,this.bufferingItem)&&this.bufferedToItem(t,0);break}}this.bufferedPos=Number.MAX_VALUE}}onMediaEnded(e){const t=this.playingItem;if(!this.playingLastItem&&t){const e=this.findItemIndex(t);this.setSchedulePosition(e+1)}else this.shouldPlay=!1}updateItem(e,t){const s=this.schedule.items;return e&&s&&s[this.findItemIndex(e,t)]||null}trimInPlace(e,t){if(this.isInterstitial(e)&&e.event.appendInPlace&&t.end-e.end>.25){e.event.assetList.forEach((t,s)=>{e.event.isAssetPastPlayoutLimit(s)&&this.clearAssetPlayer(t.identifier,null)});const t=e.end+.25,s=Nt.bufferInfo(this.primaryMedia,t,0);(s.end>t||(s.nextStart||0)>t)&&(this.attachPrimary(t,null),this.flushFrontBuffer(t))}}itemsMatch(e,t){return!!t&&(e===t||e.event&&t.event&&this.eventItemsMatch(e,t)||!e.event&&!t.event&&this.findItemIndex(e)===this.findItemIndex(t))}eventItemsMatch(e,t){var s;return!!t&&(e===t||e.event.identifier===(null==(s=t.event)?void 0:s.identifier))}findItemIndex(e,t){return e?this.schedule.findItemIndex(e,t):-1}updateSchedule(){const e=this.mediaSelection;e&&this.schedule.updateSchedule(e,[])}checkBuffer(e){const t=this.schedule.items;if(!t)return;const s=Nt.bufferInfo(this.primaryMedia,this.timelinePos,0);e&&(this.bufferedPos=this.timelinePos),e||(e=s.len<1),this.updateBufferedPos(s.end,t,e)}updateBufferedPos(e,t,s){const i=this.schedule,n=this.bufferingItem;if(this.bufferedPos>e)return;if(1===t.length&&this.itemsMatch(t[0],n))return void(this.bufferedPos=e);const r=this.playingItem,a=this.findItemIndex(r);let o=i.findItemIndexAtTime(e);if(this.bufferedPos<e){var l,d;const s=this.findItemIndex(n),i=Math.min(s+1,t.length-1),r=t[i];if((-1===o&&n&&e>=n.end||null!=(l=r.event)&&l.appendInPlace&&e+.01>=r.start)&&(o=i),i-a>1&&!1===(null==n||null==(d=n.event)?void 0:d.appendInPlace))return;if(this.bufferedPos=e,o>s&&o>a)this.bufferedToItem(r);else{const t=this.primaryDetails;this.primaryLive&&t&&e>t.edge-t.targetduration&&r.start<t.edge+this.hls.config.interstitialLiveLookAhead&&this.isInterstitial(r)&&this.preloadAssets(r.event,0)}}else s&&r&&!this.itemsMatch(r,n)&&(o===a?this.bufferedToItem(r):o===a+1&&this.bufferedToItem(t[o]))}assetsBuffered(e,t){return 0!==e.event.assetList.length&&!e.event.assetList.some(e=>{const s=this.getAssetPlayer(e.identifier);return!(null!=s&&s.bufferedInPlaceToEnd(t))})}setBufferingItem(e){const t=this.bufferingItem,s=this.schedule;if(this.itemsMatch(e,t))this.bufferingItem!==e&&(this.bufferingItem=e);else{const{items:i,events:n}=s;if(!i||!n)return t;const r=this.isInterstitial(e),a=this.getBufferingPlayer();this.bufferingItem=e,this.bufferedPos=Math.max(e.start,Math.min(e.end,this.timelinePos));const o=a?a.remaining:t?t.end-this.timelinePos:0;this.log(`INTERSTITIALS_BUFFERED_TO_BOUNDARY ${Gr(e)}`+(t?` (${o.toFixed(2)} remaining)`:"")),this.playbackDisabled||(r?e.event.assetList.forEach(e=>{const t=this.getAssetPlayer(e.identifier);t&&t.resumeBuffering()}):(this.hls.resumeBuffering(),this.playerQueue.forEach(e=>e.pauseBuffering()))),this.hls.trigger(l.INTERSTITIALS_BUFFERED_TO_BOUNDARY,{events:n.slice(0),schedule:i.slice(0),bufferingIndex:this.findItemIndex(e),playingIndex:this.findItemIndex(this.playingItem)})}return t}bufferedToItem(e,t=0){const s=this.setBufferingItem(e);if(!this.playbackDisabled)if(this.isInterstitial(e))this.bufferedToEvent(e,t);else if(null!==s){this.bufferingAsset=null;const t=this.detachedData;if(t)if(t.mediaSource){const t=!0;this.attachPrimary(e.start,e,t)}else this.preloadPrimary(e);else this.preloadPrimary(e)}}preloadPrimary(e){const t=this.findItemIndex(e),s=this.getPrimaryResumption(e,t);this.startLoadingPrimaryAt(s)}bufferedToEvent(e,t){const s=e.event,i=0===s.assetList.length&&!s.assetListLoader,n=s.cue.once;if(i||!n){const e=this.preloadAssets(s,t);if(null!=e&&e.interstitial.appendInPlace){const i=s.assetList[t],n=this.primaryMedia;i&&n&&this.bufferAssetPlayer(e,n)}}}preloadAssets(e,t){const s=e.assetUrl,i=e.assetList.length,n=0===i&&!e.assetListLoader,r=e.cue.once;if(n){const n=e.timelineStart;if(e.appendInPlace){var a;const t=this.playingItem;this.isInterstitial(t)||(null==t||null==(a=t.nextEvent)?void 0:a.identifier)!==e.identifier||this.flushFrontBuffer(n+.25)}let r,o=0;if(!this.playingItem&&this.primaryLive&&(o=this.hls.startPosition,-1===o&&(o=this.hls.liveSyncPosition||0)),o&&!e.cue.pre&&!e.cue.post){const e=o-n;e>0&&(r=Math.round(1e3*e)/1e3)}if(this.log(`Load interstitial asset ${t+1}/${s?1:i} ${e}${r?` live-start: ${o} start-offset: ${r}`:""}`),s)return this.createAsset(e,0,0,n,e.duration,s);const l=this.assetListLoader.loadAssetList(e,r);l&&(e.assetListLoader=l)}else if(!r&&i){for(let s=t;s<i;s++){const t=e.assetList[s],i=this.getAssetPlayerQueueIndex(t.identifier);-1!==i&&!this.playerQueue[i].destroyed||t.error||this.createAssetPlayer(e,t,s)}return this.getAssetPlayer(e.assetList[t].identifier)}return null}flushFrontBuffer(e){const t=this.requiredTracks;t&&(this.log(`Removing front buffer starting at ${e}`),Object.keys(t).forEach(t=>{this.hls.trigger(l.BUFFER_FLUSHING,{startOffset:e,endOffset:1/0,type:t})}))}getAssetPlayerQueueIndex(e){const t=this.playerQueue;for(let s=0;s<t.length;s++)if(e===t[s].assetId)return s;return-1}getAssetPlayer(e){const t=this.getAssetPlayerQueueIndex(e);return this.playerQueue[t]||null}getBufferingPlayer(){const{playerQueue:e,primaryMedia:t}=this;if(t)for(let s=0;s<e.length;s++)if(e[s].media===t)return e[s];return null}createAsset(e,t,s,i,n,r){const a={parentIdentifier:e.identifier,identifier:Pr(e,r,t),duration:n,startOffset:s,timelineStart:i,uri:r};return this.createAssetPlayer(e,a,t)}createAssetPlayer(e,t,s){const i=this.hls,n=i.userConfig;let r=n.videoPreference;const d=i.loadLevelObj||i.levels[i.currentLevel];(r||d)&&(r=y({},r),d.videoCodec&&(r.videoCodec=d.videoCodec),d.videoRange&&(r.allowedVideoRanges=[d.videoRange]));const c=i.audioTracks[i.audioTrack],h=i.subtitleTracks[i.subtitleTrack];let u=0;if(this.primaryLive||e.appendInPlace){const e=this.timelinePos-t.timelineStart;if(e>1){const s=t.duration;s&&e<s&&(u=e)}}const f=t.identifier,g=E(E({},n),{},{autoStartLoad:!0,startFragPrefetch:!0,primarySessionId:i.sessionId,assetPlayerId:f,abrEwmaDefaultEstimate:i.bandwidthEstimate,interstitialsController:void 0,startPosition:u,liveDurationInfinity:!1,testBandwidth:!1,videoPreference:r,audioPreference:c||n.audioPreference,subtitlePreference:h||n.subtitlePreference});e.appendInPlace&&(e.appendInPlaceStarted=!0,t.timelineStart&&(g.timelineOffset=t.timelineStart));const m=g.cmcd;null!=m&&m.sessionId&&m.contentId&&(g.cmcd=y({},m,{contentId:Dr(t.uri)})),this.getAssetPlayer(f)&&this.warn(`Duplicate date range identifier ${e} and asset ${f}`);const p=new Ur(this.HlsPlayerClass,g,e,t);this.playerQueue.push(p),e.assetList[s]=t;const v=i=>{if(i.live){const t=new Error(`Interstitials MUST be VOD assets ${e}`),i={fatal:!0,type:a.OTHER_ERROR,details:o.INTERSTITIAL_ASSET_ITEM_ERROR,error:t};return void this.handleAssetItemError(i,e,this.schedule.findEventIndex(e.identifier),s,t.message)}const n=i.edge-i.fragmentStart,r=t.duration;(null===r||n>r)&&(this.log(`Interstitial asset "${f}" duration change ${r} > ${n}`),t.duration=n,this.updateSchedule())};p.on(l.LEVEL_UPDATED,(e,{details:t})=>v(t)),p.on(l.LEVEL_PTS_UPDATED,(e,{details:t})=>v(t));const T=(e,t)=>{const s=this.getAssetPlayer(f);if(s&&t.tracks){s.off(l.BUFFER_CODECS,T),s.tracks=t.tracks;const e=this.primaryMedia;this.bufferingAsset===s.assetItem&&e&&!s.media&&this.bufferAssetPlayer(s,e)}};p.on(l.BUFFER_CODECS,T);const S=()=>{var s;const i=this.getAssetPlayer(f);if(this.log(`buffered to end of asset ${i}`),!i)return;const n=this.schedule.findEventIndex(e.identifier),r=null==(s=this.schedule.items)?void 0:s[n];if(this.isInterstitial(r)){const s=e.findAssetIndex(t),i=Nr(e,s);if(e.isAssetPastPlayoutLimit(i)){var a;const e=null==(a=this.schedule.items)?void 0:a[n+1];e&&this.bufferedToItem(e)}else this.bufferedToItem(r,i)}};p.on(l.BUFFERED_TO_END,S);const b=t=>()=>{if(!this.getAssetPlayer(f))return;this.shouldPlay=!0;const s=this.schedule.findEventIndex(e.identifier);this.advanceAfterAssetEnded(e,s,t)};return p.once(l.MEDIA_ENDED,b(s)),p.once(l.PLAYOUT_LIMIT_REACHED,b(1/0)),p.on(l.ERROR,(t,i)=>{const n=this.getAssetPlayer(f);if(i.details!==o.BUFFER_STALLED_ERROR)this.handleAssetItemError(i,e,this.schedule.findEventIndex(e.identifier),s,`Asset player error ${i.error} ${e}`);else if(null!=n&&n.media){const t=n.currentTime,s=n.duration-t;t&&e.appendInPlace&&s/n.media.playbackRate<.5?(this.log(`Advancing buffer past end of asset ${f} ${e} at ${n.media.currentTime}`),S()):(this.warn(`Stalled at ${t} of ${t+s} in asset ${f} ${e}`),this.onTimeupdate(),this.checkBuffer(!0))}}),p.on(l.DESTROYING,()=>{if(!this.getAssetPlayer(f))return;const t=new Error(`Asset player destroyed unexpectedly ${f}`),i={fatal:!0,type:a.OTHER_ERROR,details:o.INTERSTITIAL_ASSET_ITEM_ERROR,error:t};this.handleAssetItemError(i,e,this.schedule.findEventIndex(e.identifier),s,t.message)}),this.log(`INTERSTITIAL_ASSET_PLAYER_CREATED ${Br(t)}`),this.hls.trigger(l.INTERSTITIAL_ASSET_PLAYER_CREATED,{asset:t,assetListIndex:s,event:e,player:p}),p}clearInterstitial(e,t){e.assetList.forEach(e=>{this.clearAssetPlayer(e.identifier,t)}),e.reset()}resetAssetPlayer(e){const t=this.getAssetPlayerQueueIndex(e);if(-1!==t){this.log(`reset asset player "${e}" after error`);const s=this.playerQueue[t];this.transferMediaFromPlayer(s,null),s.resetDetails()}}clearAssetPlayer(e,t){const s=this.getAssetPlayerQueueIndex(e);if(-1!==s){this.log(`clear asset player "${e}" toSegment: ${t?Gr(t):t}`);const i=this.playerQueue[s];this.transferMediaFromPlayer(i,t),this.playerQueue.splice(s,1),i.destroy()}}emptyPlayerQueue(){let e;for(;e=this.playerQueue.pop();)e.destroy();this.playerQueue=[]}startAssetPlayer(e,t,s,i,n){const{interstitial:r,assetItem:a,assetId:o}=e,d=r.assetList.length,c=this.playingAsset;this.endedAsset=null,this.playingAsset=a,c&&c.identifier===o||(c&&(this.clearAssetPlayer(c.identifier,s[i]),delete c.error),this.log(`INTERSTITIAL_ASSET_STARTED ${t+1}/${d} ${Br(a)}`),this.hls.trigger(l.INTERSTITIAL_ASSET_STARTED,{asset:a,assetListIndex:t,event:r,schedule:s.slice(0),scheduleIndex:i,player:e})),this.bufferAssetPlayer(e,n)}bufferAssetPlayer(e,t){var s,i;const{interstitial:n,assetItem:r}=e,l=this.schedule.findEventIndex(n.identifier),d=null==(s=this.schedule.items)?void 0:s[l];if(!d)return;this.setBufferingItem(d),this.bufferingAsset=r;const c=this.getBufferingPlayer();if(c===e)return;const h=n.appendInPlace;if(h&&!1===(null==c?void 0:c.interstitial.appendInPlace))return;const u=(null==c?void 0:c.tracks)||(null==(i=this.detachedData)?void 0:i.tracks)||this.requiredTracks;if(h&&r!==this.playingAsset){if(!e.tracks)return;if(u&&!x(u,e.tracks)){const t=new Error(`Asset ${Br(r)} SourceBuffer tracks ('${Object.keys(e.tracks)}') are not compatible with primary content tracks ('${Object.keys(u)}')`),s={fatal:!0,type:a.OTHER_ERROR,details:o.INTERSTITIAL_ASSET_ITEM_ERROR,error:t},i=n.findAssetIndex(r);return void this.handleAssetItemError(s,n,l,i,t.message)}}this.transferMediaTo(e,t)}handleAssetItemError(e,t,s,i,n){if(e.details===o.BUFFER_STALLED_ERROR)return;const r=t.assetList[i];this.warn(`INTERSTITIAL_ASSET_ERROR ${r?Br(r):r} ${e.error}`);const a=null==r?void 0:r.identifier,d=this.getAssetPlayerQueueIndex(a),c=this.playerQueue[d]||null,h=this.schedule.items,u=y({},e,{fatal:!1,errorAction:pt(!0),asset:r,assetListIndex:i,event:t,schedule:h,scheduleIndex:s,player:c});if(this.hls.trigger(l.INTERSTITIAL_ASSET_ERROR,u),!e.fatal)return;const f=this.playingAsset,g=new Error(n);if(r&&(this.clearAssetPlayer(a,null),r.error=g),t.assetList.some(e=>!e.error)){for(let e=i;e<t.assetList.length;e++)this.resetAssetPlayer(t.assetList[e].identifier);this.updateSchedule()}else t.error=g;t.error?this.primaryFallback(t):f&&f.identifier===a&&this.advanceAfterAssetEnded(t,s,i)}primaryFallback(e){const t=e.timelineStart,s=this.effectivePlayingItem;if(this.updateSchedule(),s){this.log(`Fallback to primary from event "${e.identifier}" start: ${t} pos: ${this.timelinePos} playing: ${s?Gr(s):"<none>"} error: ${e.error}`);let i=this.timelinePos;-1===i&&(i=this.hls.startPosition);const n=this.updateItem(s,i);this.itemsMatch(s,n)&&this.clearInterstitial(e,null),e.appendInPlace&&(this.attachPrimary(t,null),this.flushFrontBuffer(t));const r=this.schedule.findItemIndexAtTime(i);this.setSchedulePosition(r)}else this.checkStart()}onAssetListLoaded(e,t){var s;const i=t.event,n=i.identifier,r=t.assetListResponse.ASSETS;if(!this.schedule.hasEvent(n))return;const a=i.timelineStart,o=i.duration;let l=0;r.forEach((e,t)=>{const s=parseFloat(e.DURATION);this.createAsset(i,t,l,a+l,s,e.URI),l+=s}),i.duration=l,this.log(`Loaded asset-list with duration: ${l} (was: ${o}) ${i}`);const d=this.waitingItem,c=(null==d?void 0:d.event.identifier)===n;this.updateSchedule();const h=null==(s=this.bufferingItem)?void 0:s.event;if(c){var u;const e=this.schedule.findEventIndex(n),t=null==(u=this.schedule.items)?void 0:u[e];if(t){if(!this.playingItem&&this.timelinePos>t.end&&this.schedule.findItemIndexAtTime(this.timelinePos)!==e)return i.error=new Error(`Interstitial no longer within playback range ${this.timelinePos} ${i}`),void this.primaryFallback(i);this.setBufferingItem(t)}this.setSchedulePosition(e)}else if((null==h?void 0:h.identifier)===n&&h.appendInPlace){const e=i.assetList[0],t=this.getAssetPlayer(e.identifier),s=this.primaryMedia;e&&t&&s&&this.bufferAssetPlayer(t,s)}}onError(e,t){switch(t.details){case o.ASSET_LIST_PARSING_ERROR:case o.ASSET_LIST_LOAD_ERROR:case o.ASSET_LIST_LOAD_TIMEOUT:{const e=t.interstitial;e&&this.primaryFallback(e);break}case o.BUFFER_STALLED_ERROR:this.onTimeupdate(),this.checkBuffer(!0)}}}});function Xa(e){return e&&"object"==typeof e?Array.isArray(e)?e.map(Xa):Object.keys(e).reduce((t,s)=>(t[s]=Xa(e[s]),t),{}):e}class Za extends Mt{constructor(e,t){super("gap-controller",e.logger),this.hls=null,this.fragmentTracker=null,this.media=null,this.mediaSource=void 0,this.nudgeRetry=0,this.stallReported=!1,this.stalled=null,this.moved=!1,this.seeking=!1,this.buffered={},this.lastCurrentTime=0,this.ended=0,this.waiting=0,this.onMediaPlaying=()=>{this.ended=0,this.waiting=0},this.onMediaWaiting=()=>{var e;null!=(e=this.media)&&e.seeking||(this.waiting=self.performance.now(),this.tick())},this.onMediaEnded=()=>{var e;this.hls&&(this.ended=(null==(e=this.media)?void 0:e.currentTime)||1,this.hls.trigger(l.MEDIA_ENDED,{stalled:!1}))},this.hls=e,this.fragmentTracker=t,this.registerListeners()}registerListeners(){const{hls:e}=this;e&&(e.on(l.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(l.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(l.BUFFER_APPENDED,this.onBufferAppended,this))}unregisterListeners(){const{hls:e}=this;e&&(e.off(l.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(l.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(l.BUFFER_APPENDED,this.onBufferAppended,this))}destroy(){super.destroy(),this.unregisterListeners(),this.media=this.hls=this.fragmentTracker=null,this.mediaSource=void 0}onMediaAttached(e,t){this.setInterval(100),this.mediaSource=t.mediaSource;const s=this.media=t.media;Er(s,"playing",this.onMediaPlaying),Er(s,"waiting",this.onMediaWaiting),Er(s,"ended",this.onMediaEnded)}onMediaDetaching(e,t){this.clearInterval();const{media:s}=this;s&&(Tr(s,"playing",this.onMediaPlaying),Tr(s,"waiting",this.onMediaWaiting),Tr(s,"ended",this.onMediaEnded),this.media=null),this.mediaSource=void 0}onBufferAppended(e,t){this.buffered=t.timeRanges}get hasBuffered(){return Object.keys(this.buffered).length>0}tick(){var e;if(null==(e=this.media)||!e.readyState||!this.hasBuffered)return;const t=this.media.currentTime;this.poll(t,this.lastCurrentTime),this.lastCurrentTime=t}poll(e,t){var s,i;const n=null==(s=this.hls)?void 0:s.config;if(!n)return;const r=this.media;if(!r)return;const{seeking:a}=r,o=this.seeking&&!a,d=!this.seeking&&a,c=r.paused&&!a||r.ended||0===r.playbackRate;if(this.seeking=a,e!==t)return t&&(this.ended=0),this.moved=!0,a||(this.nudgeRetry=0,n.nudgeOnVideoHole&&!c&&e>t&&this.nudgeOnVideoHole(e,t)),void(0===this.waiting&&this.stallResolved(e));if(d||o)return void(o&&this.stallResolved(e));if(c)return this.nudgeRetry=0,this.stallResolved(e),void(!this.ended&&r.ended&&this.hls&&(this.ended=e||1,this.hls.trigger(l.MEDIA_ENDED,{stalled:!1})));if(!Nt.getBuffered(r).length)return void(this.nudgeRetry=0);const h=Nt.bufferInfo(r,e,0),u=h.nextStart||0,f=this.fragmentTracker;if(a&&f&&this.hls){const t=Qa(this.hls.inFlightFragments,e),s=h.len>2,i=!u||t||u-e>2&&!f.getPartialFragment(e);if(s||i)return;this.moved=!1}const g=null==(i=this.hls)?void 0:i.latestLevelDetails;if(!this.moved&&null!==this.stalled&&f){if(!(h.len>0||u))return;const t=Math.max(u,h.start||0)-e,s=null!=g&&g.live?2*g.targetduration:2,i=f.getPartialFragment(e);if(t>0&&(t<=s||i))return void(r.paused||this._trySkipBufferHole(i))}const m=n.detectStallWithCurrentTimeMs,p=self.performance.now(),y=this.waiting;let v=this.stalled;if(null===v){if(!(y>0&&p-y<m))return void(this.stalled=p);v=this.stalled=y}const E=p-v;if(!a&&(E>=m||y)&&this.hls){var T;if("ended"===(null==(T=this.mediaSource)?void 0:T.readyState)&&(null==g||!g.live)&&Math.abs(e-((null==g?void 0:g.edge)||0))<1){if(this.ended)return;return this.ended=e||1,void this.hls.trigger(l.MEDIA_ENDED,{stalled:!0})}if(this._reportStall(h),!this.media||!this.hls)return}const S=Nt.bufferInfo(r,e,n.maxBufferHole);this._tryFixBufferStall(S,E,e)}stallResolved(e){const t=this.stalled;if(t&&this.hls&&(this.stalled=null,this.stallReported)){const s=self.performance.now()-t;this.log(`playback not stuck anymore @${e}, after ${Math.round(s)}ms`),this.stallReported=!1,this.waiting=0,this.hls.trigger(l.STALL_RESOLVED,{})}}nudgeOnVideoHole(e,t){var s;const i=this.buffered.video;if(this.hls&&this.media&&this.fragmentTracker&&null!=(s=this.buffered.audio)&&s.length&&i&&i.length>1&&e>i.end(0)){const s=Nt.bufferedInfo(Nt.timeRangesToArray(this.buffered.audio),e,0);if(s.len>1&&t>=s.start){const s=Nt.timeRangesToArray(i),n=Nt.bufferedInfo(s,t,0).bufferedIndex;if(n>-1&&n<s.length-1){const t=Nt.bufferedInfo(s,e,0).bufferedIndex,i=s[n].end,r=s[n+1].start;if((-1===t||t>n)&&r-i<1&&e-i<2){const s=new Error(`nudging playhead to flush pipeline after video hole. currentTime: ${e} hole: ${i} -> ${r} buffered index: ${t}`);this.warn(s.message),this.media.currentTime+=1e-6;const n=this.fragmentTracker.getPartialFragment(e)||void 0,d=Nt.bufferInfo(this.media,e,0);this.hls.trigger(l.ERROR,{type:a.MEDIA_ERROR,details:o.BUFFER_SEEK_OVER_HOLE,fatal:!1,error:s,reason:s.message,frag:n,buffer:d.len,bufferInfo:d})}}}}}_tryFixBufferStall(e,t,s){var i,n;const{fragmentTracker:r,media:a}=this,o=null==(i=this.hls)?void 0:i.config;if(!a||!r||!o)return;const l=null==(n=this.hls)?void 0:n.latestLevelDetails,d=r.getPartialFragment(s);if((d||null!=l&&l.live&&s<l.fragmentStart)&&(this._trySkipBufferHole(d)||!this.media))return;const c=e.buffered,h=this.adjacentTraversal(e,s);(c&&c.length>1&&e.len>o.maxBufferHole||e.nextStart&&(e.nextStart-s<o.maxBufferHole||h))&&(t>1e3*o.highBufferWatchdogPeriod||this.waiting)&&(this.warn("Trying to nudge playhead over buffer-hole"),this._tryNudgeBuffer(e))}adjacentTraversal(e,t){const s=this.fragmentTracker,i=e.nextStart;if(s&&i){const e=s.getFragAtPos(t,f.MAIN),n=s.getFragAtPos(i,f.MAIN);if(e&&n)return n.sn-e.sn<2}return!1}_reportStall(e){const{hls:t,media:s,stallReported:i,stalled:n}=this;if(!i&&null!==n&&s&&t){this.stallReported=!0;const i=new Error(`Playback stalling at @${s.currentTime} due to low buffer (${Ye(e)})`);this.warn(i.message),t.trigger(l.ERROR,{type:a.MEDIA_ERROR,details:o.BUFFER_STALLED_ERROR,fatal:!1,error:i,buffer:e.len,bufferInfo:e,stalled:{start:n}})}}_trySkipBufferHole(e){var t;const{fragmentTracker:s,media:i}=this,n=null==(t=this.hls)?void 0:t.config;if(!i||!s||!n)return 0;const r=i.currentTime,d=Nt.bufferInfo(i,r,0),c=r<d.start?d.start:d.nextStart;if(c&&this.hls){const t=d.len<=n.maxBufferHole,u=d.len>0&&d.len<1&&i.readyState<3,g=c-r;if(g>0&&(t||u)){if(g>n.maxBufferHole){let t=!1;if(0===r){const e=s.getAppendedFrag(0,f.MAIN);e&&c<e.end&&(t=!0)}if(!t){const t=e||s.getAppendedFrag(r,f.MAIN);if(t){var h;if(null==(h=this.hls.loadLevelObj)||!h.details)return 0;if(Qa(this.hls.inFlightFragments,c))return 0;let e=!1,i=t.end;for(;i<c;){const t=s.getAppendedFrag(i,f.MAIN)||s.getPartialFragment(i);if(!t){e=!0;break}i+=t.duration}if(e)return 0}}}const t=Math.max(c+.05,r+.1);if(this.warn(`skipping hole, adjusting currentTime from ${r} to ${t}`),this.moved=!0,i.currentTime=t,null==e||!e.gap){const s=new Error(`fragment loaded with buffer holes, seeking from ${r} to ${t}`);this.hls.trigger(l.ERROR,{type:a.MEDIA_ERROR,details:o.BUFFER_SEEK_OVER_HOLE,fatal:!1,error:s,reason:s.message,frag:e||void 0,buffer:d.len,bufferInfo:d})}return t}}return 0}_tryNudgeBuffer(e){const{hls:t,media:s,nudgeRetry:i}=this,n=null==t?void 0:t.config;if(!s||!n)return 0;const r=s.currentTime;if(this.nudgeRetry++,i<n.nudgeMaxRetry){const d=r+(i+1)*n.nudgeOffset,c=new Error(`Nudging 'currentTime' from ${r} to ${d}`);this.warn(c.message),s.currentTime=d,t.trigger(l.ERROR,{type:a.MEDIA_ERROR,details:o.BUFFER_NUDGE_ON_STALL,error:c,fatal:!1,buffer:e.len,bufferInfo:e})}else{const s=new Error(`Playhead still not moving while enough data buffered @${r} after ${n.nudgeMaxRetry} nudges`);this.error(s.message),t.trigger(l.ERROR,{type:a.MEDIA_ERROR,details:o.BUFFER_STALLED_ERROR,error:s,fatal:!0,buffer:e.len,bufferInfo:e})}}}function Qa(e,t){const s=Ja(e.main);if(s&&s.start<=t)return s;const i=Ja(e.audio);return i&&i.start<=t?i:null}function Ja(e){if(!e)return null;switch(e.state){case Hs:case js:case Xs:case Zs:return null}return e.frag}function eo(){if("undefined"!=typeof self)return self.VTTCue||self.TextTrackCue}function to(e,t,s,i,n){let r=new e(t,s,"");try{r.value=i,n&&(r.type=n)}catch(a){r=new e(t,s,Ye(n?E({type:n},i):i))}return r}const so=(()=>{const e=eo();try{e&&new e(0,Number.POSITIVE_INFINITY,"")}catch(e){return Number.MAX_VALUE}return Number.POSITIVE_INFINITY})();class io{constructor(e){this.hls=void 0,this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.removeCues=!0,this.onEventCueEnter=()=>{this.hls&&this.hls.trigger(l.EVENT_CUE_ENTER,{})},this.hls=e,this._registerListeners()}destroy(){this._unregisterListeners(),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=this.onEventCueEnter=null}_registerListeners(){const{hls:e}=this;e.on(l.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(l.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(l.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(l.MANIFEST_LOADING,this.onManifestLoading,this),e.on(l.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),e.on(l.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(l.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(l.LEVEL_PTS_UPDATED,this.onLevelPtsUpdated,this)}_unregisterListeners(){const{hls:e}=this;e.off(l.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(l.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(l.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(l.MANIFEST_LOADING,this.onManifestLoading,this),e.off(l.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),e.off(l.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(l.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(l.LEVEL_PTS_UPDATED,this.onLevelPtsUpdated,this)}onMediaAttaching(e,t){var s;this.media=t.media,!1===(null==(s=t.overrides)?void 0:s.cueRemoval)&&(this.removeCues=!1)}onMediaAttached(){const e=this.hls.latestLevelDetails;e&&this.updateDateRangeCues(e)}onMediaDetaching(e,t){this.media=null,t.transferMedia||(this.id3Track&&(this.removeCues&&Rr(this.id3Track,this.onEventCueEnter),this.id3Track=null),this.dateRangeCuesAppended={})}onManifestLoading(){this.dateRangeCuesAppended={}}createTrack(e){const t=this.getID3Track(e.textTracks);return t.mode="hidden",t}getID3Track(e){if(this.media){for(let t=0;t<e.length;t++){const s=e[t];if("metadata"===s.kind&&"id3"===s.label)return Lr(s,this.media),s}return this.media.addTextTrack("metadata","id3")}}onFragParsingMetadata(e,t){if(!this.media)return;const{hls:{config:{enableEmsgMetadataCues:s,enableID3MetadataCues:i}}}=this;if(!s&&!i)return;const{samples:n}=t;this.id3Track||(this.id3Track=this.createTrack(this.media));const r=eo();if(r)for(let e=0;e<n.length;e++){const t=n[e].type;if(t===ki.emsg&&!s||!i)continue;const a=wi(n[e].data);if(a){const s=n[e].pts;let i=s+n[e].duration;i>so&&(i=so),i-s<=0&&(i=s+.25);for(let e=0;e<a.length;e++){const n=a[e];if(!Ri(n)){this.updateId3CueEnds(s,t);const e=to(r,s,i,n,t);e&&this.id3Track.addCue(e)}}}}}updateId3CueEnds(e,t){var s;const i=null==(s=this.id3Track)?void 0:s.cues;if(i)for(let s=i.length;s--;){const n=i[s];n.type===t&&n.startTime<e&&n.endTime===so&&(n.endTime=e)}}onBufferFlushing(e,{startOffset:t,endOffset:s,type:i}){const{id3Track:n,hls:r}=this;if(!r)return;const{config:{enableEmsgMetadataCues:a,enableID3MetadataCues:o}}=r;if(n&&(a||o)){let e;e="audio"===i?e=>e.type===ki.audioId3&&o:"video"===i?e=>e.type===ki.emsg&&a:e=>e.type===ki.audioId3&&o||e.type===ki.emsg&&a,Ir(n,t,s,e)}}onLevelUpdated(e,{details:t}){this.updateDateRangeCues(t,!0)}onLevelPtsUpdated(e,t){Math.abs(t.drift)>.01&&this.updateDateRangeCues(t.details)}updateDateRangeCues(e,t){if(!this.media||!e.hasProgramDateTime||!this.hls.config.enableDateRangeMetadataCues)return;const{id3Track:s}=this,{dateRanges:n}=e,r=Object.keys(n);let a=this.dateRangeCuesAppended;var o;if(s&&t)if(null!=(o=s.cues)&&o.length){const e=Object.keys(a).filter(e=>!r.includes(e));for(let t=e.length;t--;){const i=e[t],n=a[i].cues;delete a[i],Object.keys(n).forEach(e=>{try{const t=n[e];t.removeEventListener("enter",this.onEventCueEnter),s.removeCue(t)}catch(e){}})}}else a=this.dateRangeCuesAppended={};const l=e.fragments[e.fragments.length-1];if(0===r.length||!i(null==l?void 0:l.programDateTime))return;this.id3Track||(this.id3Track=this.createTrack(this.media));const d=eo();for(let e=0;e<r.length;e++){const t=r[e],s=n[t],i=s.startTime,o=a[t],l=(null==o?void 0:o.cues)||{};let c=(null==o?void 0:o.durationKnown)||!1,h=so;const{duration:u,endDate:f}=s;if(f&&null!==u)h=i+u,c=!0;else if(s.endOnNext&&!c){const e=r.reduce((e,t)=>{if(t!==s.id){const i=n[t];if(i.class===s.class&&i.startDate>s.startDate&&(!e||s.startDate<e.startDate))return i}return e},null);e&&(h=e.startTime,c=!0)}const g=Object.keys(s.attr);for(let e=0;e<g.length;e++){const n=g[e];if(!qt(n))continue;const r=l[n];if(r)c&&!o.durationKnown?r.endTime=h:Math.abs(r.startTime-i)>.01&&(r.startTime=i,r.endTime=h);else if(d){let e=s.attr[n];Yt(n)&&(e=_(e));const r=to(d,i,h,{key:n,data:e},ki.dateRange);r&&(r.id=t,this.id3Track.addCue(r),l[n]=r,this.hls.config.interstitialsController&&("X-ASSET-LIST"!==n&&"X-ASSET-URL"!==n||r.addEventListener("enter",this.onEventCueEnter)))}}a[t]={cues:l,dateRange:s,durationKnown:c}}}}class no{constructor(e){this.hls=void 0,this.config=void 0,this.media=null,this.currentTime=0,this.stallCount=0,this._latency=null,this._targetLatencyUpdated=!1,this.onTimeupdate=()=>{const{media:e}=this,t=this.levelDetails;if(!e||!t)return;this.currentTime=e.currentTime;const s=this.computeLatency();if(null===s)return;this._latency=s;const{lowLatencyMode:i,maxLiveSyncPlaybackRate:n}=this.config;if(!i||1===n||!t.live)return;const r=this.targetLatency;if(null===r)return;const a=s-r;if(a<Math.min(this.maxLatency,r+t.targetduration)&&a>.05&&this.forwardBufferLength>1){const t=Math.min(2,Math.max(1,n)),s=Math.round(2/(1+Math.exp(-.75*a-this.edgeStalled))*20)/20,i=Math.min(t,Math.max(1,s));this.changeMediaPlaybackRate(e,i)}else 1!==e.playbackRate&&0!==e.playbackRate&&this.changeMediaPlaybackRate(e,1)},this.hls=e,this.config=e.config,this.registerListeners()}get levelDetails(){var e;return(null==(e=this.hls)?void 0:e.latestLevelDetails)||null}get latency(){return this._latency||0}get maxLatency(){const{config:e}=this;if(void 0!==e.liveMaxLatencyDuration)return e.liveMaxLatencyDuration;const t=this.levelDetails;return t?e.liveMaxLatencyDurationCount*t.targetduration:0}get targetLatency(){const e=this.levelDetails;if(null===e||null===this.hls)return null;const{holdBack:t,partHoldBack:s,targetduration:i}=e,{liveSyncDuration:n,liveSyncDurationCount:r,lowLatencyMode:a}=this.config,o=this.hls.userConfig;let l=a&&s||t;(this._targetLatencyUpdated||o.liveSyncDuration||o.liveSyncDurationCount||0===l)&&(l=void 0!==n?n:r*i);const d=i;return l+Math.min(this.stallCount*this.config.liveSyncOnStallIncrease,d)}set targetLatency(e){this.stallCount=0,this.config.liveSyncDuration=e,this._targetLatencyUpdated=!0}get liveSyncPosition(){const e=this.estimateLiveEdge(),t=this.targetLatency;if(null===e||null===t)return null;const s=this.levelDetails;if(null===s)return null;const i=s.edge,n=e-t-this.edgeStalled,r=i-s.totalduration,a=i-(this.config.lowLatencyMode&&s.partTarget||s.targetduration);return Math.min(Math.max(r,n),a)}get drift(){const e=this.levelDetails;return null===e?1:e.drift}get edgeStalled(){const e=this.levelDetails;if(null===e)return 0;const t=3*(this.config.lowLatencyMode&&e.partTarget||e.targetduration);return Math.max(e.age-t,0)}get forwardBufferLength(){const{media:e}=this,t=this.levelDetails;if(!e||!t)return 0;const s=e.buffered.length;return(s?e.buffered.end(s-1):t.edge)-this.currentTime}destroy(){this.unregisterListeners(),this.onMediaDetaching(),this.hls=null}registerListeners(){const{hls:e}=this;e&&(e.on(l.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(l.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(l.MANIFEST_LOADING,this.onManifestLoading,this),e.on(l.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(l.ERROR,this.onError,this))}unregisterListeners(){const{hls:e}=this;e&&(e.off(l.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(l.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(l.MANIFEST_LOADING,this.onManifestLoading,this),e.off(l.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(l.ERROR,this.onError,this))}onMediaAttached(e,t){this.media=t.media,this.media.addEventListener("timeupdate",this.onTimeupdate)}onMediaDetaching(){this.media&&(this.media.removeEventListener("timeupdate",this.onTimeupdate),this.media=null)}onManifestLoading(){this._latency=null,this.stallCount=0}onLevelUpdated(e,{details:t}){t.advanced&&this.onTimeupdate(),!t.live&&this.media&&this.media.removeEventListener("timeupdate",this.onTimeupdate)}onError(e,t){var s;t.details===o.BUFFER_STALLED_ERROR&&(this.stallCount++,this.hls&&null!=(s=this.levelDetails)&&s.live&&this.hls.logger.warn("[latency-controller]: Stall detected, adjusting target latency"))}changeMediaPlaybackRate(e,t){var s,i;e.playbackRate!==t&&(null==(s=this.hls)||s.logger.debug(`[latency-controller]: latency=${this.latency.toFixed(3)}, targetLatency=${null==(i=this.targetLatency)?void 0:i.toFixed(3)}, forwardBufferLength=${this.forwardBufferLength.toFixed(3)}: adjusting playback rate from ${e.playbackRate} to ${t}`),e.playbackRate=t)}estimateLiveEdge(){const e=this.levelDetails;return null===e?null:e.edge+e.age}computeLatency(){const e=this.estimateLiveEdge();return null===e?null:e-this.currentTime}}class ro extends _n{constructor(e,t){super(e,"level-controller"),this._levels=[],this._firstLevel=-1,this._maxAutoLevel=-1,this._startLevel=void 0,this.currentLevel=null,this.currentLevelIndex=-1,this.manualLevelIndex=-1,this.steering=void 0,this.onParsedComplete=void 0,this.steering=t,this._registerListeners()}_registerListeners(){const{hls:e}=this;e.on(l.MANIFEST_LOADING,this.onManifestLoading,this),e.on(l.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(l.LEVEL_LOADED,this.onLevelLoaded,this),e.on(l.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(l.FRAG_BUFFERED,this.onFragBuffered,this),e.on(l.ERROR,this.onError,this)}_unregisterListeners(){const{hls:e}=this;e.off(l.MANIFEST_LOADING,this.onManifestLoading,this),e.off(l.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(l.LEVEL_LOADED,this.onLevelLoaded,this),e.off(l.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(l.FRAG_BUFFERED,this.onFragBuffered,this),e.off(l.ERROR,this.onError,this)}destroy(){this._unregisterListeners(),this.steering=null,this.resetLevels(),super.destroy()}stopLoad(){this._levels.forEach(e=>{e.loadError=0,e.fragmentError=0}),super.stopLoad()}resetLevels(){this._startLevel=void 0,this.manualLevelIndex=-1,this.currentLevelIndex=-1,this.currentLevel=null,this._levels=[],this._maxAutoLevel=-1}onManifestLoading(e,t){this.resetLevels()}onManifestLoaded(e,t){const s=this.hls.config.preferManagedMediaSource,i=[],n={},r={};let a=!1,o=!1,l=!1;t.levels.forEach(e=>{const t=e.attrs;let{audioCodec:d,videoCodec:c}=e;d&&(e.audioCodec=d=xe(d,s)||void 0),c&&(c=e.videoCodec=function(e){const t=e.split(",");for(let e=0;e<t.length;e++){const s=t[e].split(".");s.length>2&&"avc1"===s[0]&&(t[e]=`avc1.${parseInt(s[1]).toString(16)}${("000"+parseInt(s[2]).toString(16)).slice(-4)}`)}return t.join(",")}(c));const{width:h,height:u,unknownCodecs:f}=e;let g=f?f.length:0;if(f)for(let t=g;t--;){const s=f[t];this.isAudioSupported(s)?(e.audioCodec=d=d?`${d},${s}`:s,g--,Ee.audio[d.substring(0,4)]=2):this.isVideoSupported(s)&&(e.videoCodec=c=c?`${c},${s}`:s,g--,Ee.video[c.substring(0,4)]=2)}if(a||(a=!(!h||!u)),o||(o=!!c),l||(l=!!d),g||d&&!this.isAudioSupported(d)||c&&!this.isVideoSupported(c))return void this.log(`Some or all CODECS not supported "${t.CODECS}"`);const{CODECS:m,"FRAME-RATE":p,"HDCP-LEVEL":y,"PATHWAY-ID":v,RESOLUTION:E,"VIDEO-RANGE":T}=t,S=`${v||"."}-${e.bitrate}-${E}-${p}-${m}-${T}-${y}`;if(n[S])if(n[S].uri===e.url||e.attrs["PATHWAY-ID"])n[S].addGroupId("audio",t.AUDIO),n[S].addGroupId("text",t.SUBTITLES);else{const t=r[S]+=1;e.attrs["PATHWAY-ID"]=new Array(t+1).join(".");const s=this.createLevel(e);n[S]=s,i.push(s)}else{const t=this.createLevel(e);n[S]=t,r[S]=1,i.push(t)}}),this.filterAndSortMediaOptions(i,t,a,o,l)}createLevel(e){const t=new Ke(e),s=e.supplemental;if(null!=s&&s.videoCodec&&!this.isVideoSupported(s.videoCodec)){const e=new Error(`SUPPLEMENTAL-CODECS not supported "${s.videoCodec}"`);this.log(e.message),t.supportedResult=Oe(e,[])}return t}isAudioSupported(e){return Se(e,"audio",this.hls.config.preferManagedMediaSource)}isVideoSupported(e){return Se(e,"video",this.hls.config.preferManagedMediaSource)}filterAndSortMediaOptions(e,t,s,i,n){let r=[],d=[],c=e;if((s||i)&&n&&(c=c.filter(({videoCodec:e,videoRange:t,width:s,height:i})=>{return(!!e||!(!s||!i))&&!!(n=t)&&Ge.indexOf(n)>-1;var n})),0===c.length)return void Promise.resolve().then(()=>{if(this.hls){let e="no level with compatible codecs found in manifest",s=e;t.levels.length&&(s=`one or more CODECS in variant not supported: ${Ye(t.levels.map(e=>e.attrs.CODECS).filter((e,t,s)=>s.indexOf(e)===t))}`,this.warn(s),e+=` (${s})`);const i=new Error(e);this.hls.trigger(l.ERROR,{type:a.MEDIA_ERROR,details:o.MANIFEST_INCOMPATIBLE_CODECS_ERROR,fatal:!0,url:t.url,error:i,reason:s})}});t.audioTracks&&(r=t.audioTracks.filter(e=>!e.audioCodec||this.isAudioSupported(e.audioCodec)),ao(r)),t.subtitles&&(d=t.subtitles,ao(d));const h=c.slice(0);c.sort((e,t)=>{if(e.attrs["HDCP-LEVEL"]!==t.attrs["HDCP-LEVEL"])return(e.attrs["HDCP-LEVEL"]||"")>(t.attrs["HDCP-LEVEL"]||"")?1:-1;if(s&&e.height!==t.height)return e.height-t.height;if(e.frameRate!==t.frameRate)return e.frameRate-t.frameRate;if(e.videoRange!==t.videoRange)return Ge.indexOf(e.videoRange)-Ge.indexOf(t.videoRange);if(e.videoCodec!==t.videoCodec){const s=Le(e.videoCodec),i=Le(t.videoCodec);if(s!==i)return i-s}if(e.uri===t.uri&&e.codecSet!==t.codecSet){const s=we(e.codecSet),i=we(t.codecSet);if(s!==i)return i-s}return e.averageBitrate!==t.averageBitrate?e.averageBitrate-t.averageBitrate:0});let u=h[0];if(this.steering&&(c=this.steering.filterParsedLevels(c),c.length!==h.length))for(let e=0;e<h.length;e++)if(h[e].pathwayId===c[0].pathwayId){u=h[e];break}this._levels=c;for(let e=0;e<c.length;e++)if(c[e]===u){var f;this._firstLevel=e;const t=u.bitrate,s=this.hls.bandwidthEstimate;if(this.log(`manifest loaded, ${c.length} level(s) found, first bitrate: ${t}`),void 0===(null==(f=this.hls.userConfig)?void 0:f.abrEwmaDefaultEstimate)){const e=Math.min(t,this.hls.config.abrEwmaDefaultEstimateMax);e>s&&s===this.hls.abrEwmaDefaultEstimate&&(this.hls.bandwidthEstimate=e)}break}const g=n&&!i,m=this.hls.config,p=!(!m.audioStreamController||!m.audioTrackController),y={levels:c,audioTracks:r,subtitleTracks:d,sessionData:t.sessionData,sessionKeys:t.sessionKeys,firstLevel:this._firstLevel,stats:t.stats,audio:n,video:i,altAudio:p&&!g&&r.some(e=>!!e.url)};this.hls.trigger(l.MANIFEST_PARSED,y)}get levels(){return 0===this._levels.length?null:this._levels}get loadLevelObj(){return this.currentLevel}get level(){return this.currentLevelIndex}set level(e){const t=this._levels;if(0===t.length)return;if(e<0||e>=t.length){const s=new Error("invalid level idx"),i=e<0;if(this.hls.trigger(l.ERROR,{type:a.OTHER_ERROR,details:o.LEVEL_SWITCH_ERROR,level:e,fatal:i,error:s,reason:s.message}),i)return;e=Math.min(e,t.length-1)}const s=this.currentLevelIndex,i=this.currentLevel,n=i?i.attrs["PATHWAY-ID"]:void 0,r=t[e],d=r.attrs["PATHWAY-ID"];if(this.currentLevelIndex=e,this.currentLevel=r,s===e&&i&&n===d)return;this.log(`Switching to level ${e} (${r.height?r.height+"p ":""}${r.videoRange?r.videoRange+" ":""}${r.codecSet?r.codecSet+" ":""}@${r.bitrate})${d?" with Pathway "+d:""} from level ${s}${n?" with Pathway "+n:""}`);const c={level:e,attrs:r.attrs,details:r.details,bitrate:r.bitrate,averageBitrate:r.averageBitrate,maxBitrate:r.maxBitrate,realBitrate:r.realBitrate,width:r.width,height:r.height,codecSet:r.codecSet,audioCodec:r.audioCodec,videoCodec:r.videoCodec,audioGroups:r.audioGroups,subtitleGroups:r.subtitleGroups,loaded:r.loaded,loadError:r.loadError,fragmentError:r.fragmentError,name:r.name,id:r.id,uri:r.uri,url:r.url,urlId:0,audioGroupIds:r.audioGroupIds,textGroupIds:r.textGroupIds};this.hls.trigger(l.LEVEL_SWITCHING,c);const h=r.details;if(!h||h.live){const e=this.switchParams(r.uri,null==i?void 0:i.details,h);this.loadPlaylist(e)}}get manualLevel(){return this.manualLevelIndex}set manualLevel(e){this.manualLevelIndex=e,void 0===this._startLevel&&(this._startLevel=e),-1!==e&&(this.level=e)}get firstLevel(){return this._firstLevel}set firstLevel(e){this._firstLevel=e}get startLevel(){if(void 0===this._startLevel){const e=this.hls.config.startLevel;return void 0!==e?e:this.hls.firstAutoLevel}return this._startLevel}set startLevel(e){this._startLevel=e}get pathways(){return this.steering?this.steering.pathways():[]}get pathwayPriority(){return this.steering?this.steering.pathwayPriority:null}set pathwayPriority(e){if(this.steering){const t=this.steering.pathways(),s=e.filter(e=>-1!==t.indexOf(e));if(e.length<1)return void this.warn(`pathwayPriority ${e} should contain at least one pathway from list: ${t}`);this.steering.pathwayPriority=s}}onError(e,t){!t.fatal&&t.context&&t.context.type===c&&t.context.level===this.level&&this.checkRetry(t)}onFragBuffered(e,{frag:t}){if(void 0!==t&&t.type===f.MAIN){const e=t.elementaryStreams;if(!Object.keys(e).some(t=>!!e[t]))return;const s=this._levels[t.level];null!=s&&s.loadError&&(this.log(`Resetting level error count of ${s.loadError} on frag buffered`),s.loadError=0)}}onLevelLoaded(e,t){var s;const{level:i,details:n}=t,r=t.levelInfo;var a;if(!r)return this.warn(`Invalid level index ${i}`),void(null!=(a=t.deliveryDirectives)&&a.skip&&(n.deltaUpdateFailed=!0));if(r===this.currentLevel||t.withoutMultiVariant){0===r.fragmentError&&(r.loadError=0);let e=r.details;e===t.details&&e.advanced&&(e=void 0),this.playlistLoaded(i,t,e)}else null!=(s=t.deliveryDirectives)&&s.skip&&(n.deltaUpdateFailed=!0)}loadPlaylist(e){super.loadPlaylist(),this.shouldLoadPlaylist(this.currentLevel)&&this.scheduleLoading(this.currentLevel,e)}loadingPlaylist(e,t){super.loadingPlaylist(e,t);const s=this.getUrlWithDirectives(e.uri,t),i=this.currentLevelIndex,n=e.attrs["PATHWAY-ID"],r=e.details,a=null==r?void 0:r.age;this.log(`Loading level index ${i}${void 0!==(null==t?void 0:t.msn)?" at sn "+t.msn+" part "+t.part:""}${n?" Pathway "+n:""}${a&&r.live?" age "+a.toFixed(1)+(r.type?" "+r.type||0:""):""} ${s}`),this.hls.trigger(l.LEVEL_LOADING,{url:s,level:i,levelInfo:e,pathwayId:e.attrs["PATHWAY-ID"],id:0,deliveryDirectives:t||null})}get nextLoadLevel(){return-1!==this.manualLevelIndex?this.manualLevelIndex:this.hls.nextAutoLevel}set nextLoadLevel(e){this.level=e,-1===this.manualLevelIndex&&(this.hls.nextAutoLevel=e)}removeLevel(e){var t;if(1===this._levels.length)return;const s=this._levels.filter((t,s)=>s!==e||(this.steering&&this.steering.removeLevel(t),t===this.currentLevel&&(this.currentLevel=null,this.currentLevelIndex=-1,t.details&&t.details.fragments.forEach(e=>e.level=-1)),!1));Fs(s),this._levels=s,this.currentLevelIndex>-1&&null!=(t=this.currentLevel)&&t.details&&(this.currentLevelIndex=this.currentLevel.details.fragments[0].level),this.manualLevelIndex>-1&&(this.manualLevelIndex=this.currentLevelIndex);const i=s.length-1;this._firstLevel=Math.min(this._firstLevel,i),this._startLevel&&(this._startLevel=Math.min(this._startLevel,i)),this.hls.trigger(l.LEVELS_UPDATED,{levels:s})}onLevelsUpdated(e,{levels:t}){this._levels=t}checkMaxAutoUpdated(){const{autoLevelCapping:e,maxAutoLevel:t,maxHdcpLevel:s}=this.hls;this._maxAutoLevel!==t&&(this._maxAutoLevel=t,this.hls.trigger(l.MAX_AUTO_LEVEL_UPDATED,{autoLevelCapping:e,levels:this.levels,maxAutoLevel:t,minAutoLevel:this.hls.minAutoLevel,maxHdcpLevel:s}))}}function ao(e){const t={};e.forEach(e=>{const s=e.groupId||"";e.id=t[s]=t[s]||0,t[s]++})}function oo(){return self.SourceBuffer||self.WebKitSourceBuffer}function lo(){if(!I())return!1;const e=oo();return!e||e.prototype&&"function"==typeof e.prototype.appendBuffer&&"function"==typeof e.prototype.remove}function co(){if(!lo())return!1;const e=I();return"function"==typeof(null==e?void 0:e.isTypeSupported)&&(["avc1.42E01E,mp4a.40.2","av01.0.01M.08","vp09.00.50.08"].some(t=>e.isTypeSupported(Ae(t,"video")))||["mp4a.40.2","fLaC"].some(t=>e.isTypeSupported(Ae(t,"audio"))))}class ho extends ei{constructor(e,t,s){super(e,t,s,"stream-controller",f.MAIN),this.audioCodecSwap=!1,this.level=-1,this._forceStartLoad=!1,this._hasEnoughToStart=!1,this.altAudio=0,this.audioOnly=!1,this.fragPlaying=null,this.fragLastKbps=0,this.couldBacktrack=!1,this.backtrackFragment=null,this.audioCodecSwitch=!1,this.videoBuffer=null,this.onMediaPlaying=()=>{this.tick()},this.onMediaSeeked=()=>{const e=this.media,t=e?e.currentTime:null;if(null===t||!i(t))return;if(this.log(`Media seeked to ${t.toFixed(3)}`),!this.getBufferedFrag(t))return;const s=this.getFwdBufferInfoAtPos(e,t,f.MAIN,0);null!==s&&0!==s.len?this.tick():this.warn(`Main forward buffer length at ${t} on "seeked" event ${s?s.len:"empty"})`)},this.registerListeners()}registerListeners(){super.registerListeners();const{hls:e}=this;e.on(l.MANIFEST_PARSED,this.onManifestParsed,this),e.on(l.LEVEL_LOADING,this.onLevelLoading,this),e.on(l.LEVEL_LOADED,this.onLevelLoaded,this),e.on(l.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.on(l.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(l.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.on(l.BUFFER_CREATED,this.onBufferCreated,this),e.on(l.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(l.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(l.FRAG_BUFFERED,this.onFragBuffered,this)}unregisterListeners(){super.unregisterListeners();const{hls:e}=this;e.off(l.MANIFEST_PARSED,this.onManifestParsed,this),e.off(l.LEVEL_LOADED,this.onLevelLoaded,this),e.off(l.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.off(l.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(l.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.off(l.BUFFER_CREATED,this.onBufferCreated,this),e.off(l.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(l.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(l.FRAG_BUFFERED,this.onFragBuffered,this)}onHandlerDestroying(){this.onMediaPlaying=this.onMediaSeeked=null,this.unregisterListeners(),super.onHandlerDestroying()}startLoad(e,t){if(this.levels){const{lastCurrentTime:s,hls:i}=this;if(this.stopLoad(),this.setInterval(100),this.level=-1,!this.startFragRequested){let e=i.startLevel;-1===e&&(i.config.testBandwidth&&this.levels.length>1?(e=0,this.bitrateTest=!0):e=i.firstAutoLevel),i.nextLoadLevel=e,this.level=i.loadLevel,this._hasEnoughToStart=!!t}s>0&&-1===e&&!t&&(this.log(`Override startPosition with lastCurrentTime @${s.toFixed(3)}`),e=s),this.state=Hs,this.nextLoadPosition=this.lastCurrentTime=e+this.timelineOffset,this.startPosition=t?-1:e,this.tick()}else this._forceStartLoad=!0,this.state=js}stopLoad(){this._forceStartLoad=!1,super.stopLoad()}doTick(){switch(this.state){case Js:{const{levels:e,level:t}=this,s=null==e?void 0:e[t],i=null==s?void 0:s.details;if(i&&(!i.live||this.levelLastLoaded===s&&!this.waitForLive(s))){if(this.waitForCdnTuneIn(i))break;this.state=Hs;break}if(this.hls.nextLoadLevel!==this.level){this.state=Hs;break}break}case qs:{var e;const t=self.performance.now(),s=this.retryDate;if(!s||t>=s||null!=(e=this.media)&&e.seeking){const{levels:e,level:t}=this,s=null==e?void 0:e[t];this.resetStartWhenNotLoaded(s||null),this.state=Hs}}}this.state===Hs&&this.doTickIdle(),this.onTickEnd()}onTickEnd(){var e;super.onTickEnd(),null!=(e=this.media)&&e.readyState&&!1===this.media.seeking&&(this.lastCurrentTime=this.media.currentTime),this.checkFragmentChanged()}doTickIdle(){const{hls:e,levelLastLoaded:t,levels:s,media:i}=this;if(null===t||!i&&!this.primaryPrefetch&&(this.startFragRequested||!e.config.startFragPrefetch))return;if(this.altAudio&&this.audioOnly)return;const n=this.buffering?e.nextLoadLevel:e.loadLevel;if(null==s||!s[n])return;const r=s[n],a=this.getMainFwdBufferInfo();if(null===a)return;const o=this.getLevelDetails();if(o&&this._streamEnded(a,o)){const e={};return 2===this.altAudio&&(e.type="video"),this.hls.trigger(l.BUFFER_EOS,e),void(this.state=Xs)}if(!this.buffering)return;e.loadLevel!==n&&-1===e.manualLevel&&this.log(`Adapting to level ${n} from level ${this.level}`),this.level=e.nextLoadLevel=n;const d=r.details;if(!d||this.state===Js||this.waitForLive(r))return this.level=n,this.state=Js,void(this.startFragRequested=!1);const c=a.len,h=this.getMaxBufferLength(r.maxBitrate);if(c>=h)return;this.backtrackFragment&&this.backtrackFragment.start>a.end&&(this.backtrackFragment=null);const u=this.backtrackFragment?this.backtrackFragment.start:a.end;let g=this.getNextFragment(u,d);if(this.couldBacktrack&&!this.fragPrevious&&g&&q(g)&&this.fragmentTracker.getState(g)!==Tt){var m;const e=(null!=(m=this.backtrackFragment)?m:g).sn-d.startSN,t=d.fragments[e-1];t&&g.cc===t.cc&&(g=t,this.fragmentTracker.removeFragment(t))}else this.backtrackFragment&&a.len&&(this.backtrackFragment=null);if(g&&this.isLoopLoading(g,u)){if(!g.gap){const e=this.audioOnly&&!this.altAudio?j:H,t=(e===H?this.videoBuffer:this.mediaBuffer)||this.media;t&&this.afterBufferFlushed(t,e,f.MAIN)}g=this.getNextFragmentLoopLoading(g,d,a,f.MAIN,h)}g&&(!g.initSegment||g.initSegment.data||this.bitrateTest||(g=g.initSegment),this.loadFragment(g,r,u))}loadFragment(e,t,s){const i=this.fragmentTracker.getState(e);i===yt||i===Et?q(e)?this.bitrateTest?(this.log(`Fragment ${e.sn} of level ${e.level} is being downloaded to test bitrate and will not be buffered`),this._loadBitrateTestFrag(e,t)):super.loadFragment(e,t,s):this._loadInitSegment(e,t):this.clearTrackerIfNeeded(e)}getBufferedFrag(e){return this.fragmentTracker.getBufferedFrag(e,f.MAIN)}followingBufferedFrag(e){return e?this.getBufferedFrag(e.end+.5):null}immediateLevelSwitch(){this.abortCurrentFrag(),this.flushMainBuffer(0,Number.POSITIVE_INFINITY)}nextLevelSwitch(){const{levels:e,media:t}=this;if(null!=t&&t.readyState){let s;const i=this.getAppendedFrag(t.currentTime);i&&i.start>1&&this.flushMainBuffer(0,i.start-1);const n=this.getLevelDetails();if(null!=n&&n.live){const e=this.getMainFwdBufferInfo();if(!e||e.len<2*n.targetduration)return}if(!t.paused&&e){const t=e[this.hls.nextLoadLevel],i=this.fragLastKbps;s=i&&this.fragCurrent?this.fragCurrent.duration*t.maxBitrate/(1e3*i)+1:0}else s=0;const r=this.getBufferedFrag(t.currentTime+s);if(r){const e=this.followingBufferedFrag(r);if(e){this.abortCurrentFrag();const t=e.maxStartPTS?e.maxStartPTS:e.start,s=e.duration,i=Math.max(r.end,t+Math.min(Math.max(s-this.config.maxFragLookUpTolerance,s*(this.couldBacktrack?.5:.125)),s*(this.couldBacktrack?.75:.25)));this.flushMainBuffer(i,Number.POSITIVE_INFINITY)}}}}abortCurrentFrag(){const e=this.fragCurrent;switch(this.fragCurrent=null,this.backtrackFragment=null,e&&(e.abortRequests(),this.fragmentTracker.removeFragment(e)),this.state){case Vs:case Ks:case qs:case Ws:case zs:this.state=Hs}this.nextLoadPosition=this.getLoadPosition()}flushMainBuffer(e,t){super.flushMainBuffer(e,t,2===this.altAudio?"video":null)}onMediaAttached(e,t){super.onMediaAttached(e,t);const s=t.media;Er(s,"playing",this.onMediaPlaying),Er(s,"seeked",this.onMediaSeeked)}onMediaDetaching(e,t){const{media:s}=this;s&&(Tr(s,"playing",this.onMediaPlaying),Tr(s,"seeked",this.onMediaSeeked)),this.videoBuffer=null,this.fragPlaying=null,super.onMediaDetaching(e,t),t.transferMedia||(this._hasEnoughToStart=!1)}onManifestLoading(){super.onManifestLoading(),this.log("Trigger BUFFER_RESET"),this.hls.trigger(l.BUFFER_RESET,void 0),this.couldBacktrack=!1,this.fragLastKbps=0,this.fragPlaying=this.backtrackFragment=null,this.altAudio=0,this.audioOnly=!1}onManifestParsed(e,t){let s=!1,i=!1;t.levels.forEach(e=>{const t=e.audioCodec;t&&(s=s||-1!==t.indexOf("mp4a.40.2"),i=i||-1!==t.indexOf("mp4a.40.5"))}),this.audioCodecSwitch=s&&i&&!function(){var e;const t=oo();return"function"==typeof(null==t||null==(e=t.prototype)?void 0:e.changeType)}(),this.audioCodecSwitch&&this.log("Both AAC/HE-AAC audio found in levels; declaring level codec as HE-AAC"),this.levels=t.levels,this.startFragRequested=!1}onLevelLoading(e,t){const{levels:s}=this;if(!s||this.state!==Hs)return;const i=t.levelInfo;(!i.details||i.details.live&&(this.levelLastLoaded!==i||i.details.expired)||this.waitForCdnTuneIn(i.details))&&(this.state=Js)}onLevelLoaded(e,t){var s;const{levels:i,startFragRequested:n}=this,r=t.level,a=t.details,o=a.totalduration;if(!i)return void this.warn(`Levels were reset while loading level ${r}`);this.log(`Level ${r} loaded [${a.startSN},${a.endSN}]${a.lastPartSn?`[part-${a.lastPartSn}-${a.lastPartIndex}]`:""}, cc [${a.startCC}, ${a.endCC}] duration:${o}`);const d=t.levelInfo,c=this.fragCurrent;!c||this.state!==Ks&&this.state!==qs||c.level!==t.level&&c.loader&&this.abortCurrentFrag();let h=0;if(a.live||null!=(s=d.details)&&s.live){var u;if(this.checkLiveUpdate(a),a.deltaUpdateFailed)return;h=this.alignPlaylists(a,d.details,null==(u=this.levelLastLoaded)?void 0:u.details)}if(d.details=a,this.levelLastLoaded=d,n||this.setStartPosition(a,h),this.hls.trigger(l.LEVEL_UPDATED,{details:a,level:r}),this.state===Js){if(this.waitForCdnTuneIn(a))return;this.state=Hs}n&&a.live&&this.synchronizeToLiveEdge(a),this.tick()}synchronizeToLiveEdge(e){const{config:t,media:s}=this;if(!s)return;const i=this.hls.liveSyncPosition,n=this.getLoadPosition(),r=e.fragmentStart,a=e.edge,o=n>=r-t.maxFragLookUpTolerance&&n<=a;if(null!==i&&s.duration>i&&(n<i||!o)){const r=void 0!==t.liveMaxLatencyDuration?t.liveMaxLatencyDuration:t.liveMaxLatencyDurationCount*e.targetduration;if((!o&&s.readyState<4||n<a-r)&&(this._hasEnoughToStart||(this.nextLoadPosition=i),s.readyState))if(this.warn(`Playback: ${n.toFixed(3)} is located too far from the end of live sliding playlist: ${a}, reset currentTime to : ${i.toFixed(3)}`),"buffered"===this.config.liveSyncMode){var l;const e=Nt.bufferInfo(s,i,0);if(null==e||null==(l=e.buffered)||!l.length)return void(s.currentTime=i);if(e.start<=n)return void(s.currentTime=i);const{nextStart:t}=Nt.bufferedInfo(e.buffered,n,0);t&&(s.currentTime=t)}else s.currentTime=i}}_handleFragmentLoadProgress(e){var t;const s=e.frag,{part:i,payload:n}=e,{levels:r}=this;if(!r)return void this.warn(`Levels were reset while fragment load was in progress. Fragment ${s.sn} of level ${s.level} will not be buffered`);const a=r[s.level];if(!a)return void this.warn(`Level ${s.level} not found on progress`);const o=a.details;if(!o)return this.warn(`Dropping fragment ${s.sn} of level ${s.level} after level details were reset`),void this.fragmentTracker.removeFragment(s);const l=a.videoCodec,d=o.PTSKnown||!o.live,c=null==(t=s.initSegment)?void 0:t.data,h=this._getAudioCodec(a),u=this.transmuxer=this.transmuxer||new kn(this.hls,f.MAIN,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)),g=i?i.index:-1,m=-1!==g,p=new Ot(s.level,s.sn,s.stats.chunkCount,n.byteLength,g,m),y=this.initPTS[s.cc];u.push(n,c,h,l,s,i,o.totalduration,d,p,y)}onAudioTrackSwitching(e,t){const s=this.hls,i=2===this.altAudio;if(tt(t.url,s))this.altAudio=1;else{if(this.mediaBuffer!==this.media){this.log("Switching on main audio, use media.buffered to schedule main fragment loading"),this.mediaBuffer=this.media;const e=this.fragCurrent;e&&(this.log("Switching to main audio track, cancel main fragment load"),e.abortRequests(),this.fragmentTracker.removeFragment(e)),this.resetTransmuxer(),this.resetLoadingState()}else this.audioOnly&&this.resetTransmuxer();if(i)return this.fragmentTracker.removeAllFragments(),s.once(l.BUFFER_FLUSHED,()=>{var e;null==(e=this.hls)||e.trigger(l.AUDIO_TRACK_SWITCHED,t)}),void s.trigger(l.BUFFER_FLUSHING,{startOffset:0,endOffset:Number.POSITIVE_INFINITY,type:null});s.trigger(l.AUDIO_TRACK_SWITCHED,t)}}onAudioTrackSwitched(e,t){const s=tt(t.url,this.hls);if(s){const e=this.videoBuffer;e&&this.mediaBuffer!==e&&(this.log("Switching on alternate audio, use video.buffered to schedule main fragment loading"),this.mediaBuffer=e)}this.altAudio=s?2:0,this.tick()}onBufferCreated(e,t){const s=t.tracks;let i,n,r=!1;for(const e in s){const t=s[e];if("main"===t.id){if(n=e,i=t,"video"===e){const t=s[e];t&&(this.videoBuffer=t.buffer)}}else r=!0}r&&i?(this.log(`Alternate track found, use ${n}.buffered to schedule main fragment loading`),this.mediaBuffer=i.buffer):this.mediaBuffer=this.media}onFragBuffered(e,t){const{frag:s,part:i}=t,n=s.type===f.MAIN;if(n){if(this.fragContextChanged(s))return this.warn(`Fragment ${s.sn}${i?" p: "+i.index:""} of level ${s.level} finished buffering, but was aborted. state: ${this.state}`),void(this.state===zs&&(this.state=Hs));const e=i?i.stats:s.stats;this.fragLastKbps=Math.round(8*e.total/(e.buffering.end-e.loading.first)),q(s)&&(this.fragPrevious=s),this.fragBufferedComplete(s,i)}const r=this.media;r&&(!this._hasEnoughToStart&&Nt.getBuffered(r).length&&(this._hasEnoughToStart=!0,this.seekToStartPos()),n&&this.tick())}get hasEnoughToStart(){return this._hasEnoughToStart}onError(e,t){var s;if(t.fatal)this.state=Zs;else switch(t.details){case o.FRAG_GAP:case o.FRAG_PARSING_ERROR:case o.FRAG_DECRYPT_ERROR:case o.FRAG_LOAD_ERROR:case o.FRAG_LOAD_TIMEOUT:case o.KEY_LOAD_ERROR:case o.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(f.MAIN,t);break;case o.LEVEL_LOAD_ERROR:case o.LEVEL_LOAD_TIMEOUT:case o.LEVEL_PARSING_ERROR:t.levelRetry||this.state!==Js||(null==(s=t.context)?void 0:s.type)!==c||(this.state=Hs);break;case o.BUFFER_ADD_CODEC_ERROR:case o.BUFFER_APPEND_ERROR:if("main"!==t.parent)return;this.reduceLengthAndFlushBuffer(t)&&this.resetLoadingState();break;case o.BUFFER_FULL_ERROR:if("main"!==t.parent)return;this.reduceLengthAndFlushBuffer(t)&&this.flushMainBuffer(0,Number.POSITIVE_INFINITY);break;case o.INTERNAL_EXCEPTION:this.recoverWorkerError(t)}}onFragLoadEmergencyAborted(){this.state=Hs,this._hasEnoughToStart||(this.startFragRequested=!1,this.nextLoadPosition=this.lastCurrentTime),this.tickImmediate()}onBufferFlushed(e,{type:t}){if(t!==j||!this.altAudio){const e=(t===H?this.videoBuffer:this.mediaBuffer)||this.media;e&&(this.afterBufferFlushed(e,t,f.MAIN),this.tick())}}onLevelsUpdated(e,t){this.level>-1&&this.fragCurrent&&(this.level=this.fragCurrent.level,-1===this.level&&this.resetWhenMissingContext(this.fragCurrent)),this.levels=t.levels}swapAudioCodec(){this.audioCodecSwap=!this.audioCodecSwap}seekToStartPos(){const{media:e}=this;if(!e)return;const t=e.currentTime;let s=this.startPosition;if(s>=0&&t<s){if(e.seeking)return void this.log(`could not seek to ${s}, already seeking at ${t}`);const i=this.timelineOffset;i&&s&&(s+=i);const n=this.getLevelDetails(),r=Nt.getBuffered(e),a=r.length?r.start(0):0,o=a-s,l=Math.max(this.config.maxBufferHole,this.config.maxFragLookUpTolerance);(this.config.startOnSegmentBoundary||o>0&&(o<l||this.loadingParts&&o<2*((null==n?void 0:n.partTarget)||0)))&&(this.log(`adjusting start position by ${o} to match buffer start`),s+=o,this.startPosition=s),t<s&&(this.log(`seek to target start position ${s} from current time ${t} buffer start ${a}`),e.currentTime=s)}}_getAudioCodec(e){let t=this.config.defaultAudioCodec||e.audioCodec;return this.audioCodecSwap&&t&&(this.log("Swapping audio codec"),t=-1!==t.indexOf("mp4a.40.5")?"mp4a.40.2":"mp4a.40.5"),t}_loadBitrateTestFrag(e,t){e.bitrateTest=!0,this._doFragLoad(e,t).then(e=>{const{hls:s}=this,i=null==e?void 0:e.frag;if(!i||this.fragContextChanged(i))return;t.fragmentError=0,this.state=Hs,this.startFragRequested=!1,this.bitrateTest=!1;const n=i.stats;n.parsing.start=n.parsing.end=n.buffering.start=n.buffering.end=self.performance.now(),s.trigger(l.FRAG_LOADED,e),i.bitrateTest=!1})}_handleTransmuxComplete(e){var t;const s=this.playlistType,{hls:n}=this,{remuxResult:r,chunkMeta:a}=e,o=this.getCurrentContext(a);if(!o)return void this.resetWhenMissingContext(a);const{frag:d,part:c,level:h}=o,{video:u,text:f,id3:g,initSegment:m}=r,{details:p}=h,y=this.altAudio?void 0:r.audio;if(this.fragContextChanged(d))this.fragmentTracker.removeFragment(d);else{if(this.state=Ws,m){if(null!=m&&m.tracks){const e=d.initSegment||d;this._bufferInitSegment(h,m.tracks,e,a),n.trigger(l.FRAG_PARSING_INIT_SEGMENT,{frag:e,id:s,tracks:m.tracks})}const e=m.initPTS,t=m.timescale,r=this.initPTS[d.cc];!i(e)||r&&r.baseTime===e&&r.timescale===t||(this.initPTS[d.cc]={baseTime:e,timescale:t},n.trigger(l.INIT_PTS_FOUND,{frag:d,id:s,initPTS:e,timescale:t}))}if(u&&p){y&&"audiovideo"===u.type&&this.logMuxedErr(d);const e=p.fragments[d.sn-1-p.startSN],t=d.sn===p.startSN,s=!e||d.cc>e.cc;if(!1!==r.independent){const{startPTS:e,endPTS:i,startDTS:n,endDTS:r}=u;if(c)c.elementaryStreams[u.type]={startPTS:e,endPTS:i,startDTS:n,endDTS:r};else if(u.firstKeyFrame&&u.independent&&1===a.id&&!s&&(this.couldBacktrack=!0),u.dropped&&u.independent){const n=this.getMainFwdBufferInfo(),a=(n?n.end:this.getLoadPosition())+this.config.maxBufferHole,o=u.firstKeyFramePTS?u.firstKeyFramePTS:e;if(!t&&a<o-this.config.maxBufferHole&&!s)return void this.backtrack(d);s&&(d.gap=!0),d.setElementaryStreamInfo(u.type,d.start,i,d.start,r,!0)}else t&&e-(p.appliedTimelineOffset||0)>2&&(d.gap=!0);d.setElementaryStreamInfo(u.type,e,i,n,r),this.backtrackFragment&&(this.backtrackFragment=d),this.bufferFragmentData(u,d,c,a,t||s)}else{if(!t&&!s)return void this.backtrack(d);d.gap=!0}}if(y){const{startPTS:e,endPTS:t,startDTS:s,endDTS:i}=y;c&&(c.elementaryStreams[j]={startPTS:e,endPTS:t,startDTS:s,endDTS:i}),d.setElementaryStreamInfo(j,e,t,s,i),this.bufferFragmentData(y,d,c,a)}if(p&&null!=g&&null!=(t=g.samples)&&t.length){const e={id:s,frag:d,details:p,samples:g.samples};n.trigger(l.FRAG_PARSING_METADATA,e)}if(p&&f){const e={id:s,frag:d,details:p,samples:f.samples};n.trigger(l.FRAG_PARSING_USERDATA,e)}}}logMuxedErr(e){this.warn(`${q(e)?"Media":"Init"} segment with muxed audiovideo where only video expected: ${e.url}`)}_bufferInitSegment(e,t,s,i){if(this.state!==Ws)return;this.audioOnly=!!t.audio&&!t.video,this.altAudio&&!this.audioOnly&&(delete t.audio,t.audiovideo&&this.logMuxedErr(s));const{audio:n,video:r,audiovideo:a}=t;if(n){const s=e.audioCodec;let i=ke(n.codec,s);"mp4a"===i&&(i="mp4a.40.5");const r=navigator.userAgent.toLowerCase();if(this.audioCodecSwitch){i&&(i=-1!==i.indexOf("mp4a.40.5")?"mp4a.40.2":"mp4a.40.5");const e=n.metadata;e&&"channelCount"in e&&1!==(e.channelCount||1)&&-1===r.indexOf("firefox")&&(i="mp4a.40.5")}i&&-1!==i.indexOf("mp4a.40.5")&&-1!==r.indexOf("android")&&"audio/mpeg"!==n.container&&(i="mp4a.40.2",this.log(`Android: force audio codec to ${i}`)),s&&s!==i&&this.log(`Swapping manifest audio codec "${s}" for "${i}"`),n.levelCodec=i,n.id=f.MAIN,this.log(`Init audio buffer, container:${n.container}, codecs[selected/level/parsed]=[${i||""}/${s||""}/${n.codec}]`),delete t.audiovideo}if(r){r.levelCodec=e.videoCodec,r.id=f.MAIN;const s=r.codec;if(4===(null==s?void 0:s.length))switch(s){case"hvc1":case"hev1":r.codec="hvc1.1.6.L120.90";break;case"av01":r.codec="av01.0.04M.08";break;case"avc1":r.codec="avc1.42e01e"}this.log(`Init video buffer, container:${r.container}, codecs[level/parsed]=[${e.videoCodec||""}/${s}]${r.codec!==s?" parsed-corrected="+r.codec:""}${r.supplemental?" supplemental="+r.supplemental:""}`),delete t.audiovideo}a&&(this.log(`Init audiovideo buffer, container:${a.container}, codecs[level/parsed]=[${e.codecs}/${a.codec}]`),delete t.video,delete t.audio);const o=Object.keys(t);if(o.length){if(this.hls.trigger(l.BUFFER_CODECS,t),!this.hls)return;o.forEach(e=>{const n=t[e].initSegment;null!=n&&n.byteLength&&this.hls.trigger(l.BUFFER_APPENDING,{type:e,data:n,frag:s,part:null,chunkMeta:i,parent:s.type})})}this.tickImmediate()}getMainFwdBufferInfo(){const e=this.mediaBuffer&&2===this.altAudio?this.mediaBuffer:this.media;return this.getFwdBufferInfo(e,f.MAIN)}get maxBufferLength(){const{levels:e,level:t}=this,s=null==e?void 0:e[t];return s?this.getMaxBufferLength(s.maxBitrate):this.config.maxBufferLength}backtrack(e){this.couldBacktrack=!0,this.backtrackFragment=e,this.resetTransmuxer(),this.flushBufferGap(e),this.fragmentTracker.removeFragment(e),this.fragPrevious=null,this.nextLoadPosition=e.start,this.state=Hs}checkFragmentChanged(){const e=this.media;let t=null;if(e&&e.readyState>1&&!1===e.seeking){const s=e.currentTime;if(Nt.isBuffered(e,s)?t=this.getAppendedFrag(s):Nt.isBuffered(e,s+.1)&&(t=this.getAppendedFrag(s+.1)),t){this.backtrackFragment=null;const e=this.fragPlaying,s=t.level;e&&t.sn===e.sn&&e.level===s||(this.fragPlaying=t,this.hls.trigger(l.FRAG_CHANGED,{frag:t}),e&&e.level===s||this.hls.trigger(l.LEVEL_SWITCHED,{level:s}))}}}get nextLevel(){const e=this.nextBufferedFrag;return e?e.level:-1}get currentFrag(){var e;if(this.fragPlaying)return this.fragPlaying;const t=(null==(e=this.media)?void 0:e.currentTime)||this.lastCurrentTime;return i(t)?this.getAppendedFrag(t):null}get currentProgramDateTime(){var e;const t=(null==(e=this.media)?void 0:e.currentTime)||this.lastCurrentTime;if(i(t)){const e=this.getLevelDetails(),s=this.currentFrag||(e?nt(null,e.fragments,t):null);if(s){const e=s.programDateTime;if(null!==e){const i=e+1e3*(t-s.start);return new Date(i)}}}return null}get currentLevel(){const e=this.currentFrag;return e?e.level:-1}get nextBufferedFrag(){const e=this.currentFrag;return e?this.followingBufferedFrag(e):null}get forceStartLoad(){return this._forceStartLoad}}class uo{constructor(e){this.config=void 0,this.keyUriToKeyInfo={},this.emeController=null,this.config=e}abort(e){for(const s in this.keyUriToKeyInfo){const i=this.keyUriToKeyInfo[s].loader;if(i){var t;if(e&&e!==(null==(t=i.context)?void 0:t.frag.type))return;i.abort()}}}detach(){for(const e in this.keyUriToKeyInfo){const t=this.keyUriToKeyInfo[e];(t.mediaKeySessionContext||t.decryptdata.isCommonEncryption)&&delete this.keyUriToKeyInfo[e]}}destroy(){this.detach();for(const e in this.keyUriToKeyInfo){const t=this.keyUriToKeyInfo[e].loader;t&&t.destroy()}this.keyUriToKeyInfo={}}createKeyLoadError(e,t=o.KEY_LOAD_ERROR,s,i,n){return new Pt({type:a.NETWORK_ERROR,details:t,fatal:!1,frag:e,response:n,error:s,networkDetails:i})}loadClear(e,t,s){if(this.emeController&&this.config.emeEnabled&&!this.emeController.getSelectedKeySystemFormats().length){if(t.length)for(let i=0,n=t.length;i<n;i++){const r=t[i];if(e.cc<=r.cc&&(!q(e)||!q(r)||e.sn<r.sn)||!s&&i==n-1)return this.emeController.selectKeySystemFormat(r).then(e=>{if(!this.emeController)return;r.setKeyFormat(e);const t=is(e);return t?this.emeController.getKeySystemAccess([t]):void 0})}if(this.config.requireKeySystemAccessOnStart){const e=rs(this.config);if(e.length)return this.emeController.getKeySystemAccess(e)}}return null}load(e){return!e.decryptdata&&e.encrypted&&this.emeController&&this.config.emeEnabled?this.emeController.selectKeySystemFormat(e).then(t=>this.loadInternal(e,t)):this.loadInternal(e)}loadInternal(e,t){var s,i;t&&e.setKeyFormat(t);const n=e.decryptdata;if(!n){const s=new Error(t?`Expected frag.decryptdata to be defined after setting format ${t}`:"Missing decryption data on fragment in onKeyLoading");return Promise.reject(this.createKeyLoadError(e,o.KEY_LOAD_ERROR,s))}const r=n.uri;if(!r)return Promise.reject(this.createKeyLoadError(e,o.KEY_LOAD_ERROR,new Error(`Invalid key URI: "${r}"`)));let a=this.keyUriToKeyInfo[r];if(null!=(s=a)&&s.decryptdata.key)return n.key=a.decryptdata.key,Promise.resolve({frag:e,keyInfo:a});var l;if(null!=(i=a)&&i.keyLoadPromise)switch(null==(l=a.mediaKeySessionContext)?void 0:l.keyStatus){case void 0:case"status-pending":case"usable":case"usable-in-future":return a.keyLoadPromise.then(t=>(n.key=t.keyInfo.decryptdata.key,{frag:e,keyInfo:a}))}switch(a=this.keyUriToKeyInfo[r]={decryptdata:n,keyLoadPromise:null,loader:null,mediaKeySessionContext:null},n.method){case"ISO-23001-7":case"SAMPLE-AES":case"SAMPLE-AES-CENC":case"SAMPLE-AES-CTR":return"identity"===n.keyFormat?this.loadKeyHTTP(a,e):this.loadKeyEME(a,e);case"AES-128":case"AES-256":case"AES-256-CTR":return this.loadKeyHTTP(a,e);default:return Promise.reject(this.createKeyLoadError(e,o.KEY_LOAD_ERROR,new Error(`Key supplied with unsupported METHOD: "${n.method}"`)))}}loadKeyEME(e,t){const s={frag:t,keyInfo:e};if(this.emeController&&this.config.emeEnabled){const t=this.emeController.loadKey(s);if(t)return(e.keyLoadPromise=t.then(t=>(e.mediaKeySessionContext=t,s))).catch(t=>{throw e.keyLoadPromise=null,t})}return Promise.resolve(s)}loadKeyHTTP(e,t){const s=this.config,i=new(0,s.loader)(s);return t.keyLoader=e.loader=i,e.keyLoadPromise=new Promise((n,r)=>{const a={keyInfo:e,frag:t,responseType:"arraybuffer",url:e.decryptdata.uri},l=s.keyLoadPolicy.default,d={loadPolicy:l,timeout:l.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},c={onSuccess:(e,t,s,i)=>{const{frag:a,keyInfo:l,url:d}=s;if(!a.decryptdata||l!==this.keyUriToKeyInfo[d])return r(this.createKeyLoadError(a,o.KEY_LOAD_ERROR,new Error("after key load, decryptdata unset or changed"),i));l.decryptdata.key=a.decryptdata.key=new Uint8Array(e.data),a.keyLoader=null,l.loader=null,n({frag:a,keyInfo:l})},onError:(e,s,i,n)=>{this.resetLoader(s),r(this.createKeyLoadError(t,o.KEY_LOAD_ERROR,new Error(`HTTP Error ${e.code} loading key ${e.text}`),i,E({url:a.url,data:void 0},e)))},onTimeout:(e,s,i)=>{this.resetLoader(s),r(this.createKeyLoadError(t,o.KEY_LOAD_TIMEOUT,new Error("key loading timed out"),i))},onAbort:(e,s,i)=>{this.resetLoader(s),r(this.createKeyLoadError(t,o.INTERNAL_ABORTED,new Error("key loading aborted"),i))}};i.load(a,d,c)})}resetLoader(e){const{frag:t,keyInfo:s,url:i}=e,n=s.loader;t.keyLoader===n&&(t.keyLoader=null,s.loader=null),delete this.keyUriToKeyInfo[i],n&&n.destroy()}}function fo(e){const{type:t}=e;switch(t){case h:return f.AUDIO;case u:return f.SUBTITLE;default:return f.MAIN}}function go(e,t){let s=e.url;return void 0!==s&&0!==s.indexOf("data:")||(s=t.url),s}class mo{constructor(e){this.hls=void 0,this.loaders=Object.create(null),this.variableList=null,this.onManifestLoaded=this.checkAutostartLoad,this.hls=e,this.registerListeners()}startLoad(e){}stopLoad(){this.destroyInternalLoaders()}registerListeners(){const{hls:e}=this;e.on(l.MANIFEST_LOADING,this.onManifestLoading,this),e.on(l.LEVEL_LOADING,this.onLevelLoading,this),e.on(l.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),e.on(l.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this),e.on(l.LEVELS_UPDATED,this.onLevelsUpdated,this)}unregisterListeners(){const{hls:e}=this;e.off(l.MANIFEST_LOADING,this.onManifestLoading,this),e.off(l.LEVEL_LOADING,this.onLevelLoading,this),e.off(l.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),e.off(l.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this),e.off(l.LEVELS_UPDATED,this.onLevelsUpdated,this)}createInternalLoader(e){const t=this.hls.config,s=t.pLoader,i=t.loader,n=new(s||i)(t);return this.loaders[e.type]=n,n}getInternalLoader(e){return this.loaders[e.type]}resetInternalLoader(e){this.loaders[e]&&delete this.loaders[e]}destroyInternalLoaders(){for(const e in this.loaders){const t=this.loaders[e];t&&t.destroy(),this.resetInternalLoader(e)}}destroy(){this.variableList=null,this.unregisterListeners(),this.destroyInternalLoaders()}onManifestLoading(e,t){const{url:s}=t;this.variableList=null,this.load({id:null,level:0,responseType:"text",type:d,url:s,deliveryDirectives:null,levelOrTrack:null})}onLevelLoading(e,t){const{id:s,level:i,pathwayId:n,url:r,deliveryDirectives:a,levelInfo:o}=t;this.load({id:s,level:i,pathwayId:n,responseType:"text",type:c,url:r,deliveryDirectives:a,levelOrTrack:o})}onAudioTrackLoading(e,t){const{id:s,groupId:i,url:n,deliveryDirectives:r,track:a}=t;this.load({id:s,groupId:i,level:null,responseType:"text",type:h,url:n,deliveryDirectives:r,levelOrTrack:a})}onSubtitleTrackLoading(e,t){const{id:s,groupId:i,url:n,deliveryDirectives:r,track:a}=t;this.load({id:s,groupId:i,level:null,responseType:"text",type:u,url:n,deliveryDirectives:r,levelOrTrack:a})}onLevelsUpdated(e,t){const s=this.loaders[c];if(s){const e=s.context;e&&!t.levels.some(t=>t===e.levelOrTrack)&&(s.abort(),delete this.loaders[c])}}load(e){var t;const s=this.hls.config;let n,r=this.getInternalLoader(e);if(r){const t=this.hls.logger,s=r.context;if(s&&s.levelOrTrack===e.levelOrTrack&&(s.url===e.url||s.deliveryDirectives&&!e.deliveryDirectives))return void(s.url===e.url?t.log(`[playlist-loader]: ignore ${e.url} ongoing request`):t.log(`[playlist-loader]: ignore ${e.url} in favor of ${s.url}`));t.log(`[playlist-loader]: aborting previous loader for type: ${e.type}`),r.abort()}if(n=e.type===d?s.manifestLoadPolicy.default:y({},s.playlistLoadPolicy.default,{timeoutRetry:null,errorRetry:null}),r=this.createInternalLoader(e),i(null==(t=e.deliveryDirectives)?void 0:t.part)){let t;if(e.type===c&&null!==e.level?t=this.hls.levels[e.level].details:e.type===h&&null!==e.id?t=this.hls.audioTracks[e.id].details:e.type===u&&null!==e.id&&(t=this.hls.subtitleTracks[e.id].details),t){const e=t.partTarget,s=t.targetduration;if(e&&s){const t=1e3*Math.max(3*e,.8*s);n=y({},n,{maxTimeToFirstByteMs:Math.min(t,n.maxTimeToFirstByteMs),maxLoadTimeMs:Math.min(t,n.maxTimeToFirstByteMs)})}}}const a=n.errorRetry||n.timeoutRetry||{},o={loadPolicy:n,timeout:n.maxLoadTimeMs,maxRetry:a.maxNumRetry||0,retryDelay:a.retryDelayMs||0,maxRetryDelay:a.maxRetryDelayMs||0},l={onSuccess:(e,t,s,i)=>{const n=this.getInternalLoader(s);this.resetInternalLoader(s.type);const r=e.data;0===r.indexOf("#EXTM3U")?(t.parsing.start=performance.now(),ms.isMediaPlaylist(r)||s.type!==d?this.handleTrackOrLevelPlaylist(e,t,s,i||null,n):this.handleMasterPlaylist(e,t,s,i)):this.handleManifestParsingError(e,s,new Error("no EXTM3U delimiter"),i||null,t)},onError:(e,t,s,i)=>{this.handleNetworkError(t,s,!1,e,i)},onTimeout:(e,t,s)=>{this.handleNetworkError(t,s,!0,void 0,e)}};r.load(e,o,l)}checkAutostartLoad(){if(!this.hls)return;const{config:{autoStartLoad:e,startPosition:t},forceStartLoad:s}=this.hls;(e||s)&&(this.hls.logger.log(`${e?"auto":"force"} startLoad with configured startPosition ${t}`),this.hls.startLoad(t))}handleMasterPlaylist(e,t,s,i){const n=this.hls,r=e.data,a=go(e,s),o=ms.parseMasterPlaylist(r,a);if(o.playlistParsingError)return void this.handleManifestParsingError(e,s,o.playlistParsingError,i,t);const{contentSteering:d,levels:c,sessionData:h,sessionKeys:u,startTimeOffset:f,variableList:g}=o;this.variableList=g;const{AUDIO:m=[],SUBTITLES:p,"CLOSED-CAPTIONS":y}=ms.parseMasterPlaylistMedia(r,a,o);m.length&&(m.some(e=>!e.url)||!c[0].audioCodec||c[0].attrs.AUDIO||(this.hls.logger.log("[playlist-loader]: audio codec signaled in quality level, but no embedded audio track signaled, create one"),m.unshift({type:"main",name:"main",groupId:"main",default:!1,autoselect:!1,forced:!1,id:-1,attrs:new Kt({}),bitrate:0,url:""}))),n.trigger(l.MANIFEST_LOADED,{levels:c,audioTracks:m,subtitles:p,captions:y,contentSteering:d,url:a,stats:t,networkDetails:i,sessionData:h,sessionKeys:u,startTimeOffset:f,variableList:g})}handleTrackOrLevelPlaylist(e,t,s,n,r){const a=this.hls,{id:o,level:c,type:h}=s,u=go(e,s),f=i(c)?c:i(o)?o:0,g=fo(s),m=ms.parseLevelPlaylist(e.data,u,f,g,0,this.variableList);if(h===d){const e={attrs:new Kt({}),bitrate:0,details:m,name:"",url:u};m.requestScheduled=t.loading.start+Cs(m,0),a.trigger(l.MANIFEST_LOADED,{levels:[e],audioTracks:[],url:u,stats:t,networkDetails:n,sessionData:null,sessionKeys:null,contentSteering:null,startTimeOffset:null,variableList:null})}t.parsing.end=performance.now(),s.levelDetails=m,this.handlePlaylistLoaded(m,e,t,s,n,r)}handleManifestParsingError(e,t,s,i,n){this.hls.trigger(l.ERROR,{type:a.NETWORK_ERROR,details:o.MANIFEST_PARSING_ERROR,fatal:t.type===d,url:e.url,err:s,error:s,reason:s.message,response:e,context:t,networkDetails:i,stats:n})}handleNetworkError(e,t,s=!1,i,n){let r=`A network ${s?"timeout":"error"+(i?" (status "+i.code+")":"")} occurred while loading ${e.type}`;e.type===c?r+=`: ${e.level} id: ${e.id}`:e.type!==h&&e.type!==u||(r+=` id: ${e.id} group-id: "${e.groupId}"`);const f=new Error(r);this.hls.logger.warn(`[playlist-loader]: ${r}`);let g=o.UNKNOWN,m=!1;const p=this.getInternalLoader(e);switch(e.type){case d:g=s?o.MANIFEST_LOAD_TIMEOUT:o.MANIFEST_LOAD_ERROR,m=!0;break;case c:g=s?o.LEVEL_LOAD_TIMEOUT:o.LEVEL_LOAD_ERROR,m=!1;break;case h:g=s?o.AUDIO_TRACK_LOAD_TIMEOUT:o.AUDIO_TRACK_LOAD_ERROR,m=!1;break;case u:g=s?o.SUBTITLE_TRACK_LOAD_TIMEOUT:o.SUBTITLE_LOAD_ERROR,m=!1}p&&this.resetInternalLoader(e.type);const y={type:a.NETWORK_ERROR,details:g,fatal:m,url:e.url,loader:p,context:e,error:f,networkDetails:t,stats:n};if(i){const s=(null==t?void 0:t.url)||e.url;y.response=E({url:s,data:void 0},i)}this.hls.trigger(l.ERROR,y)}handlePlaylistLoaded(e,t,s,i,n,r){const g=this.hls,{type:m,level:p,id:y,groupId:v,deliveryDirectives:E}=i,T=go(t,i),S=fo(i),b="number"==typeof i.level&&S===f.MAIN?p:void 0;if(!e.fragments.length){const r=e.playlistParsingError=new Error("No Segments found in Playlist");return void g.trigger(l.ERROR,{type:a.NETWORK_ERROR,details:o.LEVEL_EMPTY_ERROR,fatal:!1,url:T,error:r,reason:r.message,response:t,context:i,level:b,parent:S,networkDetails:n,stats:s})}e.targetduration||(e.playlistParsingError=new Error("Missing Target Duration"));const A=e.playlistParsingError;if(A){if(this.hls.logger.warn(A),!g.config.ignorePlaylistParsingErrors)return void g.trigger(l.ERROR,{type:a.NETWORK_ERROR,details:o.LEVEL_PARSING_ERROR,fatal:!1,url:T,error:A,reason:A.message,response:t,context:i,level:b,parent:S,networkDetails:n,stats:s});e.playlistParsingError=null}switch(e.live&&r&&(r.getCacheAge&&(e.ageHeader=r.getCacheAge()||0),r.getCacheAge&&!isNaN(e.ageHeader)||(e.ageHeader=0)),m){case d:case c:g.trigger(l.LEVEL_LOADED,{details:e,levelInfo:i.levelOrTrack||g.levels[0],level:b||0,id:y||0,stats:s,networkDetails:n,deliveryDirectives:E,withoutMultiVariant:m===d});break;case h:g.trigger(l.AUDIO_TRACK_LOADED,{details:e,track:i.levelOrTrack,id:y||0,groupId:v||"",stats:s,networkDetails:n,deliveryDirectives:E});break;case u:g.trigger(l.SUBTITLE_TRACK_LOADED,{details:e,track:i.levelOrTrack,id:y||0,groupId:v||"",stats:s,networkDetails:n,deliveryDirectives:E})}}}class po{static get version(){return oi}static isMSESupported(){return lo()}static isSupported(){return co()}static getMediaSource(){return I()}static get Events(){return l}static get MetadataSchema(){return ki}static get ErrorTypes(){return a}static get ErrorDetails(){return o}static get DefaultConfig(){return po.defaultConfig?po.defaultConfig:za}static set DefaultConfig(e){po.defaultConfig=e}constructor(e={}){this.config=void 0,this.userConfig=void 0,this.logger=void 0,this.coreComponents=void 0,this.networkControllers=void 0,this._emitter=new ai,this._autoLevelCapping=-1,this._maxHdcpLevel=null,this.abrController=void 0,this.bufferController=void 0,this.capLevelController=void 0,this.latencyController=void 0,this.levelController=void 0,this.streamController=void 0,this.audioStreamController=void 0,this.subtititleStreamController=void 0,this.audioTrackController=void 0,this.subtitleTrackController=void 0,this.interstitialsController=void 0,this.gapController=void 0,this.emeController=void 0,this.cmcdController=void 0,this._media=null,this._url=null,this._sessionId=void 0,this.triggeringException=void 0,this.started=!1;const t=this.logger=function(e,t,s){const i=A();if("object"==typeof console&&!0===e||"object"==typeof e){const t=["debug","log","info","warn","error"];t.forEach(t=>{i[t]=L(t,e,s)});try{i.log('Debug logs enabled for "Hls instance" in hls.js version 1.6.7')}catch(e){return A()}t.forEach(t=>{w[t]=L(t,e)})}else y(w,i);return i}(e.debug||!1,0,e.assetPlayerId),s=this.config=function(e,t,s){if((t.liveSyncDurationCount||t.liveMaxLatencyDurationCount)&&(t.liveSyncDuration||t.liveMaxLatencyDuration))throw new Error("Illegal hls.js config: don't mix up liveSyncDurationCount/liveMaxLatencyDurationCount and liveSyncDuration/liveMaxLatencyDuration");if(void 0!==t.liveMaxLatencyDurationCount&&(void 0===t.liveSyncDurationCount||t.liveMaxLatencyDurationCount<=t.liveSyncDurationCount))throw new Error('Illegal hls.js config: "liveMaxLatencyDurationCount" must be greater than "liveSyncDurationCount"');if(void 0!==t.liveMaxLatencyDuration&&(void 0===t.liveSyncDuration||t.liveMaxLatencyDuration<=t.liveSyncDuration))throw new Error('Illegal hls.js config: "liveMaxLatencyDuration" must be greater than "liveSyncDuration"');const i=Xa(e),n=["TimeOut","MaxRetry","RetryDelay","MaxRetryTimeout"];return["manifest","level","frag"].forEach(e=>{const r=`${"level"===e?"playlist":e}LoadPolicy`,a=void 0===t[r],o=[];n.forEach(s=>{const n=`${e}Loading${s}`,l=t[n];if(void 0!==l&&a){o.push(n);const e=i[r].default;switch(t[r]={default:e},s){case"TimeOut":e.maxLoadTimeMs=l,e.maxTimeToFirstByteMs=l;break;case"MaxRetry":e.errorRetry.maxNumRetry=l,e.timeoutRetry.maxNumRetry=l;break;case"RetryDelay":e.errorRetry.retryDelayMs=l,e.timeoutRetry.retryDelayMs=l;break;case"MaxRetryTimeout":e.errorRetry.maxRetryDelayMs=l,e.timeoutRetry.maxRetryDelayMs=l}}}),o.length&&s.warn(`hls.js config: "${o.join('", "')}" setting(s) are deprecated, use "${r}": ${Ye(t[r])}`)}),E(E({},i),t)}(po.DefaultConfig,e,t);this.userConfig=e,s.progressive&&function(e,t){const s=e.loader;s!==Va&&s!==Wa?(t.log("[config]: Custom loader detected, cannot enable progressive streaming"),e.progressive=!1):ja()&&(e.loader=Va,e.progressive=!0,e.enableSoftwareAES=!0,t.log("[config]: Progressive streaming enabled, using FetchLoader"))}(s,t);const{abrController:i,bufferController:n,capLevelController:r,errorController:a,fpsController:o}=s,d=new a(this),c=this.abrController=new i(this),h=new St(this),u=s.interstitialsController,f=u?this.interstitialsController=new u(this,po):null,g=this.bufferController=new n(this,h),m=this.capLevelController=new r(this),p=new o(this),v=new mo(this),T=s.contentSteeringController,S=T?new T(this):null,b=this.levelController=new ro(this,S),R=new io(this),I=new uo(this.config),x=this.streamController=new ho(this,h,I),k=this.gapController=new Za(this,h);m.setStreamController(x),p.setStreamController(x);const D=[v,b,x];f&&D.splice(1,0,f),S&&D.splice(1,0,S),this.networkControllers=D;const _=[c,g,k,m,p,R,h];this.audioTrackController=this.createController(s.audioTrackController,D);const C=s.audioStreamController;C&&D.push(this.audioStreamController=new C(this,h,I)),this.subtitleTrackController=this.createController(s.subtitleTrackController,D);const P=s.subtitleStreamController;P&&D.push(this.subtititleStreamController=new P(this,h,I)),this.createController(s.timelineController,_),I.emeController=this.emeController=this.createController(s.emeController,_),this.cmcdController=this.createController(s.cmcdController,_),this.latencyController=this.createController(no,_),this.coreComponents=_,D.push(d);const M=d.onErrorOut;"function"==typeof M&&this.on(l.ERROR,M,d),this.on(l.MANIFEST_LOADED,v.onManifestLoaded,v)}createController(e,t){if(e){const s=new e(this);return t&&t.push(s),s}return null}on(e,t,s=this){this._emitter.on(e,t,s)}once(e,t,s=this){this._emitter.once(e,t,s)}removeAllListeners(e){this._emitter.removeAllListeners(e)}off(e,t,s=this,i){this._emitter.off(e,t,s,i)}listeners(e){return this._emitter.listeners(e)}emit(e,t,s){return this._emitter.emit(e,t,s)}trigger(e,t){if(this.config.debug)return this.emit(e,e,t);try{return this.emit(e,e,t)}catch(t){if(this.logger.error("An internal error happened while handling event "+e+'. Error message: "'+t.message+'". Here is a stacktrace:',t),!this.triggeringException){this.triggeringException=!0;const s=e===l.ERROR;this.trigger(l.ERROR,{type:a.OTHER_ERROR,details:o.INTERNAL_EXCEPTION,fatal:s,event:e,error:t}),this.triggeringException=!1}}return!1}listenerCount(e){return this._emitter.listenerCount(e)}destroy(){this.logger.log("destroy"),this.trigger(l.DESTROYING,void 0),this.detachMedia(),this.removeAllListeners(),this._autoLevelCapping=-1,this._url=null,this.networkControllers.forEach(e=>e.destroy()),this.networkControllers.length=0,this.coreComponents.forEach(e=>e.destroy()),this.coreComponents.length=0;const e=this.config;e.xhrSetup=e.fetchSetup=void 0,this.userConfig=null}attachMedia(e){if(!e||"media"in e&&!e.media){const t=new Error(`attachMedia failed: invalid argument (${e})`);return void this.trigger(l.ERROR,{type:a.OTHER_ERROR,details:o.ATTACH_MEDIA_ERROR,fatal:!0,error:t})}this.logger.log("attachMedia"),this._media&&(this.logger.warn("media must be detached before attaching"),this.detachMedia());const t="media"in e,s=t?e.media:e,i=t?e:{media:s};this._media=s,this.trigger(l.MEDIA_ATTACHING,i)}detachMedia(){this.logger.log("detachMedia"),this.trigger(l.MEDIA_DETACHING,{}),this._media=null}transferMedia(){this._media=null;const e=this.bufferController.transferMedia();return this.trigger(l.MEDIA_DETACHING,{transferMedia:e}),e}loadSource(e){this.stopLoad();const t=this.media,s=this._url,i=this._url=$.buildAbsoluteURL(self.location.href,e,{alwaysNormalize:!0});this._autoLevelCapping=-1,this._maxHdcpLevel=null,this.logger.log(`loadSource:${i}`),t&&s&&(s!==i||this.bufferController.hasSourceTypes())&&(this.detachMedia(),this.attachMedia(t)),this.trigger(l.MANIFEST_LOADING,{url:e})}get url(){return this._url}get hasEnoughToStart(){return this.streamController.hasEnoughToStart}get startPosition(){return this.streamController.startPositionValue}startLoad(e=-1,t){this.logger.log(`startLoad(${e+(t?", <skip seek to start>":"")})`),this.started=!0,this.resumeBuffering();for(let s=0;s<this.networkControllers.length&&(this.networkControllers[s].startLoad(e,t),this.started&&this.networkControllers);s++);}stopLoad(){this.logger.log("stopLoad"),this.started=!1;for(let e=0;e<this.networkControllers.length&&(this.networkControllers[e].stopLoad(),!this.started&&this.networkControllers);e++);}get loadingEnabled(){return this.started}get bufferingEnabled(){return this.streamController.bufferingEnabled}resumeBuffering(){this.bufferingEnabled||(this.logger.log("resume buffering"),this.networkControllers.forEach(e=>{e.resumeBuffering&&e.resumeBuffering()}))}pauseBuffering(){this.bufferingEnabled&&(this.logger.log("pause buffering"),this.networkControllers.forEach(e=>{e.pauseBuffering&&e.pauseBuffering()}))}get inFlightFragments(){const e={[f.MAIN]:this.streamController.inFlightFrag};return this.audioStreamController&&(e[f.AUDIO]=this.audioStreamController.inFlightFrag),this.subtititleStreamController&&(e[f.SUBTITLE]=this.subtititleStreamController.inFlightFrag),e}swapAudioCodec(){this.logger.log("swapAudioCodec"),this.streamController.swapAudioCodec()}recoverMediaError(){this.logger.log("recoverMediaError");const e=this._media,t=null==e?void 0:e.currentTime;this.detachMedia(),e&&(this.attachMedia(e),t&&this.startLoad(t))}removeLevel(e){this.levelController.removeLevel(e)}get sessionId(){let e=this._sessionId;return e||(e=this._sessionId=function(){try{return crypto.randomUUID()}catch(e){try{const e=URL.createObjectURL(new Blob),t=e.toString();return URL.revokeObjectURL(e),t.slice(t.lastIndexOf("/")+1)}catch(e){let t=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const s=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"==e?s:3&s|8).toString(16)})}}}()),e}get levels(){return this.levelController.levels||[]}get latestLevelDetails(){return this.streamController.getLevelDetails()||null}get loadLevelObj(){return this.levelController.loadLevelObj}get currentLevel(){return this.streamController.currentLevel}set currentLevel(e){this.logger.log(`set currentLevel:${e}`),this.levelController.manualLevel=e,this.streamController.immediateLevelSwitch()}get nextLevel(){return this.streamController.nextLevel}set nextLevel(e){this.logger.log(`set nextLevel:${e}`),this.levelController.manualLevel=e,this.streamController.nextLevelSwitch()}get loadLevel(){return this.levelController.level}set loadLevel(e){this.logger.log(`set loadLevel:${e}`),this.levelController.manualLevel=e}get nextLoadLevel(){return this.levelController.nextLoadLevel}set nextLoadLevel(e){this.levelController.nextLoadLevel=e}get firstLevel(){return Math.max(this.levelController.firstLevel,this.minAutoLevel)}set firstLevel(e){this.logger.log(`set firstLevel:${e}`),this.levelController.firstLevel=e}get startLevel(){const e=this.levelController.startLevel;return-1===e&&this.abrController.forcedAutoLevel>-1?this.abrController.forcedAutoLevel:e}set startLevel(e){this.logger.log(`set startLevel:${e}`),-1!==e&&(e=Math.max(e,this.minAutoLevel)),this.levelController.startLevel=e}get capLevelToPlayerSize(){return this.config.capLevelToPlayerSize}set capLevelToPlayerSize(e){const t=!!e;t!==this.config.capLevelToPlayerSize&&(t?this.capLevelController.startCapping():(this.capLevelController.stopCapping(),this.autoLevelCapping=-1,this.streamController.nextLevelSwitch()),this.config.capLevelToPlayerSize=t)}get autoLevelCapping(){return this._autoLevelCapping}get bandwidthEstimate(){const{bwEstimator:e}=this.abrController;return e?e.getEstimate():NaN}set bandwidthEstimate(e){this.abrController.resetEstimator(e)}get abrEwmaDefaultEstimate(){const{bwEstimator:e}=this.abrController;return e?e.defaultEstimate:NaN}get ttfbEstimate(){const{bwEstimator:e}=this.abrController;return e?e.getEstimateTTFB():NaN}set autoLevelCapping(e){this._autoLevelCapping!==e&&(this.logger.log(`set autoLevelCapping:${e}`),this._autoLevelCapping=e,this.levelController.checkMaxAutoUpdated())}get maxHdcpLevel(){return this._maxHdcpLevel}set maxHdcpLevel(e){(function(e){return $e.indexOf(e)>-1})(e)&&this._maxHdcpLevel!==e&&(this._maxHdcpLevel=e,this.levelController.checkMaxAutoUpdated())}get autoLevelEnabled(){return-1===this.levelController.manualLevel}get manualLevel(){return this.levelController.manualLevel}get minAutoLevel(){const{levels:e,config:{minAutoBitrate:t}}=this;if(!e)return 0;const s=e.length;for(let i=0;i<s;i++)if(e[i].maxBitrate>=t)return i;return 0}get maxAutoLevel(){const{levels:e,autoLevelCapping:t,maxHdcpLevel:s}=this;let i;if(i=-1===t&&null!=e&&e.length?e.length-1:t,s)for(let t=i;t--;){const i=e[t].attrs["HDCP-LEVEL"];if(i&&i<=s)return t}return i}get firstAutoLevel(){return this.abrController.firstAutoLevel}get nextAutoLevel(){return this.abrController.nextAutoLevel}set nextAutoLevel(e){this.abrController.nextAutoLevel=e}get playingDate(){return this.streamController.currentProgramDateTime}get mainForwardBufferInfo(){return this.streamController.getMainFwdBufferInfo()}get maxBufferLength(){return this.streamController.maxBufferLength}setAudioOption(e){var t;return(null==(t=this.audioTrackController)?void 0:t.setAudioOption(e))||null}setSubtitleOption(e){var t;return(null==(t=this.subtitleTrackController)?void 0:t.setSubtitleOption(e))||null}get allAudioTracks(){const e=this.audioTrackController;return e?e.allAudioTracks:[]}get audioTracks(){const e=this.audioTrackController;return e?e.audioTracks:[]}get audioTrack(){const e=this.audioTrackController;return e?e.audioTrack:-1}set audioTrack(e){const t=this.audioTrackController;t&&(t.audioTrack=e)}get allSubtitleTracks(){const e=this.subtitleTrackController;return e?e.allSubtitleTracks:[]}get subtitleTracks(){const e=this.subtitleTrackController;return e?e.subtitleTracks:[]}get subtitleTrack(){const e=this.subtitleTrackController;return e?e.subtitleTrack:-1}get media(){return this._media}set subtitleTrack(e){const t=this.subtitleTrackController;t&&(t.subtitleTrack=e)}get subtitleDisplay(){const e=this.subtitleTrackController;return!!e&&e.subtitleDisplay}set subtitleDisplay(e){const t=this.subtitleTrackController;t&&(t.subtitleDisplay=e)}get lowLatencyMode(){return this.config.lowLatencyMode}set lowLatencyMode(e){this.config.lowLatencyMode=e}get liveSyncPosition(){return this.latencyController.liveSyncPosition}get latency(){return this.latencyController.latency}get maxLatency(){return this.latencyController.maxLatency}get targetLatency(){return this.latencyController.targetLatency}set targetLatency(e){this.latencyController.targetLatency=e}get drift(){return this.latencyController.drift}get forceStartLoad(){return this.streamController.forceStartLoad}get pathways(){return this.levelController.pathways}get pathwayPriority(){return this.levelController.pathwayPriority}set pathwayPriority(e){this.levelController.pathwayPriority=e}get bufferedToEnd(){var e;return!(null==(e=this.bufferController)||!e.bufferedToEnd)}get interstitialsManager(){var e;return(null==(e=this.interstitialsController)?void 0:e.interstitialsManager)||null}getMediaDecodingInfo(e,t=this.allAudioTracks){return Ne(e,ze(t),navigator.mediaCapabilities)}}po.defaultConfig=void 0},"./node_modules/style-loader/dist/runtime/injectStylesIntoStyleTag.js":e=>{var t=[];function s(e){for(var s=-1,i=0;i<t.length;i++)if(t[i].identifier===e){s=i;break}return s}function i(e,i){for(var r={},a=[],o=0;o<e.length;o++){var l=e[o],d=i.base?l[0]+i.base:l[0],c=r[d]||0,h="".concat(d," ").concat(c);r[d]=c+1;var u=s(h),f={css:l[1],media:l[2],sourceMap:l[3],supports:l[4],layer:l[5]};if(-1!==u)t[u].references++,t[u].updater(f);else{var g=n(f,i);i.byIndex=o,t.splice(o,0,{identifier:h,updater:g,references:1})}a.push(h)}return a}function n(e,t){var s=t.domAPI(t);return s.update(e),function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap&&t.supports===e.supports&&t.layer===e.layer)return;s.update(e=t)}else s.remove()}}e.exports=function(e,n){var r=i(e=e||[],n=n||{});return function(e){e=e||[];for(var a=0;a<r.length;a++){var o=s(r[a]);t[o].references--}for(var l=i(e,n),d=0;d<r.length;d++){var c=s(r[d]);0===t[c].references&&(t[c].updater(),t.splice(c,1))}r=l}}},"./node_modules/style-loader/dist/runtime/insertBySelector.js":e=>{var t={};e.exports=function(e,s){var i=function(e){if(void 0===t[e]){var s=document.querySelector(e);if(window.HTMLIFrameElement&&s instanceof window.HTMLIFrameElement)try{s=s.contentDocument.head}catch(e){s=null}t[e]=s}return t[e]}(e);if(!i)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");i.appendChild(s)}},"./node_modules/style-loader/dist/runtime/insertStyleElement.js":e=>{e.exports=function(e){var t=document.createElement("style");return e.setAttributes(t,e.attributes),e.insert(t,e.options),t}},"./node_modules/style-loader/dist/runtime/setAttributesWithoutAttributes.js":(e,t,s)=>{e.exports=function(e){var t=s.nc;t&&e.setAttribute("nonce",t)}},"./node_modules/style-loader/dist/runtime/styleDomAPI.js":e=>{e.exports=function(e){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var t=e.insertStyleElement(e);return{update:function(s){!function(e,t,s){var i="";s.supports&&(i+="@supports (".concat(s.supports,") {")),s.media&&(i+="@media ".concat(s.media," {"));var n=void 0!==s.layer;n&&(i+="@layer".concat(s.layer.length>0?" ".concat(s.layer):""," {")),i+=s.css,n&&(i+="}"),s.media&&(i+="}"),s.supports&&(i+="}");var r=s.sourceMap;r&&"undefined"!=typeof btoa&&(i+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(r))))," */")),t.styleTagTransform(i,e,t.options)}(t,e,s)},remove:function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(t)}}}},"./node_modules/style-loader/dist/runtime/styleTagTransform.js":e=>{e.exports=function(e,t){if(t.styleSheet)t.styleSheet.cssText=e;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(e))}}},"./src/js/components/chat/chat.js":(e,t,s)=>{s.r(t),s.d(t,{renderChatHistory:()=>i});const i=()=>{const e=document.createElement("div");e.id="widget-chat-history",e.className="widget-chat-history",e.style.height="100%",e.style.overflowY="auto",e.style.padding="10px",e.style.boxSizing="border-box",e.style.display="flex",e.style.flexDirection="column";const t=document.createElement("div");t.className="chat-message bot",t.id="typing-indicator",t.innerHTML='\n    <div class="chat-bubble typing-bubble">\n      <span class="dot"></span>\n      <span class="dot"></span>\n      <span class="dot"></span>\n    </div>\n  ';let s=[];try{const e=sessionStorage.getItem("conversation_history");if(console.log("ðŸ” Loading conversation history:",e),e){const t=JSON.parse(e);console.log("ðŸ” Parsed conversation data:",t),Array.isArray(t)?(s=t.filter(e=>e.text&&""!==e.text.trim()),console.log("ðŸ” Using array format, filtered messages:",s)):"object"==typeof t&&null!==t&&(s=(i=t)&&"object"==typeof i?Object.keys(i).sort((e,t)=>parseInt(e.split("_")[1],10)-parseInt(t.split("_")[1],10)).map(e=>({sender:e.startsWith("user")?"user":"bot",text:i[e]})).filter(e=>e.text&&""!==e.text.trim()):[],console.log("ðŸ” Using object format, converted messages:",s))}}catch(e){console.warn("Could not parse conversation_history from sessionStorage:",e)}var i;return 0===s.length&&(console.log("ðŸ” No conversation history found, showing default message"),s=[{sender:"bot",text:"Hi there! How can I help you today?"}]),console.log("ðŸ” Final messages to render:",s),s.forEach(({sender:t,text:s})=>{const i=document.createElement("div");i.className=`chat-message ${t}`,i.innerHTML=`\n      <div class="chat-bubble">${s}</div>\n    `,e.appendChild(i)}),setTimeout(()=>{e.scrollTop=e.scrollHeight},0),e.showTypingIndicator=()=>{e.querySelector("#typing-indicator")||(e.appendChild(t),e.scrollTop=e.scrollHeight)},e.hideTypingIndicator=()=>{const t=e.querySelector("#typing-indicator");t&&t.remove()},e.addMessage=(t,s)=>{e.hideTypingIndicator();const i=document.createElement("div");i.className=`chat-message ${t}`,i.innerHTML=`\n      <div class="chat-bubble">${s}</div>\n    `,e.appendChild(i),e.scrollTop=e.scrollHeight},e}},"./src/js/components/chat/chatToggleButton.js":(e,t,s)=>{s.r(t),s.d(t,{renderChatToggleButton:()=>a});var i=s("./src/store/index.js");s("./src/js/components/chat/style.css");const n=`data:image/svg+xml;base64,${btoa('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="white"><path fill="white" d="m13.087 21.388.645.382-.645-.382Zm.542-.916-.646-.382.646.382Zm-3.258 0-.645.382.645-.382Zm.542.916.646-.382-.646.382Zm-8.532-5.475.693-.287-.693.287Zm5.409 3.078-.013.75.013-.75Zm-2.703-.372-.287.693.287-.693Zm16.532-2.706.693.287-.693-.287Zm-5.409 3.078-.012-.75.012.75Zm2.703-.372.287.693-.287-.693Zm.7-15.882-.392.64.392-.64Zm1.65 1.65.64-.391-.64.392ZM4.388 2.738l-.392-.64.392.64Zm-1.651 1.65-.64-.391.64.392ZM9.403 19.21l.377-.649-.377.649Zm4.33 2.56.541-.916-1.29-.764-.543.916 1.291.764Zm-4.007-.916.542.916 1.29-.764-.541-.916-1.291.764Zm2.715.152a.52.52 0 0 1-.882 0l-1.291.764c.773 1.307 2.69 1.307 3.464 0l-1.29-.764ZM10.5 2.75h3v-1.5h-3v1.5Zm10.75 7.75v1h1.5v-1h-1.5Zm-18.5 1v-1h-1.5v1h1.5Zm-1.5 0c0 1.155 0 2.058.05 2.787.05.735.153 1.347.388 1.913l1.386-.574c-.147-.352-.233-.782-.278-1.441-.046-.666-.046-1.51-.046-2.685h-1.5Zm6.553 6.742c-1.256-.022-1.914-.102-2.43-.316L4.8 19.313c.805.334 1.721.408 2.977.43l.026-1.5ZM1.688 16.2A5.75 5.75 0 0 0 4.8 19.312l.574-1.386a4.25 4.25 0 0 1-2.3-2.3l-1.386.574Zm19.562-4.7c0 1.175 0 2.019-.046 2.685-.045.659-.131 1.089-.277 1.441l1.385.574c.235-.566.338-1.178.389-1.913.05-.729.049-1.632.049-2.787h-1.5Zm-5.027 8.241c1.256-.021 2.172-.095 2.977-.429l-.574-1.386c-.515.214-1.173.294-2.428.316l.025 1.5Zm4.704-4.115a4.25 4.25 0 0 1-2.3 2.3l.573 1.386a5.75 5.75 0 0 0 3.112-3.112l-1.386-.574ZM13.5 2.75c1.651 0 2.837 0 3.762.089.914.087 1.495.253 1.959.537l.783-1.279c-.739-.452-1.577-.654-2.6-.752-1.012-.096-2.282-.095-3.904-.095v1.5Zm9.25 7.75c0-1.622 0-2.891-.096-3.904-.097-1.023-.299-1.862-.751-2.6l-1.28.783c.285.464.451 1.045.538 1.96.088.924.089 2.11.089 3.761h1.5Zm-3.53-7.124a4.25 4.25 0 0 1 1.404 1.403l1.279-.783a5.75 5.75 0 0 0-1.899-1.899l-.783 1.28ZM10.5 1.25c-1.622 0-2.891 0-3.904.095-1.023.098-1.862.3-2.6.752l.783 1.28c.464-.285 1.045-.451 1.96-.538.924-.088 2.11-.089 3.761-.089v-1.5ZM2.75 10.5c0-1.651 0-2.837.089-3.762.087-.914.253-1.495.537-1.959l-1.279-.783c-.452.738-.654 1.577-.752 2.6C1.25 7.61 1.25 8.878 1.25 10.5h1.5Zm1.246-8.403a5.75 5.75 0 0 0-1.899 1.899l1.28.783a4.25 4.25 0 0 1 1.402-1.403l-.783-1.279Zm7.02 17.993c-.202-.343-.38-.646-.554-.884a2.229 2.229 0 0 0-.682-.645l-.754 1.297c.047.028.112.078.224.232.121.166.258.396.476.764l1.29-.764Zm-3.24-.349c.44.008.718.014.93.037.198.022.275.054.32.08l.754-1.297c-.293-.17-.598-.24-.909-.274-.298-.033-.657-.038-1.069-.045l-.025 1.5Zm6.498 1.113c.218-.367.355-.598.476-.764.112-.154.177-.204.224-.232l-.754-1.297c-.29.17-.5.395-.682.645-.173.238-.352.54-.555.884l1.291.764Zm1.924-2.612c-.412.007-.771.012-1.069.045-.311.035-.616.104-.909.274l.754 1.297c.045-.026.122-.058.32-.08.212-.023.49-.03.93-.037l-.026-1.5Z" /><path stroke="white" stroke-linecap="round" stroke-width="1.5" d="M8 9h8M8 12.5h5.5" /></svg>')}`,r=`data:image/svg+xml;base64,${btoa('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none"><path fill="currentcolor" d="m13.087 21.388.645.382-.645-.382Zm.542-.916-.646-.382.646.382Zm-3.258 0-.645.382.645-.382Zm.542.916.646-.382-.646.382Zm-8.532-5.475.693-.287-.693.287Zm5.409 3.078-.013.75.013-.75Zm-2.703-.372-.287.693.287-.693Zm16.532-2.706.693.287-.693-.287Zm-5.409 3.078-.012-.75.012.75Zm2.703-.372.287.693-.287-.693Zm.7-15.882-.392.64.392-.64Zm1.65 1.65.64-.391-.64.392ZM4.388 2.738l-.392-.64.392.64Zm-1.651 1.65-.64-.391.64.392ZM9.403 19.21l.377-.649-.377.649Zm4.33 2.56.541-.916-1.29-.764-.543.916 1.291.764Zm-4.007-.916.542.916 1.29-.764-.541-.916-1.291.764Zm2.715.152a.52.52 0 0 1-.882 0l-1.291.764c.773 1.307 2.69 1.307 3.464 0l-1.29-.764ZM10.5 2.75h3v-1.5h-3v1.5Zm10.75 7.75v1h1.5v-1h-1.5Zm-18.5 1v-1h-1.5v1h1.5Zm-1.5 0c0 1.155 0 2.058.05 2.787.05.735.153 1.347.388 1.913l1.386-.574c-.147-.352-.233-.782-.278-1.441-.046-.666-.046-1.51-.046-2.685h-1.5Zm6.553 6.742c-1.256-.022-1.914-.102-2.43-.316L4.8 19.313c.805.334 1.721.408 2.977.43l.026-1.5ZM1.688 16.2A5.75 5.75 0 0 0 4.8 19.312l.574-1.386a4.25 4.25 0 0 1-2.3-2.3l-1.386.574Zm19.562-4.7c0 1.175 0 2.019-.046 2.685-.045.659-.131 1.089-.277 1.441l1.385.574c.235-.566.338-1.178.389-1.913.05-.729.049-1.632.049-2.787h-1.5Zm-5.027 8.241c1.256-.021 2.172-.095 2.977-.429l-.574-1.386c-.515.214-1.173.294-2.428.316l.025 1.5Zm4.704-4.115a4.25 4.25 0 0 1-2.3 2.3l.573 1.386a5.75 5.75 0 0 0 3.112-3.112l-1.386-.574ZM13.5 2.75c1.651 0 2.837 0 3.762.089.914.087 1.495.253 1.959.537l.783-1.279c-.739-.452-1.577-.654-2.6-.752-1.012-.096-2.282-.095-3.904-.095v1.5Zm9.25 7.75c0-1.622 0-2.891-.096-3.904-.097-1.023-.299-1.862-.751-2.6l-1.28.783c.285.464.451 1.045.538 1.96.088.924.089 2.11.089 3.761h1.5Zm-3.53-7.124a4.25 4.25 0 0 1 1.404 1.403l1.279-.783a5.75 5.75 0 0 0-1.899-1.899l-.783 1.28ZM10.5 1.25c-1.622 0-2.891 0-3.904.095-1.023.098-1.862.3-2.6.752l.783 1.28c.464-.285 1.045-.451 1.96-.538.924-.088 2.11-.089 3.761-.089v-1.5ZM2.75 10.5c0-1.651 0-2.837.089-3.762.087-.914.253-1.495.537-1.959l-1.279-.783c-.452.738-.654 1.577-.752 2.6C1.25 7.61 1.25 8.878 1.25 10.5h1.5Zm1.246-8.403a5.75 5.75 0 0 0-1.899 1.899l1.28.783a4.25 4.25 0 0 1 1.402-1.403l-.783-1.279Zm7.02 17.993c-.202-.343-.38-.646-.554-.884a2.229 2.229 0 0 0-.682-.645l-.754 1.297c.047.028.112.078.224.232.121.166.258.396.476.764l1.29-.764Zm-3.24-.349c.44.008.718.014.93.037.198.022.275.054.32.08l.754-1.297c-.293-.17-.598-.24-.909-.274-.298-.033-.657-.038-1.069-.045l-.025 1.5Zm6.498 1.113c.218-.367.355-.598.476-.764.112-.154.177-.204.224-.232l-.754-1.297c-.29.17-.5.395-.682.645-.173.238-.352.54-.555.884l1.291.764Zm1.924-2.612c-.412.007-.771.012-1.069.045-.311.035-.616.104-.909.274l.754 1.297c.045-.026.122-.058.32-.08.212-.023.49-.03.93-.037l-.026-1.5Z" /><path stroke="currentcolor" stroke-linecap="round" stroke-width="1.5" d="M8 9h8M8 12.5h5.5" /></svg>')}`;function a(){const e=document.createElement("button");e.className="toggle-chat-btn",e.type="button",e.addEventListener("click",()=>{(0,i.setChatOpen)(!(0,i.getState)().chatOpen)});const t=t=>{const s=t?r:n,i=t?"Chat show Icon":"Chat hide Icon",a=t?"Click to close<br>messages":"Click to view<br>messages",o=t?"#000000":"#ffffff";e.innerHTML=`\n      <div style="display: flex; flex-direction: column; align-items: center; gap: 4px;">\n        <img src="${s}" alt="${i}" style="width: 26px; height: 26px;" />\n        <div style="font-size: 8px; color: ${o}; text-align: center; line-height: 1.1; font-weight: 500;">\n          ${a}\n        </div>\n      </div>\n    `,e.style.backgroundColor=t?"white":"#2d2d2d80"};return(0,i.subscribeChat)(t),t((0,i.getState)().chatOpen),e}},"./src/js/components/chat/style.css":(e,t,s)=>{s.r(t),s.d(t,{default:()=>y});var i=s("./node_modules/style-loader/dist/runtime/injectStylesIntoStyleTag.js"),n=s.n(i),r=s("./node_modules/style-loader/dist/runtime/styleDomAPI.js"),a=s.n(r),o=s("./node_modules/style-loader/dist/runtime/insertBySelector.js"),l=s.n(o),d=s("./node_modules/style-loader/dist/runtime/setAttributesWithoutAttributes.js"),c=s.n(d),h=s("./node_modules/style-loader/dist/runtime/insertStyleElement.js"),u=s.n(h),f=s("./node_modules/style-loader/dist/runtime/styleTagTransform.js"),g=s.n(f),m=s("./node_modules/css-loader/dist/cjs.js!./src/js/components/chat/style.css"),p={};p.styleTagTransform=g(),p.setAttributes=c(),p.insert=l().bind(null,"head"),p.domAPI=a(),p.insertStyleElement=u(),n()(m.default,p);const y=m.default&&m.default.locals?m.default.locals:void 0},"./src/js/components/contact.js":(e,t,s)=>{s.r(t),s.d(t,{renderContactForm:()=>l});var i=s("./src/store/index.js"),n=s("./src/js/utils/index.js"),r=s("./src/js/layout/body.js"),a=s("./src/js/utils/api.js"),o=s("./src/js/components/video/video.js");const l=()=>{try{const{chatOpen:e}=(0,i.getState)();if(e){const{setChatOpen:e}=s("./src/store/index.js");e(!1)}const t=document.getElementById("fb-widget-config"),n=t?.shadowRoot,r=n?.querySelector(".my-widget-wrapper");r&&r.classList.remove("chat-visible")}catch(e){console.warn("Could not close chat or remove chat-visible class:",e)}const e=document.createElement("div");e.id="widget-contact-form";const t=(0,i.getState)()?.widgetConfig?.contact_fields||[],l=(Array.isArray(t)?t:[]).sort((e,t)=>(e.position||0)-(t.position||0)),c=l.map(e=>{const{label:t,type:s,required:i}=e;let n;n="email"===t||"Email"===t?"email_id":"phone_number"===t||"Phone Number"===t?"phone_number":t.toLowerCase().replace(/\s+/g,"_");let r="";return"string"===s||"email"===s||"phone"===s?r=`<input id="${n}" name="${n}" type="${"phone"===s?"tel":s}"\n        placeholder="${t}" ${i?"required":""} />`:"textarea"!==s&&"message"!==t.toLowerCase()||(r=`<textarea id="${n}" name="${n}" rows="4" placeholder="${t}" ${i?"required":""}></textarea>`),`\n      <div class="form-group">\n        <label for="${n}">${t}</label>\n        ${r}\n        <span class="error-message" id="error-${n}"></span>\n      </div>\n    `}).join("");e.innerHTML=`\n    <form id="contact-form" novalidate>\n      ${c}\n\n      <div id="form-footer" class="form-footer">\n  <button type="button" id="skip-btn" aria-label="Skip contact form">\n    <span>Skip this form</span>\n  </button>\n\n  <div class="form-actions">\n    <button type="submit" id="submit-btn">Submit</button>\n  </div>\n</div>\n\n      <div id="form-loader" class="hidden">\n        <div class="loader-spinner"></div>\n        <span>Sending your details...</span>\n      </div>\n\n      <div id="success-banner" class="hidden">âœ… Message sent successfully!</div>\n      <div id="error-banner" class="hidden">âŒ Something went wrong. Please try again later.</div>\n    </form>\n\n  `;const h=e.querySelector("#contact-form"),u=e.querySelector("#form-loader"),f=e.querySelector("#success-banner"),g=e.querySelector("#error-banner"),m=e.querySelector("#submit-btn"),p=e.querySelector("#skip-btn"),y=document.getElementById("fb-widget-config")?.getAttribute("data-partner_id"),v=document.getElementById("fb-widget-config")?.getAttribute("data-fb_id"),E=`https://d1jcbfcd9v1do3.cloudfront.net/${y}/videos/knowledge_base/${v}/contact_end/1_playlist.m3u8`;return h.onsubmit=async e=>{e.preventDefault(),f.classList.add("hidden"),g.classList.add("hidden");let t=!1;const s={};for(const e of l){let i;i="email"===e.label||"Email"===e.label?"email_id":"phone_number"===e.label||"Phone Number"===e.label?"phone_number":e.label.toLowerCase().replace(/\s+/g,"_");const n=h.querySelector(`#${i}`),r=h.querySelector(`#error-${i}`);if(!n){console.warn("Input not found for field:",e,"Expected id:",i);continue}const a=n.value.trim();r&&(r.textContent=""),s[i]=a,n&&!n.dataset.listenerAdded&&(n.addEventListener("input",()=>{r&&(r.textContent="")}),n.dataset.listenerAdded=!0),e.required&&!a?(r&&(r.textContent=`${e.label} is required.`),d(n),t=!0):"email"===e.type&&a&&(/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(a)||(r&&(r.textContent="Invalid email format."),d(n),t=!0))}if(t)return;u.classList.remove("hidden"),m.disabled=!0,p.disabled=!0;const i={...s,action:"contact_message"};try{await(0,a.apiRequest)(i),sessionStorage.removeItem("conversation_data"),h.reset(),f.classList.remove("hidden"),setTimeout(()=>f.classList.add("hidden"),4e3);const e=document.getElementById("fb-widget-config"),t=e?.shadowRoot,s=window.__myWidgetBody;if(s&&"function"==typeof s.setView)s.setView("video_with_chat");else{const e=t?.getElementById("widget-content-area");e&&(e.innerHTML="",e.appendChild((0,o.renderVideoPlayer)(E)))}(0,n.toggleInputBar)(!0),setTimeout(()=>{const e=document.getElementById("fb-widget-config"),t=e?.shadowRoot,s=t?.getElementById("widget-video-player");s?.playNewVideo?s.playNewVideo(E):console.warn("âŒ Video container or playNewVideo method not found.")},100)}catch(e){console.error("âŒ Contact form error:",e),g.classList.remove("hidden"),setTimeout(()=>g.classList.add("hidden"),4e3)}finally{u.classList.add("hidden"),m.disabled=!1,p.disabled=!1}},p&&p.addEventListener("click",()=>{(0,i.setView)({currentView:"video_with_chat"}),(0,n.toggleInputBar)(!0);const e=document.getElementById("fb-widget-config"),t=e?.shadowRoot,s=t?.getElementById("widget-content-area");if(s){s.innerHTML="";const e=(0,r.renderBody)("video_with_chat");s.appendChild(e)}}),e};function d(e){e&&(e.classList.add("shake"),setTimeout(()=>e.classList.remove("shake"),300))}},"./src/js/components/html/index.js":(e,t,s)=>{s.r(t),s.d(t,{default:()=>r,renderHtmlPanel:()=>n});var i=s("./src/js/components/html/render.js");s("./src/js/components/html/style.css");const n=(e,t)=>{const s=document.createElement("div");s.id="html-wrapper",s.className="html-wrapper",s.style.position="relative",s.style.width="100%",s.style.height="100%";const n=document.createElement("div");n.id="html-container",n.className="html-container",n.style.position="relative",n.style.width="100%",n.style.height="100%",n.style.overflow="auto";const r=document.createElement("div");r.className="html-section",r.appendChild((0,i.default)(e,t));const a=document.createElement("div");a.id="video-container",a.className="video-pip-container";const o=document.createElement("button");o.className="video-toggle-btn";const l='\n    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">\n      <path d="M19 13H5v-2h14v2z"/>\n    </svg>\n  ';o.innerHTML=l,o.style.cssText="\n    position: absolute;\n    top: 8px;\n    right: 8px;\n    width: 24px;\n    height: 24px;\n    background: rgba(0, 0, 0, 0.7);\n    color: white;\n    border: none;\n    border-radius: 50%;\n    cursor: pointer;\n    font-size: 16px;\n    line-height: 1;\n    z-index: 1001;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n  ";let d=!1,c=null,h=!1;const u=()=>{h=!0,c&&(clearTimeout(c),c=null),d?(a.classList.remove("minimized"),a.style.width="320px",a.style.height="180px",o.innerHTML=l,d=!1):(a.classList.add("minimized"),a.style.width="160px",a.style.height="90px",o.innerHTML='\n    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">\n      <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>\n    </svg>\n  ',d=!0,c=setTimeout(()=>{d&&!h&&(a.classList.remove("minimized"),a.style.width="320px",a.style.height="180px",o.innerHTML=l,d=!1)},2e4))};o.addEventListener("click",e=>{e.stopPropagation(),u()}),a.addEventListener("click",u),a.addEventListener("mouseenter",()=>{h=!0}),a.appendChild(o),n.appendChild(r),s.appendChild(n),console.log("HTML Section with Video PiP:",e,t),a.style.position="fixed",a.style.zIndex="10000";const f=()=>{const e=document.getElementById("fb-widget-config"),t=e?.shadowRoot,s=t?.querySelector("#my-widget-body");if(s){const e=s.getBoundingClientRect(),t=window.innerWidth-(e.right-20),i=window.innerHeight-(e.bottom-20);a.style.right=t+"px",a.style.bottom=i+"px",console.log("ðŸ” Desktop PiP position updated - right:",t,"bottom:",i)}};return setTimeout(f,100),window.addEventListener("scroll",f),window.addEventListener("resize",f),s.appendChild(a),{htmlContainer:s,videoContainer:a}},r=i.default},"./src/js/components/html/mobile.js":(e,t,s)=>{s.r(t),s.d(t,{default:()=>r,renderHtmlPanelMobile:()=>n});var i=s("./src/js/components/html/render.js");s("./src/js/components/html/style.css");const n=(e,t)=>{const s=document.createElement("div");s.id="html-wrapper",s.className="html-wrapper mobile-html-wrapper",s.style.position="relative",s.style.width="100%",s.style.height="100%";const n=document.createElement("div");n.id="html-container",n.className="html-container",n.style.position="relative",n.style.width="100%",n.style.height="100%",n.style.overflow="auto";const r=document.createElement("div");r.className="html-section",r.appendChild((0,i.default)(e,t));const a=document.createElement("div");a.id="video-container",a.className="video-pip-container mobile-pip",a.style.position="fixed",a.style.zIndex="10000",a.style.width="200px",a.style.height="112px";const o=document.createElement("button");o.className="video-toggle-btn";const l='\n    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">\n      <path d="M19 13H5v-2h14v2z"/>\n    </svg>\n  ';o.innerHTML=l,o.style.cssText="\n    position: absolute;\n    top: 8px;\n    right: 8px;\n    width: 24px;\n    height: 24px;\n    background: rgba(0, 0, 0, 0.7);\n    color: white;\n    border: none;\n    border-radius: 50%;\n    cursor: pointer;\n    font-size: 16px;\n    line-height: 1;\n    z-index: 1001;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n  ";let d=!1,c=null,h=!1;const u=()=>{console.log("ðŸ”„ Mobile toggleVideoSize called, isMinimized:",d),h=!0,c&&(clearTimeout(c),c=null),d?(a.classList.remove("minimized"),a.style.width="200px",a.style.height="112px",o.innerHTML=l,d=!1,console.log("ðŸ“± Mobile PiP restored to 200x112px")):(a.classList.add("minimized"),a.style.width="120px",a.style.height="67px",o.innerHTML='\n    <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">\n      <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>\n    </svg>\n  ',d=!0,console.log("ðŸ“± Mobile PiP minimized to 120x67px"),c=setTimeout(()=>{d&&!h&&(a.classList.remove("minimized"),a.style.width="200px",a.style.height="112px",o.innerHTML=l,d=!1,console.log("ðŸ“± Mobile PiP auto-restored after timeout"))},2e4))};let f=0,g=!1;o.addEventListener("touchstart",e=>{e.stopPropagation(),f=Date.now(),g=!1,h=!0}),o.addEventListener("touchmove",e=>{g=!0}),o.addEventListener("touchend",e=>{e.preventDefault(),e.stopPropagation(),Date.now()-f<500&&!g&&u()}),o.addEventListener("click",e=>{e.stopPropagation(),u()}),a.addEventListener("touchstart",e=>{e.target===o||o.contains(e.target)||(f=Date.now(),g=!1,h=!0)}),a.addEventListener("touchmove",e=>{g=!0}),a.addEventListener("touchend",e=>{e.target===o||o.contains(e.target)||(e.preventDefault(),Date.now()-f<500&&!g&&u())}),a.addEventListener("click",e=>{e.target===o||o.contains(e.target)||u()}),a.addEventListener("contextmenu",e=>{e.preventDefault()}),a.appendChild(o),n.appendChild(r),s.appendChild(n),console.log("HTML Mobile Layout (same as desktop with mobile PiP):",e,t);const m=()=>{const e=document.getElementById("fb-widget-config"),t=e?.shadowRoot,s=t?.querySelector("#my-widget-body");if(s){const e=s.getBoundingClientRect(),t=window.innerWidth-(e.right-20),i=window.innerHeight-(e.bottom-20);a.style.right=t+"px",a.style.bottom=i+"px",console.log("ðŸ” Mobile PiP position updated - right:",t,"bottom:",i)}};setTimeout(m,100),window.addEventListener("scroll",m),window.addEventListener("resize",m);const p=document.getElementById("fb-widget-config"),y=p?.shadowRoot,v=y?.querySelector("#my-widget-body");return v&&(v.style.height="50vh",v.style.maxHeight="50vh",v.style.position="relative",console.log("ðŸ” Set mobile HTML body height to 50vh")),s.appendChild(a),{htmlContainer:s,videoContainer:a}},r=n},"./src/js/components/html/render.js":(e,t,s)=>{s.r(t),s.d(t,{default:()=>n,renderHtml:()=>i});const i=(e,t)=>{const s=document.createElement("div"),i=e||"fallback-layout",n=t||'<div class="fallback-content"><p>Content is loading...</p></div>';return s.className=`layout-wrapper ${i}`,s.innerHTML=n,s},n=i},"./src/js/components/html/style.css":(e,t,s)=>{s.r(t),s.d(t,{default:()=>y});var i=s("./node_modules/style-loader/dist/runtime/injectStylesIntoStyleTag.js"),n=s.n(i),r=s("./node_modules/style-loader/dist/runtime/styleDomAPI.js"),a=s.n(r),o=s("./node_modules/style-loader/dist/runtime/insertBySelector.js"),l=s.n(o),d=s("./node_modules/style-loader/dist/runtime/setAttributesWithoutAttributes.js"),c=s.n(d),h=s("./node_modules/style-loader/dist/runtime/insertStyleElement.js"),u=s.n(h),f=s("./node_modules/style-loader/dist/runtime/styleTagTransform.js"),g=s.n(f),m=s("./node_modules/css-loader/dist/cjs.js!./src/js/components/html/style.css"),p={};p.styleTagTransform=g(),p.setAttributes=c(),p.insert=l().bind(null,"head"),p.domAPI=a(),p.insertStyleElement=u(),n()(m.default,p);const y=m.default&&m.default.locals?m.default.locals:void 0},"./src/js/components/inputBar.js":(e,t,s)=>{s.r(t),s.d(t,{renderInputBar:()=>c});var i=s("./src/store/index.js"),n=s("./src/js/utils/api.js"),r=s("./src/js/components/contact.js"),a=s("./src/js/utils/index.js"),o=s("./src/js/components/chat/chat.js"),l=s("./src/js/components/suggestions/index.js");const d=`data:image/svg+xml;base64,${btoa('<svg xmlns="http://www.w3.org/2000/svg" fill="white" width="512" height="512" viewBox="0 0 512 512"><path d="M16,464,496,256,16,48V208l320,48L16,304Z"/></svg>')}`,c=()=>{const e=document.createElement("div");e.id="input-bar-container",e.style.position="relative";const t=document.createElement("div");t.id="input-suggestions-container",t.style.position="relative";const s=document.createElement("div");s.id="my-widget-input-bar",s.innerHTML=`\n    <input \n      type="text" \n      id="widget-chat-input" \n      placeholder="Ask a question..." \n    />\n    <button id="widget-send-btn" disabled aria-label="Send message">\n      <img src="${d}" alt="Send" width="21" height="21" />\n    </button>\n  `;const c=(0,l.createSuggestionsSystem)(t);e.appendChild(t),e.appendChild(s);const h=s.querySelector("#widget-chat-input"),u=s.querySelector("#widget-send-btn"),f=c.sendToAPI.bind(c);c.sendToAPI=async(e,t)=>((e=>{h.value=e,h.focus(),u.disabled=!1,c.hide()})(e),await f(e,t)),h.addEventListener("input",()=>{const e=h.value.trim();u.disabled=0===e.length,c.trackInteraction()}),h.addEventListener("focus",()=>{c.trackInteraction()}),h.addEventListener("click",()=>{c.trackInteraction()}),u.addEventListener("click",()=>{c.trackInteraction()});const{currentView:g}=(0,i.getState)(),m={chat:"message",contact:"contact_message"}[g]||"message",p=async()=>{const e=h.value.trim();if(!e)return;u.disabled=!0,h.disabled=!0;const t=u.innerHTML;u.innerHTML='<div class="fb-loader" role="status" aria-label="Loading"></div>';const s=sessionStorage.getItem("conversation_history");let l=[];try{s&&(l=JSON.parse(s))}catch(e){console.error("Error parsing conversation history:",e)}const d=document.getElementById("fb-widget-config"),f=d?.shadowRoot,g=f?.querySelector("#widget-chat-history");console.log("ðŸ” Adding user message to chat:",e),console.log("ðŸ” Chat history element found:",!!g),console.log("ðŸ” Chat history addMessage method:",!!g?.addMessage),g&&g.addMessage?(g.addMessage("user",e),console.log("ðŸ” User message added successfully")):console.warn("âš ï¸ Could not add user message to chat history");try{const t=await(0,n.apiRequest)({question:e,action:m,conversation_history:l});if("message"===m){const e=t?.answer_video_url?.[0],s=t?.show_contact_form,n=t?.layout_id,l=t?.additional_info,d=t.conversation;sessionStorage.setItem("conversation_history",JSON.stringify(d));const h=t?.suggestions;h&&Array.isArray(h)&&h.length>0&&(console.log("âœ… Suggestions received from API:",h),c.update(h));const u=f?.querySelector(".chat-section");if(u&&(u.innerHTML="",u.appendChild((0,o.renderChatHistory)())),s)console.log("ðŸ“¨ Triggering contact form render..."),setTimeout(()=>{(0,i.setView)({currentView:"contact"});const e=f?.getElementById("widget-content-area");if((0,a.toggleInputBar)(!1),e){e.innerHTML="";const t=(0,r.renderContactForm)();e.appendChild(t)}else console.warn("âš ï¸ Cannot find view container to render contact form.")},400);else if(n&&l)(0,i.setChatOpen)(!1),console.log("ðŸ” HTML data received:",{html_layout_id:n,html_data:l,videoUrl:e}),console.log("ðŸ” Window width:",window.innerWidth,"isMobile:",window.innerWidth<=900),(0,i.setView)({currentView:"html"}),setTimeout(()=>{const t=f?.querySelector("#my-widget-body");console.log("ðŸ” Body element found:",!!t),console.log("ðŸ” Body setView method found:",!!t?.setView),t&&t.setView?(console.log("ðŸ” Calling body.setView with HTML data"),t.setView("html",{htmlLayoutId:n,htmlData:l,videoUrl:e})):(console.warn("âš ï¸ Body element or setView method not found for HTML rendering"),console.log("ðŸ” Available elements in shadow root:",f?.querySelectorAll("*")))},100);else if(e)console.log("ðŸ” Fallback: HTML layout/data is null, showing video with chat view:",e),(0,i.setView)({currentView:"video_with_chat"}),setTimeout(()=>{const t=f?.querySelector("#my-widget-body");t&&t.setView?(console.log("ðŸ” Calling body.setView for video_with_chat fallback:",e),t.setView("video_with_chat",{videoUrl:e})):console.warn("âŒ Body element or setView method not found for video_with_chat fallback")},100);else if(!n&&!l||e)console.log("ðŸ” Ultimate fallback: No HTML data or video available, showing default message"),(0,i.setView)({currentView:"video"}),setTimeout(()=>{const e=f?.getElementById("widget-content-area");e&&(e.innerHTML='\n                <div style="\n                  display: flex;\n                  align-items: center;\n                  justify-content: center;\n                  height: 100%;\n                  padding: 20px;\n                  text-align: center;\n                  color: #666;\n                  font-family: Arial, sans-serif;\n                ">\n                  <div>\n                    <h3 style="margin-bottom: 10px; color: #333;">Response Received</h3>\n                    <p>The system has processed your request successfully.</p>\n                  </div>\n                </div>\n              ')},100);else{console.log("ðŸ” Fallback: Partial HTML data without video, creating fallback HTML view");const e=l||'<div class="fallback-content"><p>Content is loading...</p></div>',t=n||"FALLBACK_LAYOUT";(0,i.setView)({currentView:"html"}),setTimeout(()=>{const s=f?.querySelector("#my-widget-body");s&&s.setView&&(console.log("ðŸ” Calling body.setView with fallback HTML data"),s.setView("html",{htmlLayoutId:t,htmlData:e,videoUrl:null}))},100)}}}catch(e){if(console.error("âŒ Failed to fetch video:",e),g&&g.children.length>0){const e=g.children[g.children.length-1];e.classList.contains("user")&&e.remove()}}finally{h.value="",h.disabled=!1,u.disabled=!0,u.innerHTML=t}};return u.addEventListener("click",p),h.addEventListener("keydown",e=>{"Enter"!==e.key||u.disabled||p()}),console.log("â„¹ï¸ Suggestions system initialized - waiting for API responses with suggestions"),e.suggestionsSystem=c,window.__suggestionsSystem=c,e}},"./src/js/components/mic/index.js":(e,t,s)=>{s.r(t),s.d(t,{cleanupMicComponent:()=>_,forceUpdateButtonState:()=>C,renderMicToggleButton:()=>D,setupVideoMonitoring:()=>R,stopMicrophoneRecording:()=>k});var i=s("./src/js/components/mic/wave.js"),n=s("./src/store/index.js"),r=(s("./src/js/components/mic/style.css"),s("./src/js/components/mic/micController.js")),a=s("./src/js/utils/api.js"),o=s("./src/js/utils/index.js"),l=s("./src/js/components/contact.js"),d=s("./src/js/components/chat/chat.js"),c=s("./src/js/utils/resourceManager.js");const h={micOn:`data:image/svg+xml;base64,${btoa('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" view-box="0 0 24 24" fill="none"><path stroke="currentcolor" stroke-width="1.5" d="M7 8a5 5 0 0 1 10 0v3a5 5 0 0 1-10 0V8Z" /><path stroke="currentcolor" stroke-linecap="round" stroke-width="1.5" d="M11 8h2M10 11h4M20 10v1a8 8 0 1 1-16 0v-1M12 19v3" /></svg>')}`,micOff:`data:image/svg+xml;base64,${btoa('<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" view-box="0 0 24 24"><path stroke="white" stroke-width="1.5" d="M7 8a5 5 0 0 1 10 0v3a5 5 0 0 1-10 0V8Z" /><path stroke="white" stroke-linecap="round" stroke-width="1.5" d="M11 8h2M10 11h4M20 10v1a8 8 0 1 1-16 0v-1M12 19v3" /><path stroke="white" stroke-linecap="round" stroke-width="1.5" d="M22 2 2 22" /></svg>')}`},u={callDelay:2e3,isProcessing:!1,lastCallTime:0};let f=null,g=!0,m=null,p=null,y=null,v=null;function E(){const e=document.getElementById("fb-widget-config");return e?.shadowRoot||null}function T(){const e=E(),t=e?.querySelector("#fb-video-main");if(!t)return console.log("ðŸŽ¬ No main video element found"),!1;const s=t.paused,i=t.ended,n=t.currentTime>0,r=t.src&&""!==t.src,a=t.hlsInstance&&t.hlsInstance.media,o=t.readyState>=2;return!s&&!i&&n&&o&&(r||a)}function S(e){const t=E(),s=t?.querySelector("#mic-wave-container");if(s)if(e){s.innerHTML="";const e=document.createElement("div");e.className="api-call-message",e.textContent="Processing...",e.style.cssText="\n      color: #ffffff;\n      font-size: 10px;\n      text-align: center;\n      padding: 8px;\n      line-height: 1.2;\n      font-weight: 500;\n      width: 100%;\n      height: 100%;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      border-radius: 6px;\n    ",s.appendChild(e),console.log("ðŸ”„ API call status shown")}else L(),console.log("âœ… API call status cleared, restored wave")}function b(){const e=E(),t=e?.querySelector("#mic-wave-container");if(!t)return;t.innerHTML="";const s=document.createElement("div");s.className="mic-permission-error",s.innerHTML='\n    <div style="color: #ffffff; font-size: 10px; text-align: center; line-height: 1.2; font-weight: 500; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; border-radius: 6px;">\n      <div>\n        <div style="margin-bottom: 4px;">Microphone access required</div>\n      </div>\n    </div>\n  ',t.appendChild(s)}function A(){const e=E(),t=e?.querySelector("#mic-wave-container");if(!t)return;t.innerHTML="";const s=document.createElement("div");s.className="video-playing-message",s.innerHTML='\n    <div style="display: flex; flex-direction: column; align-items: center; gap: 4px;">\n      <div style="font-size: 12px; font-weight: 600; color: #ffffff;">Video Playing</div>\n      <div style="font-size: 9px; color: #cccccc; text-align: center;">Recording paused</div>\n    </div>\n  ',s.style.cssText="\n    color: #ffffff;\n    font-size: 10px;\n    text-align: center;\n    padding: 8px;\n    line-height: 1.2;\n    width: 100%;\n    height: 100%;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    border-radius: 6px;\n    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);\n  ",t.appendChild(s),console.log("ðŸŽ¬ Video playing message shown")}function L(){const e=E(),t=e?.querySelector("#mic-wave-container");if(t&&(t.innerHTML="",(0,n.getState)().micOn&&m)){const e=document.createElement("canvas");e.className="mic-wave",e.width=200,e.height=40,t.appendChild(e),m=(0,i.createMicWave)(e),m.start(!1)}}function w(){T()?(L(),(0,n.getState)().micOn||setTimeout(()=>{v?(v(!1),console.log("ðŸŽ¬ Button text updated for video started playing")):console.log("âŒ Global update function not available")},100),f&&!g&&(g=!0,x(),f?.start(),console.log("ðŸŽ¤ Speech recognition enabled during video playback"))):(L(),console.log("ðŸ”‡ No video playing, restored wave"),(0,n.getState)().micOn&&!g&&(g=!0,x(),f?.start(),console.log("ðŸŽ¤ Speech recognition re-enabled after video ended")),(0,n.getState)().micOn||setTimeout(()=>{v?(v(!1),console.log("ðŸŽ¬ Button text updated for video stopped")):console.log("âŒ Global update function not available")},100))}function R(){p||(p=(0,c.getResourceManager)());const e=E(),t=e?.querySelector("#fb-video-main");if(!t){const e=setTimeout(R,500);return void p.registerTimer(e,"timeout")}"true"!==t.dataset.monitoringSetup&&(["play","pause","ended","loadstart","canplay","playing","waiting"].forEach(e=>{p.addEventListener(t,e,()=>{console.log(`ðŸŽ¬ Video event triggered: ${e}`);const t=setTimeout(w,100);p.registerTimer(t,"timeout")})}),t.dataset.monitoringSetup="true",console.log("ðŸŽ¬ Video monitoring set up with resource management"),setTimeout(()=>{const e=T();console.log("ðŸŽ¬ Initial video state check - isPlaying:",e),e&&w()},200))}function I(){p||(p=(0,c.getResourceManager)());const e=E();if(!e){console.log("ðŸŽ¬ No shadow root found, retrying in 500ms...");const e=setTimeout(I,500);return void p.registerTimer(e,"timeout")}console.log("ðŸŽ¬ Setting up video element observer");const t=new MutationObserver(e=>{e.forEach(e=>{e.addedNodes.forEach(e=>{if(e.nodeType===Node.ELEMENT_NODE){if("fb-video-main"===e.id){console.log("ðŸŽ¬ New video element detected, setting up monitoring");const e=setTimeout(R,100);p.registerTimer(e,"timeout")}if(e.querySelector("#fb-video-main")){const e=setTimeout(R,100);p.registerTimer(e,"timeout")}const t=e.querySelector("#widget-video-player");if(t){const e=setTimeout(()=>{t.querySelector("#fb-video-main")&&(console.log("ðŸŽ¬ Video element found in container, setting up monitoring"),R())},100);p.registerTimer(e,"timeout")}}})})});t.observe(e,{childList:!0,subtree:!0}),p.registerResource(t,e=>e.disconnect(),"VideoElementObserver"),console.log("ðŸŽ¬ Video element observer set up with resource management"),e.querySelector("#fb-video-main")&&setTimeout(R,100)}function x(){if(f)return;if(!(0,n.getState)().micOn)return void console.log("ðŸŽ™ï¸ Cannot setup mic - mic is off");const e=T();if(e)return console.log("ðŸŽ¬ Cannot setup mic - video is playing"),void A();console.log("ðŸŽ¤ Setting up mic (video playing status:",e,")"),f=(0,r.default)({onResult:(e,t,s)=>{!async function(e,t,s){const i=Date.now();if(u.isProcessing)return void console.log("ðŸ”„ API call already in progress, skipping this request");const r=i-u.lastCallTime;if(r<u.callDelay)console.log(`â±ï¸ API call too soon (${r}ms < ${u.callDelay}ms), skipping`);else{u.isProcessing=!0,u.lastCallTime=i,S(!0);try{const i=sessionStorage.getItem("conversation_history");let r=[];try{i&&(r=JSON.parse(i))}catch(e){console.error("Error parsing conversation history:",e)}const c=await async function(e){if(!e||0===e.size)return console.warn("No audio blob available"),null;try{return await new Promise((t,s)=>{const i=new FileReader;i.onload=()=>{const e=i.result.split(",")[1];t(e)},i.onerror=s,i.readAsDataURL(e)})}catch(e){return console.error("Error converting audio to base64:",e),null}}(t),h=s<=.5?{action:"voice_message",conversation_history:r,audioMessage:c}:{action:"message",conversation_history:r,question:e};!function(e){console.log("âœ… API call completed successfully"),(0,n.setMicOn)(!1),console.log("ðŸŽ™ï¸ Mic disabled after API call completion");const t=E(),s=e?.answer_video_url?.[0],i=e?.show_contact_form,r=e.conversation;sessionStorage.setItem("conversation_history",JSON.stringify(r));const a=t?.querySelector(".chat-section");a&&(a.innerHTML="",a.appendChild((0,d.renderChatHistory)())),s&&((0,n.setView)({currentView:"video",videoUrl:s}),setTimeout(()=>{const e=t?.getElementById("widget-video-player");e?.playNewVideo?e.playNewVideo(s):console.warn("âŒ Video container or playNewVideo method not found.")},100)),i&&(console.log("ðŸ“¨ Triggering contact form render..."),setTimeout(()=>{(0,n.setView)({currentView:"contact"}),(0,o.toggleInputBar)(!1);const e=t?.getElementById("widget-content-area");if(e){e.innerHTML="";const t=(0,l.renderContactForm)();e.appendChild(t)}else console.warn("âš ï¸ Cannot find view container to render contact form.")},400))}(await(0,a.apiRequest)(h))}catch(e){console.error("Error in mic API logic:",e),function(){console.log("âŒ API call failed, resetting processing flag"),(0,n.setMicOn)(!1),console.log("ðŸŽ™ï¸ Mic disabled after API call failure");const e=E(),t=e?.querySelector("#widget-chat-history");if(t&&t.children.length>0){const e=t.children[t.children.length-1];e.classList.contains("user")&&e.remove()}}()}finally{u.isProcessing=!1,S(!1)}}}(e,t,s)},onEnd:()=>{g&&!f?.isProcessingResult&&setTimeout(()=>{const e=(0,n.getState)(),t=T();g&&e.micOn&&!t?f?.start():t&&(console.log("ðŸŽ¬ Mic restart prevented - video is playing"),A())},500)},onError:e=>{console.error("Mic error:",e),"not-allowed"!==e.error&&"permission-denied"!==e.error||(g=!1,f=null,(0,o.isAndroidDevice)()?(console.log("ðŸ¤– Android microphone permission error detected"),function(){const e=E(),t=e?.querySelector("#mic-wave-container");if(!t)return;t.innerHTML="";const s=document.createElement("div");s.className="mic-permission-error android",s.innerHTML='\n    <div style="color: #ffffff; font-size: 9px; text-align: center; line-height: 1.2; font-weight: 500; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 6px; background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3); padding: 8px;">\n      <div style="margin-bottom: 4px; font-weight: 600;">ðŸ¤– Android Permission</div>\n      <div style="font-size: 8px; opacity: 0.9; margin-bottom: 6px;">Please allow microphone access</div>\n      <button id="retry-permission-btn" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 4px 8px; border-radius: 4px; font-size: 7px; cursor: pointer; font-weight: 500;">\n        Try Again\n      </button>\n    </div>\n  ',t.appendChild(s);const i=s.querySelector("#retry-permission-btn");i&&i.addEventListener("click",()=>{console.log("ðŸ¤– Android permission retry requested"),(0,n.setMicOn)(!1),setTimeout(()=>{(0,n.setMicOn)(!0)},100)}),console.log("ðŸ¤– Android permission error message displayed with retry button")}()):b(),(0,n.setMicOn)(!1))},onRecordingStateChange:e=>{m&&(e?(console.log("ðŸŽ¤ Wave animation: Recording active"),m.start(!0)):(console.log("ðŸ”‡ Wave animation: Recording stopped"),m.start(!1)))}})}function k(){f&&f.stop().then(()=>{console.log("Microphone stopped due to widget close")}).catch(e=>{console.error("Error stopping microphone:",e)}),g=!1,f=null}function D(){p||(p=(0,c.getResourceManager)());const e=document.createElement("button");e.className="toggle-mic-btn",e.type="button";const t=document.createElement("canvas");t.className="mic-wave",t.width=200,t.height=40,m=(0,i.createMicWave)(t);const s=i=>{v=s;const r=i?h.micOn:h.micOff,a=i?"Mic On Icon":"Mic Off Icon",o=T();let l,d;i?(l="Recording...",d="#000000"):o?(console.log("ðŸŽ¬ Video is playing - showing wait message"),l="Please wait until<br>this video completes.",d="#ffffff",e.style.fontSize="10px"):(l="Click to use<br>audio search",d="#ffffff"),e.innerHTML=`\n      <div style="display: flex; flex-direction: column; align-items: center; gap: 4px;">\n        <img src="${r}" alt="${a}" style="width: 26px; height: 26px;" />\n        <div style="font-size: 8px; color: ${d}; text-align: center; line-height: 1.1; font-weight: 500;">\n          ${l}\n        </div>\n      </div>\n    `,e.style.backgroundColor=i?"white":"#2d2d2d80",e.style.cursor=o&&!i?"not-allowed":"pointer",e.title=i?"Turn off microphone":o?"Please wait for video to complete":"Turn on microphone";const c=setTimeout(()=>{const e=E(),s=e?.querySelector("#controls-container");if(i){if(m.start(!0),s&&!s.querySelector("#mic-wave-container")){const e=document.createElement("div");e.id="mic-wave-container",e.appendChild(t),e.classList.add("visible");const i=s.children[1];s.insertBefore(e,i),s.classList.add("expanded"),g=!0,(0,n.getState)().micOn?T()?(A(),console.log("ðŸŽ¬ Video playing - mic setup prevented")):(x(),f?.start()):console.log("ðŸŽ™ï¸ Mic setup delayed - mic is off");const r=setTimeout(w,50);p.registerTimer(r,"timeout")}}else g=!1,m.stop(),f&&f.stop().then(()=>{console.log("Mic stopped successfully")}).catch(e=>{console.error("Error stopping mic:",e)}),s?.querySelector("#mic-wave-container")?.remove(),s?.classList.remove("expanded")},50);p.registerTimer(c,"timeout")};p.addEventListener(e,"click",async()=>{const e=(0,n.getState)().micOn,t=T();return console.log("ðŸŽ¬ Mic toggle requested (video playing:",t,")"),!e&&t?(console.log("ðŸŽ¬ Cannot turn on mic while video is playing"),void A()):e||(0,o.isAndroidDevice)()||"denied"!==await async function(){try{return navigator.permissions&&navigator.permissions.query?(await navigator.permissions.query({name:"microphone"})).state:((await navigator.mediaDevices.getUserMedia({audio:!0})).getTracks().forEach(e=>e.stop()),"granted")}catch(e){return"NotAllowedError"===e.name||"PermissionDeniedError"===e.name?"denied":"prompt"}}()?(!e&&(0,o.isAndroidDevice)()&&console.log("ðŸ¤– Android device - letting micController handle permissions"),(0,n.setMicOn)(!e),void console.log("ðŸŽ™ï¸ Mic toggled:",!e)):(console.log("ðŸŽ¤ Microphone permission denied"),void b())}),y=(0,n.subscribeMic)(s),p.registerSubscription(y,"mic state subscription");const r=setTimeout(()=>s((0,n.getState)().micOn),50);return p.registerTimer(r,"timeout"),e}function _(){k(),m&&(m.stop(),m=null),y&&(y(),y=null),g=!1,f=null}function C(){if(v){const e=(0,n.getState)();v(e.micOn)}else console.log("âŒ Global update function not available")}!function(){p||(p=(0,c.getResourceManager)());const e=setTimeout(R,1e3);p.registerTimer(e,"timeout");const t=setTimeout(I,1e3);p.registerTimer(t,"timeout");const s=()=>{const e=T();!(0,n.getState)().micOn&&v&&(console.log("ðŸŽ¬ Periodic video state check - isPlaying:",e),v(!1));const t=setTimeout(s,2e3);p.registerTimer(t,"timeout")},i=setTimeout(s,2e3);p.registerTimer(i,"timeout"),console.log("ðŸ”§ Mic Component: Initialized with resource management and periodic checks")}()},"./src/js/components/mic/micController.js":(e,t,s)=>{function i(){const e=["audio/webm;codecs=opus","audio/webm","audio/wav"].filter(e=>MediaRecorder.isTypeSupported(e));return console.log("ðŸŽ¤ Supported audio formats:",e),e}s.r(t),s.d(t,{default:()=>n,getSupportedAudioFormats:()=>i});const n=({lang:e="en-US",onResult:t,onError:s,onStart:i,onEnd:n,onRecordingStateChange:r})=>{const a=/Android/i.test(navigator.userAgent);a&&console.log("ðŸ¤– Android device detected - using MediaRecorder only (no Speech Recognition)");const o=a?null:window.SpeechRecognition||window.webkitSpeechRecognition;let l=null;!a&&o?(l=new o,l.lang=e,l.interimResults=!1,l.continuous=!1,window.webkitSpeechRecognition&&(l.continuous=!1,l.interimResults=!1,console.log("Using webkitSpeechRecognition for Safari"))):a||console.error("ðŸš« Speech Recognition not supported in this browser");let d=!1,c=!1,h=null,u=[],f=null,g=null,m=!1,p=null,y=null,v=null,E=!1,T=null,S="audio/webm";const b={silenceThreshold:.01,silenceDuration:1e3,speechThreshold:.02,checkInterval:100};console.log("ðŸŽ¤ VAD Settings:",b);const A=()=>{if(!g)return;p=new(window.AudioContext||window.webkitAudioContext),y=p.createAnalyser(),v=p.createMediaStreamSource(g),y.fftSize=256,y.smoothingTimeConstant=.8,v.connect(y);const e=y.frequencyBinCount,t=new Uint8Array(e),s=()=>{if(!d)return;y?.getByteFrequencyData(t);let i=0;for(let s=0;s<e;s++)i+=t[s];const n=i/e/255;n>b.speechThreshold&&!E?(console.log("ðŸŽ¤ Speech detected - starting audio recording"),L()):n<b.silenceThreshold&&E?(T&&clearTimeout(T),T=setTimeout(()=>{E&&(console.log("ðŸ”‡ Silence detected - stopping audio recording"),w())},b.silenceDuration)):n>b.silenceThreshold&&E&&T&&(clearTimeout(T),T=null),d&&setTimeout(s,b.checkInterval)};s()},L=()=>{if(E)return;if(!window.MediaRecorder)return console.error("ðŸ¤– MediaRecorder API not available on this device"),void(s&&s({error:"not-supported",message:"Audio recording not supported on this device/browser."}));const e=["audio/webm;codecs=opus","audio/webm","audio/wav"];let t=!1;for(const s of e){if(t)break;try{MediaRecorder.isTypeSupported&&MediaRecorder.isTypeSupported(s)&&(h=new MediaRecorder(g,{mimeType:s}),S=s,console.log(`ðŸŽ¤ Audio recording started with format: ${s}`),t=!0)}catch(e){console.log(`Format ${s} not supported, trying next...`,e);continue}}if(!t)try{h=new MediaRecorder(g),console.log("ðŸŽ¤ Audio recording started with default format"),t=!0}catch(e){return console.error("Failed to create MediaRecorder with any format:",e),void(E=!1)}u=[],E=!0,h.ondataavailable=e=>{e.data.size>0&&u.push(e.data)},h.onstart=()=>{console.log("ðŸŽ¤ Audio recording started"),r&&r(!0)},h.start(100)},w=()=>{E&&h&&(console.log("ðŸ”‡ Stopping audio recording..."),E=!1,r&&r(!1),"recording"===h.state&&(a&&(h.onstop=()=>{console.log("ðŸ¤– Android MediaRecorder stopped, processing result..."),setTimeout(()=>{R()},100)}),h.stop()))},R=async()=>{m?console.log("ðŸ¤– Already processing result, skipping..."):(m=!0,console.log("ðŸ¤– Android MediaRecorder processing audio result..."),E&&(console.log("ðŸ¤– Stopping audio recording for processing..."),w()),h&&"recording"===h.state?await new Promise(e=>{const t=h.onstop;h.onstop=async()=>{console.log("ðŸ¤– MediaRecorder stopped, processing audio..."),u.length>0?(f=new Blob(u,{type:S}),console.log(`ðŸ¤– Audio blob created with format ${S}, size:`,f.size,"bytes")):(console.warn("ðŸ¤– No audio chunks captured"),f=null),t&&t(),e()},h.stop()}):u.length>0&&(f=new Blob(u,{type:S}),console.log(`ðŸ¤– Audio blob created from existing chunks with format ${S}, size:`,f.size,"bytes")),g&&(g.getTracks().forEach(e=>{e.stop(),console.log("ðŸ¤– Audio track stopped:",e.kind)}),g=null),p&&(p.close(),p=null,y=null,v=null),T&&(clearTimeout(T),T=null),t&&t("",f,0),setTimeout(()=>{m=!1},1e3))};!a&&l&&(l.onresult=async e=>{if(m)return void console.log("Already processing result, skipping...");m=!0;const s=e.results[0][0].transcript,i=e.results[0][0].confidence;console.log("Speech recognition result:",s),console.log("Transcript confidence:",i),E&&(console.log("Stopping audio recording for processing..."),w()),h&&"recording"===h.state?await new Promise(e=>{const t=h.onstop;h.onstop=async()=>{console.log("MediaRecorder stopped, processing audio..."),u.length>0?(f=new Blob(u,{type:S}),console.log(`Audio blob created with format ${S}, size:`,f.size,"bytes")):(console.warn("No audio chunks captured"),f=null),t&&t(),e()},h.stop()}):u.length>0&&(f=new Blob(u,{type:S}),console.log(`Audio blob created from existing chunks with format ${S}, size:`,f.size,"bytes")),g&&(g.getTracks().forEach(e=>{e.stop(),console.log("Audio track stopped:",e.kind)}),g=null),p&&(p.close(),p=null,y=null,v=null),T&&(clearTimeout(T),T=null),t&&t(s,f,i),setTimeout(()=>{m=!1},1e3)},l.onerror=e=>{console.error("Speech recognition error:",e.error,e.message),"not-allowed"!==e.error&&"permission-denied"!==e.error||(console.log("Microphone permission denied, stopping recognition attempts"),c=!1,d=!1),"network"!==e.error&&"service-not-allowed"!==e.error||console.log("Safari network or service error, may need user interaction"),m=!1,s&&s(e)},l.onstart=()=>{d=!0,f=null,m=!1,E=!1,console.log("Speech recognition started"),(async()=>{try{if(navigator.permissions&&navigator.permissions.query)try{if("denied"===(await navigator.permissions.query({name:"microphone"})).state)throw new Error("Microphone permission denied")}catch(e){console.log("Permissions API not available or failed, proceeding with getUserMedia",e)}const e={audio:{echoCancellation:!0,noiseSuppression:!0,sampleRate:44100,autoGainControl:!0,channelCount:1}};g=await navigator.mediaDevices.getUserMedia(e),console.log("Audio stream obtained, starting VAD..."),A()}catch(e){if(console.error("Audio capture error:",e),"NotAllowedError"===e.name||"NotSupportedError"===e.name)try{console.log("Trying with minimal audio constraints for Safari..."),g=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1}}),console.log("Fallback audio stream obtained with minimal constraints, starting VAD..."),A()}catch(e){throw console.error("Fallback audio capture failed:",e),e}else try{g=await navigator.mediaDevices.getUserMedia({audio:!0}),console.log("Basic audio stream obtained, starting VAD..."),A()}catch(e){throw console.error("Basic audio capture failed:",e),e}}})(),i&&i()},l.onend=()=>{d=!1,console.log("Speech recognition ended"),E&&w(),p&&(p.close(),p=null,y=null,v=null),T&&(clearTimeout(T),T=null),n&&n(),c&&!0===d&&!m?(console.log("Restarting speech recognition..."),setTimeout(()=>I.start(),1e3)):console.log("Speech recognition not restarting - stopped, error occurred, or processing result")});const I={start(){if(c=!0,a)return console.log("ðŸ¤– Starting MediaRecorder-only mode on Android..."),void(async()=>{if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){console.error("ðŸ¤– MediaDevices API not available on this Android device");const e=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;if(e){console.log("ðŸ¤– Trying legacy getUserMedia for Android...");try{const t=await new Promise((t,s)=>{e.call(navigator,{audio:!0},t,s)});return console.log("ðŸ¤– Android microphone permission granted via legacy API"),g=t,d=!0,f=null,m=!1,E=!1,console.log("ðŸ¤– Android MediaRecorder mode started with legacy API"),A(),void(i&&i())}catch(e){console.error("ðŸ¤– Legacy getUserMedia failed:",e)}}return void(s&&s({error:"not-supported",message:"Microphone API not supported on this Android device/browser."}))}try{console.log("ðŸ¤– Requesting Android microphone permission...");const e=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}});console.log("ðŸ¤– Android microphone permission granted"),g=e,d=!0,f=null,m=!1,E=!1,console.log("ðŸ¤– Android MediaRecorder mode started"),A(),i&&i()}catch(e){console.error("ðŸ¤– Android microphone permission error:",e);try{console.log("ðŸ¤– Trying basic audio constraints for Android...");const e=await navigator.mediaDevices.getUserMedia({audio:!0});console.log("ðŸ¤– Android microphone permission granted with basic constraints"),g=e,d=!0,f=null,m=!1,E=!1,console.log("ðŸ¤– Android MediaRecorder mode started with basic audio"),A(),i&&i()}catch(e){console.error("ðŸ¤– Android microphone permission denied (basic):",e),s&&s({error:"not-allowed",message:"Microphone permission denied. Please allow microphone access and try again."})}}})();if(!l)return console.error("ðŸš« Speech Recognition not available"),void(s&&s({error:"not-supported",message:"Speech Recognition not supported"}));try{"undefined"!=typeof window&&window.webkitSpeechRecognition&&console.log("Starting speech recognition in Safari..."),l.start()}catch(e){console.warn("Failed to start recognition:",e),"not-allowed"!==e.error&&"permission-denied"!==e.error||(console.log("Speech recognition permission denied"),c=!1,d=!1)}},async stop(){if(console.log("Stopping MicController..."),c=!1,d=!1,m=!1,E&&w(),h&&"recording"===h.state&&(console.log("Stopping MediaRecorder..."),h.stop(),await new Promise(e=>{setTimeout(e,200)})),g&&(console.log("Stopping audio stream..."),g.getTracks().forEach(e=>{e.stop(),console.log("Audio track stopped:",e.kind)}),g=null),p&&(p.close(),p=null,y=null,v=null),T&&(clearTimeout(T),T=null),u=[],f=null,!a&&l)try{l.stop(),console.log("Speech recognition stopped")}catch(e){console.warn("Error stopping recognition:",e)}console.log("MicController stopped completely")},isListening:()=>d};return I}},"./src/js/components/mic/style.css":(e,t,s)=>{s.r(t),s.d(t,{default:()=>y});var i=s("./node_modules/style-loader/dist/runtime/injectStylesIntoStyleTag.js"),n=s.n(i),r=s("./node_modules/style-loader/dist/runtime/styleDomAPI.js"),a=s.n(r),o=s("./node_modules/style-loader/dist/runtime/insertBySelector.js"),l=s.n(o),d=s("./node_modules/style-loader/dist/runtime/setAttributesWithoutAttributes.js"),c=s.n(d),h=s("./node_modules/style-loader/dist/runtime/insertStyleElement.js"),u=s.n(h),f=s("./node_modules/style-loader/dist/runtime/styleTagTransform.js"),g=s.n(f),m=s("./node_modules/css-loader/dist/cjs.js!./src/js/components/mic/style.css"),p={};p.styleTagTransform=g(),p.setAttributes=c(),p.insert=l().bind(null,"head"),p.domAPI=a(),p.insertStyleElement=u(),n()(m.default,p);const y=m.default&&m.default.locals?m.default.locals:void 0},"./src/js/components/mic/wave.js":(e,t,s)=>{function i(e){const t=e.getContext("2d");e.width=200,e.height=40;const s=12,i=new Array(s).fill(4),n=new Array(s).fill(4),r=new Array(s).fill(!0),a=new Array(s).fill(0);let o,l,d,c,h,u=!1,f=0,g=!0;function m(){h=requestAnimationFrame(m),t.clearRect(0,0,e.width,e.height),!u&&l&&l?.getByteFrequencyData(d);const o=(e.width-146)/2;for(let e=0;e<s;e++){if(!u&&d){const t=Math.floor(e/s*d.length),i=d[t]/255,o=.8+.4*Math.random();n[e]=4+31*i*o,a[e]=g?Math.min(1,a[e]+.1):1,r[e]=!1}else{const t=Math.abs(e-5.5)/5.5,s=(Math.sin(f+.8*e)+1)/2*(1-.5*t);n[e]=4*(.5+.5*s),a[e]=g?0:Math.max(0,a[e]-.1),r[e]=!0}i[e]+=.15*(n[e]-i[e])}g=u;for(let n=0;n<s;n++){const s=o+13*n,r=Math.max(4,i[n]),l=(e.height-r)/2;if(u||a[n]<.5){const i=e.height/2,r=2*(1+.5*a[n]),o=t.createRadialGradient(s+1.5,i,0,s+1.5,i,r);u?(o.addColorStop(0,"#ffffff60"),o.addColorStop(1,"#ffffff20")):(o.addColorStop(0,"#ffffff"),o.addColorStop(1,"#ffffff60")),t.fillStyle=o,t.beginPath(),t.arc(s+1.5,i,r,0,2*Math.PI),t.fill()}else{const e=t.createLinearGradient(s,l,s,l+r);e.addColorStop(0,"#ffffff"),e.addColorStop(.5,"#ffffffcc"),e.addColorStop(1,"#ffffff80"),t.fillStyle=e,t.beginPath();const i=1.5;if(t.moveTo(s+i,l),t.lineTo(s+3-i,l),t.quadraticCurveTo(s+3,l,s+3,l+i),t.lineTo(s+3,l+r-i),t.quadraticCurveTo(s+3,l+r,s+3-i,l+r),t.lineTo(s+i,l+r),t.quadraticCurveTo(s,l+r,s,l+r-i),t.lineTo(s,l+i),t.quadraticCurveTo(s,l,s+i,l),t.closePath(),t.fill(),r>9){t.shadowColor="#ffffff",t.shadowBlur=3,t.fillStyle="#ffffff20",t.beginPath();const e=i+1;t.moveTo(s-1+e,l-1),t.lineTo(s-1+3+2-e,l-1),t.quadraticCurveTo(s-1+3+2,l-1,s-1+3+2,l-1+e),t.lineTo(s-1+3+2,l-1+r+2-e),t.quadraticCurveTo(s-1+3+2,l-1+r+2,s-1+3+2-e,l-1+r+2),t.lineTo(s-1+e,l-1+r+2),t.quadraticCurveTo(s-1,l-1+r+2,s-1,l-1+r+2-e),t.lineTo(s-1,l-1+e),t.quadraticCurveTo(s-1,l-1,s-1+e,l-1),t.closePath(),t.fill(),t.shadowBlur=0}}}f+=.08}function p(){cancelAnimationFrame(h),t.clearRect(0,0,e.width,e.height),o&&"closed"!==o.state&&o.close().catch(()=>{}),c?.getTracks().forEach(e=>e.stop()),o=null,c=null}return{start:async function(e=!0){if(p(),e)try{c=await navigator.mediaDevices.getUserMedia({audio:!0}),o=new(window.AudioContext||window.webkitAudioContext);const e=o.createMediaStreamSource(c);l=o.createAnalyser(),l.fftSize=128,l.smoothingTimeConstant=.8,d=new Uint8Array(l.frequencyBinCount),e.connect(l),u=!1}catch(e){console.warn("ðŸŽ™ï¸ Mic access failed, using fake animation",e),u=!0}else u=!0;m()},stop:p}}s.r(t),s.d(t,{createMicWave:()=>i})},"./src/js/components/suggestions/index.js":(e,t,s)=>{s.r(t),s.d(t,{createSuggestionsOverlay:()=>i.createSuggestionsOverlay,createSuggestionsSystem:()=>i.createSuggestionsSystem,default:()=>i.createSuggestionsSystem,fetchSuggestions:()=>i.fetchSuggestions,hideSuggestions:()=>i.hideSuggestions,sendSuggestionToAPI:()=>i.sendSuggestionToAPI,showSuggestions:()=>i.showSuggestions,updateSuggestions:()=>i.updateSuggestions});var i=s("./src/js/components/suggestions/suggestions.js")},"./src/js/components/suggestions/style.css":(e,t,s)=>{s.r(t),s.d(t,{default:()=>y});var i=s("./node_modules/style-loader/dist/runtime/injectStylesIntoStyleTag.js"),n=s.n(i),r=s("./node_modules/style-loader/dist/runtime/styleDomAPI.js"),a=s.n(r),o=s("./node_modules/style-loader/dist/runtime/insertBySelector.js"),l=s.n(o),d=s("./node_modules/style-loader/dist/runtime/setAttributesWithoutAttributes.js"),c=s.n(d),h=s("./node_modules/style-loader/dist/runtime/insertStyleElement.js"),u=s.n(h),f=s("./node_modules/style-loader/dist/runtime/styleTagTransform.js"),g=s.n(f),m=s("./node_modules/css-loader/dist/cjs.js!./src/js/components/suggestions/style.css"),p={};p.styleTagTransform=g(),p.setAttributes=c(),p.insert=l().bind(null,"head"),p.domAPI=a(),p.insertStyleElement=u(),n()(m.default,p);const y=m.default&&m.default.locals?m.default.locals:void 0},"./src/js/components/suggestions/suggestions.js":(e,t,s)=>{s.r(t),s.d(t,{createSuggestionsOverlay:()=>o,createSuggestionsSystem:()=>a,fetchSuggestions:()=>u,hideSuggestions:()=>d,sendSuggestionToAPI:()=>h,showSuggestions:()=>l,updateSuggestions:()=>c});var i=s("./src/js/utils/api.js"),n=s("./src/store/index.js"),r=s("./src/js/utils/ResponseManager.js");s("./src/js/components/suggestions/style.css");const a=(e=null,t={})=>{let s=e,a=null,o=!1,l=[],d=null,c=null,h=0,u=Date.now(),f={...(0,n.getSuggestionsConfig)(),...t};const g=e=>(s=e,a=m(),s.appendChild(a),f.autoShowEnabled&&p(),I),m=()=>{const e=document.createElement("div");return e.id="suggestions-overlay",e.className="suggestions-overlay",e.style.display="none",e},p=()=>{d&&clearTimeout(d),h>=f.maxAutoShows?console.log("â„¹ï¸ Maximum auto-shows reached, stopping auto-show timer"):(d=setTimeout(()=>{y()},f.autoShowDelay),console.log(`â° Auto-show timer started: ${f.autoShowDelay}ms`))},y=async()=>{o||Date.now()-u<f.autoShowDelay||(l&&l.length>0?(h++,await v(l),console.log(`âœ… Auto-showed existing suggestions (${h}/${f.maxAutoShows}):`,l),f.autoHideEnabled&&E()):console.log("â„¹ï¸ No existing suggestions available for auto-show")),p()},v=async e=>{if(!a)return;if(a.innerHTML="",!e||!Array.isArray(e)||0===e.length)return void b();console.log("ðŸ”„ Showing existing suggestions without resetting auto-show count");const t=document.createElement("div");t.className="suggestions-container";const s=document.createElement("div");s.className="suggestions-header";const i=document.createElement("div");i.className="suggestions-title",i.textContent="Suggestions",s.appendChild(i);const n=document.createElement("button");n.className="suggestions-close-btn",n.innerHTML='\n      <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">\n        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>\n      </svg>\n    ',n.setAttribute("aria-label","Close suggestions"),n.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),b(),console.log("âœ… Suggestions closed by user")}),s.appendChild(n),t.appendChild(s);const r=document.createElement("div");r.className="suggestions-list";const o=f.maxVisibleSuggestions||4,l=e.length>o,d=l?e.slice(0,o):e;let c=!1;const h=(t,s=!1)=>{if(r.innerHTML="",t.forEach((e,t)=>{const s=document.createElement("button");s.className="suggestion-item",s.textContent=e,s.setAttribute("data-suggestion",e),s.setAttribute("data-index",t),s.addEventListener("click",async e=>{e.preventDefault(),e.stopPropagation();const t=e.target.getAttribute("data-suggestion"),i=e.target.getAttribute("data-index");await A(s,t,i)}),r.appendChild(s)}),l&&!s){const t=document.createElement("button");t.className="suggestion-item more-button",t.innerHTML=`\n          +${e.length-o} more\n        `,t.setAttribute("aria-label",`Show ${e.length-o} more suggestions`),t.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),c=!0,h(e,!0),console.log(`âœ… Expanded to show all ${e.length} suggestions`)}),r.appendChild(t)}if(l&&s){const e=document.createElement("button");e.className="suggestion-item less-button",e.innerHTML='\n          <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">\n            <path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/>\n          </svg>\n          Show less\n        ',e.setAttribute("aria-label","Show fewer suggestions"),e.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),c=!1,h(d,!1),console.log(`âœ… Collapsed to show ${o} suggestions`)}),r.appendChild(e)}};h(d,!1),t.appendChild(r),a.appendChild(t),S()},E=()=>{setTimeout(()=>{o&&(b(),console.log("â° Auto-hide: suggestions hidden after timeout"))},f.autoHideDelay)},T=e=>{f={...f,...e},f.autoShowEnabled?p():d&&(clearTimeout(d),d=null),console.log("âš™ï¸ Suggestions config updated:",f)},S=()=>{a&&((()=>{const e=(0,n.getState)().currentView;return console.log("ðŸ” Checking if suggestions should show for view:",e),"contact"===e||"object"==typeof e&&"contact"===e.currentView?(console.log("â„¹ï¸ Suggestions disabled for contact view:",e),!1):(console.log("âœ… Suggestions allowed for current view:",e),!0)})()?(a.style.display="flex",a.style.opacity="0",requestAnimationFrame(()=>{a.style.transition="opacity 0.3s ease-in-out",a.style.opacity="1"}),o=!0):console.log("â„¹ï¸ Suggestions not shown due to current view state"))},b=()=>{a&&(a.style.transition="opacity 0.3s ease-in-out",a.style.opacity="0",setTimeout(()=>{a.style.display="none"},300),o=!1)},A=async(e,t,s)=>{e.classList.add("loading"),e.disabled=!0,e.innerHTML=`\n      <span class="loading-spinner"></span>\n      ${t}\n    `;try{await R(t,s),b(),console.log("âœ… Suggestion sent successfully:",t)}catch(s){console.error("âŒ Failed to send suggestion:",s),e.classList.remove("loading"),e.disabled=!1,e.textContent=t,e.classList.add("error"),setTimeout(()=>{e.classList.remove("error")},2e3)}},L=sessionStorage.getItem("conversation_history");let w=[];try{L&&(w=JSON.parse(L))}catch(e){console.error("Error parsing conversation history:",e)}const R=async(e,t)=>{try{const s=await(0,i.apiRequest)({action:"message",question:e,conversation_history:w});console.log("ðŸŽ¯ Suggestions: Processing API response with ResponseManager",s);const n=await(0,r.handleAPIResponse)(s,{source:"suggestions",selectedSuggestion:e,suggestionIndex:t});return console.log("ðŸŽ¯ Suggestions: ResponseManager result",n),n}catch(e){throw console.error("âŒ Error sending suggestion to API:",e),e}};c=(0,n.subscribeSuggestions)(e=>{console.log("âš™ï¸ Store config changed, updating suggestions system:",e),T(e)});const I={init:g,show:S,hide:b,update:async e=>{if(!a)return;if(a.innerHTML="",l=e||[],!e||!Array.isArray(e)||0===e.length)return void b();console.log("ðŸ”„ New suggestions received, resetting auto-show count"),h=0;const t=document.createElement("div");t.className="suggestions-container";const s=document.createElement("div");s.className="suggestions-header";const i=document.createElement("div");i.className="suggestions-title",i.textContent="Suggestions",s.appendChild(i);const n=document.createElement("button");n.className="suggestions-close-btn",n.innerHTML='\n      <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">\n        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>\n      </svg>\n    ',n.setAttribute("aria-label","Close suggestions"),n.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),b(),console.log("âœ… Suggestions closed by user")}),s.appendChild(n),t.appendChild(s);const r=document.createElement("div");r.className="suggestions-list";const o=f.maxVisibleSuggestions||4,d=e.length>o,c=d?e.slice(0,o):e;let u=!1;const g=(t,s=!1)=>{if(r.innerHTML="",t.forEach((e,t)=>{const s=document.createElement("button");s.className="suggestion-item",s.textContent=e,s.setAttribute("data-suggestion",e),s.setAttribute("data-index",t),s.addEventListener("click",async e=>{e.preventDefault(),e.stopPropagation();const t=e.target.getAttribute("data-suggestion"),i=e.target.getAttribute("data-index");await A(s,t,i)}),r.appendChild(s)}),d&&!s){const t=document.createElement("button");t.className="suggestion-item more-button",t.innerHTML=`\n          +${e.length-o} more\n        `,t.setAttribute("aria-label",`Show ${e.length-o} more suggestions`),t.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),u=!0,g(e,!0),console.log(`âœ… Expanded to show all ${e.length} suggestions`)}),r.appendChild(t)}if(d&&s){const e=document.createElement("button");e.className="suggestion-item less-button",e.innerHTML='\n          <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">\n            <path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/>\n          </svg>\n          Show less\n        ',e.setAttribute("aria-label","Show fewer suggestions"),e.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),u=!1,g(c,!1),console.log(`âœ… Collapsed to show ${o} suggestions`)}),r.appendChild(e)}};g(c,!1),t.appendChild(r),a.appendChild(t),S()},loadFromAPI:async()=>(console.log("â„¹ï¸ Suggestions are only loaded from message/voice_message API responses, not separate API calls"),[]),trackInteraction:()=>{u=Date.now(),console.log("ðŸ‘† User interaction tracked, resetting auto-show timer"),f.autoShowEnabled&&p()},updateConfig:T,destroy:()=>{d&&(clearTimeout(d),d=null),c&&(c(),c=null),a&&a.parentNode&&a.parentNode.removeChild(a),a=null,s=null,l=[],o=!1,console.log("ðŸ§¹ Suggestions system destroyed and cleaned up")},sendToAPI:R,resetAutoShowCount:()=>{h=0,console.log("ðŸ”„ Auto-show count reset to 0"),f.autoShowEnabled&&p()},get isVisible(){return o},get overlay(){return a},get suggestions(){return l},get config(){return f}};return e&&g(e),I},o=e=>{const t=a(e);return{overlay:t.overlay,showSuggestions:()=>t.show(),hideSuggestions:()=>t.hide(),updateSuggestions:e=>t.update(e),system:t}},l=e=>{e.style.display="flex",e.style.opacity="0",requestAnimationFrame(()=>{e.style.transition="opacity 0.3s ease-in-out",e.style.opacity="1"})},d=e=>{e.style.transition="opacity 0.3s ease-in-out",e.style.opacity="0",setTimeout(()=>{e.style.display="none"},300)},c=async(e,t)=>{if(e.innerHTML="",!t||!Array.isArray(t)||0===t.length)return void d(e);const s=document.createElement("div");s.className="suggestions-container";const i=document.createElement("div");i.className="suggestions-title",i.textContent="Suggestions",s.appendChild(i);const n=document.createElement("div");n.className="suggestions-list",t.forEach((t,s)=>{const i=document.createElement("button");i.className="suggestion-item",i.textContent=t,i.setAttribute("data-suggestion",t),i.setAttribute("data-index",s),i.addEventListener("click",async t=>{t.preventDefault(),t.stopPropagation();const s=t.target.getAttribute("data-suggestion"),n=t.target.getAttribute("data-index");i.classList.add("loading"),i.disabled=!0,i.innerHTML=`\n        <span class="loading-spinner"></span>\n        ${s}\n      `;try{await h(s,n),d(e),console.log("âœ… Suggestion sent successfully:",s)}catch(e){console.error("âŒ Failed to send suggestion:",e),i.classList.remove("loading"),i.disabled=!1,i.textContent=s,i.classList.add("error"),setTimeout(()=>{i.classList.remove("error")},2e3)}}),n.appendChild(i)}),s.appendChild(n),e.appendChild(s),l(e)},h=async(e,t)=>{try{const s=await(0,i.apiRequest)({action:"message",question:e});console.log("ðŸŽ¯ Legacy Suggestions: Processing API response with ResponseManager",s);const n=await(0,r.handleAPIResponse)(s,{source:"legacy-suggestions",selectedSuggestion:e,suggestionIndex:t});return console.log("ðŸŽ¯ Legacy Suggestions: ResponseManager result",n),n}catch(e){throw console.error("âŒ Error sending suggestion to API:",e),e}},u=async()=>{try{return(await(0,i.apiRequest)({action:"get_suggestions"})).suggestions||[]}catch(e){return console.error("âŒ Error fetching suggestions:",e),[]}}},"./src/js/components/video/style.css":(e,t,s)=>{s.r(t),s.d(t,{default:()=>y});var i=s("./node_modules/style-loader/dist/runtime/injectStylesIntoStyleTag.js"),n=s.n(i),r=s("./node_modules/style-loader/dist/runtime/styleDomAPI.js"),a=s.n(r),o=s("./node_modules/style-loader/dist/runtime/insertBySelector.js"),l=s.n(o),d=s("./node_modules/style-loader/dist/runtime/setAttributesWithoutAttributes.js"),c=s.n(d),h=s("./node_modules/style-loader/dist/runtime/insertStyleElement.js"),u=s.n(h),f=s("./node_modules/style-loader/dist/runtime/styleTagTransform.js"),g=s.n(f),m=s("./node_modules/css-loader/dist/cjs.js!./src/js/components/video/style.css"),p={};p.styleTagTransform=g(),p.setAttributes=c(),p.insert=l().bind(null,"head"),p.domAPI=a(),p.insertStyleElement=u(),n()(m.default,p);const y=m.default&&m.default.locals?m.default.locals:void 0},"./src/js/components/video/video.js":(e,t,s)=>{s.r(t),s.d(t,{changeVideoSource:()=>g,renderVideoPlayer:()=>p});var i=s("./node_modules/hls.js/dist/hls.mjs"),n=s("./src/js/components/contact.js"),r=s("./src/store/index.js"),a=s("./src/js/utils/index.js"),o=s("./src/js/components/chat/chatToggleButton.js"),l=(s("./src/js/components/video/style.css"),s("./src/js/components/mic/index.js"));const d=document.getElementById("fb-widget-config")?.getAttribute("data-partner_id"),c=document.getElementById("fb-widget-config")?.getAttribute("data-fb_id"),h=()=>{const e=(0,r.getState)().widgetConfig?.default_video_url;return"string"==typeof e&&e.trim()?e.trim():`https://d1jcbfcd9v1do3.cloudfront.net/${d}/videos/knowledge_base/${c}/default/1_playlist.m3u8`},u=`https://d1jcbfcd9v1do3.cloudfront.net/${d}/videos/knowledge_base/${c}/contact/1_playlist.m3u8`;function f(e){return new Promise((t,s)=>{e.muted=!1,e.play().then(()=>{console.log("âœ… Autoplay successful with sound"),t()}).catch(i=>{console.warn("âš ï¸ Autoplay with sound failed, trying muted:",i.message),e.muted=!0,e.play().then(()=>{console.log("âœ… Muted autoplay successful");const s=e.closest("#widget-video-player");if(s&&e.muted){const t=function(e){const t=document.createElement("div");return t.className="video-unmute-button",t.innerHTML='\n    <div style="\n      position: absolute;\n      top: 20px;\n      right: 20px;\n      background: rgba(0, 0, 0, 0.7);\n      color: white;\n      padding: 10px 15px;\n      border-radius: 20px;\n      cursor: pointer;\n      font-size: 14px;\n      z-index: 15;\n      display: flex;\n      align-items: center;\n      gap: 8px;\n      transition: opacity 0.3s ease;\n    ">\n      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">\n        <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>\n      </svg>\n      Unmute\n    </div>\n  ',t.onclick=()=>{e.muted=!1,t.querySelector("div").style.opacity="0",setTimeout(()=>{t.remove()},300)},t}(e);s.appendChild(t)}t()}).catch(i=>{console.warn("âš ï¸ Muted autoplay also failed:",i.message);const n=document.createElement("div");n.className="video-play-button",n.innerHTML='\n              <div style="\n                position: absolute;\n                top: 50%;\n                left: 50%;\n                transform: translate(-50%, -50%);\n                background: rgba(0, 0, 0, 0.7);\n                color: white;\n                padding: 15px 25px;\n                border-radius: 25px;\n                cursor: pointer;\n                font-size: 16px;\n                z-index: 10;\n                display: flex;\n                align-items: center;\n                gap: 10px;\n              ">\n                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">\n                  <path d="M8 5v14l11-7z"/>\n                </svg>\n                Click to Play Video\n              </div>\n            ';const r=e.closest("#widget-video-player");r&&(r.appendChild(n),n.onclick=()=>{e.muted=!1,e.play().then(()=>{n.remove(),t()}).catch(s)}),s(i)})})})}function g(e,t){if(e)try{if(e.onended=null,e.hlsInstance instanceof i.default&&(e.hlsInstance.destroy(),e.hlsInstance=null),e.loop=t===h(),e.canPlayType("application/vnd.apple.mpegurl"))e.src=t,e.load(),e.addEventListener("canplay",()=>{f(e).catch(console.error)},{once:!0});else if(i.default.isSupported()){const s=new i.default;s.attachMedia(e),s.on(i.default.Events.MEDIA_ATTACHED,()=>{console.log("âœ… HLS: Media attached"),s.loadSource(t)}),s.on(i.default.Events.MANIFEST_PARSED,()=>{console.log("âœ… HLS: Manifest parsed"),f(e).catch(console.error)}),s.on(i.default.Events.ERROR,(e,t)=>{console.error("âŒ HLS Error:",t)}),e.hlsInstance=s}else console.error("âŒ HLS not supported")}catch(e){console.error("âŒ Failed to change video source:",e)}else console.error("âŒ Video element is null.")}function m(e){if(e)try{e.pause(),e.currentTime=0,e.src="",e.load(),e.hlsInstance instanceof i.default&&(e.hlsInstance.destroy(),e.hlsInstance=null),e.onended=null,e.oncanplay=null,e.onloadedmetadata=null,e.onplaying=null,e.loop=!1,e.muted=!1,e.playsInline=!0,e.preload="auto",console.log("âœ… Video element cleaned up")}catch(e){console.error("âŒ Error cleaning up video element:",e)}}const p=e=>{const t=document.createElement("div");t.id="widget-video-player",t.style.position="relative",t.style.width="100%",t.style.height="50vh",t.style.overflow="hidden";const s=document.createElement("div");s.id="controls-container";const d=(0,l.renderMicToggleButton)();s.appendChild(d),t.appendChild(s);const c=(0,o.renderChatToggleButton)();s.appendChild(c),t.appendChild(s);const p=document.createElement("video");p.id="fb-video-background",p.preload="auto";const y=document.createElement("video");return y.id="fb-video-main",[p,y].forEach(e=>{e.controls=!1,e.muted=!1,e.playsInline=!0,e.preload="auto",e.style.width="100%",e.style.height="100%",e.style.objectFit="cover",e.style.position="absolute",e.style.top="0",e.style.left="0",e.style.transition="opacity 0.4s ease",e.style.opacity="0",e.style.display="block",e.style.zIndex="1",e.style.willChange="transform",e.style.transform="translateZ(0)",t.appendChild(e)}),p.style.opacity="1",t.playNewVideo=e=>{y.style.opacity="0",y.style.zIndex="2";const t=((0,r.getState)().playCount||0)+1;(0,r.setPlayCount)(t),console.log("â–¶ï¸ Play count:",t);const s=(0,r.getState)().widgetConfig?.contact_prompt_point||0;console.log("ðŸ“ Contact form trigger point:",s);const i=()=>{console.log("ðŸ” Closing chat container before contact form load"),(0,r.setChatOpen)(!1),(0,r.setView)({currentView:"contact"});const e=document.getElementById("fb-widget-config"),t=e?.shadowRoot,s=t?.getElementById("widget-content-area");if((0,a.toggleInputBar)(!1),s){s.innerHTML="";const e=(0,n.renderContactForm)();s.appendChild(e)}else console.warn("âš ï¸ Cannot find view container to render contact form.")};g(y,e),y.addEventListener("playing",()=>{y.style.opacity="1"},{once:!0}),y.onended=()=>{y.style.opacity="0",y.style.zIndex="1",(0,r.getState)().playCount===((0,r.getState)().widgetConfig?.contact_prompt_point||0)-1&&(g(y,u),y.style.opacity="1",y.style.zIndex="2",y.addEventListener("ended",function e(){y.removeEventListener("ended",e),y.style.opacity="0",y.style.zIndex="1",setTimeout(i,400)},{once:!0}))}},((e,s,n=!1)=>{if(e.hlsInstance instanceof i.default&&(e.hlsInstance.destroy(),e.hlsInstance=null),e.loop=n,e.onended=null,i.default.isSupported()){const t=new i.default;t.loadSource(s),t.attachMedia(e),t.on(i.default.Events.MANIFEST_PARSED,()=>{f(e).catch(console.warn)}),t.on(i.default.Events.ERROR,(e,t)=>{console.error("âŒ HLS Error:",t)}),e.hlsInstance=t}else e.canPlayType("application/vnd.apple.mpegurl")?(e.src=s,e.addEventListener("loadedmetadata",()=>{f(e).catch(console.warn)},{once:!0})):t.innerHTML="<p>Your browser does not support HLS playback.</p>"})(p,h(),!0),e&&(console.log("ðŸŽ¬ Playing intro video:",e),t.playNewVideo(e)),t.cleanup=()=>{console.log("ðŸ§¹ Cleaning up video player..."),m(p),m(y)},t.getVideoElement=()=>y,t}},"./src/js/components/video/videoWithChat.js":(e,t,s)=>{s.r(t),s.d(t,{renderVideoWithChat:()=>a,toggleChatState:()=>o});var i=s("./src/js/components/video/video.js"),n=s("./src/js/components/chat/chat.js"),r=s("./src/store/index.js");const a=e=>{const t=document.createElement("div");t.id="my-widget-body",t.className="video-chat-layout";const s=document.createElement("div");s.className="video-section",s.appendChild((0,i.renderVideoPlayer)(e));const a=document.createElement("div");a.className="chat-section",a.appendChild((0,n.renderChatHistory)()),t.appendChild(s),t.appendChild(a);const o=e=>{e?(a.classList.remove("collapsed"),t.closest(".my-widget-wrapper")?.classList.add("chat-visible"),a.style.flex="1 1 0",s.style.flex="1 1 0"):(a.classList.add("collapsed"),t.closest(".my-widget-wrapper")?.classList.remove("chat-visible"),a.style.flex="0 0 0",s.style.flex="1 1 0")};return(0,r.subscribeChat)(o),o((0,r.getState)().chatOpen),t};function o(){(0,r.setChatOpen)(!(0,r.getState)().chatOpen)}},"./src/js/components/video/videoWithChatMobile.js":(e,t,s)=>{s.r(t),s.d(t,{renderVideoWithChatMobile:()=>a});var i=s("./src/js/components/video/video.js"),n=s("./src/js/components/chat/chat.js"),r=s("./src/store/index.js");function a(e){const t=document.createElement("div");t.className="video-chat-mobile-container";const s=document.createElement("div");s.className="video-section",s.appendChild((0,i.renderVideoPlayer)(e));const a=document.createElement("div");a.className="mobile-chat-modal hidden";const o=document.createElement("div");let l;o.className="chat-section",o.id="mobile-chat-section",o.appendChild((0,n.renderChatHistory)()),a.appendChild(o);const d=e=>{const s=document.getElementById("fb-widget-config"),i=s?.shadowRoot;if(l=i?.querySelector("#my-widget-body"),console.log("ðŸ” Mobile chat visibility update:",{isOpen:e,bodyContainer:!!l}),l)if(e){a.classList.remove("hidden"),t.classList.add("chat-open"),t.classList.add("chat-expanded"),l.style.height="auto",l.style.minHeight="73vh",l.style.maxHeight="85vh",l.style.overflow="visible",l.classList.add("chat-expanded"),l.style.transition="height 0.4s cubic-bezier(0.4, 0, 0.2, 1)";const e=i?.querySelector(".my-widget-wrapper");e&&(e.style.height="auto",e.style.minHeight="50vh"),a.style.position="fixed",a.style.bottom="55px",a.style.left="0",a.style.right="0",a.style.zIndex="10002",console.log("ðŸ” Mobile chat opened - body height set to auto with max 85vh, modal position fixed")}else{l.style.height="50vh",l.style.minHeight="50vh",l.style.maxHeight="none",l.style.overflow="auto",l.classList.remove("chat-expanded"),a.classList.add("hidden"),t.classList.remove("chat-open"),t.classList.remove("chat-expanded");const e=i?.querySelector(".my-widget-wrapper");e&&(e.style.height="",e.style.minHeight="",e.style.maxHeight=""),a.style.position="fixed",a.style.bottom="55px",a.style.left="0",a.style.right="0",a.style.zIndex="10002",console.log("ðŸ” Mobile chat closed - body height reset to 50vh, modal position maintained")}else console.warn("âš ï¸ Body container not found in mobile video with chat")};return(0,r.subscribeChat)(d),d((0,r.getState)().chatOpen),t.appendChild(s),t.appendChild(a),t}},"./src/js/layout/body.js":(e,t,s)=>{s.r(t),s.d(t,{renderBody:()=>h});var i=s("./src/js/components/video/video.js"),n=s("./src/js/components/contact.js"),r=s("./src/js/components/chat/chat.js"),a=s("./src/js/components/video/videoWithChat.js"),o=s("./src/js/components/video/videoWithChatMobile.js"),l=s("./src/js/components/html/index.js"),d=s("./src/js/components/html/mobile.js"),c=s("./src/store/index.js");const h=(e="video",t)=>{const s=document.createElement("div");s.id="my-widget-body",s.className="fade-slide";const h=document.createElement("div");h.id="widget-content-area",s.appendChild(h);let u=null,f=e;function g(){return window.innerWidth<=900}return s.setView=async(e,m={})=>{const p=h.querySelector("#widget-video-player");switch(p&&"function"==typeof p.cleanup&&p.cleanup(),h.innerHTML="",u=null,f=e,e){case"video":const e=m?.videoUrl||t;console.log("ðŸ” Video case - videoUrl from options:",m?.videoUrl,"initial videoUrl:",t,"final videoToPlay:",e);const f=(0,i.renderVideoPlayer)(e);h.appendChild(f),m?.videoUrl&&f?.playNewVideo&&setTimeout(()=>{console.log("ðŸ” Playing new video from options:",m.videoUrl),f.playNewVideo(m.videoUrl)},100);break;case"contact":h.appendChild((0,n.renderContactForm)());break;case"chat":h.appendChild((0,r.renderChatHistory)());break;case"video_with_chat":const p=m?.videoUrl||t;console.log("ðŸ” Video with chat case - videoUrl from options:",m?.videoUrl,"initial videoUrl:",t,"final videoUrlForChat:",p),u=g()?(0,o.renderVideoWithChatMobile)(p):(0,a.renderVideoWithChat)(p),h.appendChild(u),m?.videoUrl&&setTimeout(()=>{const e=u.querySelector("#widget-video-player");e?.playNewVideo&&(console.log("ðŸ” Playing new video in video_with_chat from options:",m.videoUrl),e.playNewVideo(m.videoUrl))},100);break;case"html":console.log("ðŸ” Closing chat container before HTML load"),(0,c.setChatOpen)(!1);const{htmlLayoutId:y,htmlData:v,videoUrl:E}=m;if(console.log("ðŸ” Body setView HTML case:",{htmlLayoutId:y,htmlData:v,htmlVideoUrl:E}),console.log("ðŸ” isMobile():",g(),"window.innerWidth:",window.innerWidth),y&&v){const e=g()?(0,d.renderHtmlPanelMobile)(y,v):(0,l.renderHtmlPanel)(y,v);console.log("ðŸ” HTML render result:",e),console.log("ðŸ” HTML container:",!!e?.htmlContainer),console.log("ðŸ” Video container:",!!e?.videoContainer),e&&e.htmlContainer?(h.appendChild(e.htmlContainer),console.log("ðŸ” HTML container appended to content area")):console.warn("âš ï¸ No HTML container to append"),E&&e&&e.videoContainer&&(console.log("ðŸ” Adding video to container:",E),setTimeout(()=>{const t=document.createElement("video");t.controls=!1,t.muted=!1,t.playsInline=!0,t.preload="auto",t.autoplay=!0,t.style.width="100%",t.style.height="100%",t.style.objectFit="cover",t.style.borderRadius="8px";const s=e.videoContainer.querySelector(".video-toggle-btn");s?e.videoContainer.insertBefore(t,s):e.videoContainer.appendChild(t),console.log("ðŸ” Video element added to PIP container");try{(0,i.changeVideoSource)(t,E),console.log("ðŸ” Video source changed successfully")}catch(e){console.error("âŒ Error changing video source:",e),t.src=E,t.load(),t.play().catch(e=>console.warn("âš ï¸ Video autoplay failed:",e))}},200),h.appendChild(e.htmlContainer),console.log("ðŸ” Fallback HTML container appended to content area"))}else{console.log("ðŸ” Ultimate fallback in body.js: No HTML data or video available");const e=document.createElement("div");e.className="fallback-content-container",e.style.cssText="\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            height: 100%;\n            padding: 20px;\n            text-align: center;\n            color: #666;\n            font-family: Arial, sans-serif;\n          ",e.innerHTML='\n            <div>\n              <h3 style="margin-bottom: 10px; color: #333;">Response Received</h3>\n              <p>The system has processed your request successfully.</p>\n            </div>\n          ',h.appendChild(e),s.classList.add("fallback-layout"),window.innerWidth<=900&&(s.style.height="50vh",s.style.minHeight="50vh",s.style.maxHeight="50vh",s.style.position="relative",console.log("ðŸ” Fallback layout: Set mobile body height to 50vh"))}break;default:h.innerHTML="<p>Welcome to the widget!</p>"}},s.toggleChatPanel=()=>{u&&"function"==typeof u.toggleChat&&u.toggleChat()},window.addEventListener("resize",async()=>{if("video_with_chat"===f){const e=g(),t=u&&u.classList.contains("video-chat-mobile-container");(e&&!t||!e&&t)&&await s.setView("video_with_chat")}else if("html"===f){const e=g(),t=h.querySelector("#html-wrapper"),i=t?.querySelector(".video-pip-container"),n=i&&i.classList.contains("mobile-pip");if(e&&!n||!e&&n){const e=t?.querySelector(".layout-wrapper")?.innerHTML,i=t?.querySelector("video"),n=i?.src;e&&await s.setView("html",{htmlLayoutId:"HTML_LAYOUT_01",htmlData:e,videoUrl:n})}}}),s.setView(e),s}},"./src/js/layout/footer.js":(e,t,s)=>{function i(){const e=document.createElement("div");e.className="my-widget-footer",e.style.backgroundColor="#f9f9f9";const t=document.createElement("small");t.append("Powered by ");const s=document.createElement("a");return s.href="https://face-bot.ai",s.target="_blank",s.rel="noopener noreferrer",s.textContent="Facebot.ai",t.appendChild(s),e.appendChild(t),e}s.r(t),s.d(t,{renderFooter:()=>i})},"./src/js/layout/header.js":(e,t,s)=>{s.r(t),s.d(t,{renderHeader:()=>n});var i=s("./src/store/index.js");function n(e={}){const t=document.createElement("div");t.className="my-widget-header";const s=(0,i.getState)()?.widgetConfig?.facebot_title||"24/7 Support Agent";return t.innerHTML=`\n    <div class="header-container">\n      <h2 class="widget-title">${s}</h2>\n      <button class="close-btn" aria-label="Close Widget">Ã—</button>\n    </div>\n  `,t.querySelector(".close-btn").addEventListener("click",()=>{const e=new CustomEvent("close-widget");document.dispatchEvent(e),(0,i.setChatOpen)(!1)}),t}},"./src/js/utils/ResponseManager.js":(e,t,s)=>{s.r(t),s.d(t,{default:()=>l,handleAPIResponse:()=>o});var i=s("./src/store/index.js"),n=s("./src/js/utils/index.js"),r=s("./src/js/components/contact.js"),a=s("./src/js/components/chat/chat.js");async function o(e,t={}){try{console.log("ðŸŽ¯ Simple Response Handler: Processing response",e);const t=document.getElementById("fb-widget-config"),s=t?.shadowRoot,o=s?.getElementById("widget-content-area"),l=e?.answer_video_url?.[0],d=e?.show_contact_form,c=e?.layout_id,h=e?.additional_info,u=e?.suggestions;if(e.conversation&&sessionStorage.setItem("conversation_history",JSON.stringify(e.conversation)),u&&Array.isArray(u)&&u.length>0){console.log("âœ… Suggestions received from API:",u);const e=window.__suggestionsSystem;e&&"function"==typeof e.update&&e.update(u)}const f=s?.querySelector(".chat-section");if(f&&(f.innerHTML="",f.appendChild((0,a.renderChatHistory)())),d)return console.log("ðŸ“¨ Triggering contact form render..."),setTimeout(()=>{if((0,i.setView)({currentView:"contact"}),(0,n.toggleInputBar)(!1),o){o.innerHTML="";const e=(0,r.renderContactForm)();o.appendChild(e)}else console.warn("âš ï¸ Cannot find view container to render contact form.")},400),{success:!0,type:"contact"};if(c&&h)return(0,i.setChatOpen)(!1),console.log("ðŸ” HTML data received:",{htmlLayoutId:c,htmlData:h,videoUrl:l}),(0,i.setView)({currentView:"html"}),setTimeout(()=>{const e=s?.querySelector("#my-widget-body");e&&e.setView?(console.log("ðŸ” Calling body.setView with HTML data"),e.setView("html",{htmlLayoutId:c,htmlData:h,videoUrl:l})):console.warn("âš ï¸ Body element or setView method not found for HTML rendering")},100),{success:!0,type:"html",htmlLayoutId:c,htmlData:h,videoUrl:l};if(l)return console.log("ðŸ” Video URL received:",l),(0,i.setView)({currentView:"video_with_chat"}),setTimeout(()=>{const e=s?.querySelector("#my-widget-body");e&&e.setView?(console.log("ðŸ” Calling body.setView for video_with_chat:",l),e.setView("video_with_chat",{videoUrl:l})):console.warn("âŒ Body element or setView method not found for video_with_chat")},100),{success:!0,type:"video",videoUrl:l};if(!c&&!h||l)return console.log("ðŸ” Ultimate fallback: No HTML data or video available, showing default message"),(0,i.setView)({currentView:"video"}),setTimeout(()=>{o&&(o.innerHTML='\n            <div style="\n              display: flex;\n              align-items: center;\n              justify-content: center;\n              height: 100%;\n              padding: 20px;\n              text-align: center;\n              color: #666;\n              font-family: Arial, sans-serif;\n            ">\n              <div>\n                <h3 style="margin-bottom: 10px; color: #333;">Response Received</h3>\n                <p>The system has processed your request successfully.</p>\n              </div>\n            </div>\n          ')},100),{success:!0,type:"fallback",message:"Response processed successfully"};{console.log("ðŸ” Partial HTML data without video, creating fallback HTML view");const e=h||'<div class="fallback-content"><p>Content is loading...</p></div>',t=c||"FALLBACK_LAYOUT";return(0,i.setView)({currentView:"html"}),setTimeout(()=>{const i=s?.querySelector("#my-widget-body");i&&i.setView&&(console.log("ðŸ” Calling body.setView with fallback HTML data"),i.setView("html",{htmlLayoutId:t,htmlData:e,videoUrl:null}))},100),{success:!0,type:"html-fallback",htmlLayoutId:t,htmlData:e}}}catch(e){return console.error("âŒ Simple Response Handler: Error handling response",e),{success:!1,type:"error",error:e.message}}}const l={handleAPIResponse:o}},"./src/js/utils/api.js":(e,t,s)=>{s.r(t),s.d(t,{apiRequest:()=>o});var i=s("./src/js/utils/index.js"),n=s("./src/store/index.js");const r=["AbortError","TypeError","NetworkError"],a=[408,429,500,502,503,504],o=async(e,t=0)=>{const s=(0,i.getSessionId)(),l=(0,n.getState)(),d=new AbortController,c=setTimeout(()=>d.abort(),2e4);try{const t={...e,fb_id:l.details.facebot_id,partner_id:l.details.partner_id,user_id:l.details.user_id,session_id:s},i={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t),signal:d.signal},n=await fetch("https://9yrts99ryd.execute-api.us-east-1.amazonaws.com/prod",i);if(clearTimeout(c),!n.ok){const e=await n.json().catch(()=>({}));throw new Error(`HTTP ${n.status}: ${e.message||n.statusText}`)}return(await n.json()).data}catch(s){clearTimeout(c);const i=((e,t)=>!(!e||!r.includes(e.name))||!(!t||!a.includes(t)))(s,s.status),n=t<3;if(i&&n){const i=(e=>{const t=1e3*Math.pow(2,e);return t+.1*Math.random()*t})(t);return console.warn(`âš ï¸ API Request failed (attempt ${t+1}/4), retrying in ${Math.round(i)}ms:`,s.message),await(h=i,new Promise(e=>setTimeout(e,h))),o(e,t+1)}throw"AbortError"===s.name?console.error("âŒ API Request Timed Out:","Request took longer than 20000ms"):i&&!n?console.error("âŒ API Request Failed After Retries:","Failed after 4 attempts:",s.message):console.error("âŒ API Request Failed:",s.message),s}var h}},"./src/js/utils/index.js":(e,t,s)=>{function i(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}function n(e){window.location.pathname;const t=document.cookie.match(new RegExp("(^| )"+e+"=([^;]+)"));return t?t[2]:null}function r(e,t,s){const i=window.location.pathname;let n="";if(s){const e=new Date;e.setTime(e.getTime()+24*s*60*60*1e3),n="; expires="+e.toUTCString()}document.cookie=e+"="+(t||"")+n+`; path=/${i}`}s.r(t),s.d(t,{generateUserId:()=>i,getCookie:()=>n,getDomElement:()=>d,getSessionId:()=>o,isAndroidDevice:()=>c,setCookie:()=>r,setSessionId:()=>a,toggleInputBar:()=>l});const a=e=>{const t=window.location.pathname;sessionStorage.setItem(`fb_chat_session_${t}`,e)},o=()=>{const e=window.location.pathname;return sessionStorage.getItem(`fb_chat_session_${e}`)},l=(e=!0)=>{const t=document.getElementById("fb-widget-config"),s=t?.shadowRoot,i=s?.getElementById("my-widget-input-bar");i&&(i.style.display=e?"flex":"none")},d=e=>{const t=document.getElementById("fb-widget-config"),s=t?.shadowRoot;return s?s.querySelector(e):null},c=()=>{const e=navigator.userAgent||navigator.vendor||window.opera;return/android/i.test(e)}},"./src/js/utils/resourceManager.js":(e,t,s)=>{s.r(t),s.d(t,{cleanupGlobalResources:()=>a,default:()=>o,getResourceManager:()=>r});class i{constructor(){this.resources=new Map,this.eventListeners=new Map,this.timers=new Set,this.subscriptions=new Set,this.hlsInstances=new Set,this.isDestroyed=!1}addEventListener(e,t,s,i={}){if(this.isDestroyed)return void console.warn("ResourceManager: Cannot add listener, manager is destroyed");e.addEventListener(t,s,i);const n=`${e.constructor.name}_${t}_${Date.now()}`;return this.eventListeners.set(n,{element:e,event:t,handler:s,options:i}),console.log(`ðŸ”§ ResourceManager: Registered event listener ${t} on ${e.constructor.name}`),()=>{this.removeEventListener(n)}}removeEventListener(e){const t=this.eventListeners.get(e);if(t)try{t.element.removeEventListener(t.event,t.handler,t.options),this.eventListeners.delete(e),console.log(`ðŸ”§ ResourceManager: Removed event listener ${t.event}`)}catch(e){console.error("ResourceManager: Error removing event listener:",e)}}registerTimer(e,t="timeout"){if(!this.isDestroyed)return this.timers.add({id:e,type:t}),console.log(`ðŸ”§ ResourceManager: Registered ${t} timer ${e}`),()=>{this.clearTimer(e,t)};console.warn("ResourceManager: Cannot register timer, manager is destroyed")}clearTimer(e,t){const s=Array.from(this.timers).find(s=>s.id===e&&s.type===t);if(s)try{"timeout"===t?clearTimeout(e):"interval"===t&&clearInterval(e),this.timers.delete(s),console.log(`ðŸ”§ ResourceManager: Cleared ${t} timer ${e}`)}catch(e){console.error("ResourceManager: Error clearing timer:",e)}}registerSubscription(e,t="unknown"){if(!this.isDestroyed)return this.subscriptions.add({unsubscribe:e,description:t}),console.log(`ðŸ”§ ResourceManager: Registered subscription: ${t}`),()=>{this.removeSubscription(e)};console.warn("ResourceManager: Cannot register subscription, manager is destroyed")}removeSubscription(e){const t=Array.from(this.subscriptions).find(t=>t.unsubscribe===e);if(t)try{t.unsubscribe(),this.subscriptions.delete(t),console.log(`ðŸ”§ ResourceManager: Removed subscription: ${t.description}`)}catch(e){console.error("ResourceManager: Error removing subscription:",e)}}registerHLSInstance(e,t="unknown"){if(!this.isDestroyed)return this.hlsInstances.add({instance:e,description:t}),console.log(`ðŸ”§ ResourceManager: Registered HLS instance: ${t}`),()=>{this.removeHLSInstance(e)};console.warn("ResourceManager: Cannot register HLS instance, manager is destroyed")}removeHLSInstance(e){const t=Array.from(this.hlsInstances).find(t=>t.instance===e);if(t)try{t.instance&&"function"==typeof t.instance.destroy&&t.instance.destroy(),this.hlsInstances.delete(t),console.log(`ðŸ”§ ResourceManager: Destroyed HLS instance: ${t.description}`)}catch(e){console.error("ResourceManager: Error destroying HLS instance:",e)}}registerResource(e,t,s="unknown"){if(this.isDestroyed)return void console.warn("ResourceManager: Cannot register resource, manager is destroyed");const i=`${s}_${Date.now()}`;return this.resources.set(i,{resource:e,cleanup:t,description:s}),console.log(`ðŸ”§ ResourceManager: Registered resource: ${s}`),()=>{this.removeResource(i)}}removeResource(e){const t=this.resources.get(e);if(t)try{t.cleanup(t.resource),this.resources.delete(e),console.log(`ðŸ”§ ResourceManager: Cleaned up resource: ${t.description}`)}catch(e){console.error("ResourceManager: Error cleaning up resource:",e)}}getResourceCounts(){return{eventListeners:this.eventListeners.size,timers:this.timers.size,subscriptions:this.subscriptions.size,hlsInstances:this.hlsInstances.size,resources:this.resources.size,isDestroyed:this.isDestroyed}}cleanup(){if(this.isDestroyed)return void console.warn("ResourceManager: Already destroyed");console.log("ðŸ”§ ResourceManager: Starting cleanup of all resources...");const e=this.getResourceCounts();console.log("ðŸ”§ ResourceManager: Initial counts:",e);for(const[e,t]of this.eventListeners)try{t.element.removeEventListener(t.event,t.handler,t.options)}catch(e){console.error("ResourceManager: Error removing event listener during cleanup:",e)}this.eventListeners.clear();for(const e of this.timers)try{"timeout"===e.type?clearTimeout(e.id):"interval"===e.type&&clearInterval(e.id)}catch(e){console.error("ResourceManager: Error clearing timer during cleanup:",e)}this.timers.clear();for(const e of this.subscriptions)try{e.unsubscribe()}catch(e){console.error("ResourceManager: Error removing subscription during cleanup:",e)}this.subscriptions.clear();for(const e of this.hlsInstances)try{e.instance&&"function"==typeof e.instance.destroy&&e.instance.destroy()}catch(e){console.error("ResourceManager: Error destroying HLS instance during cleanup:",e)}this.hlsInstances.clear();for(const[e,t]of this.resources)try{t.cleanup(t.resource)}catch(e){console.error("ResourceManager: Error cleaning up resource during cleanup:",e)}this.resources.clear(),this.isDestroyed=!0;const t=this.getResourceCounts();console.log("ðŸ”§ ResourceManager: Cleanup completed. Final counts:",t)}}let n=null;function r(){return n&&!n.isDestroyed||(n=new i,console.log("ðŸ”§ Created new global ResourceManager")),n}function a(){n&&(n.cleanup(),n=null,console.log("ðŸ”§ Cleaned up global ResourceManager"))}const o=i},"./src/launcher.js":(e,t,s)=>{s.r(t),s.d(t,{createLauncher:()=>c});var i=s("./src/store/index.js"),n=s("./src/js/components/inputBar.js"),r=s("./src/js/layout/footer.js"),a=s("./src/js/layout/header.js"),o=s("./src/js/utils/api.js"),l=s("./src/js/utils/index.js"),d=s("./src/js/components/mic/index.js");const c=e=>{const t=document.createElement("div");t.className="widget-launcher";const s=(0,i.getState)().widgetConfig?.tooltip_text||"ðŸ‘‹ AI Assistant 24/7",c=document.createElement("div");c.className="launcher-text",c.textContent=s,c.style.opacity="0",c.style.transition="opacity 0.5s ease";const h=document.createElement("div");h.className="logo-container",h.style.position="relative",h.style.overflow="hidden",h.style.borderRadius="8px",h.style.cursor="pointer",h.style.opacity="0",h.style.width="60px",h.style.height="60px",h.style.display="flex",h.style.alignItems="center",h.style.justifyContent="center",h.style.backgroundColor="white",h.style.color="white",h.style.transition="transform 0.3s ease, opacity 0.5s ease",h.addEventListener("mouseenter",()=>{h.style.transform="scale(1.05)"}),h.addEventListener("mouseleave",()=>{h.style.transform=""});const u=document.createElement("div");u.innerHTML='<svg width="52" height="52" viewBox="0 0 29 36" fill="none" xmlns="http://www.w3.org/2000/svg">\n      <path fill-rule="evenodd" clip-rule="evenodd" d="M17.2503 2.76209C17.2503 1.2642 16.0474 2.38419e-07 14.5026 0C12.9578 -2.38419e-07 11.755 1.2642 11.755 2.76209C11.755 3.94518 12.5053 4.98248 13.5819 5.36624V7.98275L13.5819 7.9855H6.08085C4.72488 7.9855 3.62565 9.08473 3.62565 10.4407V35.3857C3.62565 35.9684 4.36145 36.2232 4.7218 35.7653L9.1125 30.1861C9.13538 30.157 9.15513 30.1267 9.17188 30.0956H22.9205C24.2764 30.0956 25.3757 28.9964 25.3757 27.6404V10.4407C25.3757 9.08473 24.2764 7.9855 22.9205 7.9855H15.4233L15.4233 7.98275V5.36624C16.4999 4.98248 17.2503 3.94518 17.2503 2.76209ZM14.5026 3.68279C13.9588 3.68279 13.5675 3.24301 13.5675 2.76209C13.5675 2.28117 13.9588 1.8414 14.5026 1.8414C15.0464 1.8414 15.4378 2.28117 15.4378 2.76209C15.4377 3.24301 15.0464 3.68279 14.5026 3.68279ZM10.4212 17.1973C11.5057 17.1973 12.3848 16.3039 12.3848 15.2018C12.3848 14.0997 11.5057 13.2063 10.4212 13.2063C9.33679 13.2063 8.45768 14.0997 8.45768 15.2018C8.45768 16.3039 9.33679 17.1973 10.4212 17.1973ZM19.9382 23.0333V23.954C19.9382 24.858 19.0497 25.4885 18.1257 25.4885H17.8249V23.0333H19.9382ZM16.9186 23.0333V25.4885H15.1061V23.0333H16.9186ZM12.3874 25.4885H14.1999V23.0333H12.3874V25.4885ZM11.4811 23.0333V25.4885H10.8757C9.95164 25.4885 9.06315 24.858 9.06315 23.954V23.0333H11.4811ZM20.541 15.2018C20.541 16.3039 19.6619 17.1973 18.5775 17.1973C17.493 17.1973 16.6139 16.3039 16.6139 15.2018C16.6139 14.0997 17.493 13.2063 18.5775 13.2063C19.6619 13.2063 20.541 14.0997 20.541 15.2018Z" fill="url(#paint0_linear_2322_2057)"></path>\n      <path d="M1.51042 22.4181L2.41667 22.4181L2.41667 15.3551H1.51042C0.620625 15.3551 1.86905e-07 16.2583 1.46218e-07 17.1977L0 20.5756C-4.06872e-08 21.5149 0.620625 22.4181 1.51042 22.4181Z" fill="url(#paint1_linear_2322_2057)"></path>\n      <path d="M26.5846 22.4181L27.4909 22.4181C28.3807 22.4181 29.0013 21.5149 29.0013 20.5756V17.1977C29.0013 16.2583 28.3807 15.3551 27.4909 15.3551H26.5846V22.4181Z" fill="url(#paint2_linear_2322_2057)"></path>\n      <defs>\n      <linearGradient id="paint0_linear_2322_2057" x1="21.472" y1="11.5317" x2="3.70572" y2="35.8565" gradientUnits="userSpaceOnUse">\n      <stop stop-color="#13C9DD"></stop>\n      <stop offset="1" stop-color="#0A30D2"></stop>\n      </linearGradient>\n      <linearGradient id="paint1_linear_2322_2057" x1="21.472" y1="11.5317" x2="3.70572" y2="35.8565" gradientUnits="userSpaceOnUse">\n      <stop stop-color="#13C9DD"></stop>\n      <stop offset="1" stop-color="#0A30D2"></stop>\n      </linearGradient>\n      <linearGradient id="paint2_linear_2322_2057" x1="21.472" y1="11.5317" x2="3.70572" y2="35.8565" gradientUnits="userSpaceOnUse">\n      <stop stop-color="#13C9DD"></stop>\n      <stop offset="1" stop-color="#0A30D2"></stop>\n      </linearGradient>\n      </defs>\n      </svg>',h.appendChild(u),t.appendChild(c),t.appendChild(h),document.body.appendChild(t);let f=!1,g=null;setTimeout(()=>{h.style.opacity="1"},100);const m=()=>{h.classList.add("launcher-jumping"),c.style.opacity="1",setTimeout(()=>{h.classList.remove("launcher-jumping"),c.style.opacity="0"},3e3)};setTimeout(()=>{m(),setInterval(m,1e4)},1e4),"left"===(0,i.getState)().widgetConfig?.widget_placement&&(t.style.left="24px",t.style.right="auto"),setTimeout(()=>{const e=(0,i.getState)().widgetConfig;!0===e?.auto_open&&(console.log("ðŸš€ Auto-opening widget due to auto_open config"),setTimeout(()=>{t.onclick()},1e3))},500);const p=()=>{const e=document.getElementById("fb-widget-config");if(e.shadowRoot){const t=e.shadowRoot.querySelector("#widget-video-player");t&&"function"==typeof t.cleanup&&t.cleanup(),e.shadowRoot.querySelectorAll("video").forEach(e=>{e&&"function"==typeof e.pause&&(e.pause(),e.currentTime=0)}),e.shadowRoot.innerHTML=""}},y=()=>{(0,d.stopMicrophoneRecording)(),p();const e=document.getElementById("fb-widget-config");e&&e.shadowRoot&&e.shadowRoot.querySelectorAll("video").forEach(e=>{e&&"function"==typeof e.pause&&(e.pause(),e.currentTime=0,e.src="")}),t.style.display="block",f=!1},v=(s=void 0)=>{const o=document.getElementById("fb-widget-config");g=o.shadowRoot||o.attachShadow({mode:"open"}),g.innerHTML="",[...document.head.querySelectorAll("style")].forEach(e=>g.appendChild(e.cloneNode(!0)));const l=e("home",s);window.__myWidgetBody=l,window.__myWidgetBody?.setView("video_with_chat"),(0,i.setView)("video_with_chat");const d=navigator.platform.toUpperCase().indexOf("MAC")>=0,c=/^((?!chrome|android).)*safari/i.test(navigator.userAgent);d&&c&&setTimeout(()=>{const e=g.querySelector("#widget-video-player");e&&"function"==typeof e.refresh&&e.refresh()},300);const h=document.createElement("div");h.className="my-widget-wrapper fade-in",/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)||window.addEventListener("resize",()=>{f&&(p(),(0,i.setChatOpen)(!1),t.onclick())}),(0,i.getState)().widgetConfig?.themeColor&&(h.style.border=`2px solid ${(0,i.getState)().widgetConfig.themeColor}`),h.appendChild((0,a.renderHeader)({onShowVideoChat:()=>{window.__myWidgetBody&&"function"==typeof window.__myWidgetBody.setView&&window.__myWidgetBody.setView("video_with_chat")}})),h.appendChild(l),"contact"!==(0,i.getState)().currentView&&h.appendChild((0,n.renderInputBar)()),h.appendChild((0,r.renderFooter)()),g.appendChild(h),f=!0,t.style.display="none"};let E=!1;return t.onclick=async()=>{if(!E){E=!0;try{if(f)y();else if((0,l.getSessionId)())v(void 0);else{const e=await(0,o.apiRequest)({action:"initialize"}),t=e?.answer_video_url?.[0]||void 0,s=e?.chat_session||void 0;t&&s&&((0,l.setSessionId)(s),v(t))}}catch(e){console.warn("Failed to open widget. Please try again.",e)}finally{setTimeout(()=>{E=!1},500)}}},document.addEventListener("close-widget",y),t}},"./src/store/index.js":(e,t,s)=>{s.r(t),s.d(t,{destroyStore:()=>T,getState:()=>a,getStoreStats:()=>E,getSuggestionsConfig:()=>m,resetStore:()=>S,setChatOpen:()=>h,setDetails:()=>d,setMicOn:()=>f,setPlayCount:()=>o,setSuggestionsConfig:()=>p,setView:()=>l,setWidgetConfig:()=>c,subscribe:()=>v,subscribeChat:()=>u,subscribeMic:()=>g,subscribeSuggestions:()=>y});const i={playCount:0,currentView:"chat",details:{},widgetConfig:{},listeners:[],chatOpen:!1,micOn:!1,chatListeners:[],micListeners:[],suggestionsConfig:{autoShowDelay:1e4,autoShowEnabled:!0,autoHideDelay:3e4,autoHideEnabled:!0,maxAutoShows:3,maxVisibleSuggestions:2},suggestionsListeners:[],_isDestroyed:!1,_subscriptionCount:0};function n(e,t,s="unknown"){i._isDestroyed?console.warn(`Store: Cannot notify ${s} listeners, store is destroyed`):e.forEach((i,n)=>{try{i(t)}catch(t){console.error(`Store: Error in ${s} listener ${n}:`,t);const r=e.indexOf(i);r>-1&&(e.splice(r,1),console.warn(`Store: Removed problematic ${s} listener`))}})}function r(e,t,s){return i._isDestroyed?(console.warn(`Store: Cannot create ${s} subscription, store is destroyed`),()=>{}):"function"!=typeof t?(console.error(`Store: ${s} subscription callback must be a function`),()=>{}):(e.push(t),i._subscriptionCount++,console.log(`ðŸ”§ Store: Created ${s} subscription (total: ${i._subscriptionCount})`),()=>{const n=e.indexOf(t);n>-1&&(e.splice(n,1),i._subscriptionCount--,console.log(`ðŸ”§ Store: Removed ${s} subscription (total: ${i._subscriptionCount})`))})}const a=()=>i._isDestroyed?(console.warn("Store: Cannot get state, store is destroyed"),{}):{...i},o=e=>{i._isDestroyed?console.warn("Store: Cannot set play count, store is destroyed"):"number"!=typeof e||e<0?console.error("Store: Play count must be a non-negative number"):(i.playCount=e,n(i.listeners,e,"playCount"))},l=e=>{i._isDestroyed?console.warn("Store: Cannot set view, store is destroyed"):"string"==typeof e||"object"==typeof e?(i.currentView=e,n(i.listeners,e,"view")):console.error("Store: View must be a string or object")},d=e=>{i._isDestroyed?console.warn("Store: Cannot set details, store is destroyed"):"object"==typeof e&&null!==e?i.details={...e}:console.error("Store: Details must be an object")},c=e=>{i._isDestroyed?console.warn("Store: Cannot set widget config, store is destroyed"):"object"==typeof e&&null!==e?i.widgetConfig={...e}:console.error("Store: Widget config must be an object")},h=e=>{i._isDestroyed?console.warn("Store: Cannot set chat open, store is destroyed"):"boolean"==typeof e?(i.chatOpen=e,n(i.chatListeners,e,"chat")):console.error("Store: Chat open state must be a boolean")},u=e=>r(i.chatListeners,e,"chat"),f=e=>{i._isDestroyed?console.warn("Store: Cannot set mic on, store is destroyed"):"boolean"==typeof e?(i.micOn=e,console.log("ðŸŽ™ï¸ Mic state changed to:",e),n(i.micListeners,e,"mic")):console.error("Store: Mic on state must be a boolean")},g=e=>r(i.micListeners,e,"mic"),m=()=>i._isDestroyed?(console.warn("Store: Cannot get suggestions config, store is destroyed"),{}):{...i.suggestionsConfig},p=e=>{i._isDestroyed?console.warn("Store: Cannot set suggestions config, store is destroyed"):"object"==typeof e&&null!==e?(i.suggestionsConfig={...i.suggestionsConfig,...e},console.log("âš™ï¸ Store: Suggestions config updated:",i.suggestionsConfig),n(i.suggestionsListeners,i.suggestionsConfig,"suggestions")):console.error("Store: Suggestions config must be an object")},y=e=>r(i.suggestionsListeners,e,"suggestions"),v=e=>r(i.listeners,e,"generic"),E=()=>({subscriptionCount:i._subscriptionCount,chatListeners:i.chatListeners.length,micListeners:i.micListeners.length,genericListeners:i.listeners.length,isDestroyed:i._isDestroyed}),T=()=>{if(i._isDestroyed)return void console.warn("Store: Already destroyed");console.log("ðŸ”§ Store: Destroying store and cleaning up subscriptions...");const e=E();console.log("ðŸ”§ Store: Pre-cleanup stats:",e),i.listeners.length=0,i.chatListeners.length=0,i.micListeners.length=0,i.playCount=0,i.currentView="chat",i.details={},i.widgetConfig={},i.chatOpen=!1,i.micOn=!1,i._subscriptionCount=0,i._isDestroyed=!0,console.log("ðŸ”§ Store: Store destroyed and cleaned up")},S=()=>{console.log("ðŸ”§ Store: Resetting store to initial state..."),i.listeners.length=0,i.chatListeners.length=0,i.micListeners.length=0,i.playCount=0,i.currentView="chat",i.details={},i.widgetConfig={},i.chatOpen=!1,i.micOn=!1,i._subscriptionCount=0,i._isDestroyed=!1,console.log("ðŸ”§ Store: Store reset completed")}},"./src/styles/style.css":(e,t,s)=>{s.r(t),s.d(t,{default:()=>y});var i=s("./node_modules/style-loader/dist/runtime/injectStylesIntoStyleTag.js"),n=s.n(i),r=s("./node_modules/style-loader/dist/runtime/styleDomAPI.js"),a=s.n(r),o=s("./node_modules/style-loader/dist/runtime/insertBySelector.js"),l=s.n(o),d=s("./node_modules/style-loader/dist/runtime/setAttributesWithoutAttributes.js"),c=s.n(d),h=s("./node_modules/style-loader/dist/runtime/insertStyleElement.js"),u=s.n(h),f=s("./node_modules/style-loader/dist/runtime/styleTagTransform.js"),g=s.n(f),m=s("./node_modules/css-loader/dist/cjs.js!./src/styles/style.css"),p={};p.styleTagTransform=g(),p.setAttributes=c(),p.insert=l().bind(null,"head"),p.domAPI=a(),p.insertStyleElement=u(),n()(m.default,p);const y=m.default&&m.default.locals?m.default.locals:void 0}},t={};function s(i){var n=t[i];if(void 0!==n)return n.exports;var r=t[i]={id:i,exports:{}};return e[i](r,r.exports,s),r.exports}s.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return s.d(t,{a:t}),t},s.d=(e,t)=>{for(var i in t)s.o(t,i)&&!s.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),s.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.nc=void 0;var i={};(()=>{s.r(i),s("./src/styles/style.css");var e=s("./src/js/layout/body.js"),t=s("./src/store/index.js"),n=s("./src/js/utils/api.js"),r=s("./src/launcher.js"),a=s("./src/js/utils/index.js");document.addEventListener("DOMContentLoaded",async()=>{const s=document.getElementById("fb-widget-config"),i=s?.getAttribute("data-partner_id"),o=s?.getAttribute("data-fb_id");let l=(0,a.getCookie)("user_id");l||(l=await(0,a.generateUserId)(),(0,a.setCookie)("user_id",l,365)),(0,t.setDetails)({partner_id:i,facebot_id:o,user_id:l});try{const e=await(0,n.apiRequest)({action:"get_config"});if(!e.active)return void console.warn("ðŸš« Widget is disabled via config.");(0,t.setWidgetConfig)(e)}catch(e){return void console.error("âŒ Failed to fetch widget config:",e)}(0,r.createLauncher)(e.renderBody)})})()})();